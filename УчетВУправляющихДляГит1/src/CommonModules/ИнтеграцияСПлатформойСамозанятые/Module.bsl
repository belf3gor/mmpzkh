#Область ПрограммныйИнтерфейс

// Возвращает список методов взаимодействия с сервисом.
//
// Возвращаемое значение:
//  ТаблицаЗначений - описание см. в функции НоваяТаблицаМетодовВзаимодействия()
//
Функция МетодыВзаимодействия() Экспорт
	
	МетодыВзаимодействия = НоваяТаблицаМетодовВзаимодействия();
	
	// Подключение и отключение сервиса, получение списка разрешений
	
	ДобавитьНовыйМетодВзаимодействия(
		"КодПодтверждения",
		НСтр("ru = 'Запрос кода подтверждения'"),
		"verification",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"ЗапросНаПривязку",
		НСтр("ru = 'Запрос на подключение сервиса'"),
		"bind_partner_by_phone",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СтатусЗапросаНаПривязку",
		НСтр("ru = 'Статус запроса на подключение'"),
		"bind_partner_status",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"ЗапросНаОтвязку",
		НСтр("ru = 'Отключение сервиса'"),
		"unbind_partner",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СписокРазрешений",
		НСтр("ru = 'Список разрешений'"),
		"permissions",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"ДетальныйСтатусНалогоплательщика",
		НСтр("ru = 'Детальный статус налогоплательщика'"),
		"taxpayer_status",
		МетодыВзаимодействия);
	
	// Регистрация и сторнирование доходов
	
	ДобавитьНовыйМетодВзаимодействия(
		"РегистрацияДохода",
		НСтр("ru = 'Регистрация дохода'"),
		"post_income",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СторнированиеДохода",
		НСтр("ru = 'Сторнирование дохода'"),
		"cancel_receipt",
		МетодыВзаимодействия);
	
	// Состояние лицевого счета, информация о зарегистрированных доходах за период
	
	ДобавитьНовыйМетодВзаимодействия(
		"СостояниеЛицевогоСчета",
		НСтр("ru = 'Состояние лицевого счета'"),
		"unpaid_tax",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СписокДоходов",
		НСтр("ru = 'Зарегистрированные доходы'"),
		"income_list",
		МетодыВзаимодействия);
	
	// Начисленный налог, получение реквизитов квитанции на уплату
	
	ДобавитьНовыйМетодВзаимодействия(
		"ИнформацияОНачислениях",
		НСтр("ru = 'Доход за период'"),
		"tax_for_period",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СписокКвитанцийНаУплатуНалога",
		НСтр("ru = 'Квитанции на оплату налога'"),
		"tax_payment_invoice",
		МетодыВзаимодействия);
	
	// Справки
	
	ДобавитьНовыйМетодВзаимодействия(
		"СправкаОПостановкеНаУчет",
		НСтр("ru = 'Справка о потановке на учет'"),
		"registration_reference",
		МетодыВзаимодействия);
	
	ДобавитьНовыйМетодВзаимодействия(
		"СправкаОДоходах",
		НСтр("ru = 'Справка о доходах'"),
		"income_reference",
		МетодыВзаимодействия);
	
	МетодыВзаимодействия.Индексы.Добавить("Код");
	
	Возврат МетодыВзаимодействия;
	
КонецФункции

// Процедура выполнения метода взаимодействия с сервисом интеграции в фоне.
// При вызове на клиенте должна выполняться асинхронно.
//
// Параметры:
//  ПараметрыМетода - Структура - описание см. в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.НовыеПараметрыМетодаВзаимодействия()
//  АдресРезультата - Строка - адрес временного хранилища, в которое будет помещен результат выполнения
//                             в виде структуры, описанное в функции НовыйЗапрос()
//
Процедура ВыполнитьМетодВзаимодействияВФоне(ПараметрыМетода, АдресРезультата) Экспорт
	
	Запрос = ВыполнитьМетодВзаимодействия(ПараметрыМетода);
	
	ПоместитьВоВременноеХранилище(Запрос, АдресРезультата);
	
КонецПроцедуры

// Процедура получения результата выполнения метода с сервисом интеграции в фоне. Сам метод взаимодействия вызывается процедурой ВыполнитьМетодВзаимодействияВФоне().
// При вызове на клиенте должна выполняться асинхронно.
//
// Параметры:
//  Запрос - Структура - возвращенная процедурой ВыполнитьМетодВзаимодействияВФоне()
//  АдресРезультата - Строка - адрес временного хранилища, в которое будет помещен результат выполнения
//                             в виде структуры, описанное в функции НовыйРезультатЗапроса()
//  АдресДополнительногоРезультата - Строка - адрес временного хранилища, в которое будет помещен результат выполнения
//                             в виде структуры, содержащей значения типов, недоступных на клиенте
//
Процедура ПолучитьРезультатВыполненияВФоне(Запрос, АдресРезультата, АдресДополнительногоРезультата = Неопределено) Экспорт
	
	СтатусыЗапросов = ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов();
	
	РезультатЗапроса = ПолучитьРезультатВыполнения(Запрос);
	
	Если Запрос.ДополнительныйРезультат
		И РезультатЗапроса.Результат <> Неопределено
		И РезультатЗапроса.Статус <> СтатусыЗапросов.Ошибка Тогда
		Если ЭтоАдресВременногоХранилища(АдресДополнительногоРезультата) Тогда
			ПоместитьВоВременноеХранилище(РезультатЗапроса.Результат, АдресДополнительногоРезультата);
			РезультатЗапроса.Результат = Новый Структура("АдресВременногоХранилища", АдресДополнительногоРезультата);
		Иначе
			ВызватьИсключение СтрШаблон("Для получения результата выполнения метода %1 должен быть передан параметр АдресДополнительногоРезультата", Запрос);
		КонецЕсли;
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(РезультатЗапроса, АдресРезультата);
	
КонецПроцедуры

// Возвращает список разрешений, предоставленных пользователем.
//
// Возвращаемое значение:
//  ТаблицаЗначений - описание см. в функции НоваяТаблицаРазрешений()
//
Функция ПереченьРазрешенийНаДействияПартнеромОтИмениНП() Экспорт
	
	ПереченьРазрешений = НоваяТаблицаРазрешений();
	
	ДобавитьНовоеРазрешение(
		"ОтражениеДохода",
		НСтр("ru = 'Отражение дохода'"),
		"INCOME_REGISTRATION",
		ПереченьРазрешений);
		
	ДобавитьНовоеРазрешение(
		"ПолучениеинформацииПоНалоговымНачислениям",
		НСтр("ru = 'Получение информации по налоговым начислениям'"),
		"PAYMENT_INFORMATION",
		ПереченьРазрешений);
		
	ДобавитьНовоеРазрешение(
		"ПолучениеИнформацииПоДоходам",
		НСтр("ru = 'Получение информации по доходам'"),
		"INCOME_LIST",
		ПереченьРазрешений);
	
	ДобавитьНовоеРазрешение(
		"ПолучениеCводнойИнформацииОДоходе",
		НСтр("ru = 'Получение сводной информации о доходе'"),
		"INCOME_SUMMARY",
		ПереченьРазрешений);
	
	ДобавитьНовоеРазрешение(
		"КорректировкаСведенийОДоходахПоданныхПартнером",
		НСтр("ru = 'Корректировка сведений о доходах, поданных партнером'"),
		"CANCEL_INCOME",
		ПереченьРазрешений);
		
	ДобавитьНовоеРазрешение(
		"КорректировкаСведенийОДоходахБезОграничений",
		НСтр("ru = 'Корректировка сведений о доходах без ограничений'"),
		"CANCEL_ANY_INCOME",
		ПереченьРазрешений);
	
	Возврат ПереченьРазрешений;
	
КонецФункции

Функция АктивироватьПромокодСервисаИнтеграции() Экспорт
	
	Если ОбщегоНазначенияКлиентСервер.РежимОтладки() Тогда
		ПараметрЗапускаПриложения = ПараметрыСеанса.ПараметрыКлиентаНаСервере.Получить("ПараметрЗапуска");
		Возврат СтрНайти(ВРег(ПараметрЗапускаПриложения), "ИНТЕГРАЦИЯСАМОЗАНЯТЫЕ") > 0;
	КонецЕсли;
	
	// В коробке интеграция всегда недоступна.
	Если Не ОбщегоНазначения.РазделениеВключено()
		Или Не ОбщегоНазначения.ДоступноИспользованиеРазделенныхДанных() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Попытка
		// В сервисе интеграция доступна, если абоненту доступно служебное приложение
		// или можно активировать специальный промокод.
		ДоступныеКонфигурации = ПрограммныйИнтерфейсСервиса.Конфигурации();
		Если ДоступныеКонфигурации.Найти(КодКонфигурацииСервисаИнтеграции(), "Код") = Неопределено Тогда
			Возврат ПрограммныйИнтерфейсСервиса.ИспользоватьПромокод(ПромокодАктивацииСервисаИнтеграции(), Ложь);
		Иначе
			Возврат Истина;
		КонецЕсли;
	Исключение
		ЗаписьЖурналаРегистрации(
			ИнтеграцияСПлатформойСамозанятыеКлиентСервер.ИмяСобытияЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка,,,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	
	Возврат Ложь;
	
КонецФункции

// Выполняет метод взаимодействия с сервисом интеграции и возвращает результат выполнения.
// Должна выполнятся в фоновой операции.
//
// Параметры:
//  ПараметрыМетода - Структура - описание см. в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.НовыеПараметрыМетодаВзаимодействия()
// 
// Возвращаемое значение:
//   - Структура - Результат выполнения. См. НовыйЗапрос()
//
Функция ВыполнитьМетодВзаимодействия(ПараметрыМетода) Экспорт
	
	МетодВзаимодействия = ПараметрыМетода.МетодВзаимодействия;
	
	Если МетодВзаимодействия = "КодПодтверждения" Тогда
		
		Запрос = ВыполнитьМетод_КодПодтверждения(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "ЗапросНаПривязку" Тогда
		
		Запрос = ВыполнитьМетод_ЗапросНаПривязку(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СтатусЗапросаНаПривязку" Тогда
		
		Запрос = ВыполнитьМетод_СтатусЗапросаНаПривязку(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "ЗапросНаОтвязку" Тогда
		
		Запрос = ВыполнитьМетод(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СписокРазрешений" Тогда
		
		Запрос = ВыполнитьМетод(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "ДетальныйСтатусНалогоплательщика" Тогда
		
		Запрос = ВыполнитьМетод(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "РегистрацияДохода" Тогда
		
		Запрос = ВыполнитьМетод_РегистрацияДохода(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СторнированиеДохода" Тогда
		
		Запрос = ВыполнитьМетод_СторнированиеДохода(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СостояниеЛицевогоСчета" Тогда
		
		Запрос = ВыполнитьМетод(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "ИнформацияОНачислениях" Тогда
		
		Запрос = ВыполнитьМетод_ИнформацияОНачислениях(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СписокДоходов" Тогда
		
		Запрос = ВыполнитьМетод_СписокДоходов(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СписокКвитанцийНаУплатуНалога" Тогда
		
		Запрос = ВыполнитьМетод_СписокКвитанцийНаУплатуНалога(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СправкаОПостановкеНаУчет" Тогда
		
		Запрос = ВыполнитьМетод_СправкаОПостановкеНаУчет(ПараметрыМетода);
		
	ИначеЕсли МетодВзаимодействия = "СправкаОДоходах" Тогда
		
		Запрос = ВыполнитьМетод_СправкаОДоходах(ПараметрыМетода);
		
	Иначе
		
		Запрос = НовыйЗапрос(МетодВзаимодействия, Истина, НСтр("ru = 'Метод взаимодействия не определен'"));
		
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

// Получает результат выполнения метода с сервисом интеграции.
// Сам метод взаимодействия вызывается процедурой ВыполнитьМетодВзаимодействия().
// Должна выполнятся в фоновой операции.
//
// Параметры:
//  Запрос - Структура - возвращенная процедурой ВыполнитьМетодВзаимодействия()
//
// Возвращаемое значение:
//   - Структура - Результат выполнения запроса. См. НовыйРезультатЗапроса().
//
Функция ПолучитьРезультатВыполнения(Запрос) Экспорт
	
	СтатусыЗапросов = ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов();
	
	Если ЗначениеЗаполнено(Запрос) И ТипЗнч(Запрос) = Тип("Структура") Тогда
		РезультатЗапроса = ПроверитьВыполнениеЗапроса(Запрос);
		СтатусыЗапросов = ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов();
	Иначе
		РезультатЗапроса = НовыйРезультатЗапроса(СтатусыЗапросов.Ошибка, НСтр("ru = 'Запрос не определен'"));
	КонецЕсли;
	
	Возврат РезультатЗапроса;
	
КонецФункции

// Возвращает значение ставки по которой будет облагаться доход, полученный от контрагента.
//
// Параметры:
//  Контрагент - СправочникСсылка.Контрагенты - ссылка на элемент справочника "Контрагенты".
//
// Возвращаемое значение:
//  Число - значение ставки.
//
Функция СтавкаНПД(Контрагент = Неопределено) Экспорт
	
	ДополнительныеСведенияОКонтрагенте = Новый Структура("ЭтоФизическоеЛицо", Истина);
	ИнтеграцияСПлатформойСамозанятыеПереопределяемый.ДополнительныеСведенияОКонтрагенте(Контрагент, ДополнительныеСведенияОКонтрагенте);
	
	Если ЗначениеЗаполнено(Контрагент) 
		И НЕ ДополнительныеСведенияОКонтрагенте.ЭтоФизическоеЛицо Тогда
		СтавкаНалога = 6;
	Иначе
		СтавкаНалога = 4; 
	КонецЕсли;
	
	Возврат СтавкаНалога;

КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Устанавливает значение константы "ДоступнаИнтеграцияСПлатформойСамозанятые".
//
// Возвращаемое значение:
//   Булево - Истина, если изменилось значение константы. Ложь - в противном случае.
//
Функция УстановитьДоступнаИнтеграция() Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	ИспользуетсяНПД = Константы.ИспользуетсяНалогНаПрофессиональныйДоход.Получить();
	УстановитьПривилегированныйРежим(Ложь);
	
	// Обращение к методу АктивироватьПромокодСервисаИнтеграции() нельзя выполнять в привилегированном режиме.
	Если ИспользуетсяНПД Тогда
		ИнтеграцияДоступна = АктивироватьПромокодСервисаИнтеграции();
	Иначе
		ИнтеграцияДоступна = Ложь;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);

	МенеджерКонстанты = Константы.ДоступнаИнтеграцияСПлатформойСамозанятые.СоздатьМенеджерЗначения();
	МенеджерКонстанты.Прочитать();
	
	Если МенеджерКонстанты.Значение = ИнтеграцияДоступна Тогда
		УстановитьПривилегированныйРежим(Ложь);
		Возврат Ложь;
	КонецЕсли;
	
	МенеджерКонстанты.Значение = ИнтеграцияДоступна;
	
	ОбновлениеИнформационнойБазы.ЗаписатьДанные(МенеджерКонстанты, Ложь);
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ВыполнениеМетодовВзаимодействия

// Выполняет метод, для выполнения которого достаточно параметров по умолчанию  ИнтеграцияСПлатформойСамозанятые.НовыеПараметры()
//
// Параметры:
//  ПараметрыМетода - Структура - описание см. в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.НовыеПараметрыМетодаВзаимодействия()
//
// Возвращаемое значение:
//  Структура - описание см. в функции НовыйЗапрос()
//
Функция ВыполнитьМетод(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация";
	
	Ошибка = Не ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке);
	
	Если Не Ошибка Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Ошибка, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_КодПодтверждения(ПараметрыМетода)
	
	Перем ПодключенСервисИнтеграции, СообщениеОбОшибке;
	
	Если Не ПодключенСервисИнтеграции() Тогда
		Результат = ПодключитьПриложениеКСервисуИнтеграции();
		Если Не Результат.Ошибка Тогда
			ПодключенСервисИнтеграции = Истина;
		Иначе
			ПодключенСервисИнтеграции = Ложь;
			СообщениеОбОшибке = Результат.СообщениеОбОшибке;
		КонецЕсли;
	Иначе
		ПодключенСервисИнтеграции = Истина;
	КонецЕсли;
	
	ПроверяемыеПараметры = "Организация, НомерТелефона";
	
	Если ПодключенСервисИнтеграции И ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.НомерТелефона, ПараметрыМетода.НомерТелефона);
		
		// Возможно приложение уже подключено, но снова прислало запрос на привязку,
		// поскольку пользователь отключил привязку в личном кабинете.
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		
		// Создание нового приложения и добавление пользователя может занять какое-то время
		// и запросы будут завершаться с платформенной ошибкой авторизации пользователя.
		Для Повтор = 1 По КоличествоПовторовОтправкиЗапросаНаПривязку() Цикл
			Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
			Если Не Запрос.Ошибка Или ЗначениеЗаполнено(Запрос.КодВозврата) Тогда
				Прервать;
			Иначе
				ОбщегоНазначенияБТС.Пауза(Повтор);
			КонецЕсли;
		КонецЦикла;
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Запрос.ВремяОжидания = 0.1;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_ЗапросНаПривязку(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, НомерТелефона, ИдентификаторКодаПодтверждения, КодПодтверждения";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.НомерТелефона, ПараметрыМетода.НомерТелефона);
		Параметры.Вставить(ИменаПараметров.КодПодтверждения, ХешКодаПодтверждения(ПараметрыМетода.ИдентификаторКодаПодтверждения, ПараметрыМетода.КодПодтверждения));
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СтатусЗапросаНаПривязку(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, Идентификатор";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.Идентификатор, ПараметрыМетода.Идентификатор);
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_РегистрацияДохода(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, ДатаФормирования, ДатаРасчета, СуммаДокумента, УИДЧека, Услуги";
	
	Ошибка = Не ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке);
	
	Если Не Ошибка Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);

		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.УИДЧека,        ПараметрыМетода.УИДЧека);
		Параметры.Вставить(ИменаПараметров.ИНН,            СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.Наименование,   СведенияОбОрганизации.Наименование);
		Параметры.Вставить(ИменаПараметров.СуммаДокумента, ПараметрыМетода.СуммаДокумента);
		
		Параметры.Вставить(ИменаПараметров.ДатаРасчета, 
			ОбщегоНазначения.ПредставлениеЛокальнойДатыСоСмещением(ПараметрыМетода.ДатаРасчета));
		Параметры.Вставить(ИменаПараметров.ДатаФормирования,
			ОбщегоНазначения.ПредставлениеЛокальнойДатыСоСмещением(ПараметрыМетода.ДатаФормирования));
			
		Словарь = СловарьТиповДохода();
		
		Если ЗначениеЗаполнено(ПараметрыМетода.Контрагент) Тогда
			// Реализация юр.лицу или ИП.
			ИменаРеквизитовКонтрагента = "ИНН, НаименованиеПолное";
			РеквизитыКонтрагента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрыМетода.Контрагент, ИменаРеквизитовКонтрагента);
			
			ДополнительныеСведенияОКонтрагенте = Новый Структура("ЭтоИностраннаяОрганизация", Ложь);
			ИнтеграцияСПлатформойСамозанятыеПереопределяемый.ДополнительныеСведенияОКонтрагенте(ПараметрыМетода.Контрагент, ДополнительныеСведенияОКонтрагенте);
			ИностраннаяОрганизация = ДополнительныеСведенияОКонтрагенте.ЭтоИностраннаяОрганизация;
				
			ПроверяемыеПараметры = "НаименованиеПолное" + ?(ИностраннаяОрганизация,"", ", ИНН");
			Ошибка = Не ПроверитьЗаполнениеПараметров(РеквизитыКонтрагента, ПроверяемыеПараметры, СообщениеОбОшибке) Или Ошибка;
			
			Если Не Ошибка Тогда
				ПараметрыКонтрагента = Новый Структура;
				ПараметрыКонтрагента.Вставить(ИменаПараметров.ИНН, РеквизитыКонтрагента.ИНН);
				ПараметрыКонтрагента.Вставить(ИменаПараметров.Наименование, РеквизитыКонтрагента.НаименованиеПолное);
				Параметры.Вставить(ИменаПараметров.Контрагент, ПараметрыКонтрагента);
				Если ИностраннаяОрганизация Тогда
					Параметры.Вставить(ИменаПараметров.ТипДохода, Словарь.ИностраннаяОрганизация);
				Иначе
					Параметры.Вставить(ИменаПараметров.ТипДохода, Словарь.РоссийскаяОрганизация);
				КонецЕсли;
			КонецЕсли;
		Иначе
			Параметры.Вставить(ИменаПараметров.ТипДохода, Словарь.ФизическоеЛицо);
		КонецЕсли;
		
		Услуги = ПараметрыМетода.Услуги;
		Если Услуги.Количество() = 1 Тогда
			Для Каждого Колонка Из Услуги.Колонки Цикл
				ИмяКолонки = Неопределено;
				Если ИменаПараметров.Свойство(СтрШаблон("%1_%2", "Услуги", Колонка.Имя), ИмяКолонки) Тогда
					Колонка.Имя = ИмяКолонки;
				Иначе
					Услуги.Колонки.Удалить(Колонка);
				КонецЕсли;
			КонецЦикла;
			Параметры.Вставить(ИменаПараметров.Услуги, ОбщегоНазначения.ТаблицаЗначенийВМассив(Услуги));
		Иначе
			Ошибка = Истина;
			СообщениеОбОшибке = НСтр("ru = 'Некорректное значение параметра Услуги. Ожидается таблица значений с одной строкой.'");
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не Ошибка Тогда
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СторнированиеДохода(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	Перем ПричинаОтменыЧека;
	
	ПроверяемыеПараметры = "Организация, ИдентификаторЧека, УИДЧека";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.УИДЧека, ПараметрыМетода.УИДЧека);
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.ИдентификаторЧека, ПараметрыМетода.ИдентификаторЧека);
		Если ПараметрыМетода.Свойство("ПричинаОтменыЧека", ПричинаОтменыЧека) И ЗначениеЗаполнено(ПричинаОтменыЧека) Тогда
			Параметры.Вставить(ИменаПараметров.ПричинаОтменыЧека, ПричинаОтменыЧека);
		КонецЕсли;
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_ИнформацияОНачислениях(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, Период";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.НалоговыйПериод, ПараметрыМетода.Период);
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СписокДоходов(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, НачалоПериода, КонецПериода";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.НачалоПериода, НачалоДня(ПараметрыМетода.НачалоПериода));
		Параметры.Вставить(ИменаПараметров.КонецПериода, КонецДня(ПараметрыМетода.КонецПериода));
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		Запрос.ДополнительныйРезультат = Истина;
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СписокКвитанцийНаУплатуНалога(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	Перем НачалоПериода, КонецПериода;
	
	ПроверяемыеПараметры = "Организация";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Если ПараметрыМетода.Свойство("НачалоПериода", НачалоПериода) И ЗначениеЗаполнено(НачалоПериода) Тогда
			Параметры.Вставить(ИменаПараметров.НачалоПериода, НачалоДня(НачалоПериода));
		КонецЕсли;
		Если ПараметрыМетода.Свойство("КонецПериода", КонецПериода) И ЗначениеЗаполнено(КонецПериода) Тогда
			Параметры.Вставить(ИменаПараметров.КонецПериода, КонецДня(КонецПериода));
		КонецЕсли;
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		Запрос.ДополнительныйРезультат = Истина;
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СправкаОПостановкеНаУчет(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация";
	
	Ошибка = Не ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке);
	
	Если Не Ошибка Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		Запрос.ДополнительныйРезультат = Истина;
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Ошибка, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

Функция ВыполнитьМетод_СправкаОДоходах(ПараметрыМетода)
	
	Перем СообщениеОбОшибке;
	
	ПроверяемыеПараметры = "Организация, НачалоПериода, КонецПериода";
	
	Если ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке) Тогда
		
		СведенияОбОрганизации = ИнтеграцияСПлатформойСамозанятыеПереопределяемый.СведенияОбОрганизации(ПараметрыМетода.Организация);
		
		ИменаПараметров = ПараметрыМетодов();
		
		Параметры = Новый Структура;
		Параметры.Вставить(ИменаПараметров.ИдентификаторПриложения, ИдентификаторПриложения(ПараметрыМетода.Организация));
		Параметры.Вставить(ИменаПараметров.ИНН, СведенияОбОрганизации.ИНН);
		Параметры.Вставить(ИменаПараметров.НачалоПериода, НачалоДня(ПараметрыМетода.НачалоПериода));
		Параметры.Вставить(ИменаПараметров.КонецПериода, НачалоДня(ПараметрыМетода.КонецПериода));
		
		Запрос = СформироватьЗапрос(ПараметрыМетода.МетодВзаимодействия, Параметры);
		Запрос.ДополнительныйРезультат = Истина;
		
	Иначе
		Запрос = НовыйЗапрос(ПараметрыМетода.МетодВзаимодействия, Истина, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

#КонецОбласти

#Область ФормированиеЗапроса

// Проверяет заполнение обязательных параметров выполнения метода функцией ВыполнитьМетод_ХХ(), соответствующей выбранному методу взаимодействия.
//
// Параметры:
//  ПараметрыМетода - Структура - описание см. в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.НовыеПараметрыМетодаВзаимодействия()
//  ПроверяемыеПараметры - Строка - имена обязательных параметров, перечисленных через запятую
//  СообщениеОбОшибке - Строка - сообщение об ошибке (исходящий параметр)
//
// Возвращаемое значение:
//   Булево - Истина, если все необходимые параметры заполнены
//
Функция ПроверитьЗаполнениеПараметров(ПараметрыМетода, ПроверяемыеПараметры, СообщениеОбОшибке = Неопределено)
	Перем ЗначениеПараметра;
	
	РезультатПроверки = Истина;
	
	ИменаПараметров = СтрРазделить(
		СтрЗаменить(ПроверяемыеПараметры, " ", ""),
		",");
	
	МассивСообщений = Новый Массив;
	
	Для Каждого ИмяПараметра Из ИменаПараметров Цикл
		Если Не ПараметрыМетода.Свойство(ИмяПараметра, ЗначениеПараметра) Или Не ЗначениеЗаполнено(ЗначениеПараметра) Тогда
			РезультатПроверки = Ложь;
			МассивСообщений.Добавить(ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения( , , ИмяПараметра));
		КонецЕсли;
	КонецЦикла;
	
	Если Не РезультатПроверки Тогда
		СообщениеОбОшибке = СтрСоединить(МассивСообщений, Символы.ПС);
	КонецЕсли;
	
	Возврат РезультатПроверки;
	
КонецФункции

// Отправляет запрос на выполнение метода взаимодействия.
//
// Параметры:
//  МетодВзаимодействия - имя метода из списка методов МетодыВзаимодействия()
//  ПараметрыЗапроса - Структура - параметры выполнения запроса, подготовленные функцией ВыполнитьМетод_ХХ(),
//                                 соответствующей выбранному методу взаимодействия.
//
// Возвращаемое значение:
//  Структура - описание см. в функции НовыйЗапрос()
//
Функция СформироватьЗапрос(МетодВзаимодействия, ПараметрыЗапроса)
	Перем Ошибка, СообщениеОбОшибке;
	
	ИдентификаторМетода = ИдентификаторМетода(МетодВзаимодействия);
	
	ПараметрыЗапросаJSON = ЗначениеВJSON(ПараметрыЗапроса);
	ДвоичныеДанныеЗапроса = ПолучитьДвоичныеДанныеИзСтроки(ПараметрыЗапросаJSON);
	
	ПараметрыДоступаКХранилищу = ПараметрыДоступаКХранилищу();
	ИдентификаторХранилища = ИдентификаторХранилища();
	
	Если ПодключенСервисИнтеграции(ПараметрыДоступаКХранилищу) Тогда
		Ответ = ПередачаДанныхСервер.ОтправитьВЛогическоеХранилище(
			ПараметрыДоступаКХранилищу,
			ИдентификаторХранилища,
			ДвоичныеДанныеЗапроса,
			ИдентификаторМетода);
		
		Если Ответ = Неопределено Тогда
			Ошибка = Истина;
			СообщениеОбОшибке = НСтр("ru = 'Ошибка при отправке данных.
				|Подробности см. в журнале регистрации.'");
		Иначе
			Ошибка = Ложь;
		КонецЕсли;
	Иначе
		Ошибка = Истина;
		СообщениеОбОшибке = НСтр("ru = 'Приложение не подключено к сервису Мой налог. Обратитесь к администратору.'");
	КонецЕсли;
	
	Если Не Ошибка Тогда
		
		Запрос = НовыйЗапрос(МетодВзаимодействия);
		
		ОсновнойРаздел = Ответ[АсинхронноеПолучениеДанныхСловарь.ПолеОсновнойРаздел()];
		Запрос.Ошибка    = ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеОшибка()];
		Запрос.Сообщение = ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеСообщениеОбОшибке()];
		Запрос.КодВозврата = ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеКодВозврата()];
		
		Если ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеКодВозврата()] = АсинхронноеПолучениеДанныхСловарь.КодВозвратаВыполнено() Тогда
			Результат = Ответ[АсинхронноеПолучениеДанныхСловарь.ПолеРезультат()];
			Запрос.Идентификатор = Результат[АсинхронноеПолучениеДанныхСловарь.ПолеИдентификатор()];
			Запрос.Хранилище     = Результат[АсинхронноеПолучениеДанныхСловарь.ПолеХранилище()];
		КонецЕсли;
		
	Иначе
		Запрос = НовыйЗапрос(МетодВзаимодействия, Ошибка, СообщениеОбОшибке);
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

// Возвращает параметры необходимые для извлечения результата выполнения метода.
//
// Возвращаемое значение:
//  Структура - параметры для извлечения результата выполнения метода:
//   * МетодВзаимодействия - Строка - имя метода взаимодействия
//   * Ошибка - Булево - признак того, что метод выполнить не удалось из-за ошибки
//   * Сообщение - Строка - сообщение об ошибке
//   * КодВозврата - Число - стандартный код возврата по имени метода. см. АсинхронноеПолучениеДанныхСловарь
//   * Идентификатор - Строка - идентификатор значения в логичесокм хранилище DataTransfer
//   * Хранилище - Строка - имя логического хранилища DataTransfer
//   * ВремяОжидания - Число - периодичность опроса сервиса для подтверждения получения запроса сервисом в секундах
//   * МетодВзаимодействия - Строка - имя метода взаимодействия
//   * ДополнительныйРезультат - Булево - Истина, если результат выполнения будет помещен в дополнительное временное хранилище
//
Функция НовыйЗапрос(МетодВзаимодействия, Ошибка = Ложь, Сообщение = "") Экспорт
	
	Запрос = Новый Структура;
	Запрос.Вставить("МетодВзаимодействия", МетодВзаимодействия);
	Запрос.Вставить("Ошибка", Ошибка);
	Запрос.Вставить("Сообщение", Сообщение);
	Запрос.Вставить("КодВозврата", 0);
	Запрос.Вставить("Идентификатор", "");
	Запрос.Вставить("Хранилище", "");
	Запрос.Вставить("ВремяОжидания", ?(ПолучитьСкоростьКлиентскогоСоединения() = СкоростьКлиентскогоСоединения.Низкая, 4, 0.8)); // В секундах
	Запрос.Вставить("ДополнительныйРезультат", Ложь);
	
	Возврат Запрос;
	
КонецФункции

#КонецОбласти

#Область ПроверкаВыполненияЗапроса

// Выполняет попытку получить результат выполнения метода.
// Возвращает статус выполнения запроса и его результат, если запрос выполнен.
//
// Параметры:
//  Запрос - Структура - описание см. в функции НовыйЗапрос()
//
// Возвращаемое значение:
//  Структура - описание см. в функции НовыйРезультатЗапроса()
//
Функция ПроверитьВыполнениеЗапроса(Запрос)
	Перем Ошибка, СообщениеОбОшибке;
	
	Ответ = ПолучитьИзЛогическогоХранилища(Запрос.Хранилище, Запрос.Идентификатор, , Ошибка, СообщениеОбОшибке);
	
	СтатусыЗапросов = ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов();
	
	Если Не Ошибка Тогда
		
		ОсновнойРаздел = Ответ[АсинхронноеПолучениеДанныхСловарь.ПолеОсновнойРаздел()];
		
		Ошибка = ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеОшибка()];
		Сообщение = ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеСообщениеОбОшибке()];
		
		Если Не Ошибка Тогда
			Статус = СтатусЗапроса(ОсновнойРаздел[АсинхронноеПолучениеДанныхСловарь.ПолеКодВозврата()], СтатусыЗапросов);
		Иначе
			Статус = СтатусыЗапросов.Ошибка;
		КонецЕсли;
		
		РезультатЗапроса = НовыйРезультатЗапроса(Статус, Сообщение);
		
		Если РезультатЗапроса.Статус = СтатусыЗапросов.Выполнено Или РезультатЗапроса.Статус = СтатусыЗапросов.Ошибка Тогда
			Результат = Ответ[АсинхронноеПолучениеДанныхСловарь.ПолеРезультат()];
			ХранилищеРезультата     = Результат[АсинхронноеПолучениеДанныхСловарь.ПолеХранилище()];
			ИдентификаторРезультата = Результат[АсинхронноеПолучениеДанныхСловарь.ПолеИдентификатор()];
			РезультатЗапроса.Результат = ПрочитатьРезультатВыполнения(ХранилищеРезультата, ИдентификаторРезультата, Ошибка, СообщениеОбОшибке);
			Если Ошибка Тогда
				РезультатЗапроса.Статус = СтатусыЗапросов.Ошибка;
				РезультатЗапроса.Сообщение = СообщениеОбОшибке;
			КонецЕсли;
		КонецЕсли;
		
		Если Не Ошибка И РезультатЗапроса.Статус = СтатусыЗапросов.Ошибка Тогда
			ЗаписьЖурналаРегистрации(
				ИнтеграцияСПлатформойСамозанятыеКлиентСервер.ИмяСобытияЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,,,
				ЗначениеВJSON(РезультатЗапроса.Результат));
		КонецЕсли;
		
	Иначе
		
		РезультатЗапроса = НовыйРезультатЗапроса(СтатусыЗапросов.Ошибка, СообщениеОбОшибке);
		
	КонецЕсли;
	
	Возврат РезультатЗапроса;
	
КонецФункции

// Вопомогательная функция чтения результата выполнения метода из логического хранилища DataTransfer
//
// Параметры:
//  Хранилище - Строка - имя логического хранилища DataTransfer
//  Идентификатор - Строка - идентификатор значения в логичесокм хранилище DataTransfer
//  Ошибка - Булево - признак того, что получить результат выполнения не удалось из-за ошибки (исходящий параметр)
//  Сообщение - Строка - сообщение об ошибке (исходящий параметр)
//
// Возвращаемое значение:
//   Структура - результат выполнения метода
//
Функция ПрочитатьРезультатВыполнения(Хранилище, Идентификатор, Ошибка, СообщениеОбОшибке)
	
	Перем Ключ;
	
	ПоляОтветаТипаДата = ПоляОтветаТипаДата();
	Ответ = ПолучитьИзЛогическогоХранилища(Хранилище, Идентификатор, ПоляОтветаТипаДата, Ошибка, СообщениеОбОшибке);
	
	Если Не Ошибка Тогда
		
		Результат = Новый Структура;
		СловарьОтветов = СловарьОтветов();
		Для Каждого КлючИЗначение Из Ответ Цикл
			Если СловарьОтветов.Свойство(КлючИЗначение.Ключ, Ключ) Тогда
				Значение = ОбработатьВходящиеДанные(Ключ, КлючИЗначение.Значение);
			Иначе
				Ключ = КлючИЗначение.Ключ;
				Значение = КлючИЗначение.Значение;
			КонецЕсли;
			Результат.Вставить(Ключ, Значение);
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Возвращает параметры необходимые для извлечения результата выполнения метода.
//
// Параметры:
//  Статус - Строка - один из возможных статусов запроса, перечисленных в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов()
//  Сообщение - Строка - сообщение об ошибке
//
// Возвращаемое значение:
//  Структура - параметры для извлечения результата выполнения метода:
//   * Статус - Строка - один из возможных статусов запроса, перечисленных в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов()
//   * Сообщение - Строка - сообщение об ошибке
//   * Результат - Структура - результат выполнения метода
//   * ВремяОжидания - Число - периодичность опроса сервиса для получения результата выполнения метода в секундах
//
Функция НовыйРезультатЗапроса(Статус, Сообщение = "") Экспорт
	
	РезультатЗапроса = Новый Структура;
	РезультатЗапроса.Вставить("Статус", Статус);
	РезультатЗапроса.Вставить("Сообщение", Сообщение);
	РезультатЗапроса.Вставить("Результат", Неопределено);
	РезультатЗапроса.Вставить("ВремяОжидания", ?(ПолучитьСкоростьКлиентскогоСоединения() = СкоростьКлиентскогоСоединения.Низкая, 4, 0.8)); // В секундах
	
	Возврат РезультатЗапроса;
	
КонецФункции

// Преобразует код состояния в статус запроса
//
// Параметры:
//  КодВозврата - Число - код возврата, возвращаемый очередью заданий DataTransfer
//  СтатусыЗапросов - перечисление статусов запросов, возвращаемое функцией ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов()
//
// Возвращаемое значение:
//  Строка - один из возможных статусов запроса, перечисленных в функции ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов()
//
Функция СтатусЗапроса(КодВозврата, СтатусыЗапросов = Неопределено)
	
	Если СтатусыЗапросов = Неопределено Тогда
		СтатусыЗапросов = ИнтеграцияСПлатформойСамозанятыеКлиентСервер.СтатусыЗапросов();
	КонецЕсли;
	
	Если КодВозврата = ОчередьЗаданийВнешнийИнтерфейсСловарь.КодСостоянияВыполнено() Тогда
		Статус = СтатусыЗапросов.Выполнено;
	ИначеЕсли КодВозврата = ОчередьЗаданийВнешнийИнтерфейсСловарь.КодСостоянияОжидание() Тогда
		Статус = СтатусыЗапросов.Выполняется;
	Иначе
		Статус = СтатусыЗапросов.Ошибка;
	КонецЕсли;
	
	Возврат Статус;
	
КонецФункции

#КонецОбласти

#Область ОбработкаВходящихДанных

// Дополнительная обработка данных, возвращенных сервисом.
//
// Параметры:
//  Ключ - Строка - ключ значения
//  Значение - Произвольный - значение
//
Функция ОбработатьВходящиеДанные(Ключ, Значение)
	
	Если Ключ = "Результат" Тогда
		Возврат ОбработатьВходящиеДанные_Результат(Значение);
	ИначеЕсли Ключ = "Разрешения" Тогда
		Возврат ОбработатьВходящиеДанные_Разрешения(Значение);
	ИначеЕсли Ключ = "СписокЧеков" Тогда
		Возврат ОбработатьВходящиеДанные_СписокЧеков(Значение);
	ИначеЕсли Ключ = "СписокКвитанций" Тогда
		Возврат ОбработатьВходящиеДанные_СписокКвитанций(Значение);
	ИначеЕсли Ключ = "Код" Тогда
		Возврат ОбработатьВходящиеДанные_Код(Значение);
	ИначеЕсли СтрНачинаетсяС(НРег(Ключ), ПрефиксДатНРег()) Тогда
		// Сервис возвращает время без учета часового пояса. Преобразуем к часовому поясу сеанса.
		Возврат МестноеВремя(Значение, ЧасовойПоясСеанса());
	Иначе
		Возврат Значение;
	КонецЕсли;
	
КонецФункции

Функция ОбработатьВходящиеДанные_Результат(Результат)
	Перем Значение;
	
	Если ЗначениеЗаполнено(Результат) Тогда
		Словарь = СловарьРезультатовВыполненияМетода();
		Если Не Словарь.Свойство(Результат, Значение) Тогда
			Значение = Результат;
		КонецЕсли;
	Иначе
		Значение = Результат;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

Функция ОбработатьВходящиеДанные_Разрешения(Разрешения)
	
	Значение = Новый Структура;
	
	Если ТипЗнч(Разрешения) = Тип("Массив") Тогда
		ПереченьРазрешений = ПереченьРазрешенийНаДействияПартнеромОтИмениНП();
		Для Каждого Разрешение Из ПереченьРазрешений Цикл
			Значение.Вставить(Разрешение.Код, ?(Разрешения.Найти(Разрешение.Идентификатор) <> Неопределено, Истина, Ложь));
		КонецЦикла;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

Функция ОбработатьВходящиеДанные_Код(Результат)
	Перем Значение;
	
	Если ЗначениеЗаполнено(Результат) Тогда
		Словарь = СловарьКодовОшибок();
		Если Не Словарь.Свойство(Результат, Значение) Тогда
			Значение = Результат;
		КонецЕсли;
	Иначе
		Значение = Результат;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

Функция ОбработатьВходящиеДанные_СписокЧеков(СписокДокументов)
	
	ТаблицаДокументов = НовыйСписокЧеков();
	
	Если ТипЗнч(СписокДокументов) = Тип("Массив") Тогда
		ОбработатьВходящиеДанные_СписокДокументов(СписокДокументов, РеквизитыЧека(), ТаблицаДокументов);
	КонецЕсли;
	
	Возврат ТаблицаДокументов;
	
КонецФункции

Функция ОбработатьВходящиеДанные_СписокКвитанций(СписокДокументов)
	
	ТаблицаДокументов = НовыйСписокКвитанций();
	
	Если ТипЗнч(СписокДокументов) = Тип("Массив") Тогда
		ОбработатьВходящиеДанные_СписокДокументов(СписокДокументов, РеквизитыКвитанции(), ТаблицаДокументов);
	КонецЕсли;
	
	Возврат ТаблицаДокументов;
	
КонецФункции

Процедура ОбработатьВходящиеДанные_СписокДокументов(СписокДокументов, СтуктураРеквизитов, ТаблицаДокументов)
	
	Перем Значение;
	
	ТаблицаДокументов.Очистить();
	
	ПрефиксДатНРег = ПрефиксДатНРег();
	
	Для Каждого Документ Из СписокДокументов Цикл
		НоваяСтрока = ТаблицаДокументов.Добавить();
		Для Каждого КлючИЗначение Из СтуктураРеквизитов Цикл
			Документ.Свойство(КлючИЗначение.Ключ, Значение);
			Если СтрНачинаетсяС(НРег(КлючИЗначение.Значение), ПрефиксДатНРег) Тогда
				Значение = МестноеВремя(Значение, ЧасовойПоясСеанса());
			КонецЕсли;
			НоваяСтрока[КлючИЗначение.Значение] = Значение;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбщиеПроцедурыФункции

Функция ПолучитьИзЛогическогоХранилища(Хранилище, Идентификатор, ИменаСвойствСоЗначениямиДата = Неопределено, Ошибка, СообщениеОбОшибке)
	
	Ошибка = Ложь;
	
	ПараметрыДоступаКХранилищу = ПараметрыДоступаКХранилищу();
	
	Ответ = ПередачаДанныхСервер.ПолучитьИзЛогическогоХранилища(
		ПараметрыДоступаКХранилищу,
		Хранилище,
		Идентификатор);
	Если Ответ = Неопределено Тогда

		Ошибка = Истина;
		СообщениеОбОшибке = НСтр("ru = 'Ошибка при получении данных.
			|Подробности см. в журнале регистрации.'");
	КонецЕсли;
	
	Если Не Ошибка Тогда
		ФайлОтвета = Новый Файл(Ответ.ПолноеИмя);
		ПолученФайлОтвета = ФайлОтвета.Существует();
		Если Не ПолученФайлОтвета Тогда
			Ошибка = Истина;
			СообщениеОбОшибке = СтрШаблон(НСтр("ru = 'Не найден файл, содержащий результата запроса %1.'"), Идентификатор);
		КонецЕсли;
	Иначе
		ПолученФайлОтвета = Ложь;
	КонецЕсли;
	
	Если ПолученФайлОтвета Тогда
		
		Попытка
			Результат = ЗначениеИзJSON(ФайлОтвета.ПолноеИмя, ИменаСвойствСоЗначениямиДата);
		Исключение
			ЗаписьЖурналаРегистрации(ИнтеграцияСПлатформойСамозанятыеКлиентСервер.ИмяСобытияЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,,,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			Ошибка = Истина;
			СообщениеОбОшибке = НСтр("ru = 'Не удалось прочитать ответ сервиса.
				|Подробности см. в журнале регистрации.'");
		КонецПопытки;
		
		Попытка
			УдалитьФайлы(ФайлОтвета.ПолноеИмя);
		Исключение
			ЗаписьЖурналаРегистрации(
				ИнтеграцияСПлатформойСамозанятыеКлиентСервер.ИмяСобытияЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,,,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ЗначениеВJSON(Значение)
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Значение);
	
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции

Функция ЗначениеИзJSON(ИмяФайла, ИменаСвойствСоЗначениямиДата = Неопределено)
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.ОткрытьФайл(ИмяФайла);
	Значение = ПрочитатьJSON(ЧтениеJSON, , ИменаСвойствСоЗначениямиДата);
	ЧтениеJSON.Закрыть();
	
	Возврат Значение;
	
КонецФункции

// Возвращает список полей, возвращаемых сервисом, имеющим тип дата.
// Используется для десереализации дат из JSON.
//
// Возвращаемое значение:
//  Массив - массив имен
//
Функция ПоляОтветаТипаДата()
	
	СписокПолей = Новый Массив;
	
	ПрефиксДатНРег = ПрефиксДатНРег();
	
	Для Каждого КлючИЗначение Из СловарьОтветов() Цикл
		Если СтрНачинаетсяС(НРег(КлючИЗначение.Значение), ПрефиксДатНРег) Тогда
			СписокПолей.Добавить(КлючИЗначение.Ключ);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого КлючИЗначение Из РеквизитыКвитанции() Цикл
		Если СтрНачинаетсяС(НРег(КлючИЗначение.Значение), ПрефиксДатНРег) Тогда
			СписокПолей.Добавить(КлючИЗначение.Ключ);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого КлючИЗначение Из РеквизитыЧека() Цикл
		Если СтрНачинаетсяС(НРег(КлючИЗначение.Значение), ПрефиксДатНРег) Тогда
			СписокПолей.Добавить(КлючИЗначение.Ключ);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СписокПолей;
	
КонецФункции

Функция ПрефиксДатНРег()
	
	Возврат "дата";
	
КонецФункции

Функция КоличествоПовторовОтправкиЗапросаНаПривязку()
	
	Возврат 15; // 120 секунд в арифметической прогрессии
	
КонецФункции

Функция ИдентификаторПриложения(Организация)
	Возврат РегистрыСведений.СостоянияИнтеграцииСПлатформойСамозанятые.ИдентификаторПриложения(Организация);
КонецФункции

#КонецОбласти

#Область МетодыВзаимодействия

Функция ИдентификаторМетода(Код)
	
	МетодыВзаимодействия = МетодыВзаимодействия();
	НайденнаяСтрока  = МетодыВзаимодействия.Найти(Код, "Код");
	Если НайденнаяСтрока  = Неопределено Тогда
		ВызватьИсключение СтрШаблон("ИнтеграцияСПлатформойСамозанятые.ИдентификаторМетода: метод %1 не определен", Код);
	КонецЕсли;
	
	Возврат НайденнаяСтрока.Идентификатор;
	
КонецФункции

Функция НоваяТаблицаМетодовВзаимодействия()
	
	МетодыВзаимодействия = Новый ТаблицаЗначений;
	МетодыВзаимодействия.Колонки.Добавить("Код", ОбщегоНазначения.ОписаниеТипаСтрока(50));
	МетодыВзаимодействия.Колонки.Добавить("Наименование", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	МетодыВзаимодействия.Колонки.Добавить("Идентификатор", ОбщегоНазначения.ОписаниеТипаСтрока(50));
	
	Возврат МетодыВзаимодействия;
	
КонецФункции

Функция ДобавитьНовыйМетодВзаимодействия(Код, Наименование, Идентификатор, МетодыВзаимодействия)
	
	НовыйМетодВзаимодействия = МетодыВзаимодействия.Добавить();
	НовыйМетодВзаимодействия.Код = Код;
	НовыйМетодВзаимодействия.Наименование = Наименование;
	НовыйМетодВзаимодействия.Идентификатор = Идентификатор;
	
	Возврат НовыйМетодВзаимодействия;
	
КонецФункции

#КонецОбласти

#Область ПереченьРазрешений

Функция НоваяТаблицаРазрешений()
	
	ПереченьРазрешений = Новый ТаблицаЗначений;
	ПереченьРазрешений.Колонки.Добавить("Код", ОбщегоНазначения.ОписаниеТипаСтрока(50));
	ПереченьРазрешений.Колонки.Добавить("Наименование", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	ПереченьРазрешений.Колонки.Добавить("Идентификатор", ОбщегоНазначения.ОписаниеТипаСтрока(50));
	
	Возврат ПереченьРазрешений;
	
КонецФункции

Функция ДобавитьНовоеРазрешение(Код, Наименование, Идентификатор, ПереченьРазрешений)
	
	НовоеРазрешение = ПереченьРазрешений.Добавить();
	НовоеРазрешение.Код = Код;
	НовоеРазрешение.Наименование = Наименование;
	НовоеРазрешение.Идентификатор = Идентификатор;
	
	Возврат НовоеРазрешение;
	
КонецФункции

#КонецОбласти

#Область ОписаниеСервисаИнтеграции

Функция ПараметрыДоступаКХранилищу()
	
	ПараметрыДоступаКХранилищу = Новый Структура;
	ПараметрыДоступаКХранилищу.Вставить("URL", АдресСервисаИнтеграции());
	ПараметрыДоступаКХранилищу.Вставить("UserName", ИмяСлужебногоПользователяСервисаИнтеграции());
	ПараметрыДоступаКХранилищу.Вставить("Password", ПарольСлужебногоПользователяСервисаИнтеграции());
	
	Возврат ПараметрыДоступаКХранилищу;
	
КонецФункции

Функция АдресСервисаИнтеграции()
	
	Возврат Константы.АдресСервисаИнтеграцииСПлатформойСамозанятые.Получить();
	
КонецФункции

Функция ВладелецДанныхСлужебногоПользователя()
	
	Возврат ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Константа.АдресСервисаИнтеграцииСПлатформойСамозанятые");
	
КонецФункции

Функция ИмяСлужебногоПользователяСервисаИнтеграции()
	
	УстановитьПривилегированныйРежим(Истина);
	ИмяСлужебногоПользователя = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(
		ВладелецДанныхСлужебногоПользователя(), КлючДанныхИмяСлужебногоПользователя());
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ИмяСлужебногоПользователя;
	
КонецФункции

Функция КлючДанныхИмяСлужебногоПользователя()
	
	Возврат "ИмяСлужебногоПользователяСервисаИнтеграцииСПлатформойСамозанятые";
	
КонецФункции

Функция ПарольСлужебногоПользователяСервисаИнтеграции()
	
	УстановитьПривилегированныйРежим(Истина);
	ПарольСлужебногоПользователя = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(
		ВладелецДанныхСлужебногоПользователя(), КлючДанныхПарольСлужебногоПользователя());
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ПарольСлужебногоПользователя;
	
КонецФункции

Функция КлючДанныхПарольСлужебногоПользователя()
	
	Возврат "ПарольСлужебногоПользователяСервисаИнтеграцииСПлатформойСамозанятые"
	
КонецФункции

// Идентификатор логического хранилища DataTransfer
//
Функция ИдентификаторХранилища()
	
	Возврат "async";
	
КонецФункции

Функция ПараметрыМетодов()
	
	ПараметрыМетодов = Новый Структура;
	
	// Общие
	ПараметрыМетодов.Вставить("ИдентификаторПриложения", "app_id");
	
	// Заявка
	ПараметрыМетодов.Вставить("НомерТелефона", "phone");
	ПараметрыМетодов.Вставить("КодПодтверждения", "code");
	ПараметрыМетодов.Вставить("Идентификатор", "id");
	
	// Организация, Контрагент
	ПараметрыМетодов.Вставить("ИНН", "inn");
	ПараметрыМетодов.Вставить("Наименование", "name");
	
	// Тип дохода
	ПараметрыМетодов.Вставить("ТипДохода", "income_type");
	
	// Период
	ПараметрыМетодов.Вставить("НалоговыйПериод", "tax_period");
	ПараметрыМетодов.Вставить("НачалоПериода", "from");
	ПараметрыМетодов.Вставить("КонецПериода", "to");
	
	// Чек
	ПараметрыМетодов.Вставить("УИДЧека", "guid");
	ПараметрыМетодов.Вставить("НомерЧека", "document_number");
	ПараметрыМетодов.Вставить("ИдентификаторЧека", "receipt_id");
	ПараметрыМетодов.Вставить("ПричинаОтменыЧека", "message");
	ПараметрыМетодов.Вставить("ДатаРасчета", "operation_time");
	ПараметрыМетодов.Вставить("ДатаФормирования", "request_time");
	ПараметрыМетодов.Вставить("Контрагент", "customer");
	ПараметрыМетодов.Вставить("СуммаДокумента", "total_amount");
	
	// Чек.Услуги
	ПараметрыМетодов.Вставить("Услуги", "services");
	ПараметрыМетодов.Вставить("Услуги_Наименование", "name");
	ПараметрыМетодов.Вставить("Услуги_Количество", "quantity");
	ПараметрыМетодов.Вставить("Услуги_Цена", "amount");
	
	Возврат ПараметрыМетодов;
	
КонецФункции

Функция СловарьОтветов()
	
	СловарьОтветов = Новый Структура;
	СловарьОтветов.Вставить("app_id", "ИдентификаторПриложения");
	СловарьОтветов.Вставить("verification_id",       "ИдентификаторКодаПодтверждения");
	СловарьОтветов.Вставить("verification_created",  "ДатаСозданияКодаПодтверждения");
	СловарьОтветов.Вставить("verification_update",   "ДатаОбновленияКодаПодтверждения");
	СловарьОтветов.Вставить("verification_duration", "ДатаСрокаДействияКодаПодтверждения");
	СловарьОтветов.Вставить("id", "Идентификатор");
	СловарьОтветов.Вставить("result", "Результат");
	СловарьОтветов.Вставить("processing_time", "ДатаРассмотренияЗаявки");
	СловарьОтветов.Вставить("unbind_time", "ДатаОтвязки");
	СловарьОтветов.Вставить("permissions", "Разрешения");
	СловарьОтветов.Вставить("bonus_amount", "СуммаБонусногоСчета");
	СловарьОтветов.Вставить("unpaid_amount", "ОбщаяСуммаНеоплаченныхПлатежей");
	СловарьОтветов.Вставить("debt_amount", "СуммаЗадолженности");
	СловарьОтветов.Вставить("total_amount", "ОбщаяСуммаДоходов");
	СловарьОтветов.Вставить("canceled_total_amount", "ОбщаяСуммаВозвратов");
	СловарьОтветов.Вставить("tax", "СуммаНалога");
	СловарьОтветов.Вставить("invoices", "СписокКвитанций");
	СловарьОтветов.Вставить("receipts", "СписокЧеков");
	СловарьОтветов.Вставить("receipt_id", "ИдентификаторЧека");
	СловарьОтветов.Вставить("link", "Ссылка");
	СловарьОтветов.Вставить("mimetype", "ТипДанных");
	СловарьОтветов.Вставить("filename", "ИмяФайла");
	СловарьОтветов.Вставить("content", "Base64Строка");
	СловарьОтветов.Вставить("is_offline", "ЧекOffLine");
	
	СловарьОтветов.Вставить("code", "Код");
	СловарьОтветов.Вставить("details", "Подробности");
	СловарьОтветов.Вставить("message", "Сообщение");
	
	СловарьОтветов.Вставить("inn", "ИНН");
	СловарьОтветов.Вставить("second_name", "Фамилия");
	СловарьОтветов.Вставить("first_name", "Имя");
	СловарьОтветов.Вставить("patronymic", "Отчество");
	
	СловарьОтветов.Вставить("registration_time", "ДатаПостановкиНаУчет");
	СловарьОтветов.Вставить("unregistration_time", "ДатаСнятияСУчета");
	СловарьОтветов.Вставить("unregistration_reason", "ПричинаСнятияСУчета");
	
	СловарьОтветов.Вставить("activities", "ВидыДеятельности");
	СловарьОтветов.Вставить("region", "Регион");
	СловарьОтветов.Вставить("phone", "НомерТелефона");
	СловарьОтветов.Вставить("email", "Email");
	СловарьОтветов.Вставить("account_number", "НомерСчетаУплатыНалога");
	СловарьОтветов.Вставить("update_time", "ДатаОбновленияДанных");
	СловарьОтветов.Вставить("registration_certificate_number", "НомерСвидетельства");
	
	Возврат СловарьОтветов;
	
КонецФункции

Функция СловарьРезультатовВыполненияМетода()
	
	Результаты = Новый Структура;
	Результаты.Вставить("COMPLETED", "Выполнено");
	Результаты.Вставить("FAILED", "Ошибка");
	Результаты.Вставить("IN_PROGRESS", "Выполняется");
	Результаты.Вставить("DELETED", "Удалено");
	
	Возврат Результаты;
	
КонецФункции

Функция СловарьКодовОшибок()
	
	Результаты = Новый Структура;
	Результаты.Вставить("INTERNAL_ERROR", "ВнутренняяОшибкаСервиса");
	Результаты.Вставить("REQUEST_VALIDATION_ERROR", "ОшибкаПарсингаЗапроса");
	Результаты.Вставить("TAXPAYER_UNREGISTERED", "НалогоплательщикНеЗарегистрирован");
	Результаты.Вставить("TAXPAYER_UNBOUND", "НалогоплательщикНеПривязан");
	Результаты.Вставить("TAXPAYER_ALREADY_BOUND", "НалогоплательщикУжеПривязан");
	Результаты.Вставить("PARTNER_DENY", "НедостаточноПолномочий");
	Результаты.Вставить("DUPLICATE", "ДоходУжеЗарегистрирован");
	Результаты.Вставить("PERMISSION_NOT_GRANTED", "НедостаточноПолномочийДляОперации");
	Результаты.Вставить("RECEPT_ID_NOT_FOUND", "ЧекНеНайден");
	Результаты.Вставить("INVALID_HASH", "НекорректныйФискальныйПризнак");
	Результаты.Вставить("INVALID_SEQUENCE", "НевалидныйНомерПоследовательности");
	
	Возврат Результаты;
	
КонецФункции

Функция СловарьТиповДохода()
	
	ТипыДоходов = Новый Структура;
	ТипыДоходов.Вставить("ИностраннаяОрганизация", "FROM_FOREIGN_AGENCY");
	ТипыДоходов.Вставить("РоссийскаяОрганизация",  "FROM_LEGAL_ENTITY");
	ТипыДоходов.Вставить("ФизическоеЛицо",         "FROM_INDIVIDUAL");
	
	Возврат ТипыДоходов;

КонецФункции

#Область СписокЧеков

Функция НовыйСписокЧеков()
	
	СписокЧеков = Новый ТаблицаЗначений;
	СписокЧеков.Колонки.Добавить("ИдентификаторЧека", ОбщегоНазначения.ОписаниеТипаСтрока(50));
	СписокЧеков.Колонки.Добавить("Ссылка", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	СписокЧеков.Колонки.Добавить("СуммаДокумента", ОбщегоНазначения.ОписаниеТипаЧисло(15, 2));
	СписокЧеков.Колонки.Добавить("ДатаФормирования", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.ДатаВремя));
	СписокЧеков.Колонки.Добавить("ДатаРасчета", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.ДатаВремя));
	СписокЧеков.Колонки.Добавить("ЧекОтменен", Новый ОписаниеТипов("Булево"));
	СписокЧеков.Колонки.Добавить("ДатаОтмены", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.ДатаВремя));
	
	Возврат СписокЧеков;
	
КонецФункции

Функция РеквизитыЧека()
	
	Реквизиты = Новый Структура;
	Реквизиты.Вставить("receipt_id", "ИдентификаторЧека");
	Реквизиты.Вставить("link", "Ссылка");
	Реквизиты.Вставить("total_amount", "СуммаДокумента");
	Реквизиты.Вставить("operation_time", "ДатаРасчета");
	Реквизиты.Вставить("request_time", "ДатаФормирования");
	Реквизиты.Вставить("canceled", "ЧекОтменен");
	Реквизиты.Вставить("cancelation_time", "ДатаОтмены");
	
	Возврат Реквизиты;
	
КонецФункции

#КонецОбласти

#Область СписокКвитанций

Функция НовыйСписокКвитанций()
	
	СписокЧеков = Новый ТаблицаЗначений;
	
	СписокЧеков.Колонки.Добавить("ИдентификаторПлатежа", ОбщегоНазначения.ОписаниеТипаСтрока(25)); // 22
	СписокЧеков.Колонки.Добавить("СтатусПлательщика", ОбщегоНазначения.ОписаниеТипаСтрока(2)); // 101
	СписокЧеков.Колонки.Добавить("КБК", ОбщегоНазначения.ОписаниеТипаСтрока(20)); // 104
	СписокЧеков.Колонки.Добавить("КодТерритории", ОбщегоНазначения.ОписаниеТипаСтрока(11)); // 105
	СписокЧеков.Колонки.Добавить("ОснованиеПлатежа", ОбщегоНазначения.ОписаниеТипаСтрока(2)); // 106
	СписокЧеков.Колонки.Добавить("ПоказательПериода", ОбщегоНазначения.ОписаниеТипаСтрока(10)); // 107
	СписокЧеков.Колонки.Добавить("ТипПлатежа", ОбщегоНазначения.ОписаниеТипаСтрока(1)); // 110
	СписокЧеков.Колонки.Добавить("ДатаОплаты", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.Дата));
	
	СписокЧеков.Колонки.Добавить("ИНН", ОбщегоНазначения.ОписаниеТипаСтрока(12));
	СписокЧеков.Колонки.Добавить("Плательщик", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	СписокЧеков.Колонки.Добавить("АдресМестаЖительства", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	
	СписокЧеков.Колонки.Добавить("Банк", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	СписокЧеков.Колонки.Добавить("БИК", ОбщегоНазначения.ОписаниеТипаСтрока(9));
	СписокЧеков.Колонки.Добавить("КоррСчет", ОбщегоНазначения.ОписаниеТипаСтрока(20));
	СписокЧеков.Колонки.Добавить("Получатель", ОбщегоНазначения.ОписаниеТипаСтрока(250));
	СписокЧеков.Колонки.Добавить("СчетПолучателя", ОбщегоНазначения.ОписаниеТипаСтрока(20));
	СписокЧеков.Колонки.Добавить("ИННПолучателя", ОбщегоНазначения.ОписаниеТипаСтрока(10));
	СписокЧеков.Колонки.Добавить("КПППолучателя", ОбщегоНазначения.ОписаниеТипаСтрока(9));
	
	СписокЧеков.Колонки.Добавить("Сумма", ОбщегоНазначения.ОписаниеТипаЧисло(15, 2));
	
	Возврат СписокЧеков;
	
КонецФункции

Функция РеквизитыКвитанции()
	
	Реквизиты = Новый Структура;
	Реквизиты.Вставить("document_index", "ИдентификаторПлатежа"); // УИН
	Реквизиты.Вставить("code_101", "СтатусПлательщика");
	Реквизиты.Вставить("kbk", "КБК");
	Реквизиты.Вставить("oktmo", "КодТерритории");
	Реквизиты.Вставить("code_106", "ОснованиеПлатежа");
	Реквизиты.Вставить("code_107", "ПоказательПериода");
	Реквизиты.Вставить("code_110", "ТипПлатежа");
	Реквизиты.Вставить("due_date", "ДатаОплаты");
	
	Реквизиты.Вставить("inn", "ИНН");
	Реквизиты.Вставить("full_name", "Плательщик");
	Реквизиты.Вставить("address", "АдресМестаЖительства");
	
	Реквизиты.Вставить("recipient_bank_name", "Банк");
	Реквизиты.Вставить("recipient_bank_bik", "БИК");
	Реквизиты.Вставить("recipient_bank_account_number", "КоррСчет");
	Реквизиты.Вставить("recipient", "Получатель");
	Реквизиты.Вставить("recipient_account_number", "СчетПолучателя");
	Реквизиты.Вставить("recipient_inn", "ИННПолучателя");
	Реквизиты.Вставить("recipient_kpp", "КПППолучателя");
	
	Реквизиты.Вставить("amount", "Сумма");
	
	Возврат Реквизиты;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПодключениеПриложенияКСервисуИнтеграции

Функция ХешКодаПодтверждения(ИдентификаторЗапроса, КодПодтверждения)
	
	ХешированиеДанных = Новый ХешированиеДанных(ХешФункция.SHA256);
	ХешированиеДанных.Добавить(ИдентификаторЗапроса);
	ХешированиеДанных.Добавить(КодПодтверждения);
	
	Возврат Base64Строка(ХешированиеДанных.ХешСумма);
	
КонецФункции

Функция ПодключенСервисИнтеграции(ПараметрыДоступаКСервису = Неопределено)
	
	Если Не АктивироватьПромокодСервисаИнтеграции() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПараметрыДоступаКСервису = Неопределено Тогда
		ПараметрыДоступаКСервису = ПараметрыДоступаКХранилищу();
	КонецЕсли;
	
	Возврат ЗначениеЗаполнено(ПараметрыДоступаКСервису.URL);
	
КонецФункции

Функция ПодключитьПриложениеКСервисуИнтеграции() Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Ошибка", Ложь);
	Результат.Вставить("СообщениеОбОшибке", "");
	
	Если АктивироватьПромокодСервисаИнтеграции() Тогда
		
		Попытка
			
			ПриложениеИнтеграции = ПриложениеСервисаИнтеграции();
			
			Если Не ЗначениеЗаполнено(ИмяСлужебногоПользователяСервисаИнтеграции()) Тогда
				СоздатьСлужебногоПользователяИнтеграции();
			КонецЕсли;
			
			ДобавитьСлужебногоПользователяВПриложениеСервисаИнтеграции(ПриложениеИнтеграции.Код);
			
			Константы.АдресСервисаИнтеграцииСПлатформойСамозанятые.Установить(ПриложениеИнтеграции.Адрес);
			
		Исключение
			
			Результат.Ошибка = Истина;
			Результат.СообщениеОбОшибке = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось подключить приложение к сервису Мой налог по причине:
						   |%1'"),
				ИнформацияОбОшибке().Описание);
			
			ЗаписьЖурналаРегистрации(
				ИнтеграцияСПлатформойСамозанятыеКлиентСервер.ИмяСобытияЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,,,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
		КонецПопытки;
	Иначе
		Результат.Ошибка = Истина;
		Результат.СообщениеОбОшибке = НСтр("ru = 'Сервис Мой налог недоступен'");
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПриложениеСервисаИнтеграции()
	
	ОписаниеПриложения = Новый Структура;
	ОписаниеПриложения.Вставить("Адрес", "");
	ОписаниеПриложения.Вставить("Код", 0);
	
	ВсеПриложения = ПрограммныйИнтерфейсСервиса.Приложения();
	ВсеПриложения.Сортировать("Код");
	
	Отбор = Новый Структура("КодАбонентаВладельца", ПрограммныйИнтерфейсСервиса.АбонентЭтогоПриложения().Код);
	ПриложенияЭтогоАбонента = ВсеПриложения.НайтиСтроки(Отбор);
	
	ПриложениеИнтеграции = Неопределено;
	ИсключаемыеСтатусыПриложений = ИсключаемыеСтатусыПриложений();
	Для Каждого Приложение Из ПриложенияЭтогоАбонента Цикл
		Если Приложение.КодКонфигурации = КодКонфигурацииСервисаИнтеграции()
			И ИсключаемыеСтатусыПриложений.Найти(Приложение.СостояниеПриложения) = Неопределено Тогда
			ПриложениеИнтеграции = Приложение;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ПриложениеИнтеграции <> Неопределено Тогда
		ОписаниеПриложения.Адрес = ПриложениеИнтеграции.АдресПриложения;
		ОписаниеПриложения.Код = ПриложениеИнтеграции.Код;
	Иначе
		НовоеПриложение = СоздатьНовоеПриложениеСервисаИнтеграции();
		
		ОписаниеПриложения.Адрес = НовоеПриложение.АдресПриложения;
		ОписаниеПриложения.Код = НовоеПриложение.Код;
	КонецЕсли;
	
	Возврат ОписаниеПриложения;
	
КонецФункции

Функция СоздатьНовоеПриложениеСервисаИнтеграции()
	
	ОписаниеПриложения = Новый Структура;
	ОписаниеПриложения.Вставить("АдресПриложения", "");
	ОписаниеПриложения.Вставить("Код", 0);
	
	ПараметрыСозданияПриложения = ПрограммныйИнтерфейсСервиса.НовыйПараметрыСозданияПриложения();
	ПараметрыСозданияПриложения.КодКонфигурации = КодКонфигурацииСервисаИнтеграции();
	
	НовоеПриложение = ПрограммныйИнтерфейсСервиса.СоздатьПриложение(ПараметрыСозданияПриложения);
	
	Для Повтор = 1 По КоличествоПовторовОжиданияПодготовкиПриложения() Цикл
		СвойстваПриложения = ПрограммныйИнтерфейсСервиса.СвойстваПриложения(НовоеПриложение.Код);
		Если СвойстваПриложения.СостояниеПриложения = Перечисления.СостоянияПриложений.Используется Тогда
			Прервать;
		Иначе
			ОбщегоНазначенияБТС.Пауза(Повтор);
		КонецЕсли;
	КонецЦикла;
	
	Если СвойстваПриложения.СостояниеПриложения = Перечисления.СостоянияПриложений.Используется Тогда
		ОписаниеПриложения.АдресПриложения = НовоеПриложение.АдресПриложения;
		ОписаниеПриложения.Код = НовоеПриложение.Код;
	Иначе
		// Что-то пошло не так и менеджер сервиса не подготовил область данных.
		ВызватьИсключение НСтр("ru = 'Превышено время ожидания подготовки нового приложения сервиса Мой налог'");
	КонецЕсли;
	
	Возврат ОписаниеПриложения;
	
КонецФункции

Функция КоличествоПовторовОжиданияПодготовкиПриложения()
	Возврат 15; // 120 секунд в арифметической прогрессии
КонецФункции

Процедура СоздатьСлужебногоПользователяИнтеграции()
	
	СлужебныйПользователь = НовыйОписаниеСлужебногоПользователя();
	ПрограммныйИнтерфейсСервиса.СоздатьПользователяАбонента(СлужебныйПользователь);
	
	УстановитьПривилегированныйРежим(Истина);
	Владелец = ВладелецДанныхСлужебногоПользователя();
	ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(Владелец, СлужебныйПользователь.Логин, КлючДанныхИмяСлужебногоПользователя());
	ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(Владелец, СлужебныйПользователь.Пароль, КлючДанныхПарольСлужебногоПользователя());
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

Процедура ДобавитьСлужебногоПользователяВПриложениеСервисаИнтеграции(КодПриложения)
	
	ПараметрыДобавления = ПрограммныйИнтерфейсСервиса.НовыйПараметрыДобавленияПользователяВПриложение();
	ПараметрыДобавления.КодПриложения = КодПриложения;
	ПараметрыДобавления.Логин = ИмяСлужебногоПользователяСервисаИнтеграции();
	ПараметрыДобавления.Право = Перечисления.ПраваПользователяПриложения.ДоступКAPI;
	ПрограммныйИнтерфейсСервиса.ДобавитьПользователяВПриложение(ПараметрыДобавления);
	
КонецПроцедуры

Функция КодКонфигурацииСервисаИнтеграции()
	
	Возврат "npd";
	
КонецФункции

Функция ИсключаемыеСтатусыПриложений()
	
	Статусы = Новый Массив;
	Статусы.Добавить(Перечисления.СостоянияПриложений.КУдалению);
	Статусы.Добавить(Перечисления.СостоянияПриложений.Отсутствует);
	Статусы.Добавить(Перечисления.СостоянияПриложений.ОшибкаПодготовки);
	Статусы.Добавить(Перечисления.СостоянияПриложений.ИмпортИзФайла);
	Статусы.Добавить(Перечисления.СостоянияПриложений.Удалена);
	
	Возврат Статусы;
	
КонецФункции

Функция НовыйОписаниеСлужебногоПользователя()
	
	НовыйПользователь = ПрограммныйИнтерфейсСервиса.НовыйПараметрыСозданияПользователя();
	НовыйПользователь.Логин = НовыйЛогинСлужебногоПользователя();
	НовыйПользователь.ПолноеИмя = НовыйПользователь.Логин;
	НовыйПользователь.Пароль = ПользователиБП.СоздатьПароль(16, Истина);
	НовыйПользователь.ПочтаОбязательна = Ложь;
	
	Возврат НовыйПользователь;
	
КонецФункции

Функция НовыйЛогинСлужебногоПользователя()
	
	Возврат СтрШаблон("npd_integration_%1", Формат(РаботаВМоделиСервиса.ЗначениеРазделителяСеанса(), "ЧГ=0"));
	
КонецФункции

Функция ПромокодАктивацииСервисаИнтеграции()
	Возврат "npd";
КонецФункции

#КонецОбласти

#КонецОбласти