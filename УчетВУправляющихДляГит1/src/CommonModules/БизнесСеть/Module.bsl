////////////////////////////////////////////////////////////////////////////////
// Подсистема "Бизнес-сеть".
// ОбщийМодуль.БизнесСеть.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область ПодключаемыеКоманды

// Выполняет проверку наличия новых документов в сервисе, с оповещением пользователю, в случае их появления.
// Также, если был передан параметр ГруппаФормы, на форме появляется гиперссылка с уведомлением.
// При нажатии на оповещение или гиперссылку открывается форма списка входящих документов "1С:Бизнес-сеть".
//  Вызывается из обработчика события формы ПриСозданииНаСервере.
//  Обработчик см. БизнесСетьКлиент.ПодобратьДокументыИзСервиса().
//
// Параметры:
//  Форма          - УправляемаяФорма - форма списка документов, из обработчика события которой происходит вызов.
//  ВидыДокументов - Массив из Перечисление.ВидыЭД - массив перечислений типа Перечисление.ВидыЭД.
//  ГруппаФормы    - ЭлементФормы - группа формы для размещения гиперссылки. Если параметр не задан,
//                                  гиперссылка размещаться на форме не будет.
//
Процедура ПодключитьОповещениеОНовыхДокументахВСервисе(Форма, ВидыДокументов, ГруппаФормы = Неопределено) Экспорт
	
	// Добавление служебных реквизитов формы.
	НовыеРеквизитыФормы = Новый Массив;
	
	ИмяРеквизитаИспользованияПодсистемы = БизнесСетьКлиентСервер.ИмяРеквизитаИспользоватьОбменБизнесСеть();
	РеквизитИспользованияПодсистемы = Новый РеквизитФормы(ИмяРеквизитаИспользованияПодсистемы,
		Новый ОписаниеТипов("Булево"));
	НовыеРеквизитыФормы.Добавить(РеквизитИспользованияПодсистемы);
	
	ИмяРеквизитаОперации = БизнесСетьКлиентСервер.ИмяРеквизитаОперацииПодбораДокументовИзСервиса();
	РеквизитОперации = Новый РеквизитФормы(ИмяРеквизитаОперации, Новый ОписаниеТипов("Неопределено"));
	НовыеРеквизитыФормы.Добавить(РеквизитОперации);
	
	ИмяРеквизитаВидаДокумента = БизнесСетьКлиентСервер.ИмяРеквизитаВидаДокументаСервиса();
	РеквизитВидаДокумента = Новый РеквизитФормы(ИмяРеквизитаВидаДокумента,
		Новый ОписаниеТипов("СписокЗначений"));
		
	НовыеРеквизитыФормы.Добавить(РеквизитВидаДокумента);
	
	Форма.ИзменитьРеквизиты(НовыеРеквизитыФормы);
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьОбменБизнесСеть") Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого ВидДокумента Из ВидыДокументов Цикл
		Если ВидыДокументовСервиса().НайтиПоЗначению(ВидДокумента) = Неопределено Тогда
			ТекстСообщения = СтрШаблон(НСтр("ru = 'Вид документа ""%1"" не найден в сервисе ""1С:Бизнес-сеть"".'"), ВидДокумента);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
	КонецЦикла;
	
	Если ГруппаФормы <> Неопределено Тогда
		СоздатьГиперссылкуПодбораДокументовИзСервиса(Форма, ГруппаФормы);
	КонецЕсли;
	
	// Создание и запуск фонового задания для актуализации данных.
	ПараметрыОбновления = Новый Структура;
	ПараметрыОбновления.Вставить("ИдентификаторФормы", Форма.УникальныйИдентификатор);
	ПараметрыОбновления.Вставить("ВидыДокументов",     ВидыДокументов);
	
	Операция = ОбновитьИнформациюОНовыхДокументахВСервисеАсинхронно(ПараметрыОбновления);
	
	// Сохранение служебной информации в данных формы.
	Форма[ИмяРеквизитаИспользованияПодсистемы] = Истина;
	Форма[ИмяРеквизитаОперации]                = Операция;
	Форма[ИмяРеквизитаВидаДокумента].ЗагрузитьЗначения(ВидыДокументов);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

#Область ОбменДанными

// Выполнение команды сервиса.
//
// Параметры:
//   ПараметрыКоманды - Структура - параметры вызова или имя команды, см. ОписаниеПараметровКомандыСервиса.
//   Отказ - Булево - признак ошибки выполнения.
// Возврат
//   Строка, Массив, Структура - возвращаемые данные сервиса.
//
Функция ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ) Экспорт
	
	Если Не ПравоВыполненияОбменаДокументами(Неопределено, Истина) Тогда
		Отказ = Истина;
	КонецЕсли;
	
	// Проверка отказа заполнения параметров.
	Если Отказ Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Определение имени сервиса.
	ИмяСервиса = "БизнесСеть";
	Если Не ПустаяСтрока(ПараметрыКоманды.Сервис) Тогда
		ИмяСервиса = ПараметрыКоманды.Сервис;
	КонецЕсли;
	
	// Установка параметров соединения.
	ПараметрыСоединения = БизнесСетьПовтИсп.ПараметрыСоединения(ИмяСервиса);
	ПараметрыКоманды.Вставить("ИдентификаторПрограммы", ПараметрыСоединения.ИдентификаторПрограммы);
	
	// Установка времени ожидания ответа.
	Если ПараметрыКоманды.Свойство("Таймаут") И ПараметрыКоманды.Таймаут <> 0 Тогда
		Таймаут = ПараметрыКоманды.Таймаут;
	Иначе
		Таймаут = ПараметрыСоединения.Таймаут;
	КонецЕсли;
		
	// Инициализация соединения с сервисом.
	Попытка
		Соединение = Новый HTTPСоединение(ПараметрыСоединения.Сервер, ПараметрыСоединения.Порт,,,
			ПараметрыСоединения.Прокси, Таймаут, ПараметрыСоединения.ЗащищенноеСоединение);
	Исключение
		ТекстСообщения = НСтр("ru='Отсутствует соединение с сервисом 1С:Бизнес-сеть'")
			+ БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации();
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,, Отказ);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "БизнесСеть");
		Возврат Неопределено;
	КонецПопытки;

	// Установка параметров запроса.
	Запрос = Новый HTTPЗапрос(ПараметрыКоманды.Адрес);
	Запрос.Заголовки.Вставить("Content-Type", "application/json");
	
	// Получение тикета сервиса.
	Если ПараметрыСоединения.Аутентификация Тогда
		КлючТикета = ПолучитьКлючТикета(Соединение, ПараметрыСоединения, ПараметрыКоманды, Отказ);
		Если Отказ ИЛИ Не ЗначениеЗаполнено(КлючТикета) Тогда
			Возврат Неопределено;
		КонецЕсли;
		Запрос.Заголовки.Вставить("Authorization", "Bearer " + КлючТикета);
	КонецЕсли;
	
	// Установка заголовков.
	Если ПараметрыКоманды.Свойство("Заголовки") Тогда
		Для каждого ПараметрЗаголовка Из ПараметрыКоманды.Заголовки Цикл
			Запрос.Заголовки.Вставить(ПараметрЗаголовка.Ключ, ПараметрЗаголовка.Значение);
		КонецЦикла;
	КонецЕсли;
	
	// Установка данных.
	Если ЗначениеЗаполнено(ПараметрыКоманды.Данные) Тогда
		Если ТипЗнч(ПараметрыКоманды.Данные) = Тип("ДвоичныеДанные") Тогда
			Запрос.УстановитьТелоИзДвоичныхДанных(ПараметрыКоманды.Данные);
		Иначе
			Запрос.УстановитьТелоИзСтроки(ПараметрыКоманды.Данные);
		КонецЕсли;
	КонецЕсли;
	
	// Выполнение запроса HTTP к сервису.
	Попытка
		
		Если ПараметрыКоманды.Метод = "DELETE" Тогда
			Запрос.Заголовки.Вставить("Content-Length", СтрДлина(Запрос.ПолучитьТелоКакСтроку()));
		КонецЕсли;
		
		Ответ = Соединение.ВызватьHTTPМетод(ПараметрыКоманды.Метод, Запрос);
		
		КодСостояния = Ответ.КодСостояния;
		Данные = Ответ.ПолучитьТелоКакСтроку();
		Если ЗначениеЗаполнено(Данные) Тогда
			Данные = ЗначениеИзСтрокиJSON(Данные);
		КонецЕсли;
		
	Исключение
		
		Отказ = Истина;
		ТекстОшибки = НСтр("ru = 'Ошибка выполнения запроса к сервису.'");
		ПодробныйТекстОшибки = ТекстОшибки + Символы.ПС + ПараметрыКоманды.Адрес + Символы.ПС
			+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ПараметрыКоманды.Наименование,
			ПодробныйТекстОшибки, ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
		
	КонецПопытки;
	
	// Обработка результата запроса.
	Результат = ОбработатьОтветСервиса(ПараметрыКоманды, КодСостояния, Данные, Отказ);
	
	Возврат Результат;
	
КонецФункции

// Адрес соединения URL.
//
// Параметры:
//  Сервер		 - Строка - имя сервера.
//  Порт		 - Число  - порт сервера.
//  Адрес		 - Строка - адрес сервера.
//  Защищенное	 - Булево - признак защищенного соединения.
// 
// Возвращаемое значение:
//  Строка - строка соединения, например "https://1c.ru:80/trade".
//
Функция АдресСоединенияURL(Сервер, Порт, Адрес, Защищенное) Экспорт
	
	Результат = ?(Защищенное, "https://", "http://") + Сервер + ":" + Формат(Порт, "ЧГ=")
		+ ?(Лев(Адрес, 1) = "/", "", "/") + Адрес;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ОперацииСервиса

// Регистрация организаций в сервисе.
//
// Параметры:
//  СписокОрганизаций			 - Массив из ОпределяемыйТип.Организация - ссылки на организации регистрации.
//  Отказ						 - Булево - ошибка выполнения.
//  ТребуетсяОбновитьИнтерфейс	 - Булево - требуется обновление интерфейса.
//
Процедура ЗарегистрироватьОрганизации(СписокОрганизаций, Отказ, ТребуетсяОбновитьИнтерфейс = Неопределено) Экспорт
	
	Если Не ПравоНастройкиОбменаДокументами() Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	// Проверка подключения программы.
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ПользователиБизнесСеть.Пользователь КАК Пользователь
	|ИЗ
	|	РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть";
	ПользователиЗарегистрированы = Не Запрос.Выполнить().Пустой();
	
	Если Не ПользователиЗарегистрированы ИЛИ Не ОрганизацияЗарегистрирована() Тогда
		
		// Очистка сохраненных данных.
		СохранитьИдентификаторПрограммы(Неопределено, Истина);
		УдалитьТикеты();
		ПользователиЗарегистрированы = Ложь;
		
	КонецЕсли;
	
	// Проверка регистрации Абонента сервиса 1С:Бизнес-сеть.
	ПараметрыКоманды = ПараметрыКомандыПроверкаРегистрацииАбонента();
	ДанныеСервиса = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ТекущийАбонент = Неопределено;
	
	// Если абонент уже существует, то новый абонент не регистрируется.
	Если ДанныеСервиса = Неопределено
		ИЛИ ДанныеСервиса = Ложь
		ИЛИ (ПользователиЗарегистрированы = Ложь И ДанныеСервиса = Истина) Тогда
		
		// Регистрация абонента и получение его идентификатора.
		ПараметрыМетода = ПараметрыКомандыРегистрацияАбонента(ПараметрыКоманды, Отказ);
		ТекущийАбонент = ВыполнитьКомандуСервиса(ПараметрыМетода, Отказ);
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
		СохранитьИдентификаторАдминистратора(ПараметрыКоманды.АдминистраторАбонента);
		СохранитьИдентификаторПрограммы(ПараметрыКоманды.ИдентификаторПрограммы);
		
	Иначе
		// Получение списка подключенных абонентов, по-умолчанию берем первого абонента из списка.
		ПараметрыКоманды = ПараметрыКомандыПолучитьСписокАбонентов();
		ДанныеСервиса = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		Если ТипЗнч(ДанныеСервиса) = Тип("Массив") Тогда
			Если ДанныеСервиса.Количество() = 0 Тогда
				Отказ = Истина;
				ВызватьИсключение НСтр("ru = 'Абонент сервиса 1С:Бизнес-сеть не найден.'");
			Иначе
				ТекущийАбонент = ДанныеСервиса[0].id;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийАбонент = Неопределено Тогда
		ВызватьИсключение НСтр("ru = 'Отсутствуют данные об администраторе абонента.'") ;
	КонецЕсли;
	
	// Подготовка данных для регистрации.
	ТаблицаОрганизаций = Новый ТаблицаЗначений;
	ТаблицаОрганизаций.Колонки.Добавить("Ссылка");
	ТаблицаОрганизаций.Колонки.Добавить("ИНН");
	ТаблицаОрганизаций.Колонки.Добавить("КПП");
	Для каждого ЗначениеМассива Из СписокОрганизаций Цикл
		НоваяСтрока = ТаблицаОрганизаций.Добавить();
		НоваяСтрока.Ссылка = ЗначениеМассива;
	КонецЦикла;
	
	ЗаполнитьРеквизитыОрганизаций(ТаблицаОрганизаций);
	
	// Проверка организаций для регистрации.
	Для каждого СтрокаОрганизаций Из ТаблицаОрганизаций Цикл
		
		ПараметрыКоманды = ПараметрыКомандыПроверкаОрганизации(СтрокаОрганизаций, Отказ);
		ДанныеСервиса = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		Если Отказ Тогда
			Прервать;
		КонецЕсли;
		
		ОрганизацияЗарегистрированаВСервисе = Ложь;
		
		// Если организация уже зарегистрирована, проверим доступ сервису запросом списка входящих документов.
		Если ТипЗнч(ДанныеСервиса) = Тип("Массив") И ДанныеСервиса[0] = Истина Тогда
			
			ОрганизацияЗарегистрированаВСервисе = Истина;
			ПараметрыМетода = Новый Структура;
			ПараметрыМетода.Вставить("Организация", СтрокаОрганизаций.Ссылка);
			ПараметрыКоманды = ПараметрыКомандыПроверкиПравОрганизации(ПараметрыМетода, Отказ);
			ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
			
			Если Отказ Тогда
				Прервать;
			КонецЕсли;
				
		КонецЕсли;
		
		Если Отказ Тогда
			// Очистка идентификаторов.
			УдалитьТикеты();
			Возврат;
		КонецЕсли;
		
		Если Не ОрганизацияЗарегистрированаВСервисе Тогда
			// Регистрация организации.
			ПараметрыМетода = Новый Структура;
			ПараметрыМетода.Вставить("Организация", СтрокаОрганизаций.Ссылка);
			ПараметрыМетода.Вставить("Абонент",     ТекущийАбонент);
			ПараметрыКоманды = ПараметрыКомандыРегистрацияОрганизации(ПараметрыМетода, Отказ);
			Если Отказ Тогда
				Прервать;
			КонецЕсли;
			ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
			Если Отказ Тогда
				Прервать;
			КонецЕсли;
		КонецЕсли;
		
		СохранитьИдентификаторыОрганизаций(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(СтрокаОрганизаций.Ссылка));
		
	КонецЦикла;
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// Обновление пользователей в сервисе и информационной базе.
	ОбновитьПользователейВСервисе(ТекущийАбонент, Ложь, Отказ);
	
	// Проверка и установка функциональной опции.
	КонстантаМенеджер = Константы.ИспользоватьОбменБизнесСеть;
	Если Не КонстантаМенеджер.Получить() Тогда
		КонстантаМенеджер.Установить(Истина);
		ТребуетсяОбновитьИнтерфейс = Истина;
	КонецЕсли;
	
КонецПроцедуры

// Статус регистрации организации в информационной базе.
//
// Параметры:
//  Организация - ОпределяемыйТип.Организация - ссылка на определяемый справочник Организация.
//                Если ссылка не указана, то проверятся, есть ли регистрация любой организации
//                в информационной базе.
//
// Возвращаемое значение:
//   Булево - признак регистрации организации.
//
Функция ОрганизацияЗарегистрирована(Организация = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	
	Если ЗначениеЗаполнено(Организация) Тогда
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОрганизацииБизнесСеть.Организация КАК Организация
		|ИЗ
		|	РегистрСведений.ОрганизацииБизнесСеть КАК ОрганизацииБизнесСеть
		|ГДЕ
		|	ОрганизацииБизнесСеть.Организация = &Организация";
		Запрос.УстановитьПараметр("Организация", Организация);
	Иначе
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОрганизацииБизнесСеть.Организация КАК Организация
		|ИЗ
		|	РегистрСведений.ОрганизацииБизнесСеть КАК ОрганизацииБизнесСеть";
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	Результат = Запрос.Выполнить();
	
	Возврат Не Результат.Пустой();
	
КонецФункции

#КонецОбласти

#Область ПараметрыКоманд

// Параметры команды получения реквизитов участника.
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//   * Ссылка         - Ссылка - ссылка на организацию или контрагента.
//   * ЭтоОрганизация - Булево - признак получения данных организации.
//   * ЭтоКонтрагент  - Булево - признак получения данных контрагента.
//   * ИНН            - Строка - ИНН участника.
//   * КПП            - Строка - КПП участника.
//  Отказ - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыПолучитьРеквизитыУчастника(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	Если ПараметрыМетода.Свойство("Ссылка") И ЗначениеЗаполнено(ПараметрыМетода.Ссылка) Тогда
		Если ТипЗнч(ПараметрыМетода.Ссылка) = Метаданные.ОпределяемыеТипы.Организация.Тип.Типы()[0] Тогда
			ПараметрыМетода.ЭтоОрганизация = Истина;
			ЗаполнитьРеквизитыОрганизаций(ПараметрыМетода);
			ПараметрыКоманды.Наименование = НСтр("ru = 'Получение профиля организации'");
		ИначеЕсли ТипЗнч(ПараметрыМетода.Ссылка) = Метаданные.ОпределяемыеТипы.КонтрагентБЭД.Тип.Типы()[0] Тогда
			ПараметрыМетода.ЭтоКонтрагент = Истина;
			ЗаполнитьРеквизитыКонтрагентов(ПараметрыМетода);
			ПараметрыКоманды.Наименование = НСтр("ru = 'Получение профиля контрагента'");
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыМетода.ЭтоОрганизация = Ложь И ПараметрыМетода.ЭтоКонтрагент = Ложь Тогда
		// Если не передан параметр, то считаем что это контрагент.
		ПараметрыМетода.ЭтоКонтрагент = Истина;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ПараметрыМетода.ИНН) Тогда
		Если ПараметрыМетода.Свойство("Ссылка") И ЗначениеЗаполнено(ПараметрыМетода.Ссылка) Тогда
			ТестСообщения = НСтр("ru = 'Не заполнено свойство ""ИНН"" для ""%1"".'");
			ТестСообщения = СтрШаблон(ТестСообщения, ПараметрыМетода.Ссылка);
		Иначе
			ТестСообщения = НСтр("ru = 'Не заполнено свойство ""ИНН"".'");
		КонецЕсли;
		ОбщегоНазначения.СообщитьПользователю(ТестСообщения,,,, Отказ);
		Возврат Неопределено;
	КонецЕсли;
	
	ТекстОшибки = "";
	Идентификаторы = ИдентификаторыУчастника(ПараметрыМетода.ИНН, ПараметрыМетода.КПП,
		ПараметрыМетода.Ссылка, Отказ, ТекстОшибки);
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка чтения данных в 1С:Бизнес-сеть:'") + " " + ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Получение реквизитов участника'");
	ПараметрыКоманды.Адрес = СтрШаблон("api/core/v1/organizations/%1/%2", Идентификаторы.ИНН, Идентификаторы.КПП);
	ПараметрыКоманды.Метод = "GET";
	ПараметрыКоманды.Права = "bn_user";
	ПараметрыКоманды.РазрешенныеСостояния.Добавить(404);
	
	Реквизиты = Новый Структура;
	Реквизиты.Вставить("Наименование",     "title");
	Реквизиты.Вставить("НаименованиеЕГРН", "titleFromFns");
	Реквизиты.Вставить("ИНН",              "inn");
	Реквизиты.Вставить("КПП",              "kpp");
	Реквизиты.Вставить("ДатаРегистрации",  "registrationDate");
	Реквизиты.Вставить("Адрес",            "address");
	Реквизиты.Вставить("Описание",         "description");
	Реквизиты.Вставить("ЭлектроннаяПочта", "email");
	Реквизиты.Вставить("Факс",             "fax");
	Реквизиты.Вставить("ОГРН",             "ogrn");
	Реквизиты.Вставить("Телефон",          "phone");
	Реквизиты.Вставить("Сайт",             "site");
	ПараметрыКоманды.Вставить("ОбработкаРезультата", Реквизиты);
		
	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды отправить документ.
//
// Параметры:
//  ПараметрыМетода	 - Структура - состав:
//   * Получатель     - Ссылка - ссылка на контрагента получателя документа.
//   * Отправитель    - Ссылка - ссылка на организацию отправителя документа.
//   * АдресХранилища - Строка - адрес временного хранилища контейнера электронного документа.
//   * АдресХранилищаПредставления - Строка - адрес временного хранилища файла с представлением документа PDF.
//   * ВидЭД          - Строка - вид электронного документа см. ВидыДокументовСервиса.
//   * Заголовок      - Строка - заголовок электронного документа, например "Товарная накладная 134 от 01.01.2000".
//   * Ссылка         - Ссылка - ссылка на учетный документ.
//   * СопроводительнаяИнформация - Строка - произвольная текстовая информация для получателя.
//   * Сумма          - Число - сумма документа
//   * КонтактноеЛицо    - Строка - контактное лицо отправителя.
//   * Телефон           - Строка - номер телефона отправителя.
//   * ЭлектроннаяПочта  - Строка - адрес электронной почты отправителя.
//   * УведомлятьПоПочте - Булево - признак необходимости уведомления отправителя об изменении статуса
//                                  обработки документа получателем.
//   * ИдентификаторыПредложений - Массив из Строка - идентификаторы торговых предложения сервиса 1С:Торговая площадка.
//  Отказ			 - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыОтправитьДокумент(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды     = ОписаниеПараметровКомандыСервиса();
	ПараметрыПолучатель  = Неопределено;
	ПараметрыОтправитель = Неопределено;
	
	Если ТипЗнч(ПараметрыМетода.Получатель) = Тип("Структура") Тогда
		ПараметрыПолучатель = ПараметрыМетода.Получатель;
	Иначе
		ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Получатель, ПараметрыПолучатель);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Отправитель, ПараметрыОтправитель);
	
	ТекстОшибки = "";
	ИдентификаторыОтправителя = ИдентификаторыУчастника(ПараметрыОтправитель.ИНН, ПараметрыОтправитель.КПП,
		ПараметрыМетода.Отправитель, Отказ, ТекстОшибки);
	ИдентификаторыПолучателя = ИдентификаторыУчастника(ПараметрыПолучатель.ИНН, ПараметрыПолучатель.КПП,
		ПараметрыМетода.Получатель, Отказ, ТекстОшибки);

	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка отправки документов через 1С:Бизнес-сеть:'") + " "
			+ ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеОрганизации = Новый Структура;
	СтруктураПолучателя = Новый Структура("inn, kpp", ИдентификаторыПолучателя.ИНН, ИдентификаторыПолучателя.КПП);
	СтруктураОтправителя = Новый Структура("inn, kpp", ИдентификаторыОтправителя.ИНН,	ИдентификаторыОтправителя.КПП);
		
	СтрокаДвоичныхДанных = Base64Строка(ПолучитьИзВременногоХранилища(ПараметрыМетода.АдресХранилища));
	ДанныеОрганизации.Вставить("destinationOrganization", СтруктураПолучателя);
	ДанныеОрганизации.Вставить("sourceOrganization", СтруктураОтправителя);
	ДанныеОрганизации.Вставить("documentDataType", "v8." + XMLСтрока(ПараметрыМетода.ВидЭД)); // Тип документа.
	ДанныеОрганизации.Вставить("documentData",  СтрокаДвоичныхДанных);
	ДанныеОрганизации.Вставить("documentTitle", ПараметрыМетода.Заголовок);
	ДанныеОрганизации.Вставить("documentGuid",  Строка(ПараметрыМетода.Ссылка.УникальныйИдентификатор()));
	ДанныеОрганизации.Вставить("info",          ПараметрыМетода.СопроводительнаяИнформация);
	ДанныеОрганизации.Вставить("moneyAmount",   ПараметрыМетода.Сумма * 100); // Сумма документа в копейках.
	ДанныеОрганизации.Вставить("metaData",      ПараметрыМетода.Ссылка.Метаданные().Имя); // Доп. информация.
	
	// Добавление представление документа PDF.
	Если ПараметрыМетода.Свойство("АдресХранилищаПредставления") 
		И ЗначениеЗаполнено(ПараметрыМетода.АдресХранилищаПредставления) Тогда
		ДвоичныеДанные = Base64Строка(ПолучитьИзВременногоХранилища(ПараметрыМетода.АдресХранилищаПредставления));
		Если ДвоичныеДанные <> Неопределено Тогда
			ДанныеОрганизации.Вставить("documentPresentationData", ДвоичныеДанные);
			ДанныеОрганизации.Вставить("documentPresentationDataType", "pdf");
		КонецЕсли;
	КонецЕсли;
	
	ПерсональныеДанные = Новый Структура;
	Если ЗначениеЗаполнено(ПараметрыМетода.КонтактноеЛицо) Тогда
		ПерсональныеДанные.Вставить("name", ПараметрыМетода.КонтактноеЛицо);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПараметрыМетода.Телефон) Тогда
		ПерсональныеДанные.Вставить("phone", ПараметрыМетода.Телефон);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПараметрыМетода.ЭлектроннаяПочта) Тогда
		ПерсональныеДанные.Вставить("email", ПараметрыМетода.ЭлектроннаяПочта);
	КонецЕсли;
	Если ПараметрыМетода.Свойство("УведомлятьПоПочте") Тогда
		ПерсональныеДанные.Вставить("notifyByEmail", ПараметрыМетода.УведомлятьПоПочте);
	КонецЕсли;
	ДанныеОрганизации.Вставить("person", ПерсональныеДанные);
	
	Если ПараметрыМетода.Свойство("ИдентификаторыПредложений") Тогда
		ДанныеОрганизации.Вставить("contextName", "CAMPAIGN"); // Служебное наименование типа.
		ДанныеОрганизации.Вставить("contextIds", ПараметрыМетода.ИдентификаторыПредложений);
	КонецЕсли;
	
	Данные = ЗначениеВJSON(ДанныеОрганизации);
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Отправка документа'");
	ПараметрыКоманды.Данные = Данные;
	ПараметрыКоманды.Адрес = "api/edi/v1/documents";
	ПараметрыКоманды.Метод = "POST";
	ПараметрыКоманды.Права = "bn_user";
	ПараметрыКоманды.Ошибки.Вставить(404,
		СтрШаблон(НСтр("ru = 'Ошибка отправки документа %1.'"), ПараметрыМетода.Заголовок));
		
	Возврат ПараметрыКоманды;

КонецФункции

#КонецОбласти

#Область ОписаниеПараметров

// Описание контактной информации пользователя.
//
Функция ОписаниеКонтактнойИнформацииПользователя() Экспорт
	
	СтруктураКонтактов = Новый Структура;
	СтруктураКонтактов.Вставить("ФИО", "");
	СтруктураКонтактов.Вставить("ЭлектроннаяПочта", "");
	СтруктураКонтактов.Вставить("Телефон", "");
	
	Возврат СтруктураКонтактов;
	
КонецФункции

// Описание параметров команды сервиса.
//
// Возвращаемое значение:
//  Структура - содержит стандартный набор параметров для выполнения команд сервиса:
//    * Сервис       - Строка - имя сервиса, например, "Рубрикатор", по умолчанию Бизнес-сеть.
//    * Наименование - Строка - полное наименование метода.
//    * Адрес        - Строка - адрес URI метода.
//    * Метод        - Строка - метод HTTP соединения, например POST.
//    * Права        - Строка - необходимые права команды bn_user, bn_its.
//    * Данные       - ДвоичныеДанные, Строка - передаваемые данные.
//    * Ошибки       - Соответствие - соответствие ошибок, например "404", "Не найдено".
//    * БлокироватьСообщенияОбОшибках - Булево - блокировка вывода сообщения об ошибках.
//    * ОбработкаРезультата    - Произвольный - описание конвертации данных результата.
//    * РазрешенныеСостояния   - Массив из Число - коды состояний ответа сервиса, отличные от 200, при
//                                       получении которых обработка результата будет продолжена.
//                                       Коды состояний не должны быть указаны в ключе Ошибки.
//
Функция ОписаниеПараметровКомандыСервиса() Экспорт
	
	ПараметрыКоманды = Новый Структура;
	ПараметрыКоманды.Вставить("Сервис",       "");
	ПараметрыКоманды.Вставить("Наименование", "");
	ПараметрыКоманды.Вставить("Адрес",        "");
	ПараметрыКоманды.Вставить("Метод",        "");
	ПараметрыКоманды.Вставить("Права",        "");
	ПараметрыКоманды.Вставить("Данные",       Неопределено);
	ПараметрыКоманды.Вставить("РазрешенныеСостояния", Новый Массив);
	ПараметрыКоманды.Вставить("Ошибки",               Новый Соответствие);
	ПараметрыКоманды.Вставить("БлокироватьСообщенияОбОшибках", Неопределено);
	ПараметрыКоманды.Вставить("ОбработкаРезультата",           Неопределено);
	ПараметрыКоманды.Вставить("Страница",       0);  // page
	ПараметрыКоманды.Вставить("РазмерСтраницы", 0);  // size
	
	Возврат ПараметрыКоманды;
	
КонецФункции

#КонецОбласти

#Область ПреобразованиеДанных

// Получение значения в формате JSON.
//
Функция ЗначениеВJSON(Данные, ПараметрыЗаписи = Неопределено) Экспорт
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку(ПараметрыЗаписи);
	ЗаписатьJSON(ЗаписьJSON, Данные);
	Результат = ЗаписьJSON.Закрыть();
	
	Возврат Результат;
	
КонецФункции

// Корректировка идентификаторов ИНН и КПП участника для сервиса, "0" если не заполнено.
//
// Параметры:
//   ИНН          - Строка - ИНН участника.
//   КПП          - Строка - КПП участника.
//   Наименование - Строка - наименование участника.
//   Отказ        - Булево - признак ошибки данных.
//   ТекстОшибки  - Строка - текст возвращаемой ошибки.
//
// Возвращаемое значение:
//   Структура - результат корректировки:
//     * ИНН - Строка - ИНН участника.
//     * КПП - Строка - КПП участника.
//
Функция ИдентификаторыУчастника(Знач ИНН, Знач КПП, Знач Наименование = Неопределено, Отказ = Неопределено,
	ТекстОшибки = "") Экспорт

	Идентификаторы = Новый Структура("ИНН, КПП");
	
	Идентификаторы.ИНН = СокрЛП(ИНН);
	Если ПустаяСтрока(Идентификаторы.ИНН) Тогда
		Идентификаторы.ИНН = "0";
	КонецЕсли;
	
	Идентификаторы.КПП = СокрЛП(КПП);
	Если ПустаяСтрока(Идентификаторы.КПП) Тогда
		Идентификаторы.КПП = "0";
	КонецЕсли;
	
	Если (СтрДлина(Идентификаторы.КПП) <> 9 И СтрДлина(Идентификаторы.ИНН) <> 12)
		ИЛИ (СтрДлина(Идентификаторы.КПП) <> 1 И СтрДлина(Идентификаторы.ИНН) <> 10) Тогда
		
		Если ЗначениеЗаполнено(Наименование) Тогда
			ТекстОшибки = СтрШаблон(НСтр("ru = 'Некорректное значение ИНН ""%1"" или КПП ""%2"" для ""%3""'"), 
				ИНН, КПП, Наименование);
		Иначе
			ТекстОшибки = СтрШаблон(НСтр("ru = 'Некорректное значение ИНН ""%1"" или КПП ""%2""'"), 
				ИНН, КПП);
		КонецЕсли;
		Отказ = Истина;
		
	КонецЕсли;
	
	Возврат Идентификаторы;

КонецФункции

#КонецОбласти

#Область Прочее

// Возврат списка доступных для обмена видов документов со строковым представлением.
//
// Возвращаемое значение:
//   СписокЗначений - список с видами электронных документов.
//
Функция ВидыДокументовСервиса() Экспорт
	
	СписокВидовЭД = Новый СписокЗначений;
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.АктИсполнитель,          НСтр("ru = 'Акт выполненных работ'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.АктНаПередачуПрав,       НСтр("ru = 'Акт передачи прав'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ОтветНаЗаказ,            НСтр("ru = 'Заказ покупателя'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ЗаказТовара,             НСтр("ru = 'Заказ поставщику'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель,
		НСтр("ru = 'Корректировка стоимости'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ТОРГ12Продавец,          НСтр("ru = 'Товарная накладная'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара,
		НСтр("ru = 'Отчет о продажах комиссионного товара'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара,
		НСтр("ru = 'Отчет о списании комиссионного товара'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ПрайсЛист,               НСтр("ru = 'Прайс-лист'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.СчетНаОплату,            НСтр("ru = 'Счет на оплату'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.КоммерческоеПредложение, НСтр("ru = 'Коммерческое предложение'"));
	СписокВидовЭД.Добавить(Перечисления.ВидыЭД.ЗапросКоммерческихПредложений,
		НСтр("ru = 'Запрос коммерческих предложений'"));
	
	Возврат СписокВидовЭД;
	
КонецФункции

// Возвращает признак установки функциональной опции 1С:Бизнес-сеть.
//
Функция ИспользоватьОбменБизнесСеть() Экспорт
	
	Возврат ПолучитьФункциональнуюОпцию("ИспользоватьОбменБизнесСеть");
	
КонецФункции

// Изменение использования регламентного задания.
//
// Параметры:
//  ИмяЗадания			- Строка - наименование регламентного задания.
//  ИмяПараметра		- Строка - наименование параметра, например "Использование".
//  ЗначениеПараметра	- Произвольный - признак использования регламентного задания.
//
Процедура ИзменитьРегламентноеЗадание(ИмяЗадания, ИмяПараметра, ЗначениеПараметра) Экспорт
	
	ПараметрыПоиска = Новый Структура("Метаданные", ИмяЗадания);
	МассивРегламентныхЗаданий = РегламентныеЗаданияСервер.НайтиЗадания(ПараметрыПоиска);
	
	Если МассивРегламентныхЗаданий.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	РегламентноеЗадание = МассивРегламентныхЗаданий[0];
	
	ПараметрыЗадания = Новый Структура;
	ПараметрыЗадания.Вставить(ИмяПараметра, ЗначениеПараметра);
	РегламентныеЗаданияСервер.ИзменитьЗадание(РегламентноеЗадание.УникальныйИдентификатор, ПараметрыЗадания);

КонецПроцедуры

// Заполнение реквизитов контрагентов.
//
// Параметры:
//   Данные - Структура, ТаблицаЗначений:
//     * Ссылка - СправочникСсылка - ссылка контрагента (обязательный).
//     * Наименование - Строка - полное наименование контрагента.
//     * ИНН - Строка - ИНН.
//     * КПП - Строка - КПП.
//
Процедура ЗаполнитьРеквизитыКонтрагентов(Данные) Экспорт

	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	Контрагенты.Наименование КАК Наименование,
	|	Контрагенты.ИНН КАК ИНН,
	|	Контрагенты.КПП КАК КПП
	|ИЗ
	|	&Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.Ссылка В(&СписокСсылок)";
	
	ИмяСправочникаКонтрагенты = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника("Контрагенты");
	РеквизитНаименование = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("НаименованиеКонтрагента");
	РеквизитИНН = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("ИННКонтрагента");
	РеквизитКПП = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("КППКонтрагента");
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Контрагенты", "Справочник." + ИмяСправочникаКонтрагенты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Контрагенты.Наименование", "Контрагенты." + РеквизитНаименование);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Контрагенты.ИНН", "Контрагенты." + РеквизитИНН);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Контрагенты.КПП", "Контрагенты." + РеквизитКПП);
	Запрос.Текст = ТекстЗапроса;
	
	Если ТипЗнч(Данные) = Тип("Структура") Тогда
		СписокСсылок = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Данные.Ссылка);
	ИначеЕсли ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
		СписокСсылок = Данные.ВыгрузитьКолонку("Ссылка");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("СписокСсылок", СписокСсылок);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если ТипЗнч(Данные) = Тип("Структура") Тогда
			Данные.Вставить("Наименование", Выборка.Наименование);
			Данные.Вставить("ИНН", Выборка.ИНН);
			Данные.Вставить("КПП", Выборка.КПП);
			Прервать;
		ИначеЕсли ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
			ЗаполнитьЗначенияСвойств(Данные.Найти(Выборка.Ссылка, "Ссылка"), Выборка);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Заполнение реквизитов организаций.
//
// Параметры:
//   Данные - Структура, ТаблицаЗначений:
//     * Ссылка - СправочникСсылка - ссылка организации (обязательный).
//     * Наименование - Строка - полное наименование организации.
//     * ИНН - Строка - ИНН.
//     * КПП - Строка - КПП.
//
Процедура ЗаполнитьРеквизитыОрганизаций(Данные) Экспорт

	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Организации.Ссылка КАК Ссылка,
	|	Организации.Наименование КАК Наименование,
	|	Организации.ИНН КАК ИНН,
	|	Организации.КПП КАК КПП
	|ИЗ
	|	&Организации КАК Организации
	|ГДЕ
	|	Организации.Ссылка В(&СписокСсылок)";
	
	ИмяСправочникаОрганизации = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника("Организации");
	РеквизитНаименование = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("НаименованиеОрганизации");
	РеквизитИНН = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("ИННОрганизации");
	РеквизитКПП = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении("КППОрганизации");
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Организации", "Справочник." + ИмяСправочникаОрганизации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Организации.Наименование", "Организации." + РеквизитНаименование);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Организации.ИНН",          "Организации." + РеквизитИНН);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Организации.КПП",          "Организации." + РеквизитКПП);
	Запрос.Текст = ТекстЗапроса;
	
	Если ТипЗнч(Данные) = Тип("Структура") Тогда
		СписокСсылок = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Данные.Ссылка);
	ИначеЕсли ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
		СписокСсылок = Данные.ВыгрузитьКолонку("Ссылка");
		Если Данные.Колонки.Найти("Наименование") = Неопределено Тогда
			Данные.Колонки.Добавить("Наименование", Новый ОписаниеТипов("Строка"));
		КонецЕсли;
		Если Данные.Колонки.Найти("ИНН") = Неопределено Тогда
			Данные.Колонки.Добавить("ИНН", Новый ОписаниеТипов("Строка"));
		КонецЕсли;
		Если Данные.Колонки.Найти("КПП") = Неопределено Тогда
			Данные.Колонки.Добавить("КПП", Новый ОписаниеТипов("Строка"));
		КонецЕсли;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("СписокСсылок", СписокСсылок);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если ТипЗнч(Данные) = Тип("Структура") Тогда
			Данные.Вставить("Наименование", Выборка.Наименование);
			Данные.Вставить("ИНН", Выборка.ИНН);
			Данные.Вставить("КПП", Выборка.КПП);
			Прервать;
		ИначеЕсли ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
			ЗаполнитьЗначенияСвойств(Данные.Найти(Выборка.Ссылка, "Ссылка"), Выборка);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Получение организаций, зарегистрированных в сервисе.
//
// Возвращаемое значение:
//   Массив - зарегистрированные организации в сервисе.
//
Функция ЗарегистрированныеОрганизации() Экспорт

	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Организации.Ссылка КАК Ссылка
	|ИЗ
	|	РегистрСведений.ОрганизацииБизнесСеть КАК ОрганизацииБизнесСеть
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник_Организации КАК Организации
	|		ПО ОрганизацииБизнесСеть.Организация = Организации.Ссылка
	|ГДЕ
	|	НЕ Организации.Ссылка ЕСТЬ NULL
	|	И НЕ ОрганизацииБизнесСеть.Организация.ПометкаУдаления";

	ИмяСправочникаОрганизации = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника("Организации");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Справочник_Организации", "Справочник." + ИмяСправочникаОрганизации);
	Запрос.Текст = ТекстЗапроса;
	Результат = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	Возврат Результат;
	
КонецФункции

// Условное оформление гиперссылки таблицы "Показать еще".
//
// Параметры:
//  УсловноеОформление	- УсловноеОформлениеКомпоновкиДанных - условное оформление формы.
//  ТаблицаФормы		- ТаблицаФормы - элемент формы таблицы списка.
//  ПолеФормы 			- ПолеФормы - элемент формы колонки "Показать еще".
//
Процедура УсловноеОформлениеГиперссылкиПоказатьЕще(УсловноеОформление, ТаблицаФормы, ПолеФормы) Экспорт
	
	ИмяКолонкиПоказатьЕще  = ПолеФормы.Имя;
	ПутьКДаннымПоказатьЕще = ПолеФормы.ПутьКДанным;
	
	// Скрытие колонок с данными для гиперссылки "Показать еще".
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение  = Новый ПолеКомпоновкиДанных(ПутьКДаннымПоказатьЕще);
	ОтборЭлемента.ВидСравнения   = ВидСравненияКомпоновкиДанных.Заполнено;
	ДобавитьПоляТаблицыПоКоллекции(ТаблицаФормы.ПодчиненныеЭлементы,
		ЭлементУсловногоОформления.Поля.Элементы, ПолеФормы);
		
	// Скрытие гиперссылки "Показать еще".
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение  = Новый ПолеКомпоновкиДанных(ПутьКДаннымПоказатьЕще);
	ОтборЭлемента.ВидСравнения   = ВидСравненияКомпоновкиДанных.НеЗаполнено;
	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ИмяКолонкиПоказатьЕще);
	
	// Отображение гиперссылки "Показать еще".
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'Показать еще'"));
	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение  = Новый ПолеКомпоновкиДанных(ПутьКДаннымПоказатьЕще);
	ОтборЭлемента.ВидСравнения   = ВидСравненияКомпоновкиДанных.Заполнено;
	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ИмяКолонкиПоказатьЕще);
	
КонецПроцедуры

#КонецОбласти

#Область Права

// Проверяет возможность настройки взаимодействия в сервисе 1С:Бизнес-сеть для текущего пользователя.
//
// Возвращаемое значение:
//  Булево - наличие права на настройку обмена документами.
//
Функция ПравоНастройкиОбменаДокументами(ВыводитьСообщение = Ложь) Экспорт
	
	Если Пользователи.ЭтоПолноправныйПользователь() Тогда
		Возврат Истина;
	КонецЕсли;
	
	ЕстьПраво = ПравоДоступа("Изменение", Метаданные.РегистрыСведений.ОрганизацииБизнесСеть);
	
	Если Не ЕстьПраво И ВыводитьСообщение Тогда
		ЭлектронноеВзаимодействиеСлужебный.СообщитьПользователюОНарушенииПравДоступа();
	КонецЕсли;
	
	Возврат ЕстьПраво;
	
КонецФункции

// Проверяет возможность чтения данных обмена документами в сервисе 1С:Бизнес-сеть для текущего пользователя.
//
// Параметры:
//  ВыводитьСообщение - Булево - признак необходимости вывода сообщения о недостаточности прав.
// 
// Возвращаемое значение:
//  Булево - наличие права на чтение настроек обмена документами.
//
Функция ПравоЧтенияНастроекОбменаДокументами(ВыводитьСообщение = Ложь) Экспорт
	
	Если Пользователи.ЭтоПолноправныйПользователь() Тогда
		Возврат Истина;
	КонецЕсли;
	
	ЕстьПраво = ПравоДоступа("Чтение", Метаданные.РегистрыСведений.ОрганизацииБизнесСеть);
	
	Если Не ЕстьПраво И ВыводитьСообщение Тогда
		ЭлектронноеВзаимодействиеСлужебный.СообщитьПользователюОНарушенииПравДоступа();
	КонецЕсли;
		
	Возврат ЕстьПраво;
		
КонецФункции

// Проверяет возможность выполнения обмена документами в сервисе 1С:Бизнес-сеть для текущего пользователя.
//
// Параметры:
//  ВыводитьСообщение - Булево - признак необходимости вывода сообщения о недостаточности прав.
// 
// Возвращаемое значение:
//  Булево - наличие права на выполнение обмена.
//
Функция ПравоВыполненияОбменаДокументами(Пользователь = Неопределено, ВыводитьСообщение = Ложь) Экспорт
	
	Если Пользователи.ЭтоПолноправныйПользователь(Пользователь) Тогда
		Возврат Истина;
	КонецЕсли;
	
	ЕстьПраво = ПравоДоступа("Просмотр", Метаданные.ОбщиеКоманды.ВходящиеДокументыБизнесСеть, Пользователь)
		И ПравоЧтенияНастроекОбменаДокументами();
	
	Если Не ЕстьПраво И ВыводитьСообщение Тогда
		ЭлектронноеВзаимодействиеСлужебный.СообщитьПользователюОНарушенииПравДоступа();
	КонецЕсли;
		
	Возврат ЕстьПраво;
	
КонецФункции

#КонецОбласти

#Область ДляВызоваИзЭлектронногоВзаимодействия

// ТехнологияСервиса.РаботаВМоделиСервиса
// См. ТарификацияПереопределяемый.ПриФормированииСпискаУслуг.
Процедура ПриФормированииСпискаУслуг(ПоставщикиУслуг) Экспорт
	
	ПоставщикПортал1СИТС = Неопределено;
	ИдентификаторПоставщикаУслугПортал1СИТС =
		ЭлектронноеВзаимодействиеКлиентСервер.ИдентификаторПоставщикаУслугПортал1СИТС();
	Для каждого ЗначениеМассива Из ПоставщикиУслуг Цикл
		Если ЗначениеМассива.Идентификатор = ИдентификаторПоставщикаУслугПортал1СИТС Тогда
			ПоставщикПортал1СИТС = ЗначениеМассива;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ПоставщикПортал1СИТС = Неопределено Тогда
		ПоставщикПортал1СИТС = Новый Структура;
		ПоставщикПортал1СИТС.Вставить("Идентификатор", ИдентификаторПоставщикаУслугПортал1СИТС);
		ПоставщикПортал1СИТС.Вставить("Наименование" , НСтр("ru = 'Портал 1С:ИТС'"));
		ПоставщикПортал1СИТС.Вставить("Услуги"       , Новый Массив);
		ПоставщикиУслуг.Добавить(ПоставщикПортал1СИТС);
	КонецЕсли;
	
	Услуги = ПоставщикПортал1СИТС.Услуги;
	
	// Оператор [] используется для исключения ошибки компиляции,
	// если не внедрена Библиотека "Технология сервиса".
	ТипУслугиБезлимитная = Перечисления["ТипыУслуг"]["Безлимитная"];
	
	НоваяУслуга = Новый Структура;
	НоваяУслуга.Вставить("Идентификатор", "1c-bn-access");
	НоваяУслуга.Вставить("Наименование" , НСтр("ru = 'ЭДО без электронной подписи для участников 1С:Бизнес-сеть'"));
	НоваяУслуга.Вставить("ТипУслуги"    , ТипУслугиБезлимитная);
	Услуги.Добавить(НоваяУслуга);
	
КонецПроцедуры
// Конец ТехнологияСервиса.РаботаВМоделиСервиса

// СтандартныеПодсистемы.БазоваяФункциональность
// См. ОбщегоНазначенияПереопределяемый.ПриДобавленииПереименованийОбъектовМетаданных.
Процедура ПриДобавленииПереименованийОбъектовМетаданных(Итог) Экспорт

	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.14",
		"Роль.АдминистрированиеАбонентаБизнесСеть",
		"Роль.ДобавлениеИзменениеНастроекБизнесСеть",
		"БиблиотекаЭлектронныхДокументов");
		
	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.14",
		"Роль.ВыполнениеОбменаБизнесСеть",
		"Роль.ВыполнениеОбменаДокументамиБизнесСеть",
		"БиблиотекаЭлектронныхДокументов");
		
	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.14",
		"Роль.ОтчетыТорговыеПредложения",
		"Роль.ЧтениеТорговыхПредложенийБизнесСеть",
		"БиблиотекаЭлектронныхДокументов");
		
	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.14",
		"Роль.СопоставлениеНоменклатуры1СБизнесСеть",
		"Роль.ДобавлениеИзменениеТорговыхПредложенийБизнесСеть",
		"БиблиотекаЭлектронныхДокументов");
	
	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.29",
		"Роль.ДобавлениеИзменениеТорговыхПредложенийБизнесСеть",
		"Роль.ДобавлениеИзменениеНастроекТорговыхПредложений",
		"БиблиотекаЭлектронныхДокументов");
		
	ОбщегоНазначения.ДобавитьПереименование(
		Итог,
		"1.4.1.29",
		"Роль.ЧтениеТорговыхПредложенийБизнесСеть",
		"Роль.ЧтениеНастроекТорговыхПредложений",
		"БиблиотекаЭлектронныхДокументов");
		
КонецПроцедуры
// Конец СтандартныеПодсистемы.БазоваяФункциональность

// СтандартныеПодсистемы.ПрофилиБезопасности
// См. РаботаВБезопасномРежимеПереопределяемый.ПриЗаполненииРазрешенийНаДоступКВнешнимРесурсам
Процедура ПриЗаполненииРазрешенийНаДоступКВнешнимРесурсам(ЗапросыРазрешений) Экспорт
	
	ДобавитьРазрешенияВнешнихРесурсов("БизнесСеть", ЗапросыРазрешений);
	ДобавитьРазрешенияВнешнихРесурсов("Рубрикатор", ЗапросыРазрешений);
	
КонецПроцедуры
// Конец СтандартныеПодсистемы.ПрофилиБезопасности

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОперацииСервиса

// Отключение организаций от сервиса.
//
// Параметры:
//  СписокОрганизаций			 - Массив из ОпределяемыйТип.Организация - ссылки на отключаемые организации.
//  РежимУдаления				 - Булево - Истина - отключение в сервисе, Ложь - только локально.
//  Отказ						 - Булево - результат исполнения.
//  ТребуетсяОбновитьИнтерфейс	 - Булево - возвращает Истина, если после исполнения требуется обновления интерфейса.
//
Процедура ОтключитьОрганизации(СписокОрганизаций, РежимУдаления, Отказ, ТребуетсяОбновитьИнтерфейс = Ложь) Экспорт
	
	Если РежимУдаления Тогда
		
		ПараметрыМетода = Новый Структура;
		ПараметрыМетода.Вставить("СписокОрганизаций", СписокОрганизаций);
		ПараметрыКоманды = ПараметрыКомандыУдаленияОрганизации(ПараметрыМетода, Отказ);
		ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	СохранитьИдентификаторыОрганизаций(СписокОрганизаций, Истина);
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ОрганизацииБизнесСеть.Организация КАК Организация
	|ИЗ
	|	РегистрСведений.ОрганизацииБизнесСеть КАК ОрганизацииБизнесСеть";
	
	Запрос.Текст = ТекстЗапроса;
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.Выполнить();
	УстановитьПривилегированныйРежим(Ложь);
	
	// Не осталось ни одной подключенной организации, требуется удалить пользователей и идентификатор клиента.	
	Если РезультатЗапроса.Пустой() Тогда
		
		СохранитьИдентификаторыПользователей(Неопределено, Истина);
		СохранитьИдентификаторПрограммы(Неопределено, Истина);
		УдалитьТикеты();
		ТребуетсяОбновитьИнтерфейс = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

// Обновление пользователей в сервисе по данным информационной базы.
//
// Параметры:
//   ТекущийАбонент - Строка - идентификатор абонента в сервисе.
//   ОбновлятьИдентификаторыДоступа - Булево.
//   Результат - Структура - результат выполнения, см БизнесСетьКлиентСервер.ОписаниеРезультатаКомандыСервиса().
//   Отказ - Булево - признак ошибки выполнения.
//
Процедура ОбновитьПользователейВСервисе(ТекущийАбонент, ОбновлятьИдентификаторыДоступа, Отказ) Экспорт
	
	// Получение списка подключенных абонентов, по-умолчанию берем первого абонента из списка.
	Если ТекущийАбонент = Неопределено Тогда
		
		ПараметрыКоманды = ПараметрыКомандыПолучитьСписокАбонентов();
		ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	ПараметрыКоманды = Новый Структура;
	
	Если ОбновлятьИдентификаторыДоступа Тогда
		
		// Обновление идентификатора информационной базы в сервисе.
		ИдентификаторПрограммы = Строка(Новый УникальныйИдентификатор);
		ПараметрыМетода = Новый Структура;
		ПараметрыМетода.Вставить("ИдентификаторПрограммы", ИдентификаторПрограммы);
		ПараметрыКоманды = ПараметрыКомандыОбновитьИдентификаторПрограммы(ПараметрыМетода);
		ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
		СохранитьИдентификаторПрограммы(ИдентификаторПрограммы);
		
	КонецЕсли;
	
	ПараметрыМетода = Новый Структура;
	ПараметрыМетода.Вставить("Данные");
	ПараметрыМетода.Вставить("СписокПользователей");
	ПараметрыМетода.Вставить("ИдентификаторПрограммы");
	СформироватьДанныеСинхронизацииПользователя(ПараметрыМетода, ОбновлятьИдентификаторыДоступа);
	
	Если ПараметрыМетода.СписокПользователей.Количество() Тогда
		ПараметрыКоманды = ПараметрыКомандыСинхронизацияПользователей(ПараметрыМетода);
		ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		СохранитьИдентификаторыПользователей(ПараметрыМетода.СписокПользователей);
	КонецЕсли;
	
	Если ОбновлятьИдентификаторыДоступа Тогда
		УдалитьТикеты();
	КонецЕсли;

КонецПроцедуры

// Отправка уведомления контрагенту об отправке электронного документа.
//
// Параметры:
//   ПараметрыУдаления - Структура - состав:
//     * Организация           - ОпределяемыйТип.Организация - организация документа.
//     * МассивИдентификаторов - Массив из Строка - идентификаторы ГУИД удаляемых документов.
//   Результат         - Структура - возвращаемые данные.
//   Отказ             - Булево - признак отказа выполнения.
//
Функция ОтправитьУведомлениеОбОтправке(Контрагент, МассивИдентификаторов, АдресПочты, Отказ) Экспорт
	
	ПараметрыМетода = Новый Структура;
	ПараметрыМетода.Вставить("Получатель", Контрагент);
	ПараметрыМетода.Вставить("МассивИдентификаторов", МассивИдентификаторов);
	ПараметрыМетода.Вставить("ЭлектроннаяПочта", АдресПочты);
	ПараметрыКоманды = ПараметрыКомандыОтправитьУведомлениеОбОтправке(ПараметрыМетода);
	Результат = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
	
	Возврат Результат;
	
КонецФункции

Функция ОбновитьИнформациюОНовыхДокументахВСервисеАсинхронно(Знач ПараметрыОбновления) Экспорт
	
	НаименованиеЗадания = НСтр("ru = 'Обновление информации о новых документах в сервисе ""1С:Бизнес-сеть"".'");
	ИмяПроцедуры        = "БизнесСеть.ОбновитьИнформациюОНовыхДокументахВСервисе";
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(ПараметрыОбновления.ИдентификаторФормы);
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НаименованиеЗадания;
	ПараметрыВыполнения.ОжидатьЗавершение = 0;
	ПараметрыВыполнения.ЗапуститьВФоне = Истина;
	
	Возврат ДлительныеОперации.ВыполнитьВФоне(ИмяПроцедуры, ПараметрыОбновления, ПараметрыВыполнения);
	
КонецФункции

Процедура ОбновитьИнформациюОНовыхДокументахВСервисе(Знач ПараметрыОбновления, Знач АдресРезультата) Экспорт
	
	НовыеДокументы = Новый Массив;
	
	Для каждого ВидДокумента Из ПараметрыОбновления.ВидыДокументов Цикл
		
		КоличествоДокументов = НовыеДокументыВСервисе(ВидДокумента).Количество();
		
		Если КоличествоДокументов = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		НовыеДокументы.Добавить(
			Новый Структура("ВидДокумента, КоличествоДокументов", 
				ВидДокумента, КоличествоДокументов));
				
	КонецЦикла;
		
	ПоместитьВоВременноеХранилище(НовыеДокументы, АдресРезультата);
	
КонецПроцедуры

// Фоновое задание Получение документов сервиса.
//
// Параметры:
//  ПараметрыЗапроса - Структура - см. ПараметрыКомандыСписокВходящихДокументов.
//  АдресРезультата	 - Строка - адрес хранилища с результатом.
//
Процедура ПолучениеДокументовСервиса(Знач ПараметрыЗапроса, Знач АдресРезультата) Экспорт
	
	Отказ = Ложь;
	
	ПараметрыКоманды = ПараметрыКомандыСписокВходящихДокументов(ПараметрыЗапроса, Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Результат = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
	Если Отказ Или Не ЗначениеЗаполнено(Результат) Тогда
		Возврат;
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

Функция НовыеДокументыВСервисе(ВидДокумента)
	
	ПараметрыЗапроса = Новый Структура;
	
	ПараметрыЗапроса.Вставить("ВидДокумента",   ВидДокумента);
	ПараметрыЗапроса.Вставить("ТолькоНовые",    Истина);
	ПараметрыЗапроса.Вставить("Страница",       1);
	ПараметрыЗапроса.Вставить("РазмерСтраницы", 101);
	ПараметрыЗапроса.Вставить("ДатаНачала",     Неопределено);
	ПараметрыЗапроса.Вставить("ДатаОкончания",  Неопределено);
	
	Отказ = Ложь;	
		
	ПараметрыКоманды = ПараметрыКомандыСписокВходящихДокументов(ПараметрыЗапроса, Отказ);
	
	НовыеДокументы = ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
	
	Если Отказ
		Или Не ТипЗнч(НовыеДокументы) = Тип("Массив") Тогда
		ПолучитьСообщенияПользователю(Истина);
		ВызватьИсключение НСтр("ru = 'Ошибка обновления данных в сервисе.'");
	КонецЕсли;
	
	Возврат НовыеДокументы;
	
КонецФункции

#КонецОбласти

#Область ПолучениеТикетов

// Получение тикета в сервисе, в том числе из кэша.
//
Функция ПолучитьКлючТикета(Соединение, ПараметрыСоединения, ПараметрыКоманды, Отказ)
	
	УстановитьПривилегированныйРежим(Истина);
	СписокТикетов  = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(Пользователи.ТекущийПользователь(), "БизнесСетьСписокТикетов");
	УстановитьПривилегированныйРежим(Ложь);
	
	Тикет = Неопределено;
	Если ЗначениеЗаполнено(СписокТикетов) И ТипЗнч(СписокТикетов) = Тип("Соответствие") Тогда
		Тикет = СписокТикетов.Получить(ПараметрыКоманды.Права);
	КонецЕсли;
	
	// Проверка ключа в кэше и его срока действия.
	Если Тикет = Неопределено ИЛИ ТекущаяУниверсальнаяДатаВМиллисекундах() > Тикет.СрокЖизни Тогда
		
		// Проверка сохраненного идентификатора программы.
		Если Не ЗначениеЗаполнено(ПараметрыСоединения.ИдентификаторПрограммы) Тогда
			ТекстСообщения = НСтр("ru='Ошибка аутентификации в сервисе 1С:Бизнес-сеть. Рекомендуется выполнить перерегистрацию организаций в сервисе.'");
			ПодробноеСообщение = ТекстСообщения + Символы.ПС + НСтр("ru = 'Описание: Не заполнен идентификатор программы.'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения
				+ БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации(),,,, Отказ);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
				ПодробноеСообщение, "БизнесСеть");
			Возврат Неопределено;
		КонецЕсли;
		
		// Подготовка и получение нового ключа.
		ПараметрыМетода = Новый Структура;
		ПараметрыМетода.Вставить("ИдентификаторПрограммы", ПараметрыСоединения.ИдентификаторПрограммы);
		ПараметрыМетода.Вставить("Права", ПараметрыКоманды.Права);
		
		Если ПараметрыКоманды.Свойство("БлокироватьСообщенияОбОшибках") Тогда
			ПараметрыМетода.Вставить("БлокироватьСообщенияОбОшибках", ПараметрыКоманды.БлокироватьСообщенияОбОшибках);
		КонецЕсли;
		
		ПараметрыТикета = ПараметрыКомандыПолучениеКлюча(ПараметрыМетода, Отказ);
		Если Отказ ИЛИ ПараметрыТикета = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		ПараметрыТикета.Вставить("Права", ПараметрыКоманды.Права);
		
		Если ПараметрыКоманды.Свойство("БлокироватьСообщенияОбОшибках") Тогда
			ПараметрыТикета.Вставить("БлокироватьСообщенияОбОшибках", ПараметрыКоманды.БлокироватьСообщенияОбОшибках);
		КонецЕсли;
		
		Тикет = ПолучитьНовыйТикет(СписокТикетов, Соединение, ПараметрыСоединения, ПараметрыТикета, Отказ);
		Если Отказ Тогда
			Возврат Неопределено;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Тикет) Тогда
		Возврат Тикет.Ключ;
	КонецЕсли;
	
КонецФункции

// Получение нового временного тикета в сервисе.
//
Функция ПолучитьНовыйТикет(СписокТикетов, Соединение, ПараметрыСоединения, ПараметрыТикета, Отказ)
	
	ИдентификаторПрограммы = Base64Строка(ПолучитьДвоичныеДанныеИзСтроки(
		ПараметрыСоединения.ИдентификаторПрограммы + ":"));
	ТребуетсяПолноеОбновлениеТикета = Истина;
	
	
	Если Не ЗначениеЗаполнено(СписокТикетов) Тогда
		СписокТикетов = Новый Соответствие;
	КонецЕсли;
	Тикет = СписокТикетов.Получить(ПараметрыТикета.Права);
	
	Если ЗначениеЗаполнено(Тикет) Тогда
		
		АдресРесурса = "oauth/token?grant_type=refresh_token&refresh_token=" + Тикет.КлючОбновления;
		
		Попытка
			Запрос = Новый HTTPЗапрос(АдресРесурса);
			Запрос.Заголовки.Вставить("Authorization", "Basic " + ИдентификаторПрограммы);
			Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
		Исключение
			Отказ = Истина;
			ВидОперации = НСтр("ru = 'Получение тикета'");
			ТекстОшибки = НСтр("ru = 'Ошибка соединения с сервисом 1С:Бизнес-сеть.'");
			ПодробныйТекстОшибки = ТекстОшибки + Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстОшибки, "БизнесСеть");
		КонецПопытки;
		
		Если Отказ Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Если Ответ.КодСостояния = 200 Тогда
			// Еще не истек срок жизни refresh-token.
			ТребуетсяПолноеОбновлениеТикета = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ТребуетсяПолноеОбновлениеТикета Тогда
		
		АдресРесурса = "oauth/token?grant_type=password&username=" + ПараметрыТикета.Логин
			+ "&password=" + КодироватьСтроку(ПараметрыТикета.Пароль, СпособКодированияСтроки.КодировкаURL);
		Попытка
			
			Запрос = Новый HTTPЗапрос(АдресРесурса);
			Запрос.Заголовки.Вставить("Authorization", "Basic " + ИдентификаторПрограммы);
			
			Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
			
		Исключение
			
			Отказ = Истина;
			ВидОперации = НСтр("ru = 'Получение тикета'");
			ТекстОшибки = НСтр("ru = 'Ошибка соединения с сервисом 1С:Бизнес-сеть.'");
			ПодробныйТекстОшибки = ТекстОшибки + Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстОшибки, "БизнесСеть");
			
		КонецПопытки;
		
	КонецЕсли;
	
	ТелоСтрокой = Ответ.ПолучитьТелоКакСтроку();
	
	Если Отказ Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Результат = ЗначениеИзСтрокиJSON(ТелоСтрокой);
	
	Если Ответ.КодСостояния <> 200 Тогда
		Отказ = Истина;
		ВидОперации = НСтр("ru = 'Аутентификация'");
		ТекстОшибки = НСтр("ru = 'Ошибка аутентификации в сервисе 1С:Бизнес-сеть.'");
		ПодробныйТекстОшибки = ТекстОшибки + Символы.ПС + СтрШаблон(НСтр("ru = 'Код состояния: %1.'"), Ответ.КодСостояния);
		Если ТипЗнч(Результат) = Тип("Структура") И Результат.Свойство("error_description") Тогда
			ПодробныйТекстОшибки = ПодробныйТекстОшибки + Символы.ПС + Результат.error_description;
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	Тикет = Новый Структура;
	Тикет.Вставить("Ключ", Результат.access_token);
	Тикет.Вставить("СрокЖизни", ТекущаяУниверсальнаяДатаВМиллисекундах() + Результат.expires_in * 1000);
	Тикет.Вставить("КлючОбновления", Результат.refresh_token);
	СписокТикетов[ПараметрыТикета.Права] = Тикет;
	
	УстановитьПривилегированныйРежим(Истина);
	ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(Пользователи.ТекущийПользователь(), СписокТикетов, "БизнесСетьСписокТикетов");
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат Тикет;
	
КонецФункции

Процедура УдалитьТикеты()
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Очистка тикетов.
	Пользователь = Пользователи.ТекущийПользователь();
	ОбщегоНазначения.УдалитьДанныеИзБезопасногоХранилища(Пользователь, "БизнесСетьСписокТикетов");
	ОбщегоНазначения.УдалитьДанныеИзБезопасногоХранилища(Пользователь, "ТорговыеПредложенияТикет");
		
КонецПроцедуры

#КонецОбласти

#Область ПараметрыКоманд

// Параметры команды проверки регистрации контрагентов.
//
// Параметры:
//  ПараметрыМетода	 - Структура - состав:
//    * СписокКонтрагентов - Массив из ОпределяемыйТип.КонтрагентБЭД - список контрагентов.
//  Отказ			 - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыПроверкаКонтрагентов(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	ДанныеКонтрагентов = Новый ТаблицаЗначений;
	ДанныеКонтрагентов.Колонки.Добавить("Ссылка");
	ДанныеКонтрагентов.Колонки.Добавить("ИНН", Новый ОписаниеТипов("Строка"));
	ДанныеКонтрагентов.Колонки.Добавить("КПП", Новый ОписаниеТипов("Строка"));
	Для каждого ЭлементСписка Из ПараметрыМетода.СписокКонтрагентов Цикл
		НоваяСтрока = ДанныеКонтрагентов.Добавить();
		НоваяСтрока.Ссылка = ЭлементСписка;
	КонецЦикла;
	
	ЗаполнитьРеквизитыКонтрагентов(ДанныеКонтрагентов);
	
	// Формирование данных.
	ДанныеЗапроса = Новый Массив;
	Для каждого РеквизитыКонтрагента Из ДанныеКонтрагентов Цикл
		
		ТекстОшибки = "";
		Идентификаторы = ИдентификаторыУчастника(РеквизитыКонтрагента.ИНН, РеквизитыКонтрагента.КПП,
			РеквизитыКонтрагента.Ссылка, Отказ, ТекстОшибки);
		Если Отказ Тогда
			ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
			Прервать;
		КонецЕсли;

		ЭлементЗапроса = Новый Структура;
		ЭлементЗапроса.Вставить("inn", Идентификаторы.ИНН);
		ЭлементЗапроса.Вставить("kpp", Идентификаторы.КПП);
		ДанныеЗапроса.Добавить(ЭлементЗапроса);
		
	КонецЦикла;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Проверка регистрации контрагента'");
	ПараметрыКоманды.Адрес  = "api/core/v1/organizations/existence";
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = ЗначениеВJSON(ДанныеЗапроса);
	ПараметрыКоманды.Ошибки.Вставить(400, НСтр("ru = 'Ошибочное значение ИНН или КПП.'"));
	
	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды получения документов
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//    * МассивСсылокНаОбъект    - Массив из Строка - идентификаторы документов сервиса.
//                              - Массив из ДокументСсылка - ссылки на документы.
//    * РежимВходящихДокументов - Булево - Истина для получения входящих документов, Ложь для исходящих.
//    * ВозвращатьДанные        - Булево - признак передачи данных документов.
//  Отказ           - Булево - признак ошибки.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса
//
Функция ПараметрыКомандыПолучитьДокументы(ПараметрыМетода, Пропускать404, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
		
	ИдентификаторыДокументов = Новый Соответствие;
	Если ПараметрыМетода.Свойство("МассивСсылокНаОбъект") Тогда
		МассивДокументов = Новый Массив;
		
		Для каждого ЗначениеМассива Из ПараметрыМетода.МассивСсылокНаОбъект Цикл
			Если ТипЗнч(ЗначениеМассива) = Тип("Число") Или ТипЗнч(ЗначениеМассива) = Тип("Строка") Тогда
				УникальныйИдентификатор = ЗначениеМассива;
			Иначе
				УникальныйИдентификатор = Строка(ЗначениеМассива.УникальныйИдентификатор());
			КонецЕсли;
			МассивДокументов.Добавить(УникальныйИдентификатор);
			ИдентификаторыДокументов.Вставить(УникальныйИдентификатор, ЗначениеМассива);
		КонецЦикла;
		Данные = ЗначениеВJSON(МассивДокументов);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыМетода.Вставить("ИдентификаторыДокументов", ИдентификаторыДокументов);
	
	Адрес = СтрШаблон("api/edi/v1/documents/byIdOrGuid?direction=%1",
		?(ПараметрыМетода.РежимВходящихДокументов, "INBOUND", "OUTBOUND"));
	Если ПараметрыМетода.Свойство("ВозвращатьДанные") Тогда
		Адрес = Адрес + СтрШаблон("&withData=%1", Формат(ПараметрыМетода.ВозвращатьДанные, "БЛ=false; БИ=true"));
	КонецЕсли;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Получение документов по списку'");
	ПараметрыКоманды.Адрес  = Адрес;
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = Данные;
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав на получение документа.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, Пропускать404);
	
	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды удаления документов.
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//    * Организация              - ОпределяемыйТип.Организация - ссылка на организация.
//                               - Структура - реквизиты организации:
//                                   ** ИНН           - Строка - ИНН организации.
//                                   ** КПП           - Строка - КПП организации.
//                                   ** Наименование  - Строка - наименование организации.
//                                   ** Идентификатор - Строка - идентификатор организации в сервисе.
//    * РежимИсходящихДокументов - Булево - удаление среди входящих или исходящих документов.
//    * ИдентификаторыДокументов - Массив из Строка - список идентификаторов документов.
//  Отказ           - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыУдалитьДокументы(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	Если ТипЗнч(ПараметрыМетода.Организация) = Тип("Структура") Тогда
		РеквизитыОрганизации = ПараметрыМетода.Организация;
	Иначе
		РеквизитыОрганизации = Неопределено;
		ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Организация, РеквизитыОрганизации);
	КонецЕсли;
	Адрес = "api/edi/v1/organizations/%1/%2/documents?direction=%3";
	
	ТекстОшибки = "";
	Идентификаторы = ИдентификаторыУчастника(РеквизитыОрганизации.ИНН, РеквизитыОрганизации.КПП,
		ПараметрыМетода.Организация, Отказ, ТекстОшибки);

	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка удаления документов в 1С:Бизнес-сеть:'") + " " + ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыКоманды.Адрес = СтрШаблон(Адрес, Идентификаторы.ИНН, Идентификаторы.КПП,
		?(ПараметрыМетода.РежимИсходящихДокументов, "OUTBOUND", "INBOUND"));
		
	ПараметрыКоманды.Наименование = НСтр("ru = 'Удаление документов в сервисе'");
	ПараметрыКоманды.Метод = "POST";
	ПараметрыКоманды.Права = "bn_user";
	ПараметрыКоманды.Данные = ЗначениеВJSON(ПараметрыМетода.ИдентификаторыДокументов);
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав на документ.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Организация или документ в сервисе не найден.'"));

	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды изменения статусов документов.
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//    * МассивДанных - Массив из Структура - где:
//      ** Идентификатор - Строка - идентификатор документа.
//      ** Ссылка        - Ссылка - ссылка документа.
//    * Статус       - Строка - новый статус "Загружен", "Отклонен".
//  Отказ           - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыИзменитьСтатусыДокументов(ПараметрыМетода, Отказ = Неопределено) Экспорт
	
	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	Данные = Неопределено;
	Если ПараметрыМетода.Свойство("МассивДанных") Тогда
		
		МассивДокументов = Новый Массив;
		Для каждого ЗначениеМассива Из ПараметрыМетода.МассивДанных Цикл
			СтруктураСтатуса = Новый Структура;
			СтруктураСтатуса.Вставить("id", ЗначениеМассива.Идентификатор);
			Если ВРег(ПараметрыМетода.Статус) = ВРег("Отклонен") Тогда
				Если ЗначениеЗаполнено(ЗначениеМассива.Ссылка) Тогда
					СтруктураСтатуса.Вставить("documentGuid", Строка(ЗначениеМассива.Ссылка.УникальныйИдентификатор()));
				КонецЕсли;
				СтруктураСтатуса.Вставить("metaData", НСтр("ru = 'Дата отклонения:'") + ТекущаяДатаСеанса());
				СтруктураСтатуса.Вставить("deliveryStatus", "REJECTED");
			Иначе // По умолчанию статус "Загружен".
				СтруктураСтатуса.Вставить("documentGuid", Строка(ЗначениеМассива.Ссылка.УникальныйИдентификатор()));
				СтруктураСтатуса.Вставить("metaData", НСтр("ru = 'Дата загрузки:'") + ТекущаяДатаСеанса());
				СтруктураСтатуса.Вставить("deliveryStatus", "DELIVERED");
			КонецЕсли;
			МассивДокументов.Добавить(СтруктураСтатуса);
		КонецЦикла;
		Данные = ЗначениеВJSON(МассивДокументов);
		
	КонецЕсли;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Изменение статусов документов'");
	ПараметрыКоманды.Адрес  = "api/edi/v1/documents/status";
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = Данные;
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав доступа или документ в сервисе не найден.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Документ в сервисе не найден.'"));
	
	Возврат ПараметрыКоманды;
	
КонецФункции

// Параметры команды отправки приглашений контрагентам.
//
// Параметры:
//  ПараметрыМетода	 - Структура - состав:
//   * Организация     - Ссылка - организация отправитель приглашения.
//   * Данные          - ТаблицаЗначений - список данных приглашаемых контрагентов:
//     ** ИНН          - Строка - ИНН контрагента.
//     ** КПП          - Строка - КПП контрагента.
//     ** Наименование - Строка - наименование контрагента.
//   * РольОтправителя - Строка - "Продавец", "Покупатель"
//  Отказ			 - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыОтправкаПриглашенийКонтрагентам(ПараметрыМетода, Отказ = Неопределено) Экспорт
	
	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	РеквизитыОрганизации = Неопределено; 
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Организация, РеквизитыОрганизации);
	
	СписокПриглашений = Новый Массив;
	ТекстОшибки = "";
	Для каждого РеквизитыКонтрагента Из ПараметрыМетода.Данные Цикл
		ДанныеПриглашения = Новый Структура;
		
		Идентификаторы = ИдентификаторыУчастника(РеквизитыКонтрагента.ИНН, РеквизитыКонтрагента.КПП,
			РеквизитыКонтрагента.Наименование, Отказ, ТекстОшибки);
			
		Если Отказ Тогда
			ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
				НСтр("ru = 'Ошибка отправки приглашения в 1С:Бизнес-сеть:'") + " " + ТекстОшибки, "БизнесСеть");
			Возврат Неопределено;
		КонецЕсли;
		
		ДанныеПриглашения.Вставить("inn",   Идентификаторы.ИНН);
		ДанныеПриглашения.Вставить("kpp",   Идентификаторы.КПП);
		ДанныеПриглашения.Вставить("title", РеквизитыКонтрагента.Наименование);
		ДанныеПриглашения.Вставить("email", РеквизитыКонтрагента.ЭлектроннаяПочта);
		СписокПриглашений.Добавить(ДанныеПриглашения);
	КонецЦикла;
	
	Если ПараметрыМетода.РольОтправителя = "Продавец" Тогда
		РольОтправителя = "shipper";
	ИначеЕсли ПараметрыМетода.РольОтправителя = "Покупатель" Тогда
		РольОтправителя = "customer";
	Иначе
		РольОтправителя = "general";
	КонецЕсли;
	
	ТекстОшибки = "";
	Идентификаторы = ИдентификаторыУчастника(РеквизитыОрганизации.ИНН, РеквизитыОрганизации.КПП,
		ПараметрыМетода.Организация, Отказ, ТекстОшибки);
		
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;

	Адрес = СтрШаблон("api/core/v1/organization/%1/%2/invitations?role=%3",
		Идентификаторы.ИНН, Идентификаторы.КПП, РольОтправителя);
		
	ПараметрыКоманды.Наименование = НСтр("ru = 'Отправка приглашений контрагентам для регистрации в сервисе'");
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Адрес  = Адрес;
	ПараметрыКоманды.Данные = ЗначениеВJSON(СписокПриглашений);
	ПараметрыКоманды.Ошибки.Вставить(400, НСтр("ru = 'Превышено максимальное количество приглашений или ошибка параметров.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав для отправки приглашения.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найдена организация в сервисе.'"));
	
	Возврат ПараметрыКоманды;
	
КонецФункции

// Параметры команды отправки приглашения контрагенту.
//
// Параметры:
//  ПараметрыМетода	 - Структура - состав:
//   * Организация      - Ссылка - организация отправитель приглашения.
//   * Контрагент       - Ссылка - контрагент получатель приглашения.
//   * ЭлектроннаяПочта - Строка - адрес электронной почты контрагента для отправки приглашения.
//  Отказ			 - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыОтправкаПриглашения(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
		
	ПараметрыОрганизации = Неопределено;
	ПараметрыКонтрагента = Неопределено;
	
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Организация, ПараметрыОрганизации);
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Контрагент,  ПараметрыКонтрагента);
	
	Если Не ЗначениеЗаполнено(ПараметрыМетода.ЭлектроннаяПочта) Тогда
		ОбщегоНазначения.СообщитьПользователю(НСтр("ru = 'Не указан адрес электронной почты контрагента.'")
			+ " " + ПараметрыМетода.Контрагент,,,, Отказ);
		Возврат Неопределено;
	КонецЕсли;
	
	ТекстОшибки = "";
	ИдентификаторыОрганизации = ИдентификаторыУчастника(ПараметрыОрганизации.ИНН,
		ПараметрыОрганизации.КПП, ПараметрыМетода.Организация, Отказ, ТекстОшибки);
	ИдентификаторыКонтрагента = ИдентификаторыУчастника(ПараметрыКонтрагента.ИНН,
		ПараметрыКонтрагента.КПП, ПараметрыМетода.Контрагент, Отказ, ТекстОшибки);
		
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка отправки приглашения в 1С:Бизнес-сеть:'") + " " + ТекстОшибки, "БизнесСеть");
	КонецЕсли;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Отправка приглашения регистрации в сервисе'");
	Адрес = СтрШаблон("api/core/v1/organizations/%1/%2/invitation?dstEmail=%3&dstTitle=%4&srcInn=%5&srcKpp=%6",
		ИдентификаторыКонтрагента.ИНН, ИдентификаторыКонтрагента.КПП,
		ПараметрыМетода.ЭлектроннаяПочта,
		КодироватьСтроку(ПараметрыКонтрагента.ОфициальноеНаименование, СпособКодированияСтроки.КодировкаURL),
		ИдентификаторыОрганизации.ИНН, ИдентификаторыОрганизации.КПП);
	ПараметрыКоманды.Адрес = Адрес;
	ПараметрыКоманды.Метод = "POST";
	ПараметрыКоманды.Права = "bn_user";
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав для отправки приглашения.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найдена организация в сервисе.'"));
	
	Возврат ПараметрыКоманды;
	
КонецФункции

Функция ПараметрыКомандыПолучениеКлюча(ПараметрыМетода, Отказ = Неопределено)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	ПараметрыКоманды.Вставить("Логин");
	ПараметрыКоманды.Вставить("Пароль");
	ПараметрыКоманды.Наименование = НСтр("ru = 'Получение тикета'");
	
	Если ПараметрыМетода.Права = "bn_its" Тогда
		
		Если ОбщегоНазначения.РазделениеВключено() Тогда
			УстановитьПривилегированныйРежим(Истина);
			ДанныеАутентификации = ИнтернетПоддержкаПользователей.ТикетАутентификацииНаПорталеПоддержки("1c-bn-access");
			УстановитьПривилегированныйРежим(Ложь);
			Если ЗначениеЗаполнено(ДанныеАутентификации.КодОшибки) Тогда
				Если ДанныеАутентификации.КодОшибки = "НеверныйЛогинИлиПароль" Тогда
					Отказ = Истина;
				КонецЕсли;
				ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось подключиться к порталу интернет-поддержки по причине:
					           |%1'"),
					ДанныеАутентификации.СообщениеОбОшибке);
					
					Если ПараметрыМетода.Свойство("БлокироватьСообщенияОбОшибках")
									И ПараметрыМетода.БлокироватьСообщенияОбОшибках = Истина Тогда
						
						Отказ = Истина;
						
					Иначе
						
						ОбщегоНазначения.СообщитьПользователю(ОписаниеОшибки,,,, Отказ);
						
					КонецЕсли;
					
				Возврат Неопределено;
			КонецЕсли;
			ПараметрыКоманды.Логин  = "AUTH_TOKEN";
			ПараметрыКоманды.Пароль = ДанныеАутентификации.Тикет;
			
		Иначе
			УстановитьПривилегированныйРежим(Истина);
			ПараметрыАутентификации = ИнтернетПоддержкаПользователей.ДанныеАутентификацииПользователяИнтернетПоддержки();
			УстановитьПривилегированныйРежим(Ложь);
			Если ТипЗнч(ПараметрыАутентификации) = Тип("Структура") Тогда
				ПараметрыКоманды.Логин  = ПараметрыАутентификации.Логин;
				ПараметрыКоманды.Пароль = ПараметрыАутентификации.Пароль;
			Иначе
				ТекстОшибки = НСтр("ru = 'Отсутствует подключение к Интернет-поддержке пользователей.'");
				ТекстСообщения = ТекстОшибки + БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации();
				Если ПараметрыМетода.Свойство("БлокироватьСообщенияОбОшибках")
								И ПараметрыМетода.БлокироватьСообщенияОбОшибках = Истина Тогда
					Отказ = Истина;
				Иначе
					ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,, Отказ);
				КонецЕсли;
				ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
					ТекстОшибки, "БизнесСеть");

			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ПараметрыМетода.Свойство("АдминистраторАбонента") Тогда
		
		ПараметрыКоманды.Логин  = ПараметрыМетода.АдминистраторАбонента.Логин;
		ПараметрыКоманды.Пароль = ПараметрыМетода.АдминистраторАбонента.Пароль;
		
	ИначеЕсли ПараметрыМетода.Права = "bn_user" Тогда
		
		СтруктураИдентификации = ПараметрыАутентификацииПользователя();
		Если СтруктураИдентификации <> Неопределено Тогда
			ПараметрыКоманды.Логин  = СтруктураИдентификации.Логин;
			ПараметрыКоманды.Пароль = СтруктураИдентификации.Пароль;
		Иначе
			Если ОрганизацияЗарегистрирована() Тогда
				
				ТекстОшибки = НСтр("ru = 'Недостаточно прав для работы с сервисом 1С:Бизнес-сеть.
										 |Обратитесь к администратору.'");
				
			Иначе
				ТекстОшибки = НСтр("ru = 'Отсутствуют зарегистрированные организации в сервисе 1С:Бизнес-сеть.'");
			КонецЕсли;
			ТекстСообщения = ТекстОшибки + БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации();
			ТекстОшибки = НСтр("ru = 'Ошибка аутентификации в сервисе.'") + Символы.ПС + ТекстОшибки;
			
			Если ПараметрыМетода.Свойство("БлокироватьСообщенияОбОшибках")
						И ПараметрыМетода.БлокироватьСообщенияОбОшибках = Истина Тогда
				
				Отказ = Истина;
				
			Иначе
				
				ОбщегоНазначения.СообщитьПользователю(ТекстОшибки,,,, Отказ);
				
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
					ТекстОшибки, "БизнесСеть");
		
		КонецЕсли;
		
	КонецЕсли;

	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыПроверкаРегистрацииАбонента()

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	ПараметрыКоманды.Наименование = НСтр("ru = 'Проверка регистрации в сервисе'");
	ПараметрыКоманды.Адрес = "api/core/v1/subscribers/existence";
	ПараметрыКоманды.Метод = "GET";
	ПараметрыКоманды.Права = "bn_its";
		
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыРегистрацияАбонента(ПараметрыМетода, Отказ)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	ПараметрыКоманды.Наименование = НСтр("ru = 'Регистрация организации в сервисе 1С:Бизнес-сеть'");
	ПараметрыКоманды.Адрес  = "api/core/v1/subscribers";
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Данные = СформироватьДанныеРегистрацииАбонента(ПараметрыМетода, Отказ);
	ПараметрыКоманды.Права  = "bn_its";
	ПараметрыКоманды.Вставить("Идентификатор", ПараметрыМетода.ИдентификаторПрограммы);
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Ошибка регистрации организации в сервисе.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав для регистрации в сервисе.'"));
	
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыПолучитьСписокАбонентов()

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	ПараметрыКоманды.Наименование = НСтр("ru = 'Запрос списка абонентов'");
	ПараметрыКоманды.Адрес = "api/core/v1/subscribers?withAdministrativePermissionsOnly=true";
	ПараметрыКоманды.Метод = "GET";
	ПараметрыКоманды.Права = "bn_user";
	
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыРегистрацияОрганизации(ПараметрыМетода, Отказ)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	РеквизитыОрганизации = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Организация, РеквизитыОрганизации);
	
	ТекстОшибки = "";
	Идентификаторы = ИдентификаторыУчастника(РеквизитыОрганизации.ИНН, РеквизитыОрганизации.КПП,
		ПараметрыМетода.Организация, Отказ, ТекстОшибки);
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка регистрации организации в 1С:Бизнес-сеть:'") + " "+ ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеОрганизации = Новый Структура;
	ДанныеОрганизации.Вставить("inn", Идентификаторы.ИНН);
	ДанныеОрганизации.Вставить("kpp", Идентификаторы.КПП);
	
	Если РеквизитыОрганизации.Свойство("СокращенноеНаименование") Тогда
		НаименованиеОрганизации = РеквизитыОрганизации.СокращенноеНаименование;
	Иначе
		НаименованиеОрганизации = РеквизитыОрганизации.ПолноеНаименование;
	КонецЕсли;
	Если ПустаяСтрока(НаименованиеОрганизации) Тогда
		Отказ = Истина;
		ТекстОшибки = НСтр("ru = 'Не заполнено наименование организации.'");
		ПодробныйТекстОшибки = ТекстОшибки + Символы.ПС + ПараметрыКоманды.Адрес + Символы.ПС
			+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Регистрация организации'"),
			ПодробныйТекстОшибки, ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	ДанныеОрганизации.Вставить("title", НаименованиеОрганизации);
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Регистрация организации'");
	ПараметрыКоманды.Адрес  = СтрШаблон("api/core/v1/subscribers/%1/organizations",
		Формат(ПараметрыМетода.Абонент, "ЧГ="));
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Данные = ЗначениеВJSON(ДанныеОрганизации);
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Ошибка регистрации организации.'"));
	
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыСинхронизацияПользователей(ПараметрыМетода)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	ПараметрыКоманды.Наименование = НСтр("ru = 'Синхронизация пользователей в сервисе'");
	ПараметрыКоманды.Адрес  = СтрШаблон("api/core/v1/subscribers/subscriberMembers/sync?endpointGuid=%1",
		ПараметрыМетода.ИдентификаторПрограммы);
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Данные = ПараметрыМетода.Данные;
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найдена учетная запись для программы.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав для выполнения операции.'"));
	ПараметрыКоманды.Ошибки.Вставить(400, НСтр("ru = 'Пользователь принадлежит другой учетной записи.'"));

	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыПроверкаОрганизации(ПараметрыМетода, Отказ)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	ТекстОшибки = "";
	Идентификаторы = ИдентификаторыУчастника(ПараметрыМетода.ИНН, ПараметрыМетода.КПП,
		ПараметрыМетода.Ссылка, Отказ, ТекстОшибки);
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			НСтр("ru = 'Ошибка проверки организации при регистрации в 1С:Бизнес-сеть:'") + " " + ТекстОшибки, "БизнесСеть");
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеЗапроса = Новый Массив;
	
	СтруктураТела = Новый Структура;
	СтруктураТела.Вставить("inn", Идентификаторы.ИНН);
	СтруктураТела.Вставить("kpp", Идентификаторы.КПП); //+
	ДанныеЗапроса.Добавить(СтруктураТела);
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Проверка регистрации организации'");
	ПараметрыКоманды.Адрес  = "api/core/v1/organizations/existence";
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = ЗначениеВJSON(ДанныеЗапроса);
	ПараметрыКоманды.Ошибки.Вставить(400, НСтр("ru = 'Ошибочное значение ИНН или КПП.'"));
		
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыОбновитьСтатус(ПараметрыМетода)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	Если ПараметрыМетода.Свойство("МассивДанных") Тогда
		МассивДокументов = Новый Массив;
		Для каждого ЭлементМассива Из ПараметрыМетода.МассивДанных Цикл
			СтруктураСтатуса = Новый Структура;
			СтруктураСтатуса.Вставить("id", ЭлементМассива.Идентификатор);
			СтруктураСтатуса.Вставить("documentGuid", Строка(ЭлементМассива.Ссылка.УникальныйИдентификатор()));
			СтруктураСтатуса.Вставить("metaData", НСтр("ru = 'Дата загрузки:'") + ТекущаяДатаСеанса());
			МассивДокументов.Добавить(СтруктураСтатуса);
		КонецЦикла;
		Данные = ЗначениеВJSON(МассивДокументов);
	КонецЕсли;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Обновление статуса документа'");
	ПараметрыКоманды.Адрес  = "api/edi/v1/documents/statusDelivered";
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = Данные;
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав доступа или документ в сервисе не найден.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Документ в сервисе не найден.'"));
		
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыОбновитьИдентификаторПрограммы(ПараметрыМетода)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	Данные = Новый Структура;
	Данные.Вставить("title",        Метаданные.Синоним);
	Данные.Вставить("endpointGUID", ПараметрыМетода.ИдентификаторПрограммы);
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Обновление идентификатора программы'");
	ПараметрыКоманды.Адрес  = "api/core/v1/endpoint";
	ПараметрыКоманды.Метод  = "PUT";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = ЗначениеВJSON(Данные);
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найден идентификатор программы.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав доступа для изменения идентификатора программы.'"));
	
	Возврат ПараметрыКоманды;

КонецФункции

Функция ПараметрыКомандыОтправитьУведомлениеОбОтправке(ПараметрыМетода)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	РеквизитыКонтрагента = Неопределено; 
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Получатель, РеквизитыКонтрагента);
	
	Адрес = "api/core/v1/organization/invitation/?dstEmail=%1&dstTitle=%2&attachDoc=true";
	ПараметрыКоманды.Наименование = НСтр("ru = 'Отправка уведомления об отправке документа'");
	ПараметрыКоманды.Адрес = СтрШаблон(Адрес, ПараметрыМетода.ЭлектроннаяПочта,
		КодироватьСтроку(РеквизитыКонтрагента.ОфициальноеНаименование, СпособКодированияСтроки.КодировкаURL));
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Права  = "bn_user";
	ПараметрыКоманды.Данные = ЗначениеВJSON(ПараметрыМетода.МассивИдентификаторов);
	ПараметрыКоманды.Ошибки.Вставить(400, НСтр("ru = 'Ошибка формирования приглашений.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав доступа к документу в сервисе.'"));
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найден документ в сервисе.'"));

	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды удаления организации.
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//   * СписокОрганизаций - Массив из Структура - ссылки на отключаемые организации, где.
//     ** ИНН           - Строка - ИНН организации.
//     ** ИНН           - Строка - КПП организации.
//     ** Наименование  - Строка - наименование организации.
//     ** Идентификатор - Строка - идентификатор организации.
//  Отказ           - Булево - ошибка выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыУдаленияОрганизации(ПараметрыМетода, Отказ)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	ТаблицаОрганизаций = Новый ТаблицаЗначений;
	ТаблицаОрганизаций.Колонки.Добавить("Источник");
	ТаблицаОрганизаций.Колонки.Добавить("ИНН", Новый ОписаниеТипов("Строка"));
	ТаблицаОрганизаций.Колонки.Добавить("КПП", Новый ОписаниеТипов("Строка"));
	Для каждого ЗначениеМассива Из ПараметрыМетода.СписокОрганизаций Цикл
		НоваяСтрока = ТаблицаОрганизаций.Добавить();
		Если ТипЗнч(ЗначениеМассива) = Тип("Структура") Тогда
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ЗначениеМассива);
			НоваяСтрока.Источник = ЗначениеМассива.Наименование;
		Иначе
			Сведения = Неопределено;
			ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ЗначениеМассива, Сведения);
			НоваяСтрока.Источник = ЗначениеМассива;
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Сведения);
		КонецЕсли;
	КонецЦикла;
	
	Данные = Новый Массив;
	Для каждого СтрокаТаблицы Из ТаблицаОрганизаций Цикл
		ДанныеОрганизации = Новый Структура;
		
		ТекстОшибки = "";
		Идентификаторы = ИдентификаторыУчастника(СтрокаТаблицы.ИНН, СтрокаТаблицы.КПП,
			СтрокаТаблицы.Источник, Отказ, ТекстОшибки);
		Если Отказ Тогда
			ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
				НСтр("ru = 'Ошибка удаления организации в 1С:Бизнес-сеть:'") + " "+ ТекстОшибки, "БизнесСеть");
			Возврат Неопределено;
		КонецЕсли;

		ДанныеОрганизации.Вставить("inn", Идентификаторы.ИНН);
		ДанныеОрганизации.Вставить("kpp", Идентификаторы.КПП);

		Данные.Добавить(ДанныеОрганизации);
	КонецЦикла;
	
	ПараметрыКоманды.Наименование = НСтр("ru = 'Удаление организации из сервиса'");
	ПараметрыКоманды.Адрес = "api/core/v1/organizations/delete";
	ПараметрыКоманды.Метод = "POST";
	ПараметрыКоманды.Данные = ЗначениеВJSON(Данные);
	ПараметрыКоманды.Права = "bn_user";
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Организация не найдена.'"));
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав для удаления организации.'"));
	
	Возврат ПараметрыКоманды;

КонецФункции

// Параметры команды проверки прав организации.
//
// Параметры:
//  ПараметрыМетода	- Структура - состав:
//    * Организация                 - Ссылка - организация.
//  Отказ			 - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыПроверкиПравОрганизации(ПараметрыМетода, Отказ = Неопределено)

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	ПараметрыОрганизации = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ПараметрыМетода.Организация, ПараметрыОрганизации);
	Идентификаторы = ИдентификаторыУчастника(ПараметрыОрганизации.ИНН, ПараметрыОрганизации.КПП);
	
	ДатаСинхронизации = КонецГода(ТекущаяДатаСеанса()); // Для проверки достаточно указать будущую дату.
	
	ПараметрыКоманды.Адрес = СтрШаблон("api/edi/v1/organizations/%1/%2/documents?fromTime=%3",
		Идентификаторы.ИНН, Идентификаторы.КПП,	Формат(ДатаСинхронизации, "ДФ=dd-MM-yyyy-HH-mm-ss"));
		
	ПараметрыКоманды.Метод = "GET";
	ПараметрыКоманды.Ошибки.Вставить(404, НСтр("ru = 'Не найдена организация в сервисе 1С:Бизнес-сеть.'"));
		
	ПараметрыКоманды.Наименование = НСтр("ru = 'Проверка прав организации'");
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Ошибка регистрации организации в сервисе 1С:Бизнес-сеть.
		|Возможно организация зарегистрирована под другой учетной записью.'"));
		
	ПараметрыКоманды.Права = "bn_user";
	
	Возврат ПараметрыКоманды;
	
КонецФункции

// Параметры команды получения списка входящих документов.
//
// Параметры:
//  ПараметрыМетода - Структура - состав:
//    * Организация    - Ссылка - организация (используется для проверки прав).
//    * Контрагент     - Ссылка - ссылка на отбор по контрагенту.
//    * ВидДокумента   - Строка - вид документа отбора, например "ЗаказТовара", см. ВидыДокументовСервиса.
//    * ТолькоНовые    - Булево - режим получения только незагруженных электронных документов.
//    * ДатаНачала     - Дата   - начало выборки.
//    * ДатаОкончания  - Дата   - окончание выборки.
//    * РежимИсходящихДокументов - Булево - режим получения исходящих документов.
//    * Страница       - Число - номер страницы запрашиваемой в сервисе.
//    * РазмерСтраницы - Число - количество записей в странице.
//  Отказ - Булево - признак ошибки выполнения.
// 
// Возвращаемое значение:
//  Структура - см. ОписаниеПараметровКомандыСервиса.
//
Функция ПараметрыКомандыСписокВходящихДокументов(ПараметрыМетода, Отказ = Неопределено) Экспорт

	ПараметрыКоманды = ОписаниеПараметровКомандыСервиса();
	
	// Ограничение списка организаций по переданному параметру.
	Если ПараметрыМетода.Свойство("Организация") Тогда
		СписокОрганизаций = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрыМетода.Организация);
	Иначе
		СписокОрганизаций = ЗарегистрированныеОрганизации();
		Если СписокОрганизаций.Количество() = 0 Тогда
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Информационная база не подключена к сервису 1С:Бизнес-сеть.'"),,,, Отказ);
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;

	РеквизитыОрганизации = Неопределено;
	
	МассивСтруктурыДанных = Новый Массив;
	Для каждого ЗначениеМассива Из СписокОрганизаций Цикл
		
		ТекстОшибки = "";
		
		Если ТипЗнч(ЗначениеМассива) = Тип("Структура") Тогда
			Идентификаторы = ИдентификаторыУчастника(ЗначениеМассива.ИНН, ЗначениеМассива.КПП,
				ЗначениеМассива.Наименование, Отказ, ТекстОшибки);
		Иначе
			Если Не ЗначениеЗаполнено(РеквизитыОрганизации) Тогда
				РеквизитыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъектов(СписокОрганизаций, "ИНН, КПП");
			КонецЕсли;
			
			Идентификаторы = ИдентификаторыУчастника(РеквизитыОрганизации.Получить(ЗначениеМассива).ИНН,
				РеквизитыОрганизации.Получить(ЗначениеМассива).КПП, ЗначениеМассива, Отказ, ТекстОшибки);
			КонецЕсли;
			
		Если Отказ Тогда
			ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
				НСтр("ru = 'Ошибка чтения данных 1С:Бизнес-сеть по организации:'") + " "
				+ ТекстОшибки, "БизнесСеть");
			Возврат Неопределено;
		КонецЕсли;
		
		СтруктураДанных = Новый Структура;
		СтруктураДанных.Вставить("inn", Идентификаторы.ИНН);
		СтруктураДанных.Вставить("kpp", Идентификаторы.КПП);
		МассивСтруктурыДанных.Добавить(СтруктураДанных);
		
	КонецЦикла;
	
	Данные = ЗначениеВJSON(МассивСтруктурыДанных);
	
	ПараметрыЗапроса = Новый Структура;
	Если ПараметрыМетода.Свойство("Контрагент") Тогда
		РеквизитыКонтрагента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			ПараметрыМетода.Контрагент, "ИНН, КПП");
		ТекстОшибки = "";
		Идентификаторы = ИдентификаторыУчастника(РеквизитыКонтрагента.ИНН, РеквизитыКонтрагента.КПП,
			ПараметрыМетода.Контрагент, Отказ, ТекстОшибки);
		Если Отказ Тогда
			ОбщегоНазначения.СообщитьПользователю(ТекстОшибки);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
				НСтр("ru = 'Ошибка отбора по контрагенту при чтении документов 1С:Бизнес-сеть:'") + " "
				+ ТекстОшибки, "БизнесСеть");
			Возврат Неопределено;
		КонецЕсли;
		ПараметрыЗапроса.Вставить("senderInn", Идентификаторы.ИНН);
		ПараметрыЗапроса.Вставить("senderKpp", Идентификаторы.КПП);
	КонецЕсли;
	
	Если ПараметрыМетода.Свойство("ВидДокумента") Тогда
		ВидДокумента = КодироватьСтроку(XMLСтрока(ПараметрыМетода.ВидДокумента),
			СпособКодированияСтроки.КодировкаURL);
		ПараметрыЗапроса.Вставить("docType", "v8." + ВидДокумента);
	КонецЕсли;
	
	// Получение списка документов без данных.
	ПараметрыЗапроса.Вставить("withData", "false");

	Если ПараметрыМетода.Свойство("РежимИсходящихДокументов") Тогда
		ПараметрыЗапроса.Вставить("inbound", ?(ПараметрыМетода.РежимИсходящихДокументов,"false", "true"));
	КонецЕсли;
	
	Если ПараметрыМетода.Свойство("ТолькоНовые") Тогда
		ПараметрыЗапроса.Вставить("deliveryStatus", "SENT");
	КонецЕсли;
	
	Если ПараметрыМетода.Свойство("Страница") Тогда
		ПараметрыЗапроса.Вставить("page", ПараметрыМетода.Страница);
		ПараметрыЗапроса.Вставить("pageSize", ПараметрыМетода.РазмерСтраницы);
	КонецЕсли;
	
	Если ПараметрыМетода.Свойство("ДатаНачала") И ЗначениеЗаполнено(ПараметрыМетода.ДатаНачала) Тогда
		ПараметрыЗапроса.Вставить("fromTime ", Формат(ПараметрыМетода.ДатаНачала, "ДФ=dd-MM-yyyy-HH-mm-ss"));
	КонецЕсли;
	
	Если ПараметрыМетода.Свойство("ДатаОкончания") И ЗначениеЗаполнено(ПараметрыМетода.ДатаОкончания) Тогда
		ПараметрыЗапроса.Вставить("toTime ", Формат(ПараметрыМетода.ДатаОкончания, "ДФ=dd-MM-yyyy-HH-mm-ss"));
	КонецЕсли;
	
	СтрокаПараметровЗапроса = ПреобразоватьВСтрокуПараметровHTML(ПараметрыЗапроса);
	
	ПараметрыКоманды.Адрес  = СтрШаблон("api/edi/v1/organizations/documents%1", СтрокаПараметровЗапроса);
	ПараметрыКоманды.Метод  = "POST";
	ПараметрыКоманды.Данные = Данные;
	ПараметрыКоманды.Ошибки.Вставить(404, Истина);
		
	ПараметрыКоманды.Наименование = НСтр("ru = 'Получение списка документов'");
	ПараметрыКоманды.Ошибки.Вставить(403, НСтр("ru = 'Недостаточно прав на получение данных организации в сервисе 1С:Бизнес-сеть.'"));
	ПараметрыКоманды.Права = "bn_user";
	
	Возврат ПараметрыКоманды;
	
КонецФункции

#КонецОбласти

#Область ПреобразованиеДанных

// Формирует строку параметров для HTTP запроса в формате "?Параметр1=Значение1&Параметр2...".
//
// Параметры:
//   ПараметрыЗапроса - Структура - данные для строки, ключ - имя параметра, значение - устанавливаемое значение,
//                                  кириллические символы необходимо закодировать по алгоритму Base64.
//
Функция ПреобразоватьВСтрокуПараметровHTML(ПараметрыЗапроса)
	
	Результат = "";
	Для каждого ЭлементСтруктуры Из ПараметрыЗапроса Цикл
		Результат = Результат + ?(Результат = "", "?", "&") + ЭлементСтруктуры.Ключ + "=" + ЭлементСтруктуры.Значение;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Формирует данные JSON для регистрации абонента в сервисе.
//
// Параметры:
//   ПараметрыКоманды - Структура - данные заполнения.
//   Отказ - Булево - признак отказа выполнения.
//
// Возвращаемое значение:
//   Строка - данные из JSON.
//
Функция СформироватьДанныеРегистрацииАбонента(ПараметрыМетода, Отказ)
	
	ПараметрыАбонента = Новый Структура;
	ПараметрыАбонента.Вставить("title",                        Метаданные.Синоним);
	ПараметрыАбонента.Вставить("restrictAccessByOrganization", Ложь); // Контроль по организациям.
	ПараметрыАбонента.Вставить("restrictAccessByEndpoint",     Ложь); // Контроль по клиентам.
	
	ЛогинПользователя  = Строка(Новый УникальныйИдентификатор);
	ПарольПользователя = Строка(Новый УникальныйИдентификатор);
	
	ПараметрыМетода.Вставить("АдминистраторАбонента", Новый Структура("Пользователь, Логин, Пароль",
		Пользователи.ТекущийПользователь(), ЛогинПользователя, ПарольПользователя));
	
	УчетныеДанные = Новый Структура;
	УчетныеДанные.Вставить("firstName", Строка(Пользователи.ТекущийПользователь()));
	
	// Заполнение пользователя администратор абонента.
	ПользовательСистемы = Новый Структура;
	ПользовательСистемы.Вставить("type",    "AUTOGENERATED");
	ПользовательСистемы.Вставить("login",    ЛогинПользователя);
	ПользовательСистемы.Вставить("password", ПарольПользователя);
	
	Клиент = Новый Структура;
	Клиент.Вставить("endpointGUID", ПараметрыМетода.ИдентификаторПрограммы);
	Клиент.Вставить("title",        Метаданные.Синоним);
	
	СписокКлиентов = Новый Массив;
	СписокКлиентов.Добавить(Клиент);
	ПользовательСистемы.Вставить("endpoints", СписокКлиентов);
	
	СписокПользователей = Новый Массив;
	СписокПользователей.Добавить(ПользовательСистемы);
	УчетныеДанные.Вставить("personAccounts", СписокПользователей);
	
	СписокУчетныхДанных = Новый Массив;
	СписокУчетныхДанных.Добавить(УчетныеДанные);
	
	// Заполнение абонента.
	ПараметрыАбонента.Вставить("members", СписокУчетныхДанных);
	Данные = ЗначениеВJSON(ПараметрыАбонента);
	
	Возврат Данные;
	
КонецФункции

// Получение таблицы пользователей сервиса в информационной базе.
//
// Возвращаемое значение:
//   ТаблицаЗначений - пользователи информационной базы, подключенные к сервису.
//
Функция ПользователиСервисаВИнформационнойБазе()
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Получение списка пользователей информационной базы.
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Пользователи.Ссылка                      КАК Ссылка,
	|	ВЫБОР
	|		КОГДА ПользователиБизнесСеть.Пользователь ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ                                    КАК Подключен,
	|	ПользователиБизнесСеть.Идентификатор   КАК Идентификатор,
	|	Пользователи.ИдентификаторПользователяИБ КАК ИдентификаторПользователяИБ
	|ИЗ
	|	Справочник.Пользователи КАК Пользователи
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть
	|		ПО Пользователи.Ссылка = ПользователиБизнесСеть.Пользователь
	|
	|УПОРЯДОЧИТЬ ПО
	|	Пользователи.Наименование";
	
	ТаблицаПользователей = Запрос.Выполнить().Выгрузить();
	ТаблицаПользователей.Колонки.Добавить("Пароль");
	ТаблицаПользователей.Колонки.Добавить("Телефон");
	ТаблицаПользователей.Колонки.Добавить("ЭлектроннаяПочта");
	ТаблицаПользователей.Колонки.Добавить("ЭтоАдминистратор");
	
	// Анализ ролей пользователей.
	СтрокиУдаления = Новый Массив;
	СтруктураКонтактовПользователя = ОписаниеКонтактнойИнформацииПользователя();
	Для каждого СтрокаТаблицы Из ТаблицаПользователей Цикл
		
		ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(
			СтрокаТаблицы.ИдентификаторПользователяИБ);
		
		Если ПользовательИБ = Неопределено Тогда
			СтрокиУдаления.Добавить(СтрокаТаблицы);
			Продолжить;
		КонецЕсли;
		
		// Для пользователей имеющих административные права устанавливается роль администратора сервиса,
		// для пользователей имеющих права обмена документами, устанавливается роль пользователя сервиса,
		// остальные пользователи не используются в сервисе.
		Если Пользователи.ЭтоПолноправныйПользователь(СтрокаТаблицы.Ссылка)
			ИЛИ	ПравоДоступа("Изменение", Метаданные.РегистрыСведений.ОрганизацииБизнесСеть, СтрокаТаблицы.Ссылка) Тогда
			СтрокаТаблицы.ЭтоАдминистратор = Истина;
		ИначеЕсли ПравоВыполненияОбменаДокументами(СтрокаТаблицы.Ссылка) Тогда
			СтрокаТаблицы.ЭтоАдминистратор = Ложь;
		Иначе
			СтрокиУдаления.Добавить(СтрокаТаблицы);
			Продолжить;
		КонецЕсли;
		
		// Получение наименования роли пользователя и адреса эл.почты.
		БизнесСетьПереопределяемый.ПолучитьКонтактнуюИнформациюПользователя(СтрокаТаблицы.Ссылка, СтруктураКонтактовПользователя);
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, СтруктураКонтактовПользователя);
		
	КонецЦикла;
	
	// Удаление незарегистрированных пользователей.
	Для каждого ЗначениеМассива Из СтрокиУдаления Цикл
		ТаблицаПользователей.Удалить(ЗначениеМассива);
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);

	Возврат ТаблицаПользователей;
	
КонецФункции

// Установка статус загрузки документа в информационную базы в сервисе.
//
Процедура УстановитьСтатусЗагружен(Идентификатор, Ссылка, Отказ) Экспорт
	
	МассивДанных = Новый Массив;
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("Ссылка", Ссылка);
	СтруктураДанных.Вставить("Идентификатор", Идентификатор);
	МассивДанных.Добавить(СтруктураДанных);
	
	ПараметрыМетода = Новый Структура;
	ПараметрыМетода.Вставить("МассивДанных", МассивДанных);
	ПараметрыМетода.Вставить("Статус", "Загружен");
	ПараметрыКоманды = ПараметрыКомандыОбновитьСтатус(ПараметрыМетода);
	ВыполнитьКомандуСервиса(ПараметрыКоманды, Отказ);
	
КонецПроцедуры

// Формирование данных JSON для регистрации и синхронизации пользователей в сервисе.
//
// Параметры:
//   ПараметрыСинхронизации         - Структура - состав:
//     * ИдентификаторПрограммы - Строка - идентификатор программы, подключенной к сервису.
//     * СписокПользователей    - Массив из СправочникСсылка.Пользователи - массив пользователей для синхронизации.
//     * Данные                 - Структура - сформированные данные для регистрации.
//   ОбновлятьИдентификаторыДоступа - Булево - признак обновления идентификаторов.
//
Процедура СформироватьДанныеСинхронизацииПользователя(ПараметрыСинхронизации, ОбновлятьИдентификаторыДоступа)
	
	УстановитьПривилегированныйРежим(Истина);
	Ссылка = ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.ПользователиБизнесСеть");
	ИдентификаторПрограммы = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(Ссылка, "ПарольБизнесСеть");
	УстановитьПривилегированныйРежим(Ложь);
	
	// Получение списка пользователей в информационной базе.
	ПользователиСервиса = ПользователиСервисаВИнформационнойБазе();
		
	// Обработка данных.
	МассивУчетныхДанных = Новый Массив;
	Для каждого СтрокаТаблицы Из ПользователиСервиса Цикл
		
		// Если пользователь не подключен, присваивается новый идентификатор.
		Если ОбновлятьИдентификаторыДоступа Или Не ЗначениеЗаполнено(СтрокаТаблицы.Идентификатор) Тогда
			СтрокаТаблицы.Идентификатор = Строка(Новый УникальныйИдентификатор);
		КонецЕсли;
		
		// Добавление в JSON пользователя.
		ПользовательСистемы = Новый Структура;
		ПользовательСистемы.Вставить("type", "AUTOGENERATED");
		ПользовательСистемы.Вставить("login", СтрокаТаблицы.Идентификатор);
		
		// Пароль при каждом обращении генерируется новый.
		СтрокаТаблицы.Пароль = Строка(Новый УникальныйИдентификатор);
		ПользовательСистемы.Вставить("password", СтрокаТаблицы.Пароль);
		
		СписокПользователей = Новый Массив;
		СписокПользователей.Добавить(ПользовательСистемы);
		
		// Добавление в JSON учетных данных.
		УчетныеДанные = Новый Структура;
		УчетныеДанные.Вставить("firstName", Строка(СтрокаТаблицы.Ссылка));
		УчетныеДанные.Вставить("personAccounts", СписокПользователей);
		
		СписокПользователей = Новый Массив;
		СписокПользователей.Добавить(ПользовательСистемы);
		
		ПользовательАбонента = Новый Структура;
		ПользовательАбонента.Вставить("roleTitle", "user");
		
		Если ЗначениеЗаполнено(СтрокаТаблицы.ЭлектроннаяПочта) Тогда
			ПользовательАбонента.Вставить("corporationEmail", СтрокаТаблицы.ЭлектроннаяПочта);	
		КонецЕсли;
		
		ПользовательАбонента.Вставить("isSubscriberAdministrator", ?(СтрокаТаблицы.ЭтоАдминистратор, "true", "false"));
		ПользовательАбонента.Вставить("person", УчетныеДанные);
		
		МассивУчетныхДанных.Добавить(ПользовательАбонента);
		
	КонецЦикла;
	
	ПараметрыСинхронизации.СписокПользователей    = ПользователиСервиса;
	ПараметрыСинхронизации.ИдентификаторПрограммы = ИдентификаторПрограммы;
	ПараметрыСинхронизации.Данные                 = ЗначениеВJSON(МассивУчетныхДанных);
	
КонецПроцедуры

// Возврат данных идентификации пользователя информационной базы из кэша.
//
// Параметры:
//   Пользователь - Справочник.Пользователи - проверяемый пользователь, если не указан, то текущий.
//
// Возвращаемое значение:
//   Структура - структура данных идентификации.
//
Функция ПараметрыАутентификацииПользователя(Пользователь = Неопределено)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Пользователь = Неопределено Тогда
		Пользователь = Пользователи.ТекущийПользователь();
	КонецЕсли;
	
	Если Пользователь = Пользователи.СсылкаНеуказанногоПользователя(Истина)
		Или ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Пользователь, "Служебный") Тогда
		Пользователь = ПроизвольныйПользовательСПравомОбменаДокументами();
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПользователиБизнесСеть.Идентификатор КАК Идентификатор
	|ИЗ
	|	РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть
	|ГДЕ
	|	ПользователиБизнесСеть.Пользователь = &Пользователь";
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтруктураИдентификации = Неопределено;
	Если Выборка.Следующий() Тогда
		Пароль = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(Пользователь, "ПарольБизнесСеть");
		СтруктураИдентификации = Новый Структура;
		СтруктураИдентификации.Вставить("Пользователь", Пользователь);
		СтруктураИдентификации.Вставить("Логин",        Выборка.Идентификатор);
		СтруктураИдентификации.Вставить("Пароль",       Пароль);
	КонецЕсли;
	
	Возврат СтруктураИдентификации;
	
КонецФункции

Функция ПроизвольныйПользовательСПравомОбменаДокументами()
	
	Пользователь = Неопределено;
	
	// Получение первого пользователя по ролям для выполнения фонового задания.
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПользователиБизнесСеть.Пользователь КАК Ссылка
	|ИЗ
	|	РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если ПравоВыполненияОбменаДокументами(Выборка.Ссылка) Тогда
			Пользователь = Выборка.Ссылка;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Пользователь;

КонецФункции

// Обновление идентификаторов организаций сервиса.
//
// Параметры:
//  СписокОрганизаций - Массив из ОпределяемыеТипы.Организация - организации обновления.
//  РежимУдаления     - Булево - режим удаления.
//
Процедура СохранитьИдентификаторыОрганизаций(СписокОрганизаций, РежимУдаления = Ложь)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НачатьТранзакцию();
	
	Попытка
		
		Если ЗначениеЗаполнено(СписокОрганизаций) Тогда
			
			МенеджерЗаписиОрганизации = РегистрыСведений.ОрганизацииБизнесСеть.СоздатьМенеджерЗаписи();
			Для каждого ЭлементМассива Из СписокОрганизаций Цикл
				
				Если ТипЗнч(ЭлементМассива) = Тип("Структура") Тогда
					Продолжить;
				КонецЕсли;
				
				БлокировкаДанных = Новый БлокировкаДанных;
				ЭлементБлокировкиДанных = БлокировкаДанных.Добавить("РегистрСведений.ОрганизацииБизнесСеть");
				ЭлементБлокировкиДанных.УстановитьЗначение("Организация", ЭлементМассива);
				ЭлементБлокировкиДанных.Режим = РежимБлокировкиДанных.Исключительный;
				БлокировкаДанных.Заблокировать();
				
				МенеджерЗаписиОрганизации.Организация = ЭлементМассива;
				МенеджерЗаписиОрганизации.Прочитать();
				Если РежимУдаления Тогда
					МенеджерЗаписиОрганизации.Удалить();
				Иначе
					МенеджерЗаписиОрганизации.Организация = ЭлементМассива;
					МенеджерЗаписиОрганизации.Записать(Истина);
				КонецЕсли;
				
			КонецЦикла;
			
		ИначеЕсли РежимУдаления Тогда
			
			// Удаление всех записей регистра для отмены регистрации организаций.
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ОрганизацииБизнесСеть");
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			Блокировка.Заблокировать();
			
			НаборЗаписей = РегистрыСведений.ОрганизацииБизнесСеть.СоздатьНаборЗаписей();
			НаборЗаписей.Записать(Истина);
			
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
	
	Исключение
		
		ОтменитьТранзакцию();
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "БизнесСеть");
		
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Ошибка сохранения идентификатора организации сервиса'")
			+ БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации());
		
	КонецПопытки;
		
КонецПроцедуры

// Обновление идентификаторов пользователей сервиса.
//
// Параметры:
//  СписокПользователей  - Массив из Структура - где:
//    * Ссылка        - СправочникСсылка.Пользователи - пользователь.
//    * Идентификатор - Строка - идентификатор пользователя.
//    * Пароль        - Строка - пароль пользователя.
//  РежимУдаления        - Булево - признак удаления идентификатора.
//
Процедура СохранитьИдентификаторыПользователей(СписокПользователей, РежимУдаления = Ложь)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НачатьТранзакцию();
	
	Попытка
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ПользователиБизнесСеть");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		Если ЗначениеЗаполнено(СписокПользователей) Тогда
			ЭлементБлокировки.ИсточникДанных = СписокПользователей;
			ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Пользователь", "Ссылка");
		КонецЕсли;
		Блокировка.Заблокировать();

		Запрос = Новый Запрос;
		
		Если ЗначениеЗаполнено(СписокПользователей) Тогда
			
			// Выборка пользователей, переданных в массиве.
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ПользователиБизнесСеть.Пользователь КАК Пользователь
			|ИЗ
			|	РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть
			|ГДЕ
			|	ПользователиБизнесСеть.Пользователь ССЫЛКА Справочник.Пользователи
			|	И НЕ ПользователиБизнесСеть.Пользователь В (&МассивСсылок)";
			Запрос.УстановитьПараметр("МассивСсылок", СписокПользователей.ВыгрузитьКолонку("Ссылка"));
			
		ИначеЕсли РежимУдаления Тогда
			
			// Если не передан массив пользователей, то выбор всех.
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ПользователиБизнесСеть.Пользователь КАК Пользователь
			|ИЗ
			|	РегистрСведений.ПользователиБизнесСеть КАК ПользователиБизнесСеть";
			
		КонецЕсли;
		
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			
			// Если список пользователей пустой, и значение ссылки это пустой пользователь, то такую запись не удаляем,
			// так как эта запись является администратором абонента в сервисе.
			ЭтоПустойАдминистратор = Не ЗначениеЗаполнено(СписокПользователей)
				И (НЕ ЗначениеЗаполнено(Выборка.Пользователь)
				ИЛИ Выборка.Пользователь = Пользователи.СсылкаНеуказанногоПользователя());
			
			Если НЕ ЭтоПустойАдминистратор ИЛИ (ЭтоПустойАдминистратор И РежимУдаления) Тогда
				
				МенеджерЗаписи = РегистрыСведений.ПользователиБизнесСеть.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.Пользователь = Выборка.Пользователь;
				МенеджерЗаписи.Удалить();
				
				// Очистка пароля в хранилище.
				ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(Выборка.Пользователь, Неопределено, "ПарольБизнесСеть");
			КонецЕсли;
			
		КонецЦикла;
		
		Если ЗначениеЗаполнено(СписокПользователей) И Не РежимУдаления Тогда
			
			Для каждого ЭлементМассива Из СписокПользователей Цикл
				
				МенеджерЗаписи = РегистрыСведений.ПользователиБизнесСеть.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.Пользователь  = ЭлементМассива.Ссылка;
				МенеджерЗаписи.Идентификатор = ЭлементМассива.Идентификатор;
				МенеджерЗаписи.Записать(Истина);
				
				ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(ЭлементМассива.Ссылка,
					ЭлементМассива.Пароль, "ПарольБизнесСеть");
					
			КонецЦикла;
			
		КонецЕсли;
	
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "БизнесСеть");
		
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Ошибка сохранения идентификатора пользователя сервиса'")
			+ БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации());
		
	КонецПопытки;
	
КонецПроцедуры

// Обновление идентификатора администратора сервиса.
//
// Параметры:
//  АдминистраторАбонента	 - Структура - состав:
//    * Пользователь - СправочникСсылка.Пользователи - пользователь.
//    * Логин - Строка - логин пользователя.
//    * Пароль - Строка - пароль пользователя.
//  РежимУдаления			 - Булево - режим удаления.
//
Процедура СохранитьИдентификаторАдминистратора(АдминистраторАбонента, РежимУдаления = Ложь)
	
	УстановитьПривилегированныйРежим(Истина);

	НачатьТранзакцию();
	
	Попытка
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ПользователиБизнесСеть");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.УстановитьЗначение("Пользователь", АдминистраторАбонента.Пользователь);
		Блокировка.Заблокировать();
		
		МенеджерЗаписи = РегистрыСведений.ПользователиБизнесСеть.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Пользователь = АдминистраторАбонента.Пользователь;
		МенеджерЗаписи.Прочитать();
		
		Если РежимУдаления Тогда
			
			МенеджерЗаписи.Удалить();
			ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(АдминистраторАбонента.Пользователь, 
				Неопределено, "ПарольБизнесСеть");
				
		Иначе
				
			МенеджерЗаписи.Пользователь  = АдминистраторАбонента.Пользователь;
			МенеджерЗаписи.Идентификатор = АдминистраторАбонента.Логин;
			МенеджерЗаписи.Записать(Истина);
			ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(АдминистраторАбонента.Пользователь,
				АдминистраторАбонента.Пароль, "ПарольБизнесСеть");
				
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "БизнесСеть");
			
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Ошибка сохранения идентификатора администратора сервиса'")
			+ БизнесСетьКлиентСервер.ПодробностиВЖурналеРегистрации());
		
	КонецПопытки;
	
КонецПроцедуры

// Обновление идентификатора программы сервиса.
//
// Параметры:
//  ИдентификаторПрограммы	 - Строка - идентификатор программы в сервисе.
//  РежимУдаления			 - Булево - режим удаление идентификатора.
//
Процедура СохранитьИдентификаторПрограммы(ИдентификаторПрограммы, РежимУдаления = Ложь)
	
	УстановитьПривилегированныйРежим(Истина);

	СсылкаМетаданных = ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.ПользователиБизнесСеть");
	Если РежимУдаления Тогда
		ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(СсылкаМетаданных, Неопределено, "ПарольБизнесСеть");
		ОбновитьПовторноИспользуемыеЗначения();
	Иначе
		ОбщегоНазначения.ЗаписатьДанныеВБезопасноеХранилище(СсылкаМетаданных, ИдентификаторПрограммы, "ПарольБизнесСеть");
	КонецЕсли;
	
КонецПроцедуры

// Получение данных из строки в формате JSON.
//
Функция ЗначениеИзСтрокиJSON(Значение)
	
	Если ТипЗнч(Значение) <> Тип("Строка")
		Или ПустаяСтрока(Значение)
		Или Лев(Значение, 1) = "<" Тогда
		Возврат Значение;
	КонецЕсли;
	
	Результат = Неопределено;
	ЧтениеJSON = Новый ЧтениеJSON;
	Попытка
		ЧтениеJSON.УстановитьСтроку(Значение);
		Результат = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
	Исключение
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "БизнесСеть");
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Обработка ответа сервиса.
//
// Параметры:
//  ПараметрыКоманды - Структура - параметры команды, см. БизнесСеть.ОписаниеПараметровКомандыСервиса.
//  КодСостояния	 - Строка - код состояния ответа HTTP-соединения.
//  Данные			 - Структура, Строка - возвращаемые данные сервиса.
//  Отказ			 - Булево - результат проверки.
// 
// Возвращаемое значение:
//  Произвольный - возвращаемый результат обработки.
//
Функция ОбработатьОтветСервиса(ПараметрыКоманды, КодСостояния, Данные, Отказ)
	
	// Инициализация возврата ошибки.
	Результат = Неопределено;
	
	Если ПараметрыКоманды.Ошибки.Получить(КодСостояния) = Неопределено
		И КодСостояния <> 200
		И ПараметрыКоманды.РазрешенныеСостояния.Найти(КодСостояния) = Неопределено Тогда
		ПараметрыКоманды.Ошибки.Вставить(КодСостояния, НСтр("ru = 'Внутренняя ошибка сервиса'"));
	КонецЕсли;
	
	Если ПараметрыКоманды.Ошибки.Получить(КодСостояния) <> Неопределено Тогда
		
		ОписаниеОшибки = ПараметрыКоманды.Ошибки.Получить(КодСостояния);
		Если ОписаниеОшибки = Ложь Тогда
			Если ЗначениеЗаполнено(Данные) Тогда
				ОписаниеОшибки = НСтр("ru = 'Ошибка сервиса'");
			Иначе
				Возврат Неопределено;
			КонецЕсли;
		ИначеЕсли ОписаниеОшибки = Истина Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Отказ = Истина;
		ТекстОшибкиСервиса = "";
		Если ТипЗнч(Данные) = Тип("Структура") Тогда
			Если Данные.Свойство("message") Тогда
				ТекстОшибкиСервиса = Данные.message;
			ИначеЕсли Данные.Свойство("error_description") Тогда
				ТекстОшибкиСервиса = Данные.error_description;
			КонецЕсли;
		КонецЕсли;
		
		ПодробныйТекстОшибки = ОписаниеОшибки
			+ ?(КодСостояния > 200, Символы.ПС + НСтр("ru = 'Код состояния:'") + " " + КодСостояния, "")
			+ Символы.ПС + ПараметрыКоманды.Адрес
			+ ?(ТекстОшибкиСервиса = "", "", Символы.ПС + ТекстОшибкиСервиса);
		
		Если Не (ПараметрыКоманды.Свойство("БлокироватьСообщенияОбОшибках")
			И ПараметрыКоманды.БлокироватьСообщенияОбОшибках = Истина) Тогда
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ПараметрыКоманды.Наименование,
				ПодробныйТекстОшибки, ОписаниеОшибки, "БизнесСеть");
		КонецЕсли;
			
		Результат = ОписаниеОшибки;
		
	Иначе
		
		Если ЗначениеЗаполнено(ПараметрыКоманды.ОбработкаРезультата) Тогда
			
			Если Не ЗначениеЗаполнено(Данные) Тогда
				Результат = Неопределено;
				Отказ = Истина;
			Иначе
				
				// Метод конвертации данных будет переработан в отдельный рекурсивный метод.
				Если ТипЗнч(ПараметрыКоманды.ОбработкаРезультата) = Тип("Структура")
					И ТипЗнч(Данные) = Тип("Структура") Тогда
					
					// Ожидается, что возвращается структура, которую необходимо привести к определенному составу.
					НовыеДанные = Новый Структура;
					Для каждого ЭлементСтруктуры Из ПараметрыКоманды.ОбработкаРезультата Цикл
						Если Данные.Свойство(ЭлементСтруктуры.Значение) Тогда
							НовыеДанные.Вставить(ЭлементСтруктуры.Ключ, Данные[ЭлементСтруктуры.Значение]);
						КонецЕсли;
					КонецЦикла;
					
				ИначеЕсли ТипЗнч(ПараметрыКоманды.ОбработкаРезультата) = Тип("ТаблицаЗначений")
					И ТипЗнч(Данные) = Тип("Массив") Тогда
					
					// Ожидается таблица значений.
					НовыеДанные = ПараметрыКоманды.ОбработкаРезультата.Скопировать();
					Для каждого ЗначениеМассива Из Данные Цикл
						НоваяСтрока = НовыеДанные.Добавить();
						Для каждого КолонкаТаблицы Из НовыеДанные.Колонки Цикл
							Если ЗначениеМассива.Свойство(КолонкаТаблицы.Заголовок) Тогда
								НоваяСтрока[КолонкаТаблицы.Имя] = ЗначениеМассива[КолонкаТаблицы.Заголовок];
							КонецЕсли;
						КонецЦикла;
					КонецЦикла;
					
				ИначеЕсли ТипЗнч(ПараметрыКоманды.ОбработкаРезультата) = Тип("Массив")
					И ПараметрыКоманды.ОбработкаРезультата.Количество() = 1
					И ТипЗнч(Данные) = Тип("Массив") Тогда
					
					// В первой строке содержится структура массива.
					СоставСвойств = ПараметрыКоманды.ОбработкаРезультата[0];
					НовыеДанные = Новый Массив;
					Для каждого ЗначениеМассива Из Данные Цикл
						НовыйЭлемент = Новый Структура;
						Для каждого ЭлементСтруктуры Из СоставСвойств Цикл
							Если ЗначениеМассива.Свойство(ЭлементСтруктуры.Значение) Тогда
								НовыйЭлемент.Вставить(ЭлементСтруктуры.Ключ, ЗначениеМассива[ЭлементСтруктуры.Значение]);
							КонецЕсли;
						КонецЦикла;
						НовыеДанные.Добавить(НовыйЭлемент);
					КонецЦикла;
					
				КонецЕсли;
				
				Результат = НовыеДанные;
				
			КонецЕсли;
			
		Иначе
			Результат = Данные;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ЗагрузкаДокументов

// Загрузить документы в информационную базу в фоне.
//
// Параметры:
//  ПараметрыЗапроса - ТаблицаЗначений - см. БизнесСеть.ДокументыОбмена, реквизит ЗагружаемыеДокументы.
//  АдресРезультата	 - Строка - адрес хранилища для сохранения результата загрузки.
//
Процедура ЗагрузитьДокументы(Знач ПараметрыЗапроса, Знач АдресРезультата) Экспорт
	
	ТекстОшибки = "";
	Отказ = Ложь;
	
	Для каждого СтрокаЗагрузки Из ПараметрыЗапроса Цикл
		
		// Упаковка по временные хранилища.
		Если ЭтоАдресВременногоХранилища(СтрокаЗагрузки.АдресХранилища) Тогда
			СтрокаЗагрузки.АдресХранилища = ПоместитьВоВременноеХранилище(СтрокаЗагрузки.АдресХранилищаЗначение);
			СтрокаЗагрузки.АдресХранилищаЗначение = Неопределено;
		КонецЕсли;
		
		Если ЭтоАдресВременногоХранилища(СтрокаЗагрузки.ДанныеФайлаРазбора) Тогда
			СтрокаЗагрузки.ДанныеФайлаРазбора = ПоместитьВоВременноеХранилище(СтрокаЗагрузки.ДанныеФайлаРазбораЗначение);
			СтрокаЗагрузки.ДанныеФайлаРазбораЗначение = Неопределено;
		КонецЕсли;
	
		Если ЭтоАдресВременногоХранилища(СтрокаЗагрузки.ДанныеФайлаДопДанных) Тогда
			СтрокаЗагрузки.ДанныеФайлаДопДанных = ПоместитьВоВременноеХранилище(СтрокаЗагрузки.ДанныеФайлаДопДанныхЗначение);
			СтрокаЗагрузки.ДанныеФайлаДопДанныхЗначение = Неопределено;
		КонецЕсли;
		
		Если ЭтоАдресВременногоХранилища(СтрокаЗагрузки.ДанныеФайлаКартинок) Тогда
			СтрокаЗагрузки.ДанныеФайлаКартинок = ПоместитьВоВременноеХранилище(СтрокаЗагрузки.ДанныеФайлаКартинокЗначение);
			СтрокаЗагрузки.ДанныеФайлаКартинокЗначение = Неопределено;
		КонецЕсли;
		
		Если ЭтоАдресВременногоХранилища(СтрокаЗагрузки.АдресСтруктурыРазбораЭД) Тогда
			СтруктураРазбораЭД = СтрокаЗагрузки.АдресСтруктурыРазбораЭДЗначение;
			СтруктураРазбораЭД.Вставить("СтрокаОбъекта", СтрокаЗагрузки.АдресСтруктурыРазбораЭДЗначение.ДеревоРазбора.Строки[0].Строки[0]);
			СтрокаЗагрузки.АдресСтруктурыРазбораЭД = ПоместитьВоВременноеХранилище(СтруктураРазбораЭД);
			СтрокаЗагрузки.АдресСтруктурыРазбораЭДЗначение = Неопределено;
		КонецЕсли;
		
		ОбменСКонтрагентамиВнутренний.СформироватьДокументИБ(СтрокаЗагрузки, СтрокаЗагрузки.СсылкаНаДокумент,
			ТекстОшибки, Истина, Ложь, Отказ);
		Если Не Отказ Тогда
			УстановитьСтатусЗагружен(СтрокаЗагрузки.Идентификатор, СтрокаЗагрузки.СсылкаНаДокумент, Отказ);
		КонецЕсли;
		
		Если Отказ Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Если Не Отказ Тогда
		ПоместитьВоВременноеХранилище(ПараметрыЗапроса, АдресРезультата);
	Иначе
		ТекстСообщения = СтрШаблон(НСтр("ru = 'Ошибка загрузки документа %1:
			|%2'"), СтрокаЗагрузки.Документ, ТекстОшибки);
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(
			ТекстСообщения, "БизнесСеть",,,);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Прочее

Процедура СоздатьГиперссылкуПодбораДокументовИзСервиса(Форма, ГруппаФормы)
		
	ИмяКоманды = БизнесСетьКлиентСервер.ИмяКомандыПодбораДокументовИзСервиса();
	
	НоваяКомандаФормы           = Форма.Команды.Добавить(ИмяКоманды);
	НоваяКомандаФормы.Действие  = СтрШаблон("Подключаемый_%1", ИмяКоманды);
	НоваяКомандаФормы.Картинка  = БиблиотекаКартинок.БизнесСетьЗагрузка;
	НоваяКомандаФормы.Подсказка = НСтр("ru = 'Подобрать новые документы из сервиса ""1С:Бизнес-сеть""'");
	
	НовыйЭлемент            = Форма.Элементы.Добавить(ИмяКоманды, Тип("КнопкаФормы"), ГруппаФормы);
	НовыйЭлемент.Вид        = ВидКнопкиФормы.Гиперссылка;
	НовыйЭлемент.ИмяКоманды = ИмяКоманды;
	НовыйЭлемент.Видимость  = Ложь;
	
КонецПроцедуры

Процедура ДобавитьРазрешенияВнешнихРесурсов(ИмяСервиса, ЗапросыРазрешений)
	
	ПараметрыСоединения = БизнесСетьПовтИсп.ПараметрыСоединения(ИмяСервиса);
	
	Протокол = ?(ПараметрыСоединения.ЗащищенноеСоединение <> Неопределено, "HTTPS", "HTTP");
	Адрес    = ПараметрыСоединения.Сервер;
	Порт     = ПараметрыСоединения.Порт;
	
	Если ИмяСервиса = "БизнесСеть" Тогда
		Описание = НСтр("ru = 'Обмен документами без электронной подписи в сервисе 1С:Бизнес-сеть.'");
	Иначе
		Описание = НСтр("ru = 'Рубрикатор номенклатуры в сервисе 1С:Бизнес-сеть.'");
	КонецЕсли;
	
	Разрешения = Новый Массив;
	Разрешения.Добавить(РаботаВБезопасномРежиме.РазрешениеНаИспользованиеИнтернетРесурса(Протокол, Адрес, Порт, Описание));
	ВладелецРазрешения = ОбщегоНазначения.ИдентификаторОбъектаМетаданных(
		Метаданные.РегистрыСведений.ОрганизацииБизнесСеть.ПолноеИмя());
	
	ЗапросРазрешений = РаботаВБезопасномРежиме.ЗапросНаИспользованиеВнешнихРесурсов(Разрешения, ВладелецРазрешения, Истина);
	
	ЗапросыРазрешений.Добавить(ЗапросРазрешений);

КонецПроцедуры

Процедура ДобавитьПоляТаблицыПоКоллекции(КоллекцияДляОбхода, КоллекцияДляДобавления, ЭлементИсключения)
	
	Для каждого ЭлементКоллекции Из КоллекцияДляОбхода Цикл
		
		Если ЭлементКоллекции = ЭлементИсключения Тогда
			Продолжить;
		КонецЕсли;
		
		Если ТипЗнч(ЭлементКоллекции) = Тип("ГруппаФормы") Тогда
			ДобавитьПоляТаблицыПоКоллекции(ЭлементКоллекции.ПодчиненныеЭлементы, КоллекцияДляДобавления, ЭлементИсключения);
		КонецЕсли;
		
		Если ТипЗнч(ЭлементКоллекции) = Тип("ПолеФормы") Тогда
			ПолеЭлемента = КоллекцияДляДобавления.Добавить();
			ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементКоллекции.Имя);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Подготовка значения идентификатора сервиса.
//
// Параметры:
//   Значение - Строка - ИНН, КПП юридического лица в сервисе,, где "0" - пустое значение.
//
// Возвращаемое значение:
//   Строка - значение идентификатора сервиса.
//
Функция ЗначениеИдентификатора(Знач Значение) Экспорт
	
	Результат = Строка(Значение);
	Если Результат = "0" Тогда
		Результат = "";
	КонецЕсли;
	
	Возврат Результат;
		
КонецФункции

#КонецОбласти

#КонецОбласти
