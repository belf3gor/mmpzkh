&НаКлиенте
Перем СопоставлениеКонтрагенты;

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Перем ТаблицаТовары, ТТНВходящаяЕГАИС;
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	Если НЕ Параметры.Свойство("ТаблицаТовары", ТаблицаТовары) Тогда
		Если Параметры.Свойство("ТТНВходящаяЕГАИС", ТТНВходящаяЕГАИС) И ЗначениеЗаполнено(ТТНВходящаяЕГАИС) Тогда
			ТаблицаТовары = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТТНВходящаяЕГАИС, "Товары").Выгрузить();
		Иначе
			ВызватьИсключение НСтр("ru='Непосредственное открытие этой формы не предусмотрено.'");
		КонецЕсли; 
	КонецЕсли;
	
	Для каждого СтрокаТовар Из ТаблицаТовары Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТовар.Номенклатура) Тогда
			НоваяСтрока = Объект.Товары.Добавить();
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТовар, "АлкогольнаяПродукция, ИдентификаторУпаковки");
			РеквизитыНоменклатурыЕГАИС = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтрокаТовар.АлкогольнаяПродукция, "Объем, Производитель, Импортер, Наименование");
			
			НоваяСтрока.НомерСтроки_ЕГАИС = СтрокаТовар.НомерСтроки;
			
			НоваяСтрока.Статус = 2;
			НоваяСтрока.ПредставлениеНовойНоменклатуры = "Новый:" + РеквизитыНоменклатурыЕГАИС.Наименование;
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, РеквизитыНоменклатурыЕГАИС);
		КонецЕсли; 
	КонецЦикла; 
	
	ПодготовитьФормуНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	СопоставлениеКонтрагенты = Новый Соответствие;
	СопоставлениеКонтрагенты.Вставить(ПредопределенноеЗначение("Справочник.КлассификаторОрганизацийЕГАИС.ПустаяСсылка"), ПредопределенноеЗначение("Справочник.Контрагенты.ПустаяСсылка"));
	
	Если Объект.Товары.Количество() = 0 Тогда
		Отказ = Истина;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура НадписьСсылкиУстановкиРеквизитовНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗакрытияФормыУстановкиЗначенийРеквизитов", ЭтотОбъект);
	
	ЗначенияРеквизитов = Новый Структура;
	ЗначенияРеквизитов.Вставить("Родитель", Родитель);
	ЗначенияРеквизитов.Вставить("ВидНоменклатуры", ВидНоменклатуры);
	ЗначенияРеквизитов.Вставить("НоменклатурнаяГруппа", НоменклатурнаяГруппа);
	ЗначенияРеквизитов.Вставить("ЕдиницаИзмерения", ЕдиницаИзмерения);
	ЗначенияРеквизитов.Вставить("СтавкаНДС", СтавкаНДС);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияРеквизитов", ЗначенияРеквизитов);
	
	ОткрытьФорму("ОбщаяФорма.ФормаУстановкиЗначенийРеквизитовНоменклатуры", ПараметрыФормы, ЭтотОбъект,,,, ОписаниеОповещения);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыТовары
&НаКлиенте
Процедура ТоварыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	ДанныеТекущейСтроки = Элементы.Товары.ТекущиеДанные;
	ДанныеТекущейСтроки.Статус = ?(ЗначениеЗаполнено(ДанныеТекущейСтроки.Номенклатура), 0, 2);
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	Отбор = Новый Структура;
	СтандартнаяОбработка = Ложь;
	ДанныеТекущейСтроки = Элементы.Товары.ТекущиеДанные;
	
	ЗаполнитьОтборыДляНоменклатуры(Отбор, ДанныеТекущейСтроки.Производитель,
										ДанныеТекущейСтроки.Импортер,
										ДанныеТекущейСтроки.АлкогольнаяПродукция);
	
	ПараметрыФормы = Новый Структура("СведенияОбАлкогольнойПродукции", Отбор);
	
	ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаВыбораАлкогольнойПродукции", ПараметрыФормы, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
	ДанныеТекущейСтроки = Элементы.Товары.ТекущиеДанные;
	
	Если ДанныеТекущейСтроки.Статус = 2 Тогда // будет создана новая номенклатура
		СтандартнаяОбработка = Ложь;
		ТекстПодбора = НСтр(СтрШаблон("ru = 'Создать: %1'", ДанныеТекущейСтроки.АлкогольнаяПродукция));
		
		ДанныеВыбора = Новый СписокЗначений;
		ДанныеВыбора.Добавить(ТекстПодбора);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Если ТипЗнч(ВыбранноеЗначение) = Тип("Строка") И СтрНайти(ВыбранноеЗначение, НСтр("ru = 'Создать:'")) > 0 Тогда
		
		СтандартнаяОбработка = Ложь;
		
		ДанныеОбъекта = Новый Структура("ВидНоменклатуры, Родитель, НоменклатурнаяГруппа, СтавкаНДС, ЕдиницаИзмерения");
		ЗаполнитьЗначенияСвойств(ДанныеОбъекта, ЭтаФорма);
		
		ДанныеСтроки = Новый Структура("АлкогольнаяПродукция, Производитель, Импортер");
		ЗаполнитьЗначенияСвойств(ДанныеСтроки, Элементы.Товары.ТекущиеДанные);
		
		ДанныеЗаполнения = ДанныеЗаполненияНоменклатуры(ДанныеСтроки, ДанныеОбъекта, СопоставлениеКонтрагенты);
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("РежимВыбора", Истина);
		ПараметрыФормы.Вставить("ТекстЗаполнения", ДанныеЗаполнения.Наименование);
		ПараметрыФормы.Вставить("ЗначенияЗаполнения", ДанныеЗаполнения);
		
		ОткрытьФорму("Справочник.Номенклатура.ФормаОбъекта", ПараметрыФормы, Элемент);
		
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ПеренестиВДокумент(Команда)
	
	АдресХранилища = ПеренестиВДокументНаСервере(СопоставлениеКонтрагенты);
	Если АдресХранилища <> Неопределено Тогда
		Закрыть(АдресХранилища);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьУсловноеОформление()

	// Серый текст для новой номенклатуры
	ЭлементУО = УсловноеОформление.Элементы.Добавить();
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "ТоварыНоменклатура");
	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.Товары.Номенклатура", ВидСравненияКомпоновкиДанных.НеЗаполнено);
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.ТемноСерый);
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", Новый ПолеКомпоновкиДанных("Объект.Товары.ПредставлениеНовойНоменклатуры"));
	
	ЭлементУО = УсловноеОформление.Элементы.Добавить();
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "ТоварыКоэффициентПересчетаУпаковки");
	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.Товары.Номенклатура", ВидСравненияКомпоновкиДанных.НеЗаполнено);
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.ТемноСерый);
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", "1,000");
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
КонецПроцедуры

&НаСервере
Процедура ПодготовитьФормуНаСервере()

	// Установка значений реквизитов для новой номенклатуры по умолчанию
	СтавкаНДС					 = ?(ЗначениеЗаполнено(СтавкаНДС), СтавкаНДС, Перечисления.СтавкиНДС.НДС18);
	ЕдиницаИзмерения			 = ?(ЗначениеЗаполнено(ЕдиницаИзмерения), ЕдиницаИзмерения,
		Справочники.КлассификаторЕдиницИзмерения.ЕдиницаИзмеренияПоКоду("796")); // единица измерения по умолчанию - штука
	ВидНоменклатуры				 = ?(ЗначениеЗаполнено(ВидНоменклатуры), ВидНоменклатуры, Справочники.ВидыНоменклатуры.НайтиСоздатьЭлементыТовар());
	НоменклатурнаяГруппа		 = ?(ЗначениеЗаполнено(НоменклатурнаяГруппа), НоменклатурнаяГруппа,
		БухгалтерскийУчетВызовСервераПовтИсп.ОсновнаяНоменклатурнаяГруппа());
		
	УстановитьУсловноеОформление();
	ЗаголовокСсылкиУстановкиРеквизитов();
КонецПроцедуры

#Область УстановкаРеквизитовПоУмолчанию

&НаСервере
Процедура ЗаголовокСсылкиУстановкиРеквизитов()
	
	МассивРеквизитов = СтрРазделить("Родитель,ВидНоменклатуры,НоменклатурнаяГруппа,ЕдиницаИзмерения,СтавкаНДС", ",", Ложь);
	МассивЗначений = Новый Массив;
	Для Каждого ЭлементМассива Из МассивРеквизитов Цикл
		
		ЗначениеРеквизитаСтр = Строка(ЭтотОбъект[ЭлементМассива]);
		Если Не ПустаяСтрока(ЗначениеРеквизитаСтр) Тогда
			
			Если ЭлементМассива = "СтавкаНДС" Тогда
				
				МассивЗначений.Добавить("НДС " + Строка(ЗначениеРеквизитаСтр));
				
			Иначе
			
				МассивЗначений.Добавить(Строка(ЗначениеРеквизитаСтр));
			
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	ЗаголовокСсылки = НСтр("ru = 'Реквизиты новой номенклатуры: '");
	ПерваяИтерация = Истина;
	Для Каждого ЭлементМассива Из МассивЗначений Цикл
		
		ЗаголовокСсылки = ЗаголовокСсылки + ?(ПерваяИтерация, "", ", ") + ЭлементМассива;
		ПерваяИтерация = Ложь;
		
	КонецЦикла;
	НадписьСсылкиУстановкиРеквизитов = ЗаголовокСсылки;

КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияФормыУстановкиЗначенийРеквизитов(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	Если РезультатЗакрытия = Неопределено ИЛИ РезультатЗакрытия = КодВозвратаДиалога.Отмена Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, РезультатЗакрытия);
	ЗаголовокСсылкиУстановкиРеквизитов();
	
КонецПроцедуры

#КонецОбласти

&НаСервереБезКонтекста
Процедура ЗаполнитьОтборыДляНоменклатуры(Отбор, Производитель, Импортер, АлкогольнаяПродукция)
	
	КонтрагентыЕГАИС = Новый Массив;
	КонтрагентыЕГАИС.Добавить(Производитель);
	КонтрагентыЕГАИС.Добавить(Импортер);
	
	СоответствиеКонтрагентовЕГАИС = Обработки.СопоставлениеДанныхЕГАИС.СоответствиеКонтрагентовЕГАИС(КонтрагентыЕГАИС);
	СоответствиеКонтрагентовЕГАИС.Вставить(Справочники.КлассификаторОрганизацийЕГАИС.ПустаяСсылка(), Справочники.Контрагенты.ПустаяСсылка());
	
	Если ЗначениеЗаполнено(Производитель) Тогда
		Отбор.Вставить("Производитель", СоответствиеКонтрагентовЕГАИС[Производитель]);
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(Импортер) Тогда
		Отбор.Вставить("Импортер", СоответствиеКонтрагентовЕГАИС[Импортер]);
	КонецЕсли;
	
	СвойстваАлкогольнойПродукции = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(АлкогольнаяПродукция, "ВидПродукции.Код, Объем");
	
	Отбор.Вставить("КодАлкогольнойПродукции", СвойстваАлкогольнойПродукции.ВидПродукцииКод);
	Отбор.Вставить("Объем", СвойстваАлкогольнойПродукции.Объем);
	
КонецПроцедуры

&НаСервере
Функция ВидыАлкогольнойПродукции()
	Результат = Новый Соответствие;

	Макет169 = РегистрыСведений.СведенияОбАлкогольнойПродукции.ПолучитьМакет("Макет169");
	
	Область = Макет169.Области.ВидыПродукции;
	Если Область.ТипОбласти = ТипОбластиЯчеекТабличногоДокумента.Строки Тогда
		ВерхОбласти = Область.Верх;
		НизОбласти = Область.Низ;
		Для НомСтр = ВерхОбласти По НизОбласти Цикл
			КодПоказателя = СокрП(Макет169.Область(НомСтр, 1).Текст);
			Если НЕ ПустаяСтрока(КодПоказателя) И КодПоказателя <> "###" Тогда
				Наименование = СокрП(Макет169.Область(НомСтр, 2).Текст);
				Результат.Вставить(КодПоказателя, Наименование);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
КонецФункции

&НаСервереБезКонтекста
Функция ДанныеЗаполненияНоменклатуры(ДанныеСтроки, ДанныеОбъекта, СоответствиеКонтрагентовЕГАИС)
	
	КонтрагентыЕГАИС = Новый Массив;
	
	Если СоответствиеКонтрагентовЕГАИС[ДанныеСтроки.Производитель] = Неопределено Тогда
		КонтрагентыЕГАИС.Добавить(ДанныеСтроки.Производитель);
	КонецЕсли; 
	
	Если СоответствиеКонтрагентовЕГАИС[ДанныеСтроки.Импортер] = Неопределено Тогда
		КонтрагентыЕГАИС.Добавить(ДанныеСтроки.Импортер);
	КонецЕсли; 
	
	Если КонтрагентыЕГАИС.Количество() > 0 Тогда
		ОбщегоНазначенияКлиентСервер.ДополнитьСоответствие(
			СоответствиеКонтрагентовЕГАИС, 
			Обработки.СопоставлениеДанныхЕГАИС.СоответствиеКонтрагентовЕГАИС(КонтрагентыЕГАИС));
	КонецЕсли; 
	
	ДанныеАлкогольнойПродукции = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДанныеСтроки.АлкогольнаяПродукция, "Наименование, НаименованиеПолное");
	
	ДанныеЗаполнения = Новый Структура;
	ДанныеЗаполнения.Вставить("Наименование",         СокрЛП(ДанныеАлкогольнойПродукции.Наименование));
	ДанныеЗаполнения.Вставить("НаименованиеПолное",   СокрЛП(ДанныеАлкогольнойПродукции.НаименованиеПолное));
	ДанныеЗаполнения.Вставить("ВидНоменклатуры",      ДанныеОбъекта.ВидНоменклатуры);
	ДанныеЗаполнения.Вставить("Родитель",             ДанныеОбъекта.Родитель);
	ДанныеЗаполнения.Вставить("НоменклатурнаяГруппа", ДанныеОбъекта.НоменклатурнаяГруппа);
	ДанныеЗаполнения.Вставить("СтавкаНДС",            ДанныеОбъекта.СтавкаНДС);
	ДанныеЗаполнения.Вставить("ЕдиницаИзмерения",     ДанныеОбъекта.ЕдиницаИзмерения);
	ДанныеЗаполнения.Вставить("Производитель",        СоответствиеКонтрагентовЕГАИС[ДанныеСтроки.Производитель]);
	ДанныеЗаполнения.Вставить("Импортер",             СоответствиеКонтрагентовЕГАИС[ДанныеСтроки.Импортер]);
	
	Возврат ДанныеЗаполнения;
КонецФункции

&НаСервере
Процедура СоздатьНовыеЭлементыСправочникаНоменклатуры(СопоставлениеКонтрагенты)
	ДанныеОбъекта = Новый Структура("ВидНоменклатуры, Родитель, НоменклатурнаяГруппа, СтавкаНДС, ЕдиницаИзмерения");
	ЗаполнитьЗначенияСвойств(ДанныеОбъекта, ЭтаФорма);
	
	СозданныеЭлементы = Новый Соответствие;
	
	ДанныеСтроки = Новый Структура("АлкогольнаяПродукция, Производитель, Импортер");
		
	Для каждого СтрокаТовары Из Объект.Товары Цикл
		
		Если СтрокаТовары.Статус = 2 Тогда
			Если СозданныеЭлементы[СтрокаТовары.АлкогольнаяПродукция] = Неопределено Тогда
				ЗаполнитьЗначенияСвойств(ДанныеСтроки, СтрокаТовары);
				
				ДанныеЗаполнения = ДанныеЗаполненияНоменклатуры(ДанныеСтроки, ДанныеОбъекта, СопоставлениеКонтрагенты);
				
				ЭлементНоменклатуры = Справочники.Номенклатура.СоздатьЭлемент();
				ЭлементНоменклатуры.Наименование = ДанныеЗаполнения.Наименование;
				ЭлементНоменклатуры.Заполнить(ДанныеЗаполнения);
				ЭлементНоменклатуры.Записать();
				
				СозданныеЭлементы.Вставить(СтрокаТовары.АлкогольнаяПродукция, ЭлементНоменклатуры.Ссылка);
			КонецЕсли; 
		
			СтрокаТовары.Номенклатура = СозданныеЭлементы[СтрокаТовары.АлкогольнаяПродукция];
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСведенияОбАлкогольнойПродукции()
	// Заполняем сведения об алкогольной продукции только для тех элементов, для которых такой записи нет
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаТовары", Объект.Товары.Выгрузить(,"АлкогольнаяПродукция, Номенклатура, Объем"));
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаТовары.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ТаблицаТовары.Номенклатура КАК Номенклатура,
	|	ТаблицаТовары.Объем КАК Объем
	|ПОМЕСТИТЬ ТаблицаТовары
	|ИЗ
	|	&ТаблицаТовары КАК ТаблицаТовары
	|ГДЕ
	|	ТаблицаТовары.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТовары.Номенклатура КАК Номенклатура,
	|	ВидыАлкогольнойПродукцииЕГАИС.Код КАК КодВида169,
	|	ВидыАлкогольнойПродукцииЕГАИС.ВидЛицензии КАК ВидЛицензии,
	|	ТаблицаТовары.Объем / 10 КАК КоэффПересчетаДал,
	|	ВидыАлкогольнойПродукцииЕГАИС.Маркируемый КАК Маркируемый
	|ИЗ
	|	ТаблицаТовары КАК ТаблицаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОбАлкогольнойПродукции КАК СведенияОбАлкогольнойПродукции
	|		ПО ТаблицаТовары.Номенклатура = СведенияОбАлкогольнойПродукции.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК КлассификаторАлкогольнойПродукцииЕГАИС
	|		ПО ТаблицаТовары.АлкогольнаяПродукция = КлассификаторАлкогольнойПродукцииЕГАИС.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыАлкогольнойПродукции КАК ВидыАлкогольнойПродукцииЕГАИС
	|		ПО (КлассификаторАлкогольнойПродукцииЕГАИС.ВидПродукции = ВидыАлкогольнойПродукцииЕГАИС.Ссылка)
	|ГДЕ
	|	СведенияОбАлкогольнойПродукции.Номенклатура ЕСТЬ NULL";
	
	СоответствиеВидовЛицензийЕГАИС = Обработки.СопоставлениеДанныхЕГАИС.СоответствиеВидовЛицензийЕГАИС();
	ВидыАлкогольнойПродукции = ВидыАлкогольнойПродукции();
	
	ТаблицаТоваров = Запрос.Выполнить().Выгрузить();
	
	Для каждого СтрокаТовары Из ТаблицаТоваров Цикл
		ЗаписьСведений = РегистрыСведений.СведенияОбАлкогольнойПродукции.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(ЗаписьСведений, СтрокаТовары);
		
		Если ЗначениеЗаполнено(СтрокаТовары.ВидЛицензии) Тогда
			ВидЛицензии = СоответствиеВидовЛицензийЕГАИС[СтрокаТовары.ВидЛицензии];
		Иначе
			ВидЛицензии = ?(СтрокаТовары.Маркируемый, Перечисления.ВидыЛицензийНаПродажуАлкоголя.АлкогольнаяПродукция, Перечисления.ВидыЛицензийНаПродажуАлкоголя.Пиво);
		КонецЕсли; 
		
		ЗаписьСведений.ВидЛицензии         = ВидЛицензии;
		ЗаписьСведений.НаименованиеВида169 = ВидыАлкогольнойПродукции[СтрокаТовары.КодВида169];
		
		ЗаписьСведений.Записать(Истина);
	КонецЦикла; 

КонецПроцедуры 

&НаСервере
Функция ТаблицаСопоставленияНоменклатуры()

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаТовары", Объект.Товары.Выгрузить(,"НомерСтроки_ЕГАИС, АлкогольнаяПродукция, ИдентификаторУпаковки, Номенклатура, КоэффициентПересчетаУпаковки"));
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаТовары.НомерСтроки_ЕГАИС КАК НомерСтроки,
	|	ТаблицаТовары.АлкогольнаяПродукция,
	|	ТаблицаТовары.ИдентификаторУпаковки,
	|	ТаблицаТовары.Номенклатура,
	|	ТаблицаТовары.КоэффициентПересчетаУпаковки
	|ПОМЕСТИТЬ ТаблицаТовары
	|ИЗ
	|	&ТаблицаТовары КАК ТаблицаТовары
	|ГДЕ
	|	ТаблицаТовары.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТовары.НомерСтроки,
	|	ТаблицаТовары.АлкогольнаяПродукция,
	|	ТаблицаТовары.ИдентификаторУпаковки,
	|	ТаблицаТовары.КоэффициентПересчетаУпаковки,
	|	ТаблицаТовары.Номенклатура
	|ИЗ
	|	ТаблицаТовары КАК ТаблицаТовары";
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

&НаСервере
Функция ПеренестиВДокументНаСервере(СопоставлениеКонтрагенты)
	
	Если НЕ ПроверитьЗаполнение() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	НачатьТранзакцию();
	
	СоздатьНовыеЭлементыСправочникаНоменклатуры(СопоставлениеКонтрагенты);
	ЗаполнитьСведенияОбАлкогольнойПродукции();
	
	ТаблицаСопоставленияНоменклатуры = ТаблицаСопоставленияНоменклатуры();
	
	ЗафиксироватьТранзакцию();
	
	СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("ТаблицаСопоставленияНоменклатуры", ОбщегоНазначения.ТаблицаЗначенийВМассив(ТаблицаСопоставленияНоменклатуры));
	СтруктураРезультат.Вставить("ТаблицаСопоставленияКонтрагентов", СопоставлениеКонтрагенты);
	
	Возврат ПоместитьВоВременноеХранилище(СтруктураРезультат);
КонецФункции

#КонецОбласти



