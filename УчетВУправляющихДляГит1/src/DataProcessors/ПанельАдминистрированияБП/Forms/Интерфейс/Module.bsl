#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	ТолькоПросмотр = НЕ ПравоДоступа("Изменение", Метаданные.Константы.ИнтерфейсТакси)
		ИЛИ НЕ ПравоДоступа("Изменение", Метаданные.Константы.ИнтерфейсТаксиПростой);
		
	Элементы.ВариантИнтерфейса.ТолькоПросмотр = ТолькоПросмотр;
	Элементы.ИспользоватьТабличныеФормыБанковскихДокументов.ТолькоПросмотр = ТолькоПросмотр;
	
	ВестиУчетПоОрганизациям = ПолучитьФункциональнуюОпцию("ВестиУчетПоОрганизациям");
	СистемаНалогообложенияТребуетПолныйИнтерфейс = УчетнаяПолитика.ТребуетсяПолныйИнтерфейс();
	ИспользуетсяФункциональностьПолногоИнтерфейса = Обработки.ФункциональностьПрограммы.ТребуетсяПолныйИнтерфейс();
	
	БлокироватьПростойИнтерфейс = ВестиУчетПоОрганизациям;
	ВыводитьПредупреждениеПростойИнтерфейс = СистемаНалогообложенияТребуетПолныйИнтерфейс
		ИЛИ ИспользуетсяФункциональностьПолногоИнтерфейса;
	
	Элементы.ОграничениеПростогоИнтерфейсаСистемаНалогообложения.Видимость = СистемаНалогообложенияТребуетПолныйИнтерфейс;
	Элементы.ОграничениеПростогоИнтерфейсаФункциональность.Видимость = ИспользуетсяФункциональностьПолногоИнтерфейса;
	
	// Значения реквизитов формы
	Если Константы.ИнтерфейсТакси.Получить() Тогда
		ВариантИнтерфейса = "ИнтерфейсТакси";
	ИначеЕсли Константы.ИнтерфейсТаксиПростой.Получить() Тогда
		ВариантИнтерфейса = "ИнтерфейсТаксиПростой";
	ИначеЕсли Константы.ИнтерфейсВерсии77.Получить() Тогда
		ВариантИнтерфейса = "ИнтерфейсВерсии77";
	Иначе
		ВариантИнтерфейса = "";
	КонецЕсли;
	
	ВариантИнтерфейсаДоИзменения = ВариантИнтерфейса;
	Если ВариантИнтерфейса = "" Тогда
		ВариантИнтерфейса = "ИнтерфейсТаксиПростой";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ВариантИнтерфейсаПриИзменении(Элемент)
	
	ИнтерфейсИзменен = ВариантИнтерфейсаДоИзменения <> ВариантИнтерфейса;
	ВыбранПростойИнтерфейс = ВариантИнтерфейса = "ИнтерфейсТаксиПростой";
	
	Если ВыбранПростойИнтерфейс Тогда
		ДоступноИзменениеИнтерфейса = ИнтерфейсИзменен И НЕ БлокироватьПростойИнтерфейс;
	Иначе
		ДоступноИзменениеИнтерфейса = ИнтерфейсИзменен;
	КонецЕсли;
	
	Элементы.БлокировкаПростойИнтерфейс.Видимость = ИнтерфейсИзменен
		И ВыбранПростойИнтерфейс
		И БлокироватьПростойИнтерфейс;
		
	Элементы.ГруппаПредупреждениеПростойИнтерфейс.Видимость = ИнтерфейсИзменен
		И ВыбранПростойИнтерфейс
		И ВыводитьПредупреждениеПростойИнтерфейс
		И НЕ БлокироватьПростойИнтерфейс;
		
	Элементы.ГруппаПерезапускКнопка.Видимость = ДоступноИзменениеИнтерфейса;
	
КонецПроцедуры

&НаКлиенте
Процедура ИспользоватьТабличныеФормыБанковскихДокументовПриИзменении(Элемент)
	Подключаемый_ПриИзмененииРеквизита(Элемент, Ложь);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Перезапустить(Команда)
	
	УстановитьИнтерфейсНаСервере(ВариантИнтерфейса);
	
	ЗавершитьРаботуСистемы(Ложь, Истина);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Процедура УстановитьИнтерфейсНаСервере(ВариантИнтерфейса)

	ОбщегоНазначенияБП.УстановитьРежимКомандногоИнтерфейса(ВариантИнтерфейса);
	ХранилищеОбщихНастроек.Сохранить(ВРег("ДатаСменыИнтерфейса"),,ТекущаяДатаСеанса(),,);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПриИзмененииРеквизита(Элемент, ОбновлятьИнтерфейс = Истина)
	
	Результат = ПриИзмененииРеквизитаСервер(Элемент.Имя);
	
КонецПроцедуры

&НаСервере
Функция ПриИзмененииРеквизитаСервер(ИмяЭлемента)
	
	Результат = Новый Структура;
	
	РеквизитПутьКДанным = Элементы[ИмяЭлемента].ПутьКДанным;
	
	СохранитьЗначениеРеквизита(РеквизитПутьКДанным, Результат);
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура СохранитьЗначениеРеквизита(РеквизитПутьКДанным, Результат)
	
	// Сохранение значений реквизитов, не связанных с константами напрямую (в отношении один-к-одному).
	Если РеквизитПутьКДанным = "" Тогда
		Возврат;
	КонецЕсли;
	
	// Определение имени константы.
	КонстантаИмя = "";
	Если НРег(Лев(РеквизитПутьКДанным, 14)) = НРег("НаборКонстант.") Тогда
		// Если путь к данным реквизита указан через "НаборКонстант".
		КонстантаИмя = Сред(РеквизитПутьКДанным, 15);
	КонецЕсли;
	
	// Сохранения значения константы.
	Если КонстантаИмя <> "" Тогда
		КонстантаМенеджер = Константы[КонстантаИмя];
		КонстантаЗначение = НаборКонстант[КонстантаИмя];
		
		Если КонстантаМенеджер.Получить() <> КонстантаЗначение Тогда
			КонстантаМенеджер.Установить(КонстантаЗначение);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
