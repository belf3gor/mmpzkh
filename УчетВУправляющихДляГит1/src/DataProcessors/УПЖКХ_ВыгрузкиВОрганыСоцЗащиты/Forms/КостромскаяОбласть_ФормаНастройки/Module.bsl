
//////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

#Область ОбработчикиСобытийФормы

&НаСервере
// Обработчик события "ПриСозданииНаСервере" формы.
//
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Получаем настройки из хранилища.
	Если Параметры.Свойство("АдресНастроекВХранилище") И Не Параметры.АдресНастроекВХранилище = Неопределено Тогда
		
		врУслугиВБазе = ПолучитьИзВременногоХранилища(Параметры.АдресНастроекВХранилище);
		
		Если ТипЗнч(врУслугиВБазе) = Тип("ТаблицаЗначений") Тогда
			Объект.КостромскаяОбласть_ТаблицаСоответствий.Загрузить(врУслугиВБазе);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ПриСозданииНаСервере()

#КонецОбласти

////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ КОМАНДНОЙ ПАНЕЛИ ТАБЛИЧНОГО ПОЛЯ "УСЛУГА В БАЗЕ"

#Область ОбработчикиСобытийКоманднойПанели

&НаКлиенте
// Процедура обработки события нажатия на кнопку "Заполнить"
//
Процедура КомандаЗаполнитьНажание(Команда)
	
	Если Объект.КостромскаяОбласть_ТаблицаСоответствий.Количество() > 0 Тогда
		
		Оповещение = Новый ОписаниеОповещения("КомандаЗаполнитьНажаниеЗавершение", ЭтотОбъект);
		
		ТекстВопроса = "Перед повторным заполнением табличная часть будет очищена. Продолжить?";
		
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Иначе
		КомандаЗаполнитьНажаниеНаСервере();
	КонецЕсли;
	
КонецПроцедуры // ЗаполнитьНажание()

&НаКлиенте
// Обработчик результата опроса команды "КомандаЗаполнить".
Процедура КомандаЗаполнитьНажаниеЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		
		Объект.КостромскаяОбласть_ТаблицаСоответствий.Очистить();
		
		КомандаЗаполнитьНажаниеНаСервере();
		
	КонецЕсли;
	
КонецПроцедуры // КомандаЗаполнитьНажаниеЗавершение()

&НаСервере
// Процедура обработки события нажатия на кнопку "Заполнить" НаСервере.
// Выгружается список всех услуг из Справочника "КВП_Услуги". 
//
Процедура КомандаЗаполнитьНажаниеНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КВП_Услуги.Ссылка КАК Услуга
	|ИЗ
	|	Справочник.КВП_Услуги КАК КВП_Услуги
	|ГДЕ
	|	НЕ КВП_Услуги.ЭтоГруппа
	|	И НЕ КВП_Услуги.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	Услуга";
	
	Объект.КостромскаяОбласть_ТаблицаСоответствий.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры // ЗаполнитьНажаниеНаСервере()

#КонецОбласти

////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ "УСЛУГА В БАЗЕ"

#Область ОбработчикиСобытийТаблицыУслуг

&НаКлиенте
// Процедура - обработчик события "НачалоВыбора" поля "Услуга" таблицы "ТП_Услуга_ВБазе".
//
Процедура ТП_Услуга_ВБазеУслугаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Форма = ПолучитьФорму("Справочник.КВП_Услуги.ФормаВыбора", , Элемент);
	
	Если Объект.КостромскаяОбласть_ТаблицаСоответствий.Количество() > 1 Тогда
		
		СписокУслуг = Новый СписокЗначений;
		ЗаполнитьСписокУслугНаСервере(СписокУслуг);
		
		УПЖКХ_ТиповыеМетодыКлиентСервер.УстановитьЭлементОтбора(Форма.Список.Отбор,
																"Код",
																СписокУслуг, 
																ВидСравненияКомпоновкиДанных.НеВСписке);
	КонецЕсли;
	
	Форма.Открыть();
	
КонецПроцедуры // ТП_Услуга_ВБазеУслугаНачалоВыбора()

&НаСервере
// Заполнение списка отбора СписокУслуг
//
Процедура ЗаполнитьСписокУслугНаСервере(СписокУслуг)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УслугиВБазе.Услуга
	|ПОМЕСТИТЬ втУслугиВБазе
	|ИЗ
	|	&УслугиВБазе КАК УслугиВБазе
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втУслугиВБазе.Услуга.Код КАК Код
	|ИЗ
	|	втУслугиВБазе КАК втУслугиВБазе";
	
	Запрос.УстановитьПараметр("УслугиВБазе", Объект.КостромскаяОбласть_ТаблицаСоответствий.Выгрузить());
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Пока РезультатЗапроса.Следующий() Цикл
		СписокУслуг.Добавить(РезультатЗапроса.Код);
	КонецЦикла;
	
КонецПроцедуры // ЗаполнитьСписокУслугНаСервере()

&НаКлиенте
// Процедура - обработчик события "ПередОкончаниемРедактирования" таблицы "ТП_Услуга_ВБазе".
//
Процедура ТП_Услуга_ВБазеПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	Если Элемент.ТекущиеДанные.Услуга.Пустая() Тогда
		УПЖКХ_ТиповыеМетодыКлиентСервер.СообщитьПользователю("Добавление незаполненных полей недопустимо!");
		Объект.КостромскаяОбласть_ТаблицаСоответствий.Удалить(Элемент.ТекущиеДанные);
	КонецЕсли;
	
КонецПроцедуры // ТП_Услуга_ВБазеПередОкончаниемРедактирования()

&НаКлиенте
// Процедура обработчик события "ОкончаниеВводаТекста" поля "КодУслуги".
//
Процедура ТП_Услуга_ВБазеКодУслугиОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, СтандартнаяОбработка)
	
	Если СтрДлина(Текст) = 1 Тогда
		Текст = "0" + Текст;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

#Область ОбработчикиКомандФормы

&НаКлиенте
// Обработчик команды "КомандаСохранить".
//
Процедура КомандаСохранить(Команда)
	
	Закрыть(ПоместитьУслугиВХранилище());
	
КонецПроцедуры // КомандаСохранить()

&НаСервере
// Помещает таблицу услуг во временное хранилище.
//
Функция ПоместитьУслугиВХранилище()
	
	Возврат ПоместитьВоВременноеХранилище(Объект.КостромскаяОбласть_ТаблицаСоответствий.Выгрузить(), Новый УникальныйИдентификатор);
	
КонецФункции // ПоместитьУслугиВХранилище()

#КонецОбласти
