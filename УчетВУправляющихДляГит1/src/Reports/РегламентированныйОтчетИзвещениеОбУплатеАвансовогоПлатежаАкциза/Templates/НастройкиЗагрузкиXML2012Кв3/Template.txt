// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
//  * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
//  * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//    поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//    нужно всегда использовать схему по умолчанию - указываем значение "null".
//  * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//  * Параметр "ИмяФайлаНастроек" содержит путь к файлу настроек для быстрого описания
//    правил загрузки без сохранения конфигурации. После отладки правил загрузки нужно
//    обязательно перенести содержимое файла в макет и удалить параметр или присвоить ему
//    значение "null". В целях безопасности нельзя выпускать конфигурации с заполненным
//    параметром "ИмяФайлаНастроек".
//
// Примечание:
//  Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
//  поэтому обработчики используются для получения значений показателей не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : null,
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

// Доступны параметры:
//
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПредОбработкаСхемыЗагрузки
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Раздел", "Раздел1"), Истина);
	Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
		Если СтрЗаканчиваетсяНа(НайденнаяСтрока.Ключ, "_") Тогда
			НайденнаяСтрока.Раздел = "Извещение";
			НайденнаяСтрока.Ключ = Лев(НайденнаяСтрока.Ключ, СтрДлина(НайденнаяСтрока.Ключ) - 1);
		КонецЕсли;
	КонецЦикла;
	
#КонецОбласти

// Доступны параметры:
//
//  П.ДанныеОтчета      - заполненные данные документа регламентированного отчета;
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПостОбработкаДокументаОтчета
	
	РазделИзвещение = Неопределено;
	
	П.ДанныеОтчета.ПоказателиОтчета.Свойство("ПолеТабличногоДокументаИзвещение", РазделИзвещение);
	Если РазделИзвещение <> Неопределено Тогда
		
		П.ДанныеОтчета.СтруктураДанныхОтчета.Вставить("СрокДействияНачало", ДатаИзСтрокиЛюбогоФормата(П.ПараметрыОтчета.СрокНачало));
		П.ДанныеОтчета.СтруктураДанныхОтчета.Вставить("СрокДействияОкончание", ДатаИзСтрокиЛюбогоФормата(П.ПараметрыОтчета.СрокОкончание));
		
		НалоговыйПериодНачало    = Формат(ДатаИзСтрокиЛюбогоФормата(П.ПараметрыОтчета.СрокНачало), "ДФ=ddMMyyyy");
		НалоговыйПериодОкончание = Формат(ДатаИзСтрокиЛюбогоФормата(П.ПараметрыОтчета.СрокОкончание), "ДФ=ddMMyyyy");
		Для Поз = 1 По 8 Цикл
			НалоговыйПериодНачалоСимв    = ?(СтрДлина(НалоговыйПериодНачало) >= Поз, Сред(НалоговыйПериодНачало, Поз, 1), "");
			НалоговыйПериодОкончаниеСимв = ?(СтрДлина(НалоговыйПериодОкончание) >= Поз, Сред(НалоговыйПериодОкончание, Поз, 1), "");
			РазделИзвещение["НалоговыйПериодНачало" + Поз] = НалоговыйПериодНачалоСимв;
			РазделИзвещение["НалоговыйПериодОкончание" + Поз] = НалоговыйПериодОкончаниеСимв;
		КонецЦикла;
		
		ДатаДок = ДатаИзСтрокиЛюбогоФормата(П.ПараметрыОтчета.ДатаДок);
		РазделИзвещение.Число = ДатаДок;
		РазделИзвещение.Месяц = ДатаДок;
		РазделИзвещение.Год = ДатаДок;
		
		РазделИзвещение.НомерЗаяв = П.ПараметрыОтчета.НомДок;
		РазделИзвещение.РегНомерАннулированногоИзвещения = П.ПараметрыОтчета.РегНомАннДок;
		РазделИзвещение.НомерЗаменыИзвещения = ЧислоИзСтроки(П.ПараметрыОтчета.ПорядНомЗамДок);
		
		РазделИзвещение.ИФНС = СокрЛП(П.ПараметрыОтчета.КодНО);
		
		РазделИзвещение.ПродавецИНН     = СокрЛП(П.ПараметрыОтчета.ИННЮЛПрод);
		РазделИзвещение.ПродавецКПП     = СокрЛП(П.ПараметрыОтчета.КПППрод);
		РазделИзвещение.ПродавецНаимОрг = СокрЛП(П.ПараметрыОтчета.НаимОргПрод);
		
		РазделИзвещение.ПокупательИНН     = СокрЛП(П.ПараметрыОтчета.ИННОрг);
		РазделИзвещение.ПокупательКПП     = СокрЛП(П.ПараметрыОтчета.КППОрг);
		РазделИзвещение.ПокупательНаимОрг = СокрЛП(П.ПараметрыОтчета.НаимОрг);
		
	КонецЕсли;
	
#КонецОбласти