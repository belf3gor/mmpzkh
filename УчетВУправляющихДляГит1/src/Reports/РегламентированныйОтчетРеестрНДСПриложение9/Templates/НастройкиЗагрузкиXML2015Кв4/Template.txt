// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
//  * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
//  * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//    поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//    нужно всегда использовать схему по умолчанию - указываем значение "null".
//  * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//
// Примечание:
//  Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
//  поэтому обработчики используются для получения значений показателей не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : null,
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

// Доступны параметры:
//
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПредОбработкаСхемыЗагрузки
	
	ДобавитьКолонкуВДеревоЕслиНеНайдена(П.ДеревоДляЗагрузки, "МнУр"); // для определения многоуровневых разделов
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Многостраничность", Истина), Истина);
	Если НайденныеСтроки.Количество() > 0 Тогда
		Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
			СтрокаДерева.МнУр = Истина;
			СтрокаДерева.Многостраничность = Ложь;
		КонецЦикла;
		НайденныеСтроки[0].Многостраничность = Истина;
	КонецЕсли;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Обязательность,Многострочность", "ОМ", Истина), Истина);
	Если НайденныеСтроки.Количество() > 0 Тогда
		НайденныеСтроки[0].Обязательность = "ОМП";
	КонецЕсли;
	
#КонецОбласти

// Доступны параметры:
//
//  П.ДанныеОтчета      - заполненные данные документа регламентированного отчета;
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПостОбработкаДокументаОтчета
	
	Титульный = Неопределено;
	
	П.ДанныеОтчета.ПоказателиОтчета.Свойство("ПолеТабличногоДокументаТитульный", Титульный);
	Если Титульный <> Неопределено Тогда
		
		Титульный.НалоговыйОрган = П.ПараметрыОтчета.КодИФНС;
		
		Если ЗначениеЗаполнено(П.ПараметрыОтчета.КодФормРеорг) Тогда
			Титульный.КодФормыРеорганизации          = П.ПараметрыОтчета.КодФормРеорг;
			Титульный.ИННРеорганизованнойОрганизации = П.ПараметрыОтчета.ИННОргРеорг;
			Титульный.КППРеорганизованнойОрганизации = П.ПараметрыОтчета.КППОргРеорг;
		КонецЕсли;
		
	КонецЕсли;
	
	УзлыСтраницыРеестра = УзлыПоXPath(П.ДеревоДляЗагрузки, "//Документ/РеестрАВН_9"); // многоуровневый раздел (Реестр)
	
	НомСтраницы = Новый Массив(1);
	
	Для НомСтраницыУровень1 = 1 По УзлыСтраницыРеестра.Количество() Цикл
		
		УзелСтраницаРеестра = УзлыСтраницыРеестра[НомСтраницыУровень1 - 1];
		
		НомСтраницы[0] = НомСтраницыУровень1;
		
		НомСтроки = Новый Массив(1);
		УзлыСтрокСтраницыРеестра = УзлыПоXPath(УзелСтраницаРеестра, "СведАВН"); // строки многоуровневого раздела (Реестр)
		Для НомСтрокиУровень1 = 1 По УзлыСтрокСтраницыРеестра.Количество() Цикл
			НомСтроки[0] = НомСтрокиУровень1;
			УзелСтрокаСтраницыРеестра = УзлыСтрокСтраницыРеестра[НомСтрокиУровень1 - 1];
			
			УзелОтпр = УзлыПоXPath(УзелСтрокаСтраницыРеестра, "Отпр")[0];
			УзлыСведФЛ = УзлыПоXPath(УзелОтпр, "СведФЛ");
			Если ЗначениеЗаполнено(УзлыСведФЛ) Тогда
				УзелФИО = УзлыПоXPath(УзлыСведФЛ[0], "ФИО")[0];
				УзелФамилия = УзлыПоXPath(УзелФИО, "@Фамилия")[0];
				СтрФИО = СокрЛП(УзелФамилия.Значение);
				УзелИмя = УзлыПоXPath(УзелФИО, "@Имя")[0];
				СтрФИО = СтрФИО + " " + УзелИмя.Значение;
				УзелИмя.Ключ = "";
				УзлыОтчество = УзлыПоXPath(УзелФИО, "@Отчество");
				Если ЗначениеЗаполнено(УзлыОтчество) Тогда
					СтрФИО = СтрФИО + " " + УзлыОтчество[0].Значение;
					УзлыОтчество[0].Ключ = "";
				КонецЕсли;
				Если ПустаяСтрока(СтрФИО) Тогда
					УзелОтпр.Строки.Удалить(УзлыСведФЛ[0]);
				Иначе
					УзелФамилия.Значение = СокрП(СтрФИО);
					
					ДопУзел = СкопированныйУзел(УзелОтпр, УзлыПоXPath(УзелОтпр, "@Адрес")[0]);
					ДопУзел.Код  = "ЭтоФЛ";
					ДопУзел.Ключ = "П1000091";
					ДопУзел.МинРазмерность  = 0;
					ДопУзел.МаксРазмерность = 1;
					ДопУзел.Значение = "V";
				КонецЕсли;
			КонецЕсли;
			
			УзелПолуч = УзлыПоXPath(УзелСтрокаСтраницыРеестра, "Получ")[0];
			УзлыСведФЛ = УзлыПоXPath(УзелПолуч, "СведФЛ");
			Если ЗначениеЗаполнено(УзлыСведФЛ) Тогда
				УзелФИО = УзлыПоXPath(УзлыСведФЛ[0], "ФИО")[0];
				УзелФамилия = УзлыПоXPath(УзелФИО, "@Фамилия")[0];
				СтрФИО = СокрЛП(УзелФамилия.Значение);
				УзелИмя = УзлыПоXPath(УзелФИО, "@Имя")[0];
				СтрФИО = СтрФИО + " " + УзелИмя.Значение;
				УзелИмя.Ключ = "";
				УзлыОтчество = УзлыПоXPath(УзелФИО, "@Отчество");
				Если ЗначениеЗаполнено(УзлыОтчество) Тогда
					СтрФИО = СтрФИО + " " + УзлыОтчество[0].Значение;
					УзлыОтчество[0].Ключ = "";
				КонецЕсли;
				Если ПустаяСтрока(СтрФИО) Тогда
					УзелПолуч.Строки.Удалить(УзлыСведФЛ[0]);
				Иначе
					УзелФамилия.Значение = СокрП(СтрФИО);
					
					ДопУзел = СкопированныйУзел(УзелПолуч, УзлыПоXPath(УзелПолуч, "@Адрес")[0]);
					ДопУзел.Код  = "ЭтоФЛ";
					ДопУзел.Ключ = "П1000092";
					ДопУзел.МинРазмерность  = 0;
					ДопУзел.МаксРазмерность = 1;
					ДопУзел.Значение = "V";
				КонецЕсли;
			КонецЕсли;
			
			УзелАгентАв = УзлыПоXPath(УзелСтрокаСтраницыРеестра, "АгентАв")[0];
			УзлыСведФЛ = УзлыПоXPath(УзелАгентАв, "СведФЛ");
			Если ЗначениеЗаполнено(УзлыСведФЛ) Тогда
				УзелФИО = УзлыПоXPath(УзлыСведФЛ[0], "ФИО")[0];
				УзелФамилия = УзлыПоXPath(УзелФИО, "@Фамилия")[0];
				СтрФИО = СокрЛП(УзелФамилия.Значение);
				УзелИмя = УзлыПоXPath(УзелФИО, "@Имя")[0];
				СтрФИО = СтрФИО + " " + УзелИмя.Значение;
				УзелИмя.Ключ = "";
				УзлыОтчество = УзлыПоXPath(УзелФИО, "@Отчество");
				Если ЗначениеЗаполнено(УзлыОтчество) Тогда
					СтрФИО = СтрФИО + " " + УзлыОтчество[0].Значение;
					УзлыОтчество[0].Ключ = "";
				КонецЕсли;
				Если ПустаяСтрока(СтрФИО) Тогда
					УзелАгентАв.Строки.Удалить(УзлыСведФЛ[0]);
				Иначе
					УзелФамилия.Значение = СокрП(СтрФИО);
					
					ДопУзел = СкопированныйУзел(УзелАгентАв, УзлыПоXPath(УзелАгентАв, "@Адрес")[0]);
					ДопУзел.Код  = "ЭтоФЛ";
					ДопУзел.Ключ = "П1000093";
					ДопУзел.МинРазмерность  = 0;
					ДопУзел.МаксРазмерность = 1;
					ДопУзел.Значение = "V";
				КонецЕсли;
			КонецЕсли;
			
			ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(УзелСтрокаСтраницыРеестра, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы, НомСтроки);
		КонецЦикла;
		
	КонецЦикла;
	
	Реестр = Неопределено;
	
	П.ДанныеОтчета.ДанныеМногоуровневыхРазделов.Свойство("Реестр", Реестр);
	Если Реестр <> Неопределено Тогда
		ТаблДокПрототип = Новый ТабличныйДокумент;
		
		Рег = РегистрыСведений.ДополнительныеФайлыРегламентированныхОтчетов;
		
		Если П.ПараметрыОтчета.Свойство("СтруктураМногострочныхЧастей") Тогда
			СтруктураМногострочныхЧастей = П.ПараметрыОтчета.СтруктураМногострочныхЧастей;
		Иначе
			СтруктураМногострочныхЧастей = Новый Структура;
		КонецЕсли;
		
		ИтоговыеСуммыПоКодамОпераций = Неопределено;
		П.ДанныеОтчета.СтруктураДанныхОтчета.Свойство("ИтоговыеСуммыПоКодамОпераций", ИтоговыеСуммыПоКодамОпераций);
		Если ТипЗнч(ИтоговыеСуммыПоКодамОпераций) <> Тип("Массив") Тогда
			ИтоговыеСуммыПоКодамОпераций = Новый Массив;
		КонецЕсли;
		
		ПроцентПред = 0;
		КоличествоСтрок = Реестр.Строки.Количество();
		Для НомерСтраницы = 1 По КоличествоСтрок Цикл
			Страница = Реестр.Строки[НомерСтраницы - 1];
			
			НаборДопФайлы = Рег.СоздатьМенеджерЗаписи();
			НаборДопФайлы.РегламентированныйОтчет = П.ДанныеОтчета.ДокументОтчета;
			НаборДопФайлы.ВидДополнительногоФайла = "РеестрСтраница" + Формат(НомерСтраницы, "ЧГ=");
			Если НомерСтраницы = 1 Тогда
				НаборДопФайлы.Прочитать();
				ТаблДокПрототип.Вывести(НаборДопФайлы.СодержимоеФайла.Получить());
			КонецЕсли;
			ТаблДокСтраницы = Новый ТабличныйДокумент;
			ТаблДокСтраницы.Вывести(ТаблДокПрототип);
			
			Если ИтоговыеСуммыПоКодамОпераций.Количество() < НомерСтраницы Тогда
				ИтоговыеСуммыПоКодамОпераций.Вставить(НомерСтраницы - 1, Новый Структура("КодОперации,НалБазаИтого", "", 0));
			КонецЕсли;
			
			// Вывод немногострочных данных.
			Для Каждого ЭлСтруктуры Из Страница.Данные Цикл
				ОбластьЗнач = ТаблДокСтраницы.Области.Найти(ЭлСтруктуры.Ключ);
				Если ОбластьЗнач <> Неопределено Тогда
					ОбластьЗнач.Значение = ЭлСтруктуры.Значение;
					Если ЭлСтруктуры.Ключ = "КодОперации" Тогда
						ИтоговыеСуммыПоКодамОпераций[НомерСтраницы - 1].КодОперации  = ЭлСтруктуры.Значение;
					ИначеЕсли ЭлСтруктуры.Ключ = "НалБазаИтого" Тогда
						ИтоговыеСуммыПоКодамОпераций[НомерСтраницы - 1].НалБазаИтого = ЭлСтруктуры.Значение;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			ВывестиМногострочныеДанныеВТабличныйДокумент(ТаблДокСтраницы, СтруктураМногострочныхЧастей, Страница);
			
			НаборДопФайлы.СодержимоеФайла = Новый ХранилищеЗначения(ТаблДокСтраницы);
			НаборДопФайлы.Записать();
			
			Процент = Мин(Окр(100 * НомерСтраницы / КоличествоСтрок), 100);
			Если ПроцентПред < Процент Тогда
				ТекстСообщения = СтрШаблон(НСтр("ru='заполнено страниц отчета %1'"), Формат(НомерСтраницы, "ЧГ="));
				ДлительныеОперации.СообщитьПрогресс(Процент, ТекстСообщения);
				ПроцентПред = Процент;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
#КонецОбласти