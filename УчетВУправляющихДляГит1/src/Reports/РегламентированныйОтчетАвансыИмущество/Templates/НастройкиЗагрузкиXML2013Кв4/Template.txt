// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
//  * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
//  * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//    поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//    нужно всегда использовать схему по умолчанию - указываем значение "null".
//  * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//
// Примечание:
//  Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
//  поэтому обработчики используются для получения значений показателей не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : null,
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

// Доступны параметры:
//
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПредОбработкаСхемыЗагрузки
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Раздел", "Раздел1"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Многострочность = Истина;
		Если СтрокаДерева.Код = "ОКТМО" Тогда
			СтрокаДерева.Ключ = "П000010001003";
		ИначеЕсли СтрокаДерева.Код = "КБК" Тогда
			СтрокаДерева.Ключ = "П000010002003";
		ИначеЕсли СтрокаДерева.Код = "НалПУ" Тогда
			СтрокаДерева.Ключ = "П000010003003";
		КонецЕсли;
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Тип", "П"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Тип = "Э"; // делаем не многострочным ("П" - многострочный)
	КонецЦикла;
	
	УзлыРаздела2 = УзлыПоXPath(П.ДеревоДляЗагрузки, "//РасОбДеятРФ");
	Для Каждого УзелРаздела2 Из УзлыРаздела2 Цикл
		УзелРаздела2.Обязательность = "НП"; // будут пропущены при автозагрузке в структуру документа (обработаем раздел из настроек)
	КонецЦикла;
	УзлыРаздела3 = УзлыПоXPath(П.ДеревоДляЗагрузки, "//РасОБНедИО");
	Для Каждого УзелРаздела3 Из УзлыРаздела3 Цикл
		УзелРаздела3.Обязательность = "НП"; // будут пропущены при автозагрузке в структуру документа (обработаем раздел из настроек)
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100020013003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000020013003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100020015003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000020016003_Основание"; // обработаем в структуре данных документа (пока присвоим "свободному" показателю)
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100020016003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000020016003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100020019003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000020019003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100030004003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000030004003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100030005003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000030006003_Основание"; // обработаем в структуре данных документа (пока присвоим "свободному" показателю)
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100030006003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000030006003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100030008003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000030008003_Числ"; // обработаем в структуре данных документа
	КонецЦикла;
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П100030010003"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.Ключ = "П000030010003_КодЛьготы"; // обработаем в структуре данных документа
	КонецЦикла;
	
#КонецОбласти

// Доступны параметры:
//
//  П.ДанныеОтчета      - заполненные данные документа регламентированного отчета;
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПостОбработкаДокументаОтчета
	
	СтраницыРаздела2 = УзлыПоXPath(П.ДеревоДляЗагрузки, "//РасОбДеятРФ/РасОб"); // Раздел 2 (все страницы)
	Для НомСтраницы = 1 По СтраницыРаздела2.Количество() Цикл
		ТекущаяСтраница = СтраницыРаздела2[НомСтраницы - 1];
		УзелОКТМО = УзлыПоXPath(ТекущаяСтраница, "../../@ОКТМО")[0];
		УзелДопПоказатель = ТекущаяСтраница.Строки.Добавить();
		ЗаполнитьЗначенияСвойств(УзелДопПоказатель, ТекущаяСтраница, , "Родитель, Строки, Значение"); // важны только раздел, ключ и значение
		УзелДопПоказатель.Ключ = "П000020001001"; УзелДопПоказатель.Обязательность = "О";
		УзелДопПоказатель.Значение = УзелОКТМО.Значение;
		ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(ТекущаяСтраница, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы);
	КонецЦикла;
	
	СтраницыРаздела3 = УзлыПоXPath(П.ДеревоДляЗагрузки, "//РасОБНедИО/РасОб"); // Раздел 3 (все страницы)
	Для НомСтраницы = 1 По СтраницыРаздела3.Количество() Цикл
		ТекущаяСтраница = СтраницыРаздела3[НомСтраницы - 1];
		УзелОКТМО = УзлыПоXPath(ТекущаяСтраница, "../../@ОКТМО")[0];
		УзелДопПоказатель = ТекущаяСтраница.Строки.Добавить();
		ЗаполнитьЗначенияСвойств(УзелДопПоказатель, ТекущаяСтраница, , "Родитель, Строки, Значение"); // важны только раздел, ключ и значение
		УзелДопПоказатель.Ключ = "П000030001001"; УзелДопПоказатель.Обязательность = "О";
		УзелДопПоказатель.Значение = УзелОКТМО.Значение;
		ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(ТекущаяСтраница, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы);
	КонецЦикла;
	
	Раздел2 = Неопределено;
	
	П.ДанныеОтчета.ДанныеМногостраничныхРазделов.Свойство("Раздел2", Раздел2);
	Если Раздел2 <> Неопределено Тогда
		Для Каждого СтраницаРаздела Из Раздел2 Цикл
			ДанныеРаздела = СтраницаРаздела.Данные;
			ЗначениеПоказателя = "";
			Если ДанныеРаздела.Свойство("П000020013003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000020013003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000020013003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000020016003_Основание", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000020015003_Числ", ЧислоИзСтроки(ЧастиЗначения[0]));
				ДанныеРаздела.Вставить("П000020015003_Знам", ЧислоИзСтроки(?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], "")));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000020016003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000020016003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000020016003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000020019003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000020019003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000020019003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Раздел3 = Неопределено;
	
	П.ДанныеОтчета.ДанныеМногостраничныхРазделов.Свойство("Раздел3", Раздел3);
	Если Раздел3 <> Неопределено Тогда
		Для Каждого СтраницаРаздела Из Раздел3 Цикл
			ДанныеРаздела = СтраницаРаздела.Данные;
			ЗначениеПоказателя = "";
			Если ДанныеРаздела.Свойство("П000030004003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000030004003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000030004003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000030006003_Основание", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000030005003_Числ", ЧислоИзСтроки(ЧастиЗначения[0]));
				ДанныеРаздела.Вставить("П000030005003_Знам", ЧислоИзСтроки(?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], "")));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000030006003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000030006003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000030006003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000030008003_Числ", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000030008003_Числ", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000030008003_Знам", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
			Если ДанныеРаздела.Свойство("П000030010003_КодЛьготы", ЗначениеПоказателя) Тогда
				ЧастиЗначения = СтрРазделить(ЗначениеПоказателя, "/");
				ДанныеРаздела.Вставить("П000030010003_КодЛьготы", ЧастиЗначения[0]);
				ДанныеРаздела.Вставить("П000030010003_Основание", ?(ЧастиЗначения.ВГраница() > 0 , ЧастиЗначения[1], ""));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
#КонецОбласти