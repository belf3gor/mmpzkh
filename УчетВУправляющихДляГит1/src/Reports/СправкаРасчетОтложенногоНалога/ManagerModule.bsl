#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область БухгалтерскиеОтчеты

// Описывает свойства отчета (манифест), декларирующий поддержанные в нем возможности подсистемы,
// включая реализованный программный интерфейс.
//
Функция ПолучитьПараметрыИсполненияОтчета() Экспорт
	
	Манифест = Новый Структура;
	Манифест.Вставить("ИспользоватьДанныеРасшифровки",      Истина);
	Манифест.Вставить("ИспользоватьПередКомпоновкойМакета", Истина);
	Манифест.Вставить("ИспользоватьПослеКомпоновкиМакета",  Истина);
	Манифест.Вставить("ИспользоватьВнешниеНаборыДанных",    Истина);
	Манифест.Вставить("ИспользоватьПриВыводеЗаголовка",     Истина);
	Манифест.Вставить("ИспользоватьПослеВыводаРезультата",  Истина);
	
	СправкиРасчеты.УстановитьОтчетНеИспользуетНаборыСуммовыхПоказателей(Манифест);

	Возврат Манифест;

КонецФункции

#КонецОбласти

#Область ОбработчикиБухгалтерскиеОтчеты

// Обработчик события подсистемы БухгалтерскиеОтчеты.
// Вызов определяется параметром ИспользоватьПередКомпоновкойМакета.
//
// Параметры:
//  Контекст			 - Структура - контекст, в котором формируется отчет.
//                         См. СправкиРасчеты.КонтекстФормированияОтчета.
//  Схема				 - СхемаКомпоновкиДанных - схема отчета.
//  КомпоновщикНастроек	 - КомпоновщикНастроекКомпоновкиДанных - описание связи настроек и схемы отчета.
//
Процедура ПередКомпоновкойМакета(Контекст, Схема, КомпоновщикНастроек) Экспорт
	
	РегистрыСведений.РасчетОтложенногоНалога.НастроитьПериодОтчета(
		КомпоновщикНастроек, 
		Контекст.НачалоПериода,
		Контекст.КонецПериода,
		Контекст.Организация);
		
	ВключитьГруппировкуФилиал(КомпоновщикНастроек.Настройки.Структура, Контекст.Организация);
	
	СтавкиНалога = РегистрыСведений.ПримененныеСтавкиОтложенногоНалога.ПрочитатьСтавки(
		Контекст.КонецПериода,
		Контекст.Организация,
		"%");
	Контекст.ВыполнениеОтчета.Вставить("СтавкиНалога", СтавкиНалога); // См. ПослеВыводаРезультата
	
	НастроитьКолонкиОтчета(КомпоновщикНастроек, СтавкиНалога, Контекст.НачалоПериода, Контекст.КонецПериода);
	
	НастроитьОтборПоОрганизации(КомпоновщикНастроек, Контекст.Организация);
	
КонецПроцедуры

// Обработчик события подсистемы БухгалтерскиеОтчеты.
// Вызов определяется параметром ИспользоватьПослеКомпоновкиМакета.
//
// Параметры:
//  Контекст		 - Структура - контекст, в котором формируется отчет.
//                     См. СправкиРасчеты.КонтекстФормированияОтчета.
//  МакетКомпоновки	 - МакетКомпоновкиДанных - сформированный макет компоновки данных.
//
Процедура ПослеКомпоновкиМакета(Контекст, МакетКомпоновки) Экспорт
	
	СправкиРасчеты.НастроитьГрафыОтчета(МакетКомпоновки, ГрафыОтчета());
	
КонецПроцедуры

// Обработчик события подсистемы БухгалтерскиеОтчеты.
// Вызов определяется параметром ИспользоватьВнешниеНаборыДанных.
//
// Параметры:
//  Контекст		 - Структура - контекст, в котором формируется отчет.
//                     См. СправкиРасчеты.КонтекстФормированияОтчета.
//  МакетКомпоновки	 - МакетКомпоновкиДанных - сформированный макет компоновки данных.
//
Функция ПолучитьВнешниеНаборыДанных(Контекст, МакетКомпоновки) Экспорт
	
	ВнешниеНаборы = Новый Структура;
	ВнешниеНаборы.Вставить("ГруппыБалансовыхСчетов", ГруппыБалансовыхСчетов());
	Возврат ВнешниеНаборы;
		
КонецФункции	

// Обработчик события подсистемы БухгалтерскиеОтчеты.
// Вызов определяется параметром ИспользоватьПриВыводеЗаголовка.
//
// Параметры:
//  Контекст		 - Структура - контекст, в котором формируется отчет.
//                     См. СправкиРасчеты.КонтекстФормированияОтчета.
//  КомпоновщикНастроек	 - КомпоновщикНастроекКомпоновкиДанных - описание связи настроек и схемы отчета.
//  Результат - ТабличныйДокумент - табличный документ с сформированным отчетом.
//
Процедура ПриВыводеЗаголовка(Контекст, КомпоновщикНастроек, Результат) Экспорт
	
	СправкиРасчеты.ВывестиШапкуОтчета(Результат, Контекст);
	
КонецПроцедуры

// Обработчик события подсистемы БухгалтерскиеОтчеты.
// Вызов определяется параметром ИспользоватьПослеВыводаРезультата.
//
// Параметры:
//  Контекст		 - Структура - контекст, в котором формируется отчет.
//                     См. СправкиРасчеты.КонтекстФормированияОтчета.
//  Результат - ТабличныйДокумент - табличный документ с сформированным отчетом.
//
Процедура ПослеВыводаРезультата(Контекст, Результат) Экспорт
	
	Результат.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	СправкиРасчеты.ОформитьРезультатОтчета(Результат, Контекст, Истина);
	
	ВывестиПорядокРасчета(Результат, Контекст.ВыполнениеОтчета.СтавкиНалога, Контекст.КонецПериода);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ТонкаяНастройка

Функция ИспользуютсяРазныеСтавки(СтавкиНалога)
	Возврат (ТипЗнч(СтавкиНалога) = Тип("Соответствие"));
КонецФункции

Процедура ВключитьГруппировкуФилиал(Группировки, Организация)
	
	ГруппировкаФилиалы = БухгалтерскиеОтчеты.НайтиГруппировкуТаблицы(Группировки, "Филиал");
	
	Если ГруппировкаФилиалы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВсяОрганизация = ОбщегоНазначенияБПВызовСервераПовтИсп.ВсяОрганизация(Организация);
	Если ВсяОрганизация.Количество() > 1 Тогда
		ГруппировкаФилиалы.Состояние = СостояниеЭлементаНастройкиКомпоновкиДанных.Включен;
	Иначе
		ГруппировкаФилиалы.Состояние = СостояниеЭлементаНастройкиКомпоновкиДанных.Отключен;
	КонецЕсли;
	
КонецПроцедуры

Процедура НастроитьОтборПоОрганизации(КомпоновщикНастроек, Организация)
	
	// Отложенный налог рассчитывается по организации.
	// Поэтому для того, чтобы вывести данные по филиалу, следует
	// - отбор по полю Организация выполнять по головной организации
	// - дополнительно установить отбор по полю Филиал.
	
	ОписаниеОтбораПоОрганизации = Новый Структура;
	ОписаниеОтбораПоОрганизации.Вставить("Организация",                       Организация);
	ОписаниеОтбораПоОрганизации.Вставить("ВключатьОбособленныеПодразделения", Ложь);
	
	ДобавитьОтборФилиал(КомпоновщикНастроек.ФиксированныеНастройки.Отбор, ОписаниеОтбораПоОрганизации);
	
	БухгалтерскиеОтчетыВызовСервера.ДобавитьОтборПоОрганизации(ОписаниеОтбораПоОрганизации, КомпоновщикНастроек);
	
КонецПроцедуры

Процедура ДобавитьОтборФилиал(Отбор, ОписаниеОтбораПоОрганизации)
	
	Если Не ЗначениеЗаполнено(ОписаниеОтбораПоОрганизации.Организация) Тогда
		Возврат;
	КонецЕсли;
	
	ГоловнаяОрганизация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОписаниеОтбораПоОрганизации.Организация, "ГоловнаяОрганизация");
	
	Если Не ЗначениеЗаполнено(ГоловнаяОрганизация)
		Или ГоловнаяОрганизация = ОписаниеОтбораПоОрганизации.Организация Тогда
		Возврат;
	КонецЕсли;
	
	// Выводим данные только по филиалу
	ОтборФилиал = Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборФилиал.ЛевоеЗначение    = Новый ПолеКомпоновкиДанных("Филиал");
	ОтборФилиал.ВидСравнения     = ВидСравненияКомпоновкиДанных.Равно;
	ОтборФилиал.ПравоеЗначение   = ОписаниеОтбораПоОрганизации.Организация;
	ОтборФилиал.Использование    = Истина;
	ОтборФилиал.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
	
	// Отложенный налог рассчитывается по головной организации
	ОписаниеОтбораПоОрганизации.Организация = ГоловнаяОрганизация;
	
КонецПроцедуры

Процедура НастроитьКолонкиОтчета(КомпоновщикНастроек, СтавкиНалога, НачалоПериода, КонецПериода)
	
	ПоказыватьИзмененияРазниц = ИспользуютсяРазныеСтавки(СтавкиНалога);
		
	ИспользованиеКолонок = Новый Соответствие; // См. СправкиРасчеты.ИспользованиеКолонокСуммовыхПоказателей()
	ИспользованиеКолонок.Вставить("ОтложенныйНалогКратко",           Не ПоказыватьИзмененияРазниц);
	ИспользованиеКолонок.Вставить("ЭффектИзмененияВычитаемыхРазниц", ПоказыватьИзмененияРазниц);
	ИспользованиеКолонок.Вставить("ЭффектИзмененияОблагаемыхРазниц", ПоказыватьИзмененияРазниц);
	
	СправкиРасчеты.НастроитьИспользованиеКолонокСуммовыхПоказателей(КомпоновщикНастроек, ИспользованиеКолонок);
	
	ТекстыЗаголовковГруппКолонок = ЗаголовкиГруппКолонок(СтавкиНалога, НачалоПериода, КонецПериода);
	
	БухгалтерскиеОтчеты.УстановитьЗаголовкиГруппКолонок(КомпоновщикНастроек, ТекстыЗаголовковГруппКолонок);
	
КонецПроцедуры

Функция ГруппыБалансовыхСчетов()
	
	// Для вычисления отложенных налоговых активов и обязательств, 
	// показатели на основном счете учета актива и контрарном счете суммируются,
	// при этом считается, что итоговая сумма отражена на основном счете.
	
	// Пользователю следует дать представление о том, какие счета были сгруппированы.
	// Поэтому в представлении основного счета выводится все содержимое группы.
	
	// С технической точки зрения набор используется для отображения представления счета
	// (см. вычисляемое поле ГруппаСчетов).
	// Для выполнения отчета без внешнего набора данных можно заменить в настройках это поле на Счет.
	
	ГруппыБалансовыхСчетов = Новый ТаблицаЗначений;
	ГруппыБалансовыхСчетов.Колонки.Добавить("ОсновнойСчет",              Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	ГруппыБалансовыхСчетов.Колонки.Добавить("ПредставлениеГруппыСчетов", Новый ОписаниеТипов("Строка"));
	
	// Получим правила
	ГруппыСчетов = Новый Соответствие;
	ВсеСчета     = Новый Массив;
	
	ПравилаГруппировки = НалогНаПрибыльБухгалтерскийУчет.НовыйПравилаГруппировкиАктивовОбязательств();
	НалогНаПрибыльБухгалтерскийУчет.ЗаполнитьПравилаГруппировкиВидовАктивовИОбязательств(ПравилаГруппировки);
	Для Каждого Правило Из ПравилаГруппировки Цикл
		
		Если Не ЗначениеЗаполнено(Правило.ДополнительныеСчета) Тогда
			Продолжить;
		КонецЕсли;
		
		СчетаПравила = ОбщегоНазначенияКлиентСервер.СкопироватьМассив(Правило.ДополнительныеСчета);
		СчетаПравила.Вставить(0, Правило.ОсновнойСчет);
		
		ГруппыСчетов.Вставить(Правило.ОсновнойСчет, СчетаПравила);
		
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ВсеСчета, СчетаПравила);
		
	КонецЦикла;
	
	// Получим представления
	Представления = Новый Соответствие;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Счета", ВсеСчета);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Хозрасчетный.Ссылка КАК Ссылка,
	|	Хозрасчетный.Код КАК Код
	|ИЗ
	|	ПланСчетов.Хозрасчетный КАК Хозрасчетный
	|ГДЕ
	|	Хозрасчетный.Ссылка В(&Счета)";
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Представления.Вставить(Выборка.Ссылка, Выборка.Код);
	КонецЦикла;

	// Скомпонуем вместе
	Для Каждого ГруппаСчетов Из ГруппыСчетов Цикл
		
		ПредставленияГруппы = Новый Массив;
		Для Каждого Счет Из ГруппаСчетов.Значение Цикл
			ПредставлениеСчета = Представления[Счет];
			Если ПредставлениеСчета <> Неопределено Тогда
				ПредставленияГруппы.Добавить(ПредставлениеСчета);
			КонецЕсли;
		КонецЦикла;
		
		Строка = ГруппыБалансовыхСчетов.Добавить();
		Строка.ОсновнойСчет              = ГруппаСчетов.Ключ;
		Строка.ПредставлениеГруппыСчетов = СтрСоединить(ПредставленияГруппы, ", ");
		
	КонецЦикла;
	
	Возврат ГруппыБалансовыхСчетов;
	
КонецФункции

Функция ГрафыОтчета()
	
	Разделы = Новый Соответствие;
	
	// Заголовки строк
	Разделы.Вставить(
		СправкиРасчеты.СлужебноеИмяЗаголовкиСтрок(),
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(НСтр("ru = '1'")));
	
	// "НаНачалоПериода"
	ГрафыРаздела = Новый Массив;
	ГрафыРаздела.Добавить(НСтр("ru = '2'")); // ВычитаемаяРазницаНачало
	ГрафыРаздела.Добавить(НСтр("ru = '3'")); // ОблагаемаяРазницаНачало
	ГрафыРаздела.Добавить(НСтр("ru = '4'")); // НалоговыйАктивНачало
	ГрафыРаздела.Добавить(НСтр("ru = '5'")); // НалоговоеОбязательствоНачало
	
	Разделы.Вставить("НаНачалоПериода", ГрафыРаздела);
	
	// "НаКонецПериода"
	ГрафыРаздела = Новый Массив;
	ГрафыРаздела.Добавить(НСтр("ru = '6'")); // ВычитаемаяРазницаКонец
	ГрафыРаздела.Добавить(НСтр("ru = '7'")); // ОблагаемаяРазницаКонец
	ГрафыРаздела.Добавить(НСтр("ru = '8'")); // НалоговыйАктивКонец
	ГрафыРаздела.Добавить(НСтр("ru = '9'")); // НалоговоеОбязательствоКонец
	
	Разделы.Вставить("НаКонецПериода", ГрафыРаздела);
	
	// "ОтложенныйНалогКратко"
	ГрафыРаздела = Новый Массив;
	ГрафыРаздела.Добавить(НСтр("ru = '10а'")); // ПризнаниеНалоговогоАктива
	ГрафыРаздела.Добавить(НСтр("ru = '10б'")); // ПогашениеНалоговогоАктива
	ГрафыРаздела.Добавить(НСтр("ru = '11а'")); // ПризнаниеНалоговогоОбязательства
	ГрафыРаздела.Добавить(НСтр("ru = '11б'")); // ПогашениеНалоговогоОбязательства
	
	Разделы.Вставить("ОтложенныйНалогКратко", ГрафыРаздела);
	
	// "ЭффектИзмененияВычитаемыхРазниц"
	ГрафыРаздела = Новый Массив;
	ГрафыРаздела.Добавить(НСтр("ru = '10'"));  // ИзменениеВычитаемыхРазниц
	ГрафыРаздела.Добавить(НСтр("ru = '10а'")); // ПризнаниеНалоговогоАктива
	ГрафыРаздела.Добавить(НСтр("ru = '10б'")); // ПогашениеНалоговогоАктива
	
	Разделы.Вставить("ЭффектИзмененияВычитаемыхРазниц", ГрафыРаздела);
	
	// "ЭффектИзмененияОблагаемыхРазниц"
	ГрафыРаздела = Новый Массив;
	ГрафыРаздела.Добавить(НСтр("ru = '11'"));  // ИзменениеОблагаемыхРазниц
	ГрафыРаздела.Добавить(НСтр("ru = '11а'")); // ПризнаниеНалоговогоОбязательства
	ГрафыРаздела.Добавить(НСтр("ru = '11б'")); // ПогашениеНалоговогоОбязательства
	
	Разделы.Вставить("ЭффектИзмененияОблагаемыхРазниц", ГрафыРаздела);
	
	Возврат Разделы;
	
КонецФункции

Функция ЗаголовкиГруппКолонок(СтавкиНалога, НачалоПериода, КонецПериода)
	
	Заголовки = Новый Структура;
	Заголовки.Вставить("НаНачалоПериода",                 "");
	Заголовки.Вставить("НаКонецПериода",                  "");
	Заголовки.Вставить("ОтложенныйНалогКратко",           "");
	Заголовки.Вставить("ЭффектИзмененияВычитаемыхРазниц", "");
	Заголовки.Вставить("ЭффектИзмененияОблагаемыхРазниц", "");
	
	ИспользуютсяРазныеСтавки = ИспользуютсяРазныеСтавки(СтавкиНалога);
	
	Если ИспользуютсяРазныеСтавки Тогда
		ШаблонГраницаПериода = НСтр("ru = 'На [ОтчетнаяДата], по ставке [Ставка]%'");
		ШаблонИзменение      = НСтр("ru = 'За отчетный период, по ставке [Ставка]%'");
		ШаблонЭффектИзмененияВычитаемыхРазниц = НСтр("ru = 'Эффект изменения вычитаемых временных разниц, по ставке [Ставка]%'");
		ШаблонЭффектИзмененияОблагаемыхРазниц = НСтр("ru = 'Эффект изменения налогооблагаемых временных разниц, по ставке [Ставка]%'");
	Иначе
		ШаблонГраницаПериода = НСтр("ru = 'На [ОтчетнаяДата]'");
		ШаблонИзменение      = НСтр("ru = 'За отчетный период'");
		ШаблонЭффектИзмененияВычитаемыхРазниц = НСтр("ru = 'Эффект изменения вычитаемых временных разниц'");
		ШаблонЭффектИзмененияОблагаемыхРазниц = НСтр("ru = 'Эффект изменения налогооблагаемых временных разниц'");
	КонецЕсли;
	
	ПараметрыТекста = Новый Структура;
	ПараметрыТекста.Вставить("ОтчетнаяДата", Формат(НачалоПериода, "ДЛФ=D"));
	Если ИспользуютсяРазныеСтавки Тогда
		ПараметрыТекста.Вставить("Ставка", СтавкиНалога[Перечисления.ВидыСтавокОтложенногоНалога.ПредыдущаяОценка]);
	КонецЕсли;
	
	Заголовки.НаНачалоПериода = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(ШаблонГраницаПериода, ПараметрыТекста);
	
	ПараметрыТекста = Новый Структура;
	ПараметрыТекста.Вставить("ОтчетнаяДата", Формат(КонецДня(КонецПериода) + 1, "ДЛФ=D"));
	Если ИспользуютсяРазныеСтавки Тогда
		ПараметрыТекста.Вставить("Ставка", СтавкиНалога[Перечисления.ВидыСтавокОтложенногоНалога.БудущийНалог]);
	КонецЕсли;
	
	Заголовки.НаКонецПериода = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(ШаблонГраницаПериода, ПараметрыТекста);
	
	ПараметрыТекста = Новый Структура;
	Если ИспользуютсяРазныеСтавки Тогда
		ПараметрыТекста.Вставить("Ставка", СтавкиНалога[Перечисления.ВидыСтавокОтложенногоНалога.ТекущийНалог]);
	КонецЕсли;
	
	Заголовки.ОтложенныйНалогКратко           = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(
		ШаблонИзменение,
		ПараметрыТекста);
	Заголовки.ЭффектИзмененияВычитаемыхРазниц = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(
		ШаблонЭффектИзмененияВычитаемыхРазниц,
		ПараметрыТекста);
	Заголовки.ЭффектИзмененияОблагаемыхРазниц = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(
		ШаблонЭффектИзмененияОблагаемыхРазниц,
		ПараметрыТекста);
		
	Возврат Заголовки;
		
КонецФункции

Процедура ВывестиПорядокРасчета(ТабличныйДокумент, СтавкиНалога, КонецПериода)
	
	Шаблон = Отчеты.СправкаРасчетОтложенногоНалога.ПолучитьМакет("ПорядокРасчета");
	
	// Заголовок
	ШаблонЗаголовок = Шаблон.ПолучитьОбласть("Заголовок");
	ТабличныйДокумент.Вывести(ШаблонЗаголовок);
	
	// Основной текст
	Если ИспользуютсяРазныеСтавки(СтавкиНалога) Тогда
		ИмяШаблонаПорядокРасчета = "РазныеСтавкиНалога";
	Иначе
		ИмяШаблонаПорядокРасчета = "ОдинаковаяСтавкаНалога";
	КонецЕсли;
	
	ШаблонПорядокРасчета = Шаблон.ПолучитьОбласть(ИмяШаблонаПорядокРасчета);
	
	ПараметрыТекста = Новый Структура;
	ПараметрыТекста.Вставить("ОтчетнаяДата", Формат(КонецМесяца(КонецПериода) + 1, "ДЛФ=D"));
	
	Если ИмяШаблонаПорядокРасчета = "РазныеСтавкиНалога" Тогда
		
		ПараметрыТекста.Вставить(
			"СтавкаНалогаБудущийНалог",
			Формат(СтавкиНалога[Перечисления.ВидыСтавокОтложенногоНалога.БудущийНалог], "ЧН=0"));
		ПараметрыТекста.Вставить(
			"СтавкаНалогаТекущийНалог",
			Формат(СтавкиНалога[Перечисления.ВидыСтавокОтложенногоНалога.ТекущийНалог], "ЧН=0"));
		
	ИначеЕсли ТипЗнч(СтавкиНалога) = Тип("Число") Тогда
		
		ПараметрыТекста.Вставить("СтавкаНалога", СтрШаблон(НСтр("ru = 'Ставка налога - %1%%'"), СтавкиНалога));
		
	Иначе
		
		ПараметрыТекста.Вставить("СтавкаНалога", "");
		
	КонецЕсли;
	
	ШаблонПорядокРасчета.Параметры.Заполнить(ПараметрыТекста);
	
	ТабличныйДокумент.Вывести(ШаблонПорядокРасчета);
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
