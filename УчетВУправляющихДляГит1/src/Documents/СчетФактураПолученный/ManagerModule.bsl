#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

Функция ВремяДокументаПоУмолчанию() Экспорт
	
	Возврат Новый Структура("Часы, Минуты", 21, 0);
	
КонецФункции

// СтандартныеПодсистемы.ВерсионированиеОбъектов

// Определяет настройки объекта для подсистемы ВерсионированиеОбъектов.
//
// Параметры:
//  Настройки - Структура - настройки подсистемы.
Процедура ПриОпределенииНастроекВерсионированияОбъектов(Настройки) Экспорт

КонецПроцедуры

// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#Область СчетаФактурыВыданныеПокупателям

Функция НовыйПараметрыЗапросаСчетовФактурВыданныхПокупателям() Экспорт

	ПараметрыЗапроса = Новый Структура;
	ПараметрыЗапроса.Вставить("ДатаВходящегоДокумента"      , Неопределено);
	ПараметрыЗапроса.Вставить("ДокументОснование"           , Неопределено);
	ПараметрыЗапроса.Вставить("Организация"                 , Неопределено);
	ПараметрыЗапроса.Вставить("Комитент"                    , Неопределено);
	ПараметрыЗапроса.Вставить("ДоговорКомитента"            , Неопределено);
	ПараметрыЗапроса.Вставить("Исправление"                 , Ложь);
	ПараметрыЗапроса.Вставить("ИсправлениеСобственнойОшибки", Ложь);
	ПараметрыЗапроса.Вставить("ИсправляемыйСчетФактура"     , Неопределено);
	ПараметрыЗапроса.Вставить("ВидСчетаФактуры"             , Неопределено);
	
	Возврат ПараметрыЗапроса;

КонецФункции

Функция СчетаФактурыВыданныеПокупателям(ПараметрыЗапроса) Экспорт

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаВходящегоДокумента", ПараметрыЗапроса.ДатаВходящегоДокумента);
	Запрос.УстановитьПараметр("ДокументОснование"     , ПараметрыЗапроса.ДокументОснование);
	Запрос.УстановитьПараметр("Организация"           , ПараметрыЗапроса.Организация);
	Запрос.УстановитьПараметр("Комитент"              , ПараметрыЗапроса.Комитент);
	Запрос.УстановитьПараметр("ДоговорКомитента"      , ПараметрыЗапроса.ДоговорКомитента);
	Запрос.УстановитьПараметр("Исправление"           , ПараметрыЗапроса.Исправление);
	
	Если ПараметрыЗапроса.ИсправлениеСобственнойОшибки Тогда
		
		Запрос.УстановитьПараметр("Ссылка", ПараметрыЗапроса.ИсправляемыйСчетФактура);
		
		Запрос.Текст = ТекстЗапросаИсправлениеСобственнойОшибки();
		
	ИначеЕсли ПараметрыЗапроса.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление И НЕ ПараметрыЗапроса.Исправление Тогда
		
		Запрос.Текст = ТекстЗапросаСчетФактураНаПоступление();
		
	ИначеЕсли ПараметрыЗапроса.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный
		ИЛИ (ПараметрыЗапроса.Исправление И НЕ ПараметрыЗапроса.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс) Тогда
		
		Запрос.Текст = ТекстЗапросаИсправлениеКорректировка();
		
	Иначе
		
		Запрос.Текст = ТекстЗапросаПрочиеСчетаФактуры();
		
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Формирует движения по регистру накопления: НДС предъявленный, если в документе основания НДС = 0.
//
// Параметры:
// ТаблицаПредъявленногоНДС - ТаблицаЗначений- получаемая ранее.
// Отказ - булево- флаг отказа от проведения.
//
Процедура СформироватьДвиженияНДСПредъявленныйПоДокументам(ТаблицаРеквизиты, ТаблицаПредъявленногоНДС,
	 Движения, Отказ) Экспорт
	Если Не ЗначениеЗаполнено(ТаблицаРеквизиты) Тогда
		Возврат;
	КонецЕсли;

	Реквизиты = ТаблицаРеквизиты[0];

	СписокДокументовБезНДС = ПолучитьСписокДокументовБезНДС(Реквизиты.Регистратор);
	Если СписокДокументовБезНДС.Количество()=0 Тогда
		Возврат;
	КонецЕсли;

	Для каждого ТекСтрокаСписокДокументов Из  СписокДокументовБезНДС Цикл
	
		СформироватьДвижениеПоДокументу(ТекСтрокаСписокДокументов, Движения, ТаблицаПредъявленногоНДС, Реквизиты.Период, Отказ);
		
		Если ТаблицаПредъявленногоНДС.Количество() > 0 Тогда
			ТаблицаПредъявленногоНДС.ЗаполнитьЗначения(Реквизиты.КодВидаОперации, "КодВидаОперации");
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

// Возвращает список документов основания без НДС.
Функция ПолучитьСписокДокументовБезНДС(СчетФактура)
	
	СписокДокументовБезНДС = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка КАК Ссылка,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации
	|ПОМЕСТИТЬ ТаблицаДокумента
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО СчетФактураПолученный.Контрагент = Контрагенты.Ссылка
	|ГДЕ
	|	СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаПоступление)
	|	И СчетФактураПолученный.Ссылка = &СсылкаНаДокумент
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтранаРегистрации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
	|ИЗ
	|	ТаблицаДокумента КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ПО ТаблицаДокумента.Ссылка = СчетФактураПолученныйДокументыОснования.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтраныМира КАК СтраныМира
	|		ПО ТаблицаДокумента.СтранаРегистрации = СтраныМира.Ссылка
	|ГДЕ
	|	(СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеДопРасходов
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтражениеНДСКВычету
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеНМА
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеИзПереработки
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ВыкупПредметовЛизинга
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ВозвратТоваровОтПокупателя)
	|	И ВЫБОР
	|			КОГДА СтраныМира.Ссылка ЕСТЬ NULL
	|				ТОГДА ИСТИНА
	|			КОГДА СтраныМира.Ссылка = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ НЕ СтраныМира.УчастникЕАЭС
	|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("СсылкаНаДокумент", СчетФактура);
	Результат = Запрос.Выполнить().Выбрать();
	
	Пока Результат.Следующий() Цикл
		
		ЕстьСуммаНДС = РаботаСДоговорамиКонтрагентовБП.ДокументСНДС(
			Результат.ДокументОснование);
		
		Если Не ЕстьСуммаНДС Тогда
			СписокДокументовБезНДС.Добавить(Результат.ДокументОснование);
		КонецЕсли;
	
	КонецЦикла;

	Возврат СписокДокументовБезНДС;
	
КонецФункции

// Формирует движения по регистру НДС Предъявленный по документам основания
//
// Параметры: 
// ТекущийДокумент - документ, по которому нужно сформировать движение
// Движения - ссылка на движения документа
// ТаблицаПредъявленногоНДС -таблица значений- таблица в которую будут вноситься движения.
// Отказ - булево - флаг отказа от проведения
Процедура СформироватьДвижениеПоДокументу(ТекущийДокумент, Движения, ТаблицаПредъявленногоНДС, Период, Отказ)

	Если ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
	
		ПараметрыПроведения = Документы.ПоступлениеТоваровУслуг.ПодготовитьПараметрыПроведенияДляСчетФактуры(ТекущийДокумент);
		ТаблицыНДС = ПараметрыПроведения.ТаблицыНДС;
		ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(Период,"Период");

		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеТоваровУслугОтПоставщика(
			ТаблицыНДС.Товары, ТаблицыНДС.Услуги, ПараметрыПроведения.НомераГТД,
			ПараметрыПроведения.Реквизиты, Движения, Отказ);
		
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеДопРасходов") Тогда
	
		ПараметрыПроведения = Документы.ПоступлениеДопРасходов.ПодготовитьПараметрыПроведенияДляСчетФактуры(ТекущийДокумент);
		СтруктураТаблицДокумента = ПараметрыПроведения.СтруктураТаблицДокумента;
		ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(Период,"Период");

		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеДопРасходовОтПоставщика(
			СтруктураТаблицДокумента.ТаблицаТовары,
			ПараметрыПроведения.ДопРасходыРеквизиты,
			Движения, Отказ);
		
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя") Тогда
	
		ПараметрыПроведения = Документы.ВозвратТоваровОтПокупателя.ПодготовитьПараметрыПроведенияДляСчетФактуры(
			ТекущийДокумент);
		ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(Период,"Период");
		ТаблицаСписанныеТовары = ПараметрыПроведения.ТаблицаСписанныеТовары;
		ТаблицыРеализация = ПараметрыПроведения.ТаблицыРеализация;
		СобственныеТоварыУслугиНДС = ?(ТаблицыРеализация.СобственныеТоварыУслуги <> Неопределено,
			ТаблицыРеализация.СобственныеТоварыУслуги.Скопировать(), Неопределено);
		// Учет НДС
		СобственныеТоварыУслугиНДС = УчетНДСРаздельный.ПодготовитьТаблицуСобственныеТоварыУслугиНДС(
			СобственныеТоварыУслугиНДС, ПараметрыПроведения.ТоварыНДС);
		
		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияВозвратТоваровОтПокупателя(СобственныеТоварыУслугиНДС,
		ТаблицаСписанныеТовары, ПараметрыПроведения.ТоварыСГТД, ПараметрыПроведения.Реквизиты, Движения, Отказ)
		
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") Тогда
	
		ПараметрыПроведения = Документы.ОтчетКомиссионераОПродажах.ПодготовитьПараметрыПроведения(ТекущийДокумент, Отказ);
		
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ПараметрыПроведения.ВознаграждениеРеквизиты) Тогда
			ПараметрыПроведения.ВознаграждениеРеквизиты.ЗаполнитьЗначения(Период,"Период");
		КонецЕсли;
		
		// Таблица взаиморасчетов по комиссионному вознаграждению с учетом зачета авансов
		ТаблицаВзаиморасчетовВознаграждение = УчетВзаиморасчетов.ПодготовитьТаблицуВзаиморасчетовЗачетАвансов(
			ПараметрыПроведения.ЗачетАвансовВознаграждениеТаблицаДокумента, Неопределено,
			ПараметрыПроведения.ЗачетАвансовВознаграждениеРеквизиты, Отказ);
	
		ТаблицаУслуги = Документы.ОтчетКомиссионераОПродажах.ПодготовитьТаблицуВознагражденияСУчетомКурсаАвансов(
			ПараметрыПроведения.ВознаграждениеТаблица,
			ТаблицаВзаиморасчетовВознаграждение, ПараметрыПроведения.ВознаграждениеРеквизиты);
		
		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеПосредническихУслуг(
			ТаблицаУслуги, ПараметрыПроведения.ВознаграждениеРеквизиты, Движения, Отказ);
			
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ОтражениеНДСКВычету") Тогда
		
		Если ТекущийДокумент.ПрямаяЗаписьВКнигу Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыПроведения = Документы.ОтражениеНДСКВычету.ПодготовитьПараметрыПроведения(ТекущийДокумент, Отказ);
		ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(Период,"Период");
		
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
		Если ПараметрыПроведения.ОтражениеНДСПредъявленный.Итог("СуммаНДС") = 0 Тогда

			Документы.ОтражениеНДСКВычету.СформироватьДвиженияПоРегиструНДСПредъявленный(
				ПараметрыПроведения.ТаблицаДокументыОплаты,
				ПараметрыПроведения.ОтражениеНДСПредъявленный,
				ПараметрыПроведения.Реквизиты,
				Движения,
				Отказ);
				
			ДанныеДвижений = Движения.НДСПредъявленный.Выгрузить();
				
		КонецЕсли;
	
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеИзПереработки") Тогда
	
		ПараметрыПроведения = Документы.ПоступлениеИзПереработки.ПодготовитьПараметрыПроведенияДляСчетФактуры(ТекущийДокумент);
		СтруктураТаблицДокумента = ПараметрыПроведения.СтруктураТаблицДокумента;
		ПараметрыПроведения.РеквизитыНДС.ЗаполнитьЗначения(Период,"Период");

		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеТоваровУслугОтПоставщика(
			Неопределено, СтруктураТаблицДокумента.ПоступлениеУслугТаблица, Неопределено,
			ПараметрыПроведения.РеквизитыНДС, Движения, Отказ);

	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеНМА") Тогда
		
		ПараметрыПроведения = Документы.ПоступлениеНМА.ПодготовитьПараметрыПроведенияДляСчетФактуры(ТекущийДокумент);
		СтруктураТаблицДокумента = ПараметрыПроведения.СтруктураТаблицДокумента;
		ПараметрыПроведения.РеквизитыНДС.ЗаполнитьЗначения(Период,"Период");
		
		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеНематериальныхАктивовОтПоставщика(
				СтруктураТаблицДокумента.ТаблицаНематериальныеАктивы,
				ПараметрыПроведения.РеквизитыНДС, Движения, Отказ);
		
	
	ИначеЕсли ТипЗнч(ТекущийДокумент) = Тип("ДокументСсылка.ВыкупПредметовЛизинга") Тогда
	
		ПараметрыПроведения = Документы.ВыкупПредметовЛизинга.ПодготовитьПараметрыПроведения(ТекущийДокумент, Отказ);
		Если Отказ Тогда
			Возврат;
		КонецЕсли;
		
		ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(Период,"Период");
		// Таблица взаиморасчетов
		ТаблицаВзаиморасчеты = УчетВзаиморасчетов.ПодготовитьТаблицуВзаиморасчетовЗачетАвансов(
			ПараметрыПроведения.ЗачетАвансовТаблицаДокумента, ПараметрыПроведения.ТаблицаЗачетАвансов,
			ПараметрыПроведения.ЗачетАвансовРеквизиты,
			Отказ);

		// Таблицы документа с корректировкой сумм по курсу авансов
		СтруктураТаблицДокумента = УчетДоходовРасходов.ПодготовитьТаблицыПоступленияПоКурсуАвансов(
			ПараметрыПроведения.СтруктураТаблицДокумента, ТаблицаВзаиморасчеты,
			ПараметрыПроведения.ЗачетАвансовРеквизиты);

		ТаблицаНДСВыкупИмущества = Документы.ВыкупПредметовЛизинга.ПодготовитьТаблицуНДС(
			СтруктураТаблицДокумента.ТаблицаВыкупИмущества);
		

		// Учет НДС
		ДанныеДвижений = СформироватьДвиженияПоступлениеТоваровУслугОтПоставщика(
			Неопределено, ТаблицаНДСВыкупИмущества, Неопределено,
			ПараметрыПроведения.Реквизиты,
			Движения, Отказ);
			
			
	КонецЕсли;

	Если ЗначениеЗаполнено(ДанныеДвижений) Тогда
		
		Если ДанныеДвижений.Итог("НДС") = 0 Тогда
			Для каждого ТекСтрокаДанныеДвижений Из ДанныеДвижений Цикл
			
				Если ТипЗнч(ТекущийДокумент) <> Тип("ДокументСсылка.ПоступлениеДопРасходов") Тогда
			
					Если ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.НМА 
						ИЛИ ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.Оборудование
						ИЛИ ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.ОбъектыНезавершенногоСтроительства
						ИЛИ ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.ОС
						ИЛИ ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.СМРПодрядные
						ИЛИ ТекСтрокаДанныеДвижений.ВидЦенности = Перечисления.ВидыЦенностей.СМРСобственнымиСилами Тогда 
					
					// Не отражаем вычет для ОС и объектов строительства (в т.ч. СМР),
					// и ценностей, использованных при строительстве
						Продолжить;
					
					КонецЕсли;
				
				КонецЕсли;
			
				НоваяСтрока = ТаблицаПредъявленногоНДС.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрокаДанныеДвижений);
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Формирует движение по регистру НДС предъявленный по документам ПоступленияНМА
// там где НДС = 0
Функция СформироватьДвиженияПоступлениеНематериальныхАктивовОтПоставщика(ТаблицаНМА, ТаблицаРеквизиты, Движения, Отказ)
	
	Если Не ЗначениеЗаполнено(ТаблицаНМА) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Параметры = УчетНДС.ПодготовитьПараметрыПоступлениеНематериальныхАктивовОтПоставщика(ТаблицаНМА, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];
	
	УчетНДС.ЗаполнитьВидыЦенностейПоступлениеОтПоставщика(Параметры.НематериальныеАктивы, Реквизиты, Неопределено, "СчетУчета");
	
	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация, Реквизиты.Период);
	
	ДанныеДвижений = УчетНДС.ПодготовитьДанныеДвиженийПоступлениеНематериальныхАктивов(
		Параметры.НематериальныеАктивы, Реквизиты);
	
	ПлательщикНДС = УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период);
	Если НЕ ПлательщикНДС Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Движения регистров подсистемы НДС
	Если УпрощенныйУчетНДС Тогда 
		Возврат Неопределено;
	КонецЕсли;
	
	Если ДанныеДвижений.Итог("НДС") = 0 Тогда
		УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
	КонецЕсли;

	Возврат ДанныеДвижений;
	
КонецФункции

// Формирует движения НДС предъявленного, по документам поступления услуг.
//
// Параметры:
// ТаблицаУслуги - ТаблицаЗначений- таблица НДС по услугам
// ТаблицаРеквизиты - ТаблицаЗначений - таблица реквизитов по документу
// Движения - ссылка на движения документа
// Отказ - булево - флаг отказа
//
// Возвращаемое значение:
// "Таблица значений" - таблица движений НДС предъявленного
Функция СформироватьДвиженияПоступлениеПосредническихУслуг(ТаблицаУслуги, ТаблицаРеквизиты, Движения, Отказ)

	Если Не ЗначениеЗаполнено(ТаблицаУслуги)
	 Или Не ЗначениеЗаполнено(ТаблицаРеквизиты) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Параметры = УчетНДС.ПодготовитьПараметрыПоступлениеПосредническихУслуг(ТаблицаУслуги, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	УчетНДС.ЗаполнитьВидыЦенностей(Параметры.Услуги, Перечисления.ВидыЦенностей.ПосредническиеУслуги, "СчетЗатрат");

	ДанныеДвижений = УчетНДС.ПодготовитьДанныеДвиженийПоступлениеТоваровУслугОтПоставщика(
		Неопределено, Параметры.Услуги, Реквизиты);

	ПлательщикНДС     = УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период);
	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация, Реквизиты.Период);
		
	Если НЕ ПлательщикНДС Тогда
		Возврат Неопределено;
	КонецЕсли;

	// Движения регистров подсистемы НДС
	
	Если УпрощенныйУчетНДС Тогда 
		Возврат Неопределено;
	КонецЕсли;
	
	Если ДанныеДвижений.Итог("НДС") = 0 Тогда
		УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
	КонецЕсли;

	Возврат ДанныеДвижений;
	
КонецФункции

// Формирует движения НДС предъявленного по документу: Возврат от покупателя.
Функция СформироватьДвиженияВозвратТоваровОтПокупателя(
	ТаблицаТовары, ТаблицаСписанныеТовары, ТаблицаНомераГТД, ТаблицаРеквизиты, Движения, Отказ)

	
	Параметры = УчетНДС.ПодготовитьПараметрыВозвратТоваровОтПокупателя(
		ТаблицаТовары, ТаблицаСписанныеТовары, ТаблицаНомераГТД, ТаблицаРеквизиты);
		
	Реквизиты = Параметры.Реквизиты[0];
	
	ПлательщикНДС = УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период);
	Если НЕ ПлательщикНДС Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаСПартиями = УчетНДС.ПодготовитьТаблицуСписанныхПартийДляВозврата(Реквизиты, Параметры);
	
	Если ТаблицаСПартиями.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;

	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	
	Если ВерсияУчетаНДС <> 1
		ИЛИ Реквизиты.ПокупателемВыставляетсяСчетФактураНаВозврат
		ИЛИ Реквизиты.ОтразитьВКнигеПокупок Тогда
		ВидЦенности = Перечисления.ВидыЦенностей.Возврат;
	Иначе
		ВидЦенности = Неопределено;
	КонецЕсли;
	УчетНДС.ЗаполнитьВидыЦенностей(ТаблицаСПартиями, ВидЦенности, "СчетУчета");

	ШаблонСодержания = НСтр("ru = 'Возврат %1 от покупателя'");
	
	Для каждого СтрокаТаблицы Из ТаблицаСПартиями Цикл
		СтрокаТаблицы.Содержание  = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСодержания,
			БухгалтерскийУчетПовтИсп.НазваниеОбъектаПоСчетуУчета(СтрокаТаблицы.СчетУчета));
		
		// СуммаРуб не должна включать НДС - как в других документах поступления
		СтрокаТаблицы.СуммаРуб = СтрокаТаблицы.СуммаРуб - СтрокаТаблицы.СуммаНДСРуб;
	КонецЦикла;

	ДанныеДвижений = УчетНДС.ПодготовитьДанныеДвиженийВозвратТоваровОтПокупателя(ТаблицаСПартиями, Реквизиты);

	Если НЕ ВерсияУчетаНДС = 1 Тогда
		
		Если ДанныеДвижений.Итог("НДС") = 0 Тогда
			УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
		КонецЕсли;

	КонецЕсли;

	Возврат ДанныеДвижений;
	
КонецФункции

// Формирует движения НДС предъявленного по документу: Поступление доп. расходов.
Функция СформироватьДвиженияПоступлениеДопРасходовОтПоставщика(ТаблицаТовары, ТаблицаРеквизиты, Движения, Отказ)

	Если Не ЗначениеЗаполнено(ТаблицаТовары) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Параметры = УчетНДС.ПодготовитьПараметрыПоступлениеДопРасходовОтПоставщика(ТаблицаТовары, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// Вид ценности по умолчанию для доп.расходов - прочие работы и услуги
	УчетНДС.ЗаполнитьВидыЦенностейПоступлениеОтПоставщика(Параметры.Товары, Реквизиты, Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги, "СчетУчета");

	ДанныеДвижений = УчетНДС.ПодготовитьДанныеДвиженийПоступлениеДопРасходовОтПоставщика(Параметры.Товары, Реквизиты);

	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация, Реквизиты.Период);
	
	ПлательщикНДС = УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период);
	Если НЕ ПлательщикНДС Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если УпрощенныйУчетНДС Тогда 
		Возврат Неопределено;
	КонецЕсли;
	
	Если ДанныеДвижений.Итог("НДС") = 0 Тогда
		УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
	КонецЕсли;
			
	Возврат ДанныеДвижений;
	
КонецФункции

// Формирует движения НДС предъявленного по документу: Поступление товаров и услуг.
Функция СформироватьДвиженияПоступлениеТоваровУслугОтПоставщика(ТаблицаТовары,
			ТаблицаУслуги, ТаблицаНомераГТД, ТаблицаРеквизиты, Движения, Отказ)

	Параметры = УчетНДС.ПодготовитьПараметрыПоступлениеТоваровУслугОтПоставщика(
		ТаблицаТовары, ТаблицаУслуги, ТаблицаНомераГТД, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];
	
	УчетНДС.ЗаполнитьВидыЦенностейПоступлениеОтПоставщика(Параметры.Товары, Реквизиты, Неопределено, "СчетУчета");
	УчетНДС.ЗаполнитьВидыЦенностейПоступлениеОтПоставщика(Параметры.Услуги, Реквизиты, Неопределено, "СчетЗатрат");

	ДанныеДвижений = УчетНДС.ПодготовитьДанныеДвиженийПоступлениеТоваровУслугОтПоставщика(
		Параметры.Товары, Параметры.Услуги, Реквизиты);
		
	ПлательщикНДС              = УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период);
	ВерсияУчетаНДС             = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС          = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация,
		 Реквизиты.Период);
	
	// Движения регистров подсистемы НДС
	
	Если НЕ ПлательщикНДС Тогда
		
		// Сформируем движения по регистру "НДС предъявленный" в случае поступления ценностей
		// по договору в иностранной валюте с исполнением обязанностей налогового агента
		// с целью корректного расчета суммовых разниц при поступлении оплаты.
		Если Реквизиты.УчетАгентскогоНДС 
			И Перечисления.ВидыАгентскихДоговоров.ЭтоНерезидент(Реквизиты.ВидАгентскогоДоговора)
			И Реквизиты.ВалютаВзаиморасчетов <> ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета()
			И ВерсияУчетаНДС = 2 Тогда
			
			Если ДанныеДвижений.Итог("НДС") = 0 Тогда
				УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат ДанныеДвижений;
		
	КонецЕсли;
		
	Если УпрощенныйУчетНДС Тогда
		Возврат Неопределено;
	КонецЕсли;
		
	Если ДанныеДвижений.Итог("НДС") = 0 Тогда
		УчетНДС.СформироватьДвиженияНДСПредъявленныйПоступлениеТоваровУслуг(ДанныеДвижений, Движения, Отказ);
	КонецЕсли;
	
	Возврат ДанныеДвижений;
	
КонецФункции

Функция ПолучитьСоответствиеВидовСчетаФактурыФормам() Экспорт

	ФормыСчетовФактур = Новый Соответствие;
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаПоступление,      "ФормаДокументаНаПоступление");
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаАванс,                 "ФормаДокументаНаАванс");
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс, "ФормаДокументаНаАванс");
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента,        "ФормаДокументаНаАванс");
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.Корректировочный,        "ФормаПодбора");
	
	// Исправление счета-фактуры
	ФормыСчетовФактур.Вставить(Перечисления.ВидСчетаФактурыПолученного.ПустаяСсылка(),          "ФормаПодбора");
	
	Возврат ФормыСчетовФактур;

КонецФункции 

Функция ПолучитьКодВидаОперации(Параметры) Экспорт
	
	КодВидаОперации = "";
	
	ПараметрыОпределенияКВО = НовыйПараметрыОпределенияКВО();
	ЗаполнитьЗначенияСвойств(ПараметрыОпределенияКВО, Параметры);
	
	Если НЕ УчетНДСПереопределяемый.ИспользуетсяПостановлениеНДС1137(ПараметрыОпределенияКВО.Дата) Тогда
		Возврат КодВидаОперации;
	КонецЕсли;
	
	ДокументыОснования = Параметры.ДокументыОснования.Выгрузить(,"ДокументОснование");
	
	ВерсияКодовВидовОпераций = УчетНДСКлиентСервер.ВерсияКодовВидовОпераций(ПараметрыОпределенияКВО.Дата);
	
	Если ПараметрыОпределенияКВО.НДСПоСтавкам4и2
	   И ВерсияКодовВидовОпераций < 3 Тогда
		Возврат "99";
	КонецЕсли;
	
	Если ВерсияКодовВидовОпераций >= 4 И ПараметрыОпределенияКВО.НДСИсчисляетсяНалоговымАгентом Тогда
		Если ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление Тогда
			Возврат "42";
		ИначеЕсли ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс Тогда
			Возврат "41";
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыОпределенияКВО.Исправление
	 ИЛИ ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
		// Код операции наследуется из исправляемого (корректируемого) счета-фактуры
		Если ЗначениеЗаполнено(ПараметрыОпределенияКВО.КодВидаОперацииОснования) Тогда
			Возврат УчетНДС.АктуальныйКодВидаОперации(
				ПараметрыОпределенияКВО.КодВидаОперацииОснования, ВерсияКодовВидовОпераций);
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление Тогда
		
		МассивКомиссияПоЗакупке = Новый Массив;

		Для Каждого СтрокаТабличнойЧасти ИЗ ДокументыОснования Цикл
			
			ТипОснования = ТипЗнч(СтрокаТабличнойЧасти.ДокументОснование);
			
			Если ТипОснования = Тип("ДокументСсылка.ОтражениеНДСКВычету")
				И ВерсияКодовВидовОпераций > 1 Тогда
				// Код операции указывается в документе
				КодВидаОперацииИзДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
					СтрокаТабличнойЧасти.ДокументОснование, "КодВидаОперации");
				КодВидаОперации = УчетНДС.АктуальныйКодВидаОперации(КодВидаОперацииИзДокумента, ВерсияКодовВидовОпераций);
				Прервать;
			ИначеЕсли ВерсияКодовВидовОпераций >= 3 Тогда
				// По умолчанию код "01", но необходимо проверить случай "смешанной" закупки (код 15),
				// которая может быть оформлена документом "Поступление товаров услуг".
				КодВидаОперации = "01";
				Если ТипОснования = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
					МассивКомиссияПоЗакупке.Добавить(СтрокаТабличнойЧасти.ДокументОснование);
				Иначе
					МассивКомиссияПоЗакупке.Очистить();
					Прервать;
				КонецЕсли;
			// Коды операций до 1 июля 2016 года.
			ИначеЕсли ТипОснования = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя")
				ИЛИ ПараметрыОпределенияКВО.ВозвратЧерезКомиссионера Тогда
				КодВидаОперации = "03";
			ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтчетКомитентуОПродажах") Тогда
				КодВидаОперации = "04";
			ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
				МассивКомиссияПоЗакупке.Добавить(СтрокаТабличнойЧасти.ДокументОснование);
			КонецЕсли;
			
		КонецЦикла;
		
		Если МассивКомиссияПоЗакупке.Количество() > 0 Тогда
			
			СчетаУчетаКомиссионногоТовара = Новый Массив;
			СчетаУчетаКомиссионногоТовара.Добавить(ПланыСчетов.Хозрасчетный.ТМЦпринятыеНаОтветственноеХранение);
			
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("ДокументыОснования", МассивКомиссияПоЗакупке);
			Запрос.УстановитьПараметр("СчетаУчетаКомиссионногоТовара", СчетаУчетаКомиссионногоТовара);
			Запрос.Текст = ТекстЗапросаКВОКомиссияПоЗакупке();
			
			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				Выборка = Результат.Выбрать();
				Если Выборка.Следующий() Тогда
					Если Выборка.ЕстьСобственныеТоварыИУслуги > 0
						И Выборка.ЕстьКомиссионныеТоварыИУслуги > 0 Тогда
						КодВидаОперации = ?(ВерсияКодовВидовОпераций < 3, "01;04", "15");
					ИначеЕсли ВерсияКодовВидовОпераций < 3 И Выборка.ЕстьКомиссионныеТоварыИУслуги > 0 Тогда 
						КодВидаОперации = "04";
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ВерсияКодовВидовОпераций >= 3 Тогда 
		Если ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс
			ИЛИ ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс
			ИЛИ ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента Тогда
			КодВидаОперации = "02";
		КонецЕсли;
	// Коды операций до 1 июля 2016 года
	ИначеЕсли ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс Тогда
		Если ДокументыОснования.Количество() > 0
			И ТипЗнч(ДокументыОснования[0].ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитентуОПродажах") Тогда
			КодВидаОперации = "05";
		Иначе
			КодВидаОперации = "02";
		КонецЕсли;
	ИначеЕсли ПараметрыОпределенияКВО.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента Тогда
		КодВидаОперации = "05";
	Иначе
		Для Каждого СтрокаТабличнойЧасти ИЗ ДокументыОснования Цикл
			Если ТипЗнч(СтрокаТабличнойЧасти.ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитентуОПродажах") Тогда
				КодВидаОперации = "04";
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(КодВидаОперации) Тогда
		КодВидаОперации = "01";
	КонецЕсли;
	
	Возврат КодВидаОперации;
	
КонецФункции

Функция ПолучитьПорядокОтраженияВычетаПоУмолчанию(СтруктураПараметров) Экспорт
	
	ПлательщикНДС = УчетнаяПолитика.ПлательщикНДС(СтруктураПараметров.Организация, СтруктураПараметров.Дата);
	Если НЕ ПлательщикНДС Тогда
		Возврат Ложь;
	КонецЕсли;
	
	НДСПредъявленКВычету = Ложь;
	
	Если УчетНДСКлиентСервер.Версия(СтруктураПараметров.Дата) > 1 Тогда
		
		Если СтруктураПараметров.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление Тогда
			
			СчетФактураКомитента = (ТипЗнч(СтруктураПараметров.ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитентуОПродажах"));
			
			Если НЕ СтруктураПараметров.Исправление И НЕ СчетФактураКомитента Тогда
				Если НЕ УчетнаяПолитика.РаздельныйУчетНДС(СтруктураПараметров.Организация, СтруктураПараметров.Дата)
					И НЕ ЕстьСписаниеНДСПоОснованию(СтруктураПараметров) 
					И (СчетФактураПолученВКварталеПоступленияЦенностей(СтруктураПараметров)
					ИЛИ СтруктураПараметров.Дата < '20150101') Тогда
					
					Если ЕстьФункцияНаличиеСуммыНДС(СтруктураПараметров.ДокументОснование) Тогда
						НДСПредъявленКВычету = РаботаСДоговорамиКонтрагентовБП.ДокументСНДС(СтруктураПараметров.ДокументОснование);
					Иначе
						НДСПредъявленКВычету = Истина;
					КонецЕсли;
					
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли СтруктураПараметров.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс
			ИЛИ СтруктураПараметров.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
			
			НДСПредъявленКВычету = Истина;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат НДСПредъявленКВычету;
	
КонецФункции

Функция ЕстьФункцияНаличиеСуммыНДС(ТекущийДокумент) 

	Если ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.СчетНаОплатуПоставщика")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ПлатежноеПоручение")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеДопРасходов")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеИзПереработки")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ПоступлениеНМА")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ВыкупПредметовЛизинга")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ОтражениеНДСКВычету")
		ИЛИ ТИПЗНЧ(ТекущийДокумент) = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") Тогда

		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Ложь;

КонецФункции

Функция ЕстьСписаниеНДСПоОснованию(СтруктураПараметров)
	
	Если СтруктураПараметров.ДокументОснование  = Неопределено Тогда 
		Возврат Ложь;
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	
	ДатаОснования = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураПараметров.ДокументОснование, "Дата");
	Запрос.УстановитьПараметр("Организация",				СтруктураПараметров.Организация);
	Запрос.УстановитьПараметр("СчетФактура",				СтруктураПараметров.ДокументОснование);
	Запрос.УстановитьПараметр("НачалоНалоговогоПериода",	НачалоКвартала(ДатаОснования));
	Запрос.УстановитьПараметр("КонецНалоговогоПериода",		КонецКвартала(ДатаОснования));
	
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА КАК ЕстьСписание
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|ГДЕ
	|	НДСПредъявленный.Организация = &Организация
	|	И НДСПредъявленный.СчетФактура = &СчетФактура
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НДСсписанНаРасходы)
	|	И НДСПредъявленный.Период >= &НачалоНалоговогоПериода
	|	И НДСПредъявленный.Период <= &КонецНалоговогоПериода";
				   
	Результат	= Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
 	
КонецФункции

Функция СчетФактураПолученВКварталеПоступленияЦенностей(СтруктураПараметров)
	
	Если СтруктураПараметров.ДокументОснование  = Неопределено Тогда 
		Возврат Истина;
	КонецЕсли;	
	
	ДатаОснования = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураПараметров.ДокументОснование, "Дата");
	
	Возврат КонецКвартала(СтруктураПараметров.Дата) = КонецКвартала(ДатаОснования);
	 	
КонецФункции

// Получаем порядок исправления счетов-фактур, 
//устанавливаем значение Истина для счетов-фактур, требующих создания корректировки
Функция ПолучитьСоответствиеВидовСчетаФактурыПорядкуИсправления() Экспорт

	ПорядокИсправления = Новый Соответствие;
	
	ПорядокИсправления.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаПоступление,           Истина);
	ПорядокИсправления.Вставить(Перечисления.ВидСчетаФактурыПолученного.Корректировочный,        Истина);
	ПорядокИсправления.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаАванс,                 Ложь);
	ПорядокИсправления.Вставить(Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента,        Ложь);
	ПорядокИсправления.Вставить(Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс, Ложь);
	
	Возврат ПорядокИсправления;

КонецФункции

Функция ПолучитьПредставлениеДокумента(ДокументСсылка, ВидСчетаФактуры) Экспорт
			
	ТекстПредставлениеКраткое	= "";
	ТекстПредставление 			= "";
	ТекстОсновноеПредставление	= "";
	
	Корректировочный = Ложь;
			
	Если ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление Тогда 
		ТекстОсновноеПредставление = НСтр("ru = 'Счет-фактура полученный на поступление'");	
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс Тогда 
		ТекстОсновноеПредставление = НСтр("ru = 'Счет-фактура полученный на аванс'");
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда 
		ТекстОсновноеПредставление = НСтр("ru = 'Корректировочный счет-фактура полученный на аванс'");
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента Тогда
		ТекстОсновноеПредставление = НСтр("ru = 'Счет-фактура полученный на аванс комитента на закупку'");
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
		Корректировочный = Истина;
		ТекстОсновноеПредставление = НСтр("ru = 'Корректировочный счет-фактура полученный'");
	КонецЕсли;	
			
	Если ЗначениеЗаполнено(ДокументСсылка) И ОбщегоНазначения.СсылкаСуществует(ДокументСсылка) Тогда
		
		РеквизитыСчетаФактуры = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка, "ВидСчетаФактуры, Исправление, НомерИсправления, ДатаИсправления, 
			|НомерВходящегоДокумента, ДатаВходящегоДокумента, БланкСтрогойОтчетности");
			
		РеквизитыСчетаФактуры.Вставить("Корректировочный", Корректировочный);
		
		СтруктураПредставленияПоРеквизитам = ПолучитьПредставлениеПоРеквизитам(РеквизитыСчетаФактуры, ТекстОсновноеПредставление);	
		ТекстПредставлениеКраткое 	= СтруктураПредставленияПоРеквизитам.ТекстПредставлениеКраткое;
		ТекстПредставление 			= СтруктураПредставленияПоРеквизитам.ТекстПредставление;
		
	Иначе
		ТекстПредставление = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1 (создание)'"), ТекстОсновноеПредставление);
	КонецЕсли;
	
	СтруктураПредставления = Новый Структура;
	СтруктураПредставления.Вставить("СчетФактураКраткоеПредставление", ТекстПредставлениеКраткое);
	СтруктураПредставления.Вставить("СчетФактураПредставление", ТекстПредставление);
	
	Возврат СтруктураПредставления;
	
КонецФункции

Функция ПолучитьПредставлениеПоРеквизитам(РеквизитыСчетаФактуры = Неопределено, ТекстОсновноеПредставление = "") Экспорт 
	
	СтруктураПредставленияПоРеквизитам = Новый Структура;
	
	Если РеквизитыСчетаФактуры = Неопределено Тогда 
		ТекстПредставлениеКраткое 	= "";
		ТекстПредставление 			= "";
	Иначе
		Если РеквизитыСчетаФактуры.БланкСтрогойОтчетности Тогда
			ТекстОсновноеПредставление = НСтр("ru = 'Счет-фактура (бланк строгой отчетности)'");
		КонецЕсли; 	
		
		Если РеквизитыСчетаФактуры.Исправление Тогда
			ТекстПредставлениеКраткое = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1 (испр. %2) от %3'"),
			РеквизитыСчетаФактуры.НомерВходящегоДокумента, РеквизитыСчетаФактуры.НомерИсправления, Формат(РеквизитыСчетаФактуры.ДатаИсправления,"ДЛФ=Д"));
			ТекстПредставление = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1 %2'"), ТекстОсновноеПредставление, ТекстПредставлениеКраткое);
		Иначе
			ТекстПредставлениеКраткое = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1 от %2'"),
			РеквизитыСчетаФактуры.НомерВходящегоДокумента, Формат(РеквизитыСчетаФактуры.ДатаВходящегоДокумента,"ДЛФ=Д"));
			ТекстПредставление = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1 %2'"), ТекстОсновноеПредставление, ТекстПредставлениеКраткое);	
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПредставленияПоРеквизитам.Вставить("ТекстПредставлениеКраткое", ТекстПредставлениеКраткое);
	СтруктураПредставленияПоРеквизитам.Вставить("ТекстПредставление", ТекстПредставление);

	Возврат СтруктураПредставленияПоРеквизитам;
	
КонецФункции

Функция ПолучитьРеквизитыИсходногоСчетаФактурыДляКорректировки(
	ДокументОснование, СчетФактура, ПолучатьПредставление = Ложь, ИсходныйСчетФактура= Неопределено) Экспорт
	
	Если СчетФактура.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитентуОПродажах") Тогда
		
		ПараметрыПоиска = Новый Структура("Организация,
			|ИННКонтрагента,
			|СчетФактураВыданный,
			|НомерСчетаФактуры,
			|ДатаСчетаФактуры,
			|НомерИсправленияСчетаФактуры,
			|ДатаИсправленияСчетаФактуры,
			|НомерКорректировочногоСчетаФактуры,
			|ДатаКорректировочногоСчетаФактуры,
			|НомерИсправленияКорректировочногоСчетаФактуры,
			|ДатаИсправленияКорректировочногоСчетаФактуры");
		
		РеквизитыСФ = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СчетФактура, "Организация, Контрагент.ИНН, НомерИсходногоДокумента, ДатаИсходногоДокумента");
		
		ПараметрыПоиска.Вставить("Организация", РеквизитыСФ.Организация);
		ПараметрыПоиска.Вставить("ИННКонтрагента", РеквизитыСФ.КонтрагентИНН);
		ПараметрыПоиска.Вставить("СчетФактураВыданный", Ложь);
		ПараметрыПоиска.Вставить("НомерСчетаФактуры", РеквизитыСФ.НомерИсходногоДокумента);
		ПараметрыПоиска.Вставить("ДатаСчетаФактуры", РеквизитыСФ.ДатаИсходногоДокумента);
		ПараметрыПоиска.Вставить("ДатаИсправленияСчетаФактуры", '00010101');
		ПараметрыПоиска.Вставить("ДатаКорректировочногоСчетаФактуры", '00010101');
		ПараметрыПоиска.Вставить("ДатаИсправленияКорректировочногоСчетаФактуры", '00010101');
		
		ИсходныйСчетФактура = УчетНДС.НайтиСчетФактуруПоРеквизитам(ПараметрыПоиска);
		
		Если ИсходныйСчетФактура <> Неопределено Тогда 
			
			РеквизитыСчетаФактуры = Новый Структура("СчетФактура, СчетФактураПредставление, СчетФактураКраткоеПредставление");
			ПредставлениеДокумента = ПолучитьПредставлениеДокумента(ИсходныйСчетФактура, СчетФактура.ВидСчетаФактуры);
			РеквизитыСчетаФактуры.Вставить("СчетФактура", ИсходныйСчетФактура);
			РеквизитыСчетаФактуры.Вставить("СчетФактураПредставление", ПредставлениеДокумента.СчетФактураПредставление);
			РеквизитыСчетаФактуры.Вставить("СчетФактураКраткоеПредставление", ПредставлениеДокумента.СчетФактураКраткоеПредставление);
			
			Возврат РеквизитыСчетаФактуры;
			
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПоступления") Тогда 
		
		ДокументПоступления = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОснование, "ДокументПоступления");
		
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда 
	
		ДокументПоступления = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОснование, "Сделка");
	
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	Если ДокументПоступления <> Неопределено Тогда 
		Если СчетФактура.Исправление ИЛИ СчетФактура.ИсправлениеСобственнойОшибки Тогда
			
			ИсходныйДокументПоступления = УчетНДСПереопределяемый.ПолучитьИсправляемыйДокументПоступления(ДокументОснование);
			
			Если ТипЗнч(ИсходныйДокументПоступления) = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
				ИсходныйДокументПоступления = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ИсходныйДокументПоступления, "ДокументПоступления");
			КонецЕсли;
			
		Иначе
			ИсходныйДокументПоступления = ДокументПоступления;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ИсходныйСчетФактура) Тогда
			// Получает реквизиты указанного счета-фактуры
			РеквизитыИсходногоСчетаФактуры = ПолучитьРеквизитыСчетаФактурыПолученного(ИсходныйСчетФактура, ПолучатьПредставление);
		Иначе
			// Сначала ищет счет-фактуру исходного документа и потом получает реквизиты
			РеквизитыИсходногоСчетаФактуры = ПолучитьРеквизитыСчетаФактурыПолученного(ИсходныйДокументПоступления, ПолучатьПредставление);
		КонецЕсли;
	Иначе
		РеквизитыИсходногоСчетаФактуры = Неопределено;
	КонецЕсли;
	
	Возврат РеквизитыИсходногоСчетаФактуры;
	
КонецФункции

Функция ПолучитьРеквизитыСчетаФактурыПолученного(ДокументОснование, ПолучатьПредставление) Экспорт
	
	РеквизитыСчетаФактуры = Новый Структура(
		"СчетФактура, СчетФактураПредставление, СчетФактураКраткоеПредставление, НомерСчетаФактуры, ДатаСчетаФактуры,
		|Исправление, НомерИсправления, ДатаИсправления, НомерИсходногоДокумента, ДатаИсходногоДокумента,
		|УчитыватьИсправлениеИсходногоДокумента, НомерИсправленияИсходногоДокумента, ДатаИсправленияИсходногоДокумента");
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументыОснования.Ссылка КАК Ссылка,
	|	ДокументыОснования.НомерИсходногоДокумента,
	|	ДокументыОснования.ДатаИсходногоДокумента,
	|	ДокументыОснования.УчитыватьИсправлениеИсходногоДокумента,
	|	ДокументыОснования.НомерИсправленияИсходногоДокумента,
	|	ДокументыОснования.ДатаИсправленияИсходногоДокумента
	|ПОМЕСТИТЬ ВТ_СчетФактураПолученныйДокументыОснования
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.ДокументОснование = &ДокументОснование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыОснования.Ссылка,
	|	ДокументыОснования.НомерИсходногоДокумента,
	|	ДокументыОснования.ДатаИсходногоДокумента,
	|	ДокументыОснования.УчитыватьИсправлениеИсходногоДокумента,
	|	ДокументыОснования.НомерИсправленияИсходногоДокумента,
	|	ДокументыОснования.ДатаИсправленияИсходногоДокумента
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка = &ДокументОснование
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КорректируемыйСчетФактура.Ссылка КАК СчетФактура,
	|	КорректируемыйСчетФактура.НомерВходящегоДокумента КАК НомерСчетаФактуры,
	|	КорректируемыйСчетФактура.ДатаВходящегоДокумента КАК ДатаСчетаФактуры,
	|	КорректируемыйСчетФактура.Исправление,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.Исправление
	|			ТОГДА КорректируемыйСчетФактура.НомерИсправления
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НомерИсправления,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.Исправление
	|			ТОГДА КорректируемыйСчетФактура.ДатаИсправления
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА КорректируемыеОснования.НомерИсходногоДокумента
	|		ИНАЧЕ КорректируемыйСчетФактура.НомерИсходногоДокумента
	|	КОНЕЦ КАК НомерИсходногоДокумента,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА КорректируемыеОснования.ДатаИсходногоДокумента
	|		ИНАЧЕ КорректируемыйСчетФактура.ДатаИсходногоДокумента
	|	КОНЕЦ КАК ДатаИсходногоДокумента,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА КорректируемыеОснования.УчитыватьИсправлениеИсходногоДокумента
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК УчитыватьИсправлениеИсходногоДокумента,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА КорректируемыеОснования.НомерИсправленияИсходногоДокумента
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НомерИсправленияИсходногоДокумента,
	|	ВЫБОР
	|		КОГДА КорректируемыйСчетФактура.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА КорректируемыеОснования.ДатаИсправленияИсходногоДокумента
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ КАК ДатаИсправленияИсходногоДокумента,
	|	КорректируемыйСчетФактура.ВидСчетаФактуры
	|ИЗ
	|	ВТ_СчетФактураПолученныйДокументыОснования КАК КорректируемыеОснования
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК КорректируемыйСчетФактура
	|		ПО КорректируемыеОснования.Ссылка = КорректируемыйСчетФактура.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО (КорректируемыйСчетФактура.Ссылка = ДанныеПервичныхДокументов.Документ)
	|			И (КорректируемыйСчетФактура.Организация = ДанныеПервичныхДокументов.Организация)
	|ГДЕ
	|	НЕ ДанныеПервичныхДокументов.Документ ЕСТЬ NULL 
	|
	|УПОРЯДОЧИТЬ ПО
	|	КорректируемыйСчетФактура.ПометкаУдаления,
	|	КорректируемыйСчетФактура.Проведен УБЫВ,
	|	КорректируемыйСчетФактура.Дата";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(РеквизитыСчетаФактуры, Выборка);
		Если ПолучатьПредставление Тогда
			ПредставлениеДокумента = ПолучитьПредставлениеДокумента(Выборка.СчетФактура, Выборка.ВидСчетаФактуры);
			ЗаполнитьЗначенияСвойств(РеквизитыСчетаФактуры, ПредставлениеДокумента);
		КонецЕсли;
		Возврат РеквизитыСчетаФактуры;
	Иначе
		Возврат Неопределено;
	КонецЕсли;

КонецФункции

Функция РеквизитыНеРедактируемыеВГрупповойОбработке() Экспорт
	
	МассивРеквизитов = Новый Массив();
	МассивРеквизитов.Добавить("УдалитьУчитыватьИсправлениеИсходногоДокумента");
	МассивРеквизитов.Добавить("УдалитьНомерИсправленияИсходногоДокумента");
	МассивРеквизитов.Добавить("УдалитьДатаИсправленияИсходногоДокумента");
	МассивРеквизитов.Добавить("УдалитьКорректировочныйСчетФактура");
	МассивРеквизитов.Добавить("УдалитьНаАванс");
	
	Возврат МассивРеквизитов;
	
КонецФункции

Функция ТекстЗапросаСчетаФактурыВыданныеПоИсправлениюСобственнойОшибки() Экспорт
	
	Возврат "ВЫБРАТЬ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.НомерСтроки,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Покупатель,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СчетФактура КАК СчетФактура,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Субкомиссионер,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Сумма,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.НДС,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУвеличение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУменьшение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетФактураПолученныйСчетаФактурыВыданныеПокупателям
	|ГДЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка = &Ссылка";

КонецФункции

Функция ТекстЗапросаПродавцыПоИсправляемомуСчетуФактуре() Экспорт
	
	Возврат "ВЫБРАТЬ
	|	Продавцы.Продавец КАК Продавец,
	|	ВЫБОР
	|		КОГДА Продавцы.ИННПродавца = """"
	|			ТОГДА Контрагенты.ИНН
	|		ИНАЧЕ Продавцы.ИННПродавца
	|	КОНЕЦ КАК ИННПродавца,
	|	ВЫБОР
	|		КОГДА Продавцы.ИННПродавца = """"
	|			ТОГДА Контрагенты.ИНН
	|		ИНАЧЕ Продавцы.ИННПродавца
	|	КОНЕЦ КАК ИННПродавцаДоИзменения,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо)
	|			ТОГДА ВЫБОР
	|					КОГДА Продавцы.КПППродавца = """"
	|						ТОГДА Контрагенты.КПП
	|					ИНАЧЕ Продавцы.КПППродавца
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КПППродавца,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо)
	|			ТОГДА ВЫБОР
	|					КОГДА Продавцы.КПППродавца = """"
	|						ТОГДА Контрагенты.КПП
	|					ИНАЧЕ Продавцы.КПППродавца
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КПППродавцаДоИзменения
	|ИЗ
	|	Документ.СчетФактураПолученный.Продавцы КАК Продавцы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО Продавцы.Продавец = Контрагенты.Ссылка
	|ГДЕ
	|	Продавцы.Ссылка = &СчетФактураИсправляемый
	|
	|УПОРЯДОЧИТЬ ПО
	|	Продавцы.НомерСтроки";
	
КонецФункции

Функция НовыйПараметрыОпределенияКВО()
	
	ПараметрыОпределенияКВО = Новый Структура();
	
	ПараметрыОпределенияКВО.Вставить("Дата",                           '00010101');
	ПараметрыОпределенияКВО.Вставить("ВидСчетаФактуры",                Перечисления.ВидСчетаФактурыПолученного.ПустаяСсылка());
	ПараметрыОпределенияКВО.Вставить("Исправление",                    Ложь);
	ПараметрыОпределенияКВО.Вставить("ВозвратЧерезКомиссионера",       Ложь);
	ПараметрыОпределенияКВО.Вставить("КодВидаОперацииОснования",       "");
	ПараметрыОпределенияКВО.Вставить("НДСПоСтавкам4и2",                Ложь);
	ПараметрыОпределенияКВО.Вставить("НДСИсчисляетсяНалоговымАгентом", Ложь);
	
	Возврат ПараметрыОпределенияКВО;
	
КонецФункции

Функция ТекстЗапросаКВОКомиссияПоЗакупке()
	
	Возврат
	"ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Ссылка КАК Ссылка,
	|	МАКСИМУМ(1) КАК ЕстьКомиссионныеТоварыИУслуги,
	|	МАКСИМУМ(0) КАК ЕстьСобственныеТоварыИУслуги
	|ПОМЕСТИТЬ ТоварыПоТипам
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка В(&ДокументыОснования)
	|	И ПоступлениеТоваровУслугТовары.СчетУчета В(&СчетаУчетаКомиссионногоТовара)
	|	И ПоступлениеТоваровУслугТовары.Контрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеТоваровУслугТовары.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Ссылка,
	|	МАКСИМУМ(0),
	|	МАКСИМУМ(1)
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка В(&ДокументыОснования)
	|	И НЕ(ПоступлениеТоваровУслугТовары.СчетУчета В (&СчетаУчетаКомиссионногоТовара)
	|				И ПоступлениеТоваровУслугТовары.Контрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеТоваровУслугТовары.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугУслуги.Ссылка,
	|	МАКСИМУМ(0),
	|	МАКСИМУМ(1)
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Услуги КАК ПоступлениеТоваровУслугУслуги
	|ГДЕ
	|	ПоступлениеТоваровУслугУслуги.Ссылка В(&ДокументыОснования)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеТоваровУслугУслуги.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка,
	|	МАКСИМУМ(1),
	|	МАКСИМУМ(0)
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.АгентскиеУслуги КАК ПоступлениеТоваровУслугАгентскиеУслуги
	|ГДЕ
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка В(&ДокументыОснования)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ТоварыПоТипам.ЕстьКомиссионныеТоварыИУслуги, 0) КАК ЕстьКомиссионныеТоварыИУслуги,
	|	ЕСТЬNULL(ТоварыПоТипам.ЕстьСобственныеТоварыИУслуги, 0) КАК ЕстьСобственныеТоварыИУслуги
	|ИЗ
	|	ТоварыПоТипам КАК ТоварыПоТипам
	|ИТОГИ
	|	МАКСИМУМ(ЕстьКомиссионныеТоварыИУслуги),
	|	МАКСИМУМ(ЕстьСобственныеТоварыИУслуги)
	|ПО
	|	ОБЩИЕ";

КонецФункции

Функция ТребуетсяЗаполнятьДоговорВСчетеФактуреНаАванс(ДатаСчетаФактуры, Договор) Экспорт
	
	// Для счета-фактуры полученного на выданный аванс договор заполняется только для случаев:
	// - оплаты комиссионеру по закупке для заполнения дополнительных реквизитов счета-фактуры,
	// - оплаты поставщику товаров, перечисленных в п.8 ст. 161 НК, для последующей реализации особенностей учета НДС.
	
	РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Договор, "ВидДоговора,УчетАгентскогоНДС,ВидАгентскогоДоговора");
	
	НДСИсчисляетсяНалоговымАгентом = ДатаСчетаФактуры >= '20180101'
		И РеквизитыДоговора.УчетАгентскогоНДС = Истина
		И РеквизитыДоговора.ВидАгентскогоДоговора = Перечисления.ВидыАгентскихДоговоров.РеализацияТоваров;
	
	Если РеквизитыДоговора.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионеромНаЗакупку
		ИЛИ НДСИсчисляетсяНалоговымАгентом Тогда
		
		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция ДобавитьДвиженияНДСПредъявленный(ДокументОбъектСФ, ДвиженияНДСПредъявленныйОснование)
	
	НаборЗаписейНДСПредъявленныйСФ = РегистрыНакопления.НДСПредъявленный.СоздатьНаборЗаписей();
	НаборЗаписейНДСПредъявленныйСФ.Отбор.Регистратор.Установить(ДокументОбъектСФ);
	НаборЗаписейНДСПредъявленныйСФ.Прочитать();
	БылаЗаписьВрегистр = Ложь;

	Попытка 
		Для каждого ТекСтрока Из ДвиженияНДСПредъявленныйОснование Цикл
			НоваяЗапись = НаборЗаписейНДСПредъявленныйСФ.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, ТекСтрока);
			БылаЗаписьВрегистр = Истина;
		КонецЦикла;
		
		Если БылаЗаписьВрегистр Тогда
			ОбновлениеИнформационнойБазы.ЗаписатьДанные(НаборЗаписейНДСПредъявленныйСФ);
			Возврат БылаЗаписьВрегистр; // Движения есть и их стоит удалить из документа поступления.
		КонецЕсли;
	
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Возврат БылаЗаписьВрегистр; // Движений нет и удалять не нужно из документа поступления.
	
КонецФункции

Процедура УдалитьДвиженияНДСПредъявленный(НаборЗаписейНДСПредъявленный)

	НаборЗаписейНДСПредъявленный.Прочитать();

	Количество = НаборЗаписейНДСПредъявленный.Количество();
	
	Если Количество = 0 Тогда
		Возврат ;
	КонецЕсли;
	
	Индекс = 0;
	
	Пока Количество > 0 Цикл
		
		ТекСтрока = НаборЗаписейНДСПредъявленный[Индекс];
		
		Если ТекСтрока.Событие = Перечисления.СобытияПоНДСПокупки.ПредъявленНДСПоставщиком Тогда
			НаборЗаписейНДСПредъявленный.Удалить(ТекСтрока);
			Количество = Количество - 1;
		Иначе
			Индекс = Индекс + 1;
		КонецЕсли;
		
		Если Индекс = Количество Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;

	ОбновлениеИнформационнойБазы.ЗаписатьДанные(НаборЗаписейНДСПредъявленный);

КонецПроцедуры

Функция СписокСчетовФактурПолученных()

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ТаблицаСФ
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.СуммаНДСДокумента = 0
	|	И СчетФактураПолученный.Дата >= ДАТАВРЕМЯ(2015, 1, 1, 0, 0, 0)
	|	И СчетФактураПолученный.Проведен = ИСТИНА
	|	И СчетФактураПолученный.РучнаяКорректировка = ЛОЖЬ
	|	И СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаПоступление)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСФ.Ссылка КАК Ссылка,
	|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
	|ПОМЕСТИТЬ СписокСчетФактурИДокументовОснования
	|ИЗ
	|	ТаблицаСФ КАК ТаблицаСФ
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ПО ТаблицаСФ.Ссылка = СчетФактураПолученныйДокументыОснования.Ссылка
	|ГДЕ
	|	(СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеДопРасходов
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтражениеНДСКВычету
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ПоступлениеНМА
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ВыкупПредметовЛизинга
	|			ИЛИ СчетФактураПолученныйДокументыОснования.ДокументОснование ССЫЛКА Документ.ВозвратТоваровОтПокупателя)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СписокСчетФактурИДокументовОснования.Ссылка КАК СФ,
	|	НДСПредъявленный.Регистратор КАК Регистратор,
	|	НДСПредъявленный.СчетФактура КАК СчетФактура,
	|	НДСПредъявленный.НДС КАК НДС,
	|	НДСПредъявленный.СуммаБезНДС КАК СуммаБезНДС
	|ИЗ
	|	СписокСчетФактурИДокументовОснования КАК СписокСчетФактурИДокументовОснования
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|		ПО СписокСчетФактурИДокументовОснования.ДокументОснование = НДСПредъявленный.Регистратор
	|ГДЕ
	|	НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСПоставщиком)
	|ИТОГИ ПО
	|	СФ,
	|	Регистратор";
	
	ТаблицаСчетовФактурВыборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	Возврат ТаблицаСчетовФактурВыборка;
	
КонецФункции

#Область СчетФактураНаПредварительнуюОплату

Функция ПодготовитьПараметрыЗаполненияАванс(ДокументОснование, ДокументСсылка, ДоговорКонтрагента = Неопределено, Отказ) Экспорт

	РеквизитыОснования      = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОснование, "Организация, Дата");
	
	РасчетнаяСтавкаНДСПоУмолчанию = УчетНДСКлиентСервер.РасчетнаяСтавкаНДСПоУмолчанию(РеквизитыОснования.Дата);
	ЗначениеСтавкиНДС             = УчетНДСПереопределяемый.ПолучитьСтавкуНДС(РасчетнаяСтавкаНДСПоУмолчанию);
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
	Запрос.УстановитьПараметр("ДокументСсылка", ?(ЗначениеЗаполнено(ДокументСсылка), ДокументСсылка, Неопределено));
	Запрос.УстановитьПараметр("ВалютаРеглУчета", ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета());
	Запрос.УстановитьПараметр("РасчетнаяСтавкаНДСПоУмолчанию", РасчетнаяСтавкаНДСПоУмолчанию);
	Запрос.УстановитьПараметр("ЗначениеСтавкиНДС", ЗначениеСтавкиНДС);
	
	НомераТаблиц = Новый Структура;
	Запрос.Текст = Документы[ДокументОснование.Метаданные().Имя].ТекстЗапросаСчетФактураПолученныйНаАвансРасшифровкаПлатежа(НомераТаблиц)
		+ ТекстЗапросаСуммыАвансовПоВзаиморасчетам(НомераТаблиц)
		+ ТекстЗапросаДанныеПлатежа(НомераТаблиц);
	
	Результат = Запрос.ВыполнитьПакет();

	Если ПроведениеСервер.ИспользуетсяОтложенноеПроведение(РеквизитыОснования.Организация, РеквизитыОснования.Дата) Тогда
		// При использовании отложенного проведения проверим дату актуальности отложенных расчетов.
		ДоговорыПлатежа = Результат[НомераТаблиц.ДоговорыПлатежа].Выгрузить().ВыгрузитьКолонку("ДоговорКонтрагента");
		Если ДоговорыПлатежа.Количество() > 0 Тогда
			МоментАктуальностиОтложенныхРасчетов = УчетВзаиморасчетовОтложенноеПроведение.МоментАктуальностиОтложенныхРасчетов(
				РеквизитыОснования.Организация,
				РеквизитыОснования.Дата,
				,
				ДоговорыПлатежа);
			Если МоментАктуальностиОтложенныхРасчетов <> Неопределено
				И МоментАктуальностиОтложенныхРасчетов.Дата <= РеквизитыОснования.Дата Тогда
				ПараметрыЗаполнения = Новый Структура();
				ПараметрыЗаполнения.Вставить("МоментАктуальностиОтложенныхРасчетов", МоментАктуальностиОтложенныхРасчетов);
				
				Отказ = Истина;
				Возврат ПараметрыЗаполнения;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	СуммыАвансов = Результат[НомераТаблиц.СуммыАвансов].Выгрузить();
	Если СуммыАвансов.Количество() = 0 Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Не обнаружены данные об авансах по документу %1.'"),
			ДокументОснование);
			
		ПараметрыЗаполнения = Новый Структура();
		ПараметрыЗаполнения.Вставить("ТекстСообщения", ТекстСообщения);
			
		Отказ = Истина;
		Возврат ПараметрыЗаполнения;
	КонецЕсли;
	
	РасшифровкаПлатежа = Результат[НомераТаблиц.РасшифровкаПлатежа].Выгрузить();
	Если РасшифровкаПлатежа.Количество() = 0 Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Не обнаружены авансы по документу %1, на которые не выставлены счета-фактуры на аванс.'"),
			ДокументОснование);
		Отказ = Истина;
		Возврат ТекстСообщения;
	КонецЕсли;
			
	// Распределяем рублевые суммы авансов по ставкам НДС из расшифровки платежа
	АвансыПоСчетамНаОплату = РасшифровкаПлатежа.СкопироватьКолонки();
	ОтборСтрокПлатежа = Новый Структура("Контрагент,ДоговорКонтрагента");
	Для каждого СтрокаАванса Из СуммыАвансов Цикл
		ЗаполнитьЗначенияСвойств(ОтборСтрокПлатежа, СтрокаАванса);
		ПлатежиСАвансом = РасшифровкаПлатежа.Скопировать(ОтборСтрокПлатежа);
		ОбщегоНазначенияБПВызовСервера.РаспределитьСуммуПоКолонкеТаблицы(СтрокаАванса.Сумма, ПлатежиСАвансом, "Сумма");
		ОбщегоНазначенияБПВызовСервера.ЗагрузитьВТаблицуЗначений(ПлатежиСАвансом, АвансыПоСчетамНаОплату);
	КонецЦикла;
	АвансыПоСчетамНаОплату.Свернуть(
		"Дата,ДокументОснование,Организация,Контрагент,ДоговорКонтрагента,СтавкаНДС,
		|ВидДоговора,НДСИсчисляетсяНалоговымАгентом",
		"Сумма, СуммаНДС");
		
	Для каждого СтрокаАванса Из АвансыПоСчетамНаОплату Цикл
		Если СтрокаАванса.НДСИсчисляетсяНалоговымАгентом Тогда
			СтрокаАванса.СтавкаНДС = УчетНДСКлиентСервер.СтавкаНДСИсчисляетсяНалоговымАгентом(СтрокаАванса.Дата);
			СтрокаАванса.СуммаНДС = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
				СтрокаАванса.Сумма, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(СтрокаАванса.СтавкаНДС));
			СтрокаАванса.Сумма = СтрокаАванса.Сумма + СтрокаАванса.СуммаНДС;
		Иначе
			СтрокаАванса.СуммаНДС = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
				СтрокаАванса.Сумма, Истина, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(СтрокаАванса.СтавкаНДС));
		КонецЕсли;
	КонецЦикла;
		
	// Удаляем строки со ставками "Без НДС" и 0% - счета-фактуры на такие авансы не выписываются
	АвансыБезНДС = АвансыПоСчетамНаОплату.НайтиСтроки(Новый Структура("СтавкаНДС", Перечисления.СтавкиНДС.БезНДС));
	Для каждого СтрокаБезНДС Из АвансыБезНДС Цикл
		АвансыПоСчетамНаОплату.Удалить(СтрокаБезНДС);
	КонецЦикла;
	Авансы0 = АвансыПоСчетамНаОплату.НайтиСтроки(Новый Структура("СтавкаНДС", Перечисления.СтавкиНДС.НДС0));
	Для каждого Строка0 Из Авансы0 Цикл
		АвансыПоСчетамНаОплату.Удалить(Строка0);
	КонецЦикла;
	Если АвансыПоСчетамНаОплату.Количество() = 0 Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Не обнаружены авансы по документу %1 по ставкам НДС, 
			|на которые требуется регистрировать счет-фактуру на аванс.'"),
			ДокументОснование);
		Отказ = Истина;
		Возврат ТекстСообщения;
	КонецЕсли;
	
	Реквизиты = Новый Структура("Дата,ДокументОснование,Организация,Контрагент,ДоговорКонтрагента,
		|ВидДоговора,НДСИсчисляетсяНалоговымАгентом");
	ЗаполнитьЗначенияСвойств(Реквизиты, АвансыПоСчетамНаОплату[0]);
	
	ПараметрыЗаполнения = Новый Структура;
	ПараметрыЗаполнения.Вставить("Реквизиты", Реквизиты);
	ПараметрыЗаполнения.Вставить("Авансы",    АвансыПоСчетамНаОплату);
	
	Возврат ПараметрыЗаполнения;
	
КонецФункции

Функция ТекстЗапросаСуммыАвансовПоВзаиморасчетам(НомераТаблиц)
	
	// Временная таблица авансов по результатам проведения документа
	НомераТаблиц.Вставить("ВТ_СуммыАвансов", НомераТаблиц.Количество());
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Проводки.СубконтоДт1 КАК Контрагент,
	|	Проводки.СубконтоДт2 КАК ДоговорКонтрагента,
	|	Проводки.СчетДт КАК СчетАвансов,
	|	СУММА(Проводки.Сумма) КАК Сумма
	|ПОМЕСТИТЬ СуммыАвансов
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ДвиженияССубконто(
	|			,
	|			,
	|			Регистратор = &ДокументОснование
	|				И ВидСубконтоДт1 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.Контрагенты)
	|				И ВидСубконтоДт2 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.Договоры)
	|				И ВидСубконтоДт3 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.ДокументыРасчетовСКонтрагентами)
	|				И СубконтоДт3 = &ДокументОснование,
	|			,
	|			) КАК Проводки
	|
	|СГРУППИРОВАТЬ ПО
	|	Проводки.СубконтоДт1,
	|	Проводки.СубконтоДт2,
	|	Проводки.СчетДт";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаДанныеПлатежа(НомераТаблиц)
	
	// Таблица договоров из ВТ РасшифровкаПлатежа для отложенного проведения 
	НомераТаблиц.Вставить("ДоговорыПлатежа", НомераТаблиц.Количество());
	
	// Временная таблица контрагентов документа аванса
	НомераТаблиц.Вставить("ВТ_КонтрагентыПлатежа", НомераТаблиц.Количество());
	
	// Временная таблица контрагентов из ВТ_КонтрагентыПлатежа,
	// содержит контрагента, по которому есть аванс, но не был получен СФ на аванс
	НомераТаблиц.Вставить("ВТ_КонтрагентыСчетаФактуры", НомераТаблиц.Количество());
	
	// Суммы авансов из ВТ СуммыАвансов с отбором по контрагенту
	НомераТаблиц.Вставить("СуммыАвансов", НомераТаблиц.Количество());
	
	// Расшифровка платежа документа из ВТ РасшифровкаПлатежа 
	// с отбором по контрагенту
	НомераТаблиц.Вставить("РасшифровкаПлатежа", НомераТаблиц.Количество());
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РасшифровкаПлатежа.ДоговорКонтрагента КАК ДоговорКонтрагента
	|ИЗ
	|	РасшифровкаПлатежа КАК РасшифровкаПлатежа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РасшифровкаПлатежа.Контрагент КАК Контрагент
	|ПОМЕСТИТЬ КонтрагентыПлатежа
	|ИЗ
	|	РасшифровкаПлатежа КАК РасшифровкаПлатежа
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	КонтрагентыПлатежа.Контрагент КАК Контрагент
	|ПОМЕСТИТЬ КонтрагентыСчетаФактуры
	|ИЗ
	|	КонтрагентыПлатежа КАК КонтрагентыПлатежа
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммыАвансов КАК СуммыАвансов
	|		ПО КонтрагентыПлатежа.Контрагент = СуммыАвансов.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактура
	|		ПО (СчетФактура.ДокументОснование = &ДокументОснование)
	|			И (СчетФактура.Ссылка <> &ДокументСсылка)
	|			И (СчетФактура.ПометкаУдаления = ЛОЖЬ)
	|			И (СчетФактура.ВидСчетаФактуры В (ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАванс), ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.КорректировочныйНаАванс), ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАвансКомитента)))
	|			И КонтрагентыПлатежа.Контрагент = СчетФактура.Контрагент
	|ГДЕ
	|	СчетФактура.Ссылка ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СуммыАвансов.Контрагент КАК Контрагент,
	|	СуммыАвансов.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	СуммыАвансов.СчетАвансов КАК СчетАвансов,
	|	СуммыАвансов.Сумма КАК Сумма
	|ИЗ
	|	СуммыАвансов КАК СуммыАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыСчетаФактуры КАК КонтрагентыСчетаФактуры
	|		ПО (КонтрагентыСчетаФактуры.Контрагент = СуммыАвансов.Контрагент)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасшифровкаПлатежа.Дата КАК Дата,
	|	РасшифровкаПлатежа.ДокументОснование КАК ДокументОснование,
	|	РасшифровкаПлатежа.Организация КАК Организация,
	|	РасшифровкаПлатежа.Контрагент КАК Контрагент,
	|	РасшифровкаПлатежа.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ВЫБОР
	|		КОГДА РасшифровкаПлатежа.Дата < ДАТАВРЕМЯ(2018, 1, 1)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ДоговорыСчетаФактуры.УчетАгентскогоНДС
	|				И ДоговорыСчетаФактуры.ВидАгентскогоДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.РеализацияТоваров)
	|	КОНЕЦ КАК НДСИсчисляетсяНалоговымАгентом,
	|	РасшифровкаПлатежа.СчетАвансов КАК СчетАвансов,
	|	ВЫБОР
	|		КОГДА РасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|		КОГДА РасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|		КОГДА РасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|		ИНАЧЕ РасшифровкаПлатежа.СтавкаНДС
	|	КОНЕЦ КАК СтавкаНДС,
	|	РасшифровкаПлатежа.Сумма КАК Сумма,
	|	РасшифровкаПлатежа.СуммаНДС КАК СуммаНДС,
	|	ДоговорыСчетаФактуры.ВидДоговора КАК ВидДоговора
	|ИЗ
	|	РасшифровкаПлатежа КАК РасшифровкаПлатежа
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыСчетаФактуры КАК КонтрагентыСчетаФактуры
	|		ПО РасшифровкаПлатежа.Контрагент = КонтрагентыСчетаФактуры.Контрагент
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыСчетаФактуры
	|		ПО РасшифровкаПлатежа.ДоговорКонтрагента = ДоговорыСчетаФактуры.Ссылка";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

#КонецОбласти

#Область ПараметрыПроведения

Функция ПодготовитьПараметрыПроведения(ДокументСсылка, Отказ) Экспорт

	ПараметрыПроведения = Новый Структура;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	РеквизитыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, Дата, ИсправляемыйСчетФактура, ИсправлениеСобственнойОшибки");
	Запрос.УстановитьПараметр("Дата",                    РеквизитыДокумента.Дата);
	Запрос.УстановитьПараметр("Организация",             РеквизитыДокумента.Организация);
	Запрос.УстановитьПараметр("ЭтоИСО",                  РеквизитыДокумента.ИсправлениеСобственнойОшибки);
	Запрос.УстановитьПараметр("ИсправляемыйСчетФактура", РеквизитыДокумента.ИсправляемыйСчетФактура);
	Запрос.УстановитьПараметр("ВалютаРеглУчета",         ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета());
	
	// Для счета-фактуры 4 квартала 2014 года отдельно определим наличие комиссионных операций.
	ЕстьКомиссия4кв2014 = Ложь;
	Если НачалоКвартала(РеквизитыДокумента.Дата) = '20141001' Тогда
		ЕстьКомиссия4кв2014 = ЕстьКомиссионныеОперацииПоСчетуФактуре4кв2014(ДокументСсылка);
	КонецЕсли;
	Запрос.УстановитьПараметр("ЕстьКомиссия4кв2014", ЕстьКомиссия4кв2014);
	
	Запрос.Текст = ТекстЗапросаРеквизитыДокумента();
	ТаблицаРеквизиты = Запрос.Выполнить().Выгрузить();
	Реквизиты = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(ТаблицаРеквизиты[0]);
	
	Если НЕ УчетнаяПолитика.Существует(Реквизиты.Организация, Реквизиты.Период, Истина, ДокументСсылка) Тогда
		Отказ = Истина;
		Возврат ПараметрыПроведения;
	КонецЕсли;
	
	Если Реквизиты.СформированПриВводеНачальныхОстатковНДС Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаСторноНаВыданныйАванс = УчетНДС.ПодготовитьТаблицуСторноНаВыданныйАванс(
		ТаблицаРеквизиты, Отказ);
		
	УстановитьПараметрыЗапросаДвиженияСФ(Запрос, Реквизиты);
	
	Реквизиты.Вставить("ПлательщикНДС", УчетнаяПолитика.ПлательщикНДС(Реквизиты.Организация, Реквизиты.Период));
	Реквизиты.Вставить("ВерсияНДС",     УчетНДСКлиентСервер.Версия(Реквизиты.Период));
	Реквизиты.Вставить("ИспользуетсяПостановление1137", УчетНДСПереопределяемый.ИспользуетсяПостановлениеНДС1137(Реквизиты.Период));
	Реквизиты.Вставить("ВедетсяУчетНДСПоФЗ134", УчетНДС.ВедетсяУчетНДСПоФЗ134(Реквизиты.Период));
	Реквизиты.Вставить("ИностранныйСчетФактура", УчетНДС.КонтрагентРезидентТаможенногоСоюза(Реквизиты.Контрагент));
	
	НомераТаблиц = Новый Структура;
	Запрос.Текст = ТекстЗапросаНДСПоАвансамВыданным(НомераТаблиц, ПараметрыПроведения, Реквизиты)
		+ ТекстЗапросаЖурналУчетаСчетовФактур(НомераТаблиц, ПараметрыПроведения, Реквизиты)
		+ ТекстЗапросаОшибочныеРеквизитыКонтрагентов(НомераТаблиц, ПараметрыПроведения, Реквизиты);
		
	Если НЕ ПустаяСтрока(Запрос.Текст) Тогда
		Результат = Запрос.ВыполнитьПакет();
		Для каждого ИндексТаблицы Из НомераТаблиц Цикл
			ПараметрыПроведения.Вставить(ИндексТаблицы.Ключ, Результат[ИндексТаблицы.Значение].Выгрузить());
		КонецЦикла; 
	КонецЕсли;
	
	ПараметрыПроведения.Вставить("ТаблицаСторноНаВыданныйАванс", ТаблицаСторноНаВыданныйАванс);
	
	Если Реквизиты.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление Тогда
		ПараметрыПроведения.Вставить("РеквизитыПоступление", ТаблицаРеквизиты);
	Иначе
		ПараметрыПроведения.Вставить("РеквизитыПоступление", Неопределено);
	КонецЕсли;
		
	Если Реквизиты.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс
		ИЛИ Реквизиты.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
		ПараметрыПроведения.Вставить("РеквизитыАванс", ТаблицаРеквизиты);
	Иначе
		ПараметрыПроведения.Вставить("РеквизитыАванс", Неопределено);
	КонецЕсли;
		
	Возврат ПараметрыПроведения;
	
КонецФункции

Функция ТекстЗапросаРеквизитыДокумента()

	ТекстЗапроса =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА КАК ЕстьДвиженияВыданногоПоПолученному,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца КАК СчетФактураПолученныйОтПродавца
	|ПОМЕСТИТЬ ДвиженияВыданногоСФПоИсправляемому
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			&ЭтоИСО
	|				И Организация = &Организация
	|				И СчетФактураПолученныйОтПродавца = &ИсправляемыйСчетФактура) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактураПолученныйОтПродавца
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Ссылка КАК Ссылка,
	|	Реквизиты.Дата КАК Дата,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.ДокументОснование КАК ДокументОснование,
	|	Реквизиты.ВалютаДокумента КАК ВалютаДокумента,
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.КППКонтрагента КАК КППКонтрагента,
	|	Реквизиты.Продавец КАК Продавец,
	|	Реквизиты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Реквизиты.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1, 1, 1)) КАК ДокументОснованиеДата,
	|	Реквизиты.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	Реквизиты.ДоговорКонтрагента.ВидАгентскогоДоговора КАК ВидАгентскогоДоговора,
	|	ЕСТЬNULL(Реквизиты.ДоговорКонтрагента.УчетАгентскогоНДС, ЛОЖЬ) КАК УчетАгентскогоНДС,
	|	ЕСТЬNULL(Реквизиты.ДоговорКонтрагента.РасчетыВУсловныхЕдиницах, ЛОЖЬ) КАК РасчетыВУсловныхЕдиницах,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2018, 1, 1)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ЕСТЬNULL(Реквизиты.ДоговорКонтрагента.УчетАгентскогоНДС, ЛОЖЬ) = ИСТИНА
	|				И ЕСТЬNULL(Реквизиты.ДоговорКонтрагента.ВидАгентскогоДоговора, ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.РеализацияТоваров)
	|	КОНЕЦ КАК НДСИсчисляетсяНалоговымАгентом,
	|	Реквизиты.ВидСчетаФактуры КАК ВидСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаВходящегоДокумента,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерВходящегоДокумента,
	|	Реквизиты.Исправление КАК Исправление,
	|	Реквизиты.НомерИсправления КАК НомерИсправления,
	|	Реквизиты.ДатаИсправления КАК ДатаИсправления,
	|	Реквизиты.СформированПриВводеНачальныхОстатковНДС КАК СформированПриВводеНачальныхОстатковНДС,
	|	Реквизиты.БланкСтрогойОтчетности КАК БланкСтрогойОтчетности,
	|	Реквизиты.НДСПредъявленКВычету КАК НДСПредъявленКВычету,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	Реквизиты.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение,
	|	Реквизиты.СуммаДокумента КАК СуммаДокумента,
	|	Реквизиты.СуммаНДСДокумента КАК СуммаНДСДокумента,
	|	Реквизиты.СуммаУвеличение КАК СуммаУвеличение,
	|	Реквизиты.СуммаУменьшение КАК СуммаУменьшение,
	|	Реквизиты.СуммаНДСУвеличение КАК СуммаНДСУвеличение,
	|	Реквизиты.СуммаНДСУменьшение КАК СуммаНДСУменьшение,
	|	Реквизиты.СуммаДокументаКомиссия КАК СуммаДокументаКомиссия,
	|	Реквизиты.СуммаНДСДокументаКомиссия КАК СуммаНДСДокументаКомиссия,
	|	Реквизиты.СуммаУвеличениеКомиссия КАК СуммаУвеличениеКомиссия,
	|	Реквизиты.СуммаУменьшениеКомиссия КАК СуммаУменьшениеКомиссия,
	|	Реквизиты.СуммаНДСУвеличениеКомиссия КАК СуммаНДСУвеличениеКомиссия,
	|	Реквизиты.СуммаНДСУменьшениеКомиссия КАК СуммаНДСУменьшениеКомиссия,
	|	Реквизиты.СчетФактураБезНДС КАК СчетФактураБезНДС,
	|	Реквизиты.Субкомиссионер КАК Субкомиссионер,
	|	Реквизиты.СчетФактураВыданныйПокупателю КАК СчетФактураВыданныйПокупателю,
	|	ВЫБОР
	|		КОГДА Реквизиты.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СКомитентом)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РеализацияТоваровКомитента,
	|	ВЫБОР
	|		КОГДА Реквизиты.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СКомитентом)
	|				И Реквизиты.Дата >= ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СводныйСчетФактураКомитентаПо1279,
	|	ВЫБОР
	|		КОГДА Реквизиты.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СКомиссионеромНаЗакупку)
	|				И Реквизиты.Дата >= ДАТАВРЕМЯ(2015, 1, 1)
	|				И Реквизиты.СводныйКомиссионный
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СводныйСчетФактураКомиссионераПо1279,
	|	ВЫБОР
	|		КОГДА Реквизиты.ДокументОснование ССЫЛКА Документ.АвансовыйОтчет
	|				И Реквизиты.Дата >= ДАТАВРЕМЯ(2014, 10, 1)
	|			ТОГДА ЕСТЬNULL(ДанныеПервичныхДокументов.Номер, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НомерДокументаОплаты,
	|	ВЫБОР
	|		КОГДА Реквизиты.ДокументОснование ССЫЛКА Документ.АвансовыйОтчет
	|				И Реквизиты.Дата >= ДАТАВРЕМЯ(2014, 10, 1)
	|			ТОГДА ЕСТЬNULL(ДанныеПервичныхДокументов.Дата, ДАТАВРЕМЯ(1, 1, 1))
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ КАК ДатаДокументаОплаты,
	|	Реквизиты.ИсправлениеСобственнойОшибки КАК ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура КАК ИсправляемыйСчетФактура,
	|	ЕСТЬNULL(ДанныеПервичныхДокументовИсправляемыйСчетФактура.ДатаРегистратора, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаИсправляемогоСчетаФактуры,
	|	Реквизиты.ИННКонтрагента КАК ИННКонтрагента,
	|	Реквизиты.СуммаДокументаКомиссия > 0
	|		ИЛИ Реквизиты.СуммаУвеличениеКомиссия > 0
	|		ИЛИ Реквизиты.СуммаУменьшениеКомиссия > 0
	|		ИЛИ &ЕстьКомиссия4кв2014 КАК ЕстьКомиссия,
	|	ЕСТЬNULL(ДвиженияВыданногоСФПоИсправляемому.ЕстьДвиженияВыданногоПоПолученному, ЛОЖЬ) КАК ПовторноеИсправлениеСобственнойОшибки,
	|	Реквизиты.СводныйКорректировочный КАК СводныйКорректировочный
	|ПОМЕСТИТЬ Реквизиты
	|ИЗ
	|	Документ.СчетФактураПолученный КАК Реквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО Реквизиты.Организация = ДанныеПервичныхДокументов.Организация
	|			И Реквизиты.ДокументОснование = ДанныеПервичныхДокументов.Документ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументовИсправляемыйСчетФактура
	|		ПО Реквизиты.Организация = ДанныеПервичныхДокументовИсправляемыйСчетФактура.Организация
	|			И Реквизиты.ИсправляемыйСчетФактура = ДанныеПервичныхДокументовИсправляемыйСчетФактура.Документ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияВыданногоСФПоИсправляемому КАК ДвиженияВыданногоСФПоИсправляемому
	|		ПО Реквизиты.ИсправляемыйСчетФактура = ДвиженияВыданногоСФПоИсправляемому.СчетФактураПолученныйОтПродавца
	|ГДЕ
	|	Реквизиты.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.ВидСчетаФактуры КАК ВидСчетаФактуры,
	|	Реквизиты.СформированПриВводеНачальныхОстатковНДС КАК СформированПриВводеНачальныхОстатковНДС,
	|	Реквизиты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Реквизиты.НДСИсчисляетсяНалоговымАгентом КАК НДСИсчисляетсяНалоговымАгентом,
	|	Реквизиты.ДокументОснование КАК ДокументОснование,
	|	Реквизиты.Исправление КАК Исправление,
	|	Реквизиты.БланкСтрогойОтчетности КАК БланкСтрогойОтчетности,
	|	Реквизиты.НДСПредъявленКВычету КАК НДСПредъявленКВычету,
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.СводныйСчетФактураКомитентаПо1279 КАК СводныйСчетФактураКомитентаПо1279,
	|	Реквизиты.СводныйСчетФактураКомиссионераПо1279 КАК СводныйСчетФактураКомиссионераПо1279,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	Реквизиты.НомерДокументаОплаты КАК НомерДокументаОплаты,
	|	Реквизиты.ДатаДокументаОплаты КАК ДатаДокументаОплаты,
	|	Реквизиты.ИсправлениеСобственнойОшибки КАК ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура КАК ИсправляемыйСчетФактура,
	|	Реквизиты.ДатаИсправляемогоСчетаФактуры КАК ДатаИсправляемогоСчетаФактуры,
	|	Реквизиты.ЕстьКомиссия КАК ЕстьКомиссия,
	|	Реквизиты.ПовторноеИсправлениеСобственнойОшибки КАК ПовторноеИсправлениеСобственнойОшибки,
	|	Реквизиты.ВидДоговора КАК ВидДоговора,
	|	Реквизиты.СуммаНДСДокумента КАК СуммаНДСДокумента,
	|	Реквизиты.СводныйКорректировочный КАК СводныйКорректировочный
	|ИЗ
	|	Реквизиты КАК Реквизиты";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаНДСПоАвансамВыданным(НомераТаблиц, ПараметрыПроведения, Реквизиты)

	
	Если Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.НаАванс
		И Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
		ПараметрыПроведения.Вставить("ТаблицаАвансов", Неопределено);
		ПараметрыПроведения.Вставить("ТаблицаКорректировочныйНаАванс", Неопределено);
		Возврат "";
	КонецЕсли;
	
	НомераТаблиц.Вставить("ТаблицаАвансов", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ТаблицаКорректировочныйНаАванс", НомераТаблиц.Количество());
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Реквизиты.НДСИсчисляетсяНалоговымАгентом КАК НДСИсчисляетсяНалоговымАгентом,
	|	""Вычет НДС с выданного аванса"" КАК Содержание,
	|	Реквизиты.ДокументОснование КАК СчетФактура,
	|	ТаблицаАвансы.СтавкаНДС КАК СтавкаНДС,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным) КАК СчетУчетаНДС,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗаписьДополнительногоЛиста,
	|	ЛОЖЬ КАК СторнирующаяЗаписьДопЛиста,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ КАК КорректируемыйПериод,
	|	Реквизиты.Дата КАК ДатаСобытия,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ИсправленныйСчетФактура,
	|	СУММА(ТаблицаАвансы.СуммаНДС) КАК НДС,
	|	СУММА(ТаблицаАвансы.Сумма - ТаблицаАвансы.СуммаНДС) КАК СуммаБезНДС,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаОплаты,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.Номер, НЕОПРЕДЕЛЕНО) КАК НомерДокументаОплаты,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ КАК КодВидаОперации
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТаблицаАвансы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО (ДанныеПервичныхДокументов.Документ = Реквизиты.ДокументОснование)
	|ГДЕ
	|	ТаблицаАвансы.Ссылка = &Ссылка
	|	И НЕ Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|
	|СГРУППИРОВАТЬ ПО
	|	Реквизиты.Контрагент,
	|	Реквизиты.ДоговорКонтрагента,
	|	Реквизиты.НДСИсчисляетсяНалоговымАгентом,
	|	Реквизиты.ДокументОснование,
	|	ТаблицаАвансы.СтавкаНДС,
	|	Реквизиты.Дата,
	|	ДанныеПервичныхДокументов.Дата,
	|	ДанныеПервичныхДокументов.Номер,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Реквизиты.Контрагент,
	|	Реквизиты.ДоговорКонтрагента,
	|	ЛОЖЬ,
	|	""Вычет НДС с выданного аванса"",
	|	Реквизиты.ДокументОснование,
	|	ТаблицаАвансы.СтавкаНДС,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным),
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ,
	|	Реквизиты.Дата,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	СУММА(ТаблицаАвансы.СуммаНДС),
	|	СУММА(ТаблицаАвансы.Сумма - ТаблицаАвансы.СуммаНДС),
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТаблицаАвансы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|ГДЕ
	|	ТаблицаАвансы.Ссылка = &Ссылка
	|	И Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|
	|СГРУППИРОВАТЬ ПО
	|	Реквизиты.Контрагент,
	|	Реквизиты.ДоговорКонтрагента,
	|	Реквизиты.ДокументОснование,
	|	ТаблицаАвансы.СтавкаНДС,
	|	Реквизиты.Дата,
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Реквизиты.Контрагент,
	|	Реквизиты.ДоговорКонтрагента,
	|	ЛОЖЬ,
	|	""Вычет НДС с выданного аванса"",
	|	Реквизиты.ДокументОснование,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным),
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА Реквизиты.ИсправлениеСобственнойОшибки
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ,
	|	Реквизиты.Дата,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	0,
	|	ПлатежноРасчетныеДокументы.ДатаДокумента,
	|	ПлатежноРасчетныеДокументы.НомерДокумента,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТаблицаАвансы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ПлатежноРасчетныеДокументы КАК ПлатежноРасчетныеДокументы
	|		ПО (ПлатежноРасчетныеДокументы.Ссылка = ТаблицаАвансы.Ссылка)
	|ГДЕ
	|	ТаблицаАвансы.Ссылка = &Ссылка
	|	И Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Реквизиты.НДСИсчисляетсяНалоговымАгентом КАК НДСИсчисляетсяНалоговымАгентом,
	|	""Вычет НДС с выданного аванса"" КАК Содержание,
	|	Реквизиты.ДокументОснование КАК СчетФактура,
	|	ТаблицаАвансы.СтавкаНДС КАК СтавкаНДС,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным) КАК СчетУчетаНДС,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗаписьДополнительногоЛиста,
	|	ЛОЖЬ КАК СторнирующаяЗаписьДопЛиста,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ КАК КорректируемыйПериод,
	|	Реквизиты.Дата КАК ДатаСобытия,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ИсправленныйСчетФактура,
	|	СУММА(ТаблицаАвансы.СуммаНДС - ТаблицаАвансы.СуммаНДСДоКорректировки) КАК НДС,
	|	СУММА(ТаблицаАвансы.Сумма - ТаблицаАвансы.СуммаНДС - (ТаблицаАвансы.СуммаДоКорректировки - ТаблицаАвансы.СуммаНДСДоКорректировки)) КАК СуммаБезНДС,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаОплаты,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.Номер, НЕОПРЕДЕЛЕНО) КАК НомерДокументаОплаты,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ КАК КодВидаОперации
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТаблицаАвансы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО (ДанныеПервичныхДокументов.Документ = Реквизиты.ДокументОснование)
	|ГДЕ
	|	ТаблицаАвансы.Ссылка = &Ссылка
	|	И НЕ Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|
	|СГРУППИРОВАТЬ ПО
	|	Реквизиты.Контрагент,
	|	Реквизиты.ДоговорКонтрагента,
	|	Реквизиты.НДСИсчисляетсяНалоговымАгентом,
	|	Реквизиты.ДокументОснование,
	|	ТаблицаАвансы.СтавкаНДС,
	|	Реквизиты.Дата,
	|	ДанныеПервичныхДокументов.Дата,
	|	ДанныеПервичныхДокументов.Номер,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (Реквизиты.ИсправлениеСобственнойОшибки
	|				ИЛИ &РегистрироватьИсправлениеВДопЛисте)
	|				И КОНЕЦПЕРИОДА(Реквизиты.Дата, КВАРТАЛ) > КОНЕЦПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|			ТОГДА НАЧАЛОПЕРИОДА(&ДатаИсходногоСчетаФактуры, КВАРТАЛ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|				ИЛИ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Дата < ДАТАВРЕМЯ(2015, 1, 1)
	|			ТОГДА """"
	|		ИНАЧЕ Реквизиты.КодВидаОперации
	|	КОНЕЦ";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();

КонецФункции

Функция ТекстЗапросаЖурналУчетаСчетовФактур(НомераТаблиц, ПараметрыПроведения, Реквизиты)
	
	Если (НЕ Реквизиты.ПлательщикНДС И НЕ Реквизиты.ВедетсяУчетНДСПоФЗ134)
		ИЛИ Реквизиты.ВерсияНДС = 1
		ИЛИ Реквизиты.БланкСтрогойОтчетности 
		ИЛИ Реквизиты.ИностранныйСчетФактура Тогда
		ПараметрыПроведения.Вставить("ЗаписьЖурналаПоступлениеАванс",             Неопределено);
		ПараметрыПроведения.Вставить("ЗаписьЖурналаКорректировка",                Неопределено);
		ПараметрыПроведения.Вставить("ЗаписьЖурналаИсправлениеСобственнойОшибки", Неопределено);
		ПараметрыПроведения.Вставить("СторнирующаяЗаписьЖурнала",                 Неопределено);
		Возврат "";
	КонецЕсли;
	
	ТекстЗапроса = "";
	
	Если НЕ Реквизиты.ИспользуетсяПостановление1137 Тогда
		
		ПараметрыПроведения.Вставить("ЗаписьЖурналаПоступлениеАванс", Неопределено);
		ПараметрыПроведения.Вставить("ЗаписьЖурналаКорректировка",    Неопределено);
		
	ИначеЕсли Реквизиты.СводныйСчетФактураКомитентаПо1279 Тогда
		
		Если Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
			
			ПараметрыПроведения.Вставить("ЗаписьЖурналаКорректировка", Неопределено);
			
			НомераТаблиц.Вставить("ВременнаяТаблицаСчетаФактурыВыданныеПокупателям", НомераТаблиц.Количество());
			НомераТаблиц.Вставить("ЗаписьЖурналаПоступлениеАванс", НомераТаблиц.Количество());
			
			ТекстЗапроса = ТекстЗапросаДляЖурналаСводныйСчетФактураКомитента();
			
		Иначе
			
			ПараметрыПроведения.Вставить("ЗаписьЖурналаПоступлениеАванс", Неопределено);
			
			НомераТаблиц.Вставить("ВременнаяТаблицаСчетаФактурыВыданныеПокупателям", НомераТаблиц.Количество());
			НомераТаблиц.Вставить("ЗаписьЖурналаКорректировка", НомераТаблиц.Количество());
			
			ТекстЗапроса = ТекстЗапросаДляЖурналаСводныйСчетФактураКомитентаКорректировочный();
			
		КонецЕсли;
	
	ИначеЕсли Реквизиты.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
		
		ПараметрыПроведения.Вставить("ЗаписьЖурналаПоступлениеАванс", Неопределено);
		
		НомераТаблиц.Вставить("ВТ_ЗаписьЖурналаУчетаСчетовФактур",    НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ЗаписьЖурналаКорректировка",           НомераТаблиц.Количество());
		
		ТекстЗапроса = ТекстЗапросаДляЖурналаКорректировочныйНаАванс();

	ИначеЕсли Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
		
		ПараметрыПроведения.Вставить("ЗаписьЖурналаКорректировка", Неопределено);
		
		НомераТаблиц.Вставить("ВременнаяТаблицаПродавцы",           НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВременнаяТаблицаДокументыОснования", НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_РублевыеСуммыДокументовВВалюте",  НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ЗаписьЖурналаПоступлениеАванс",      НомераТаблиц.Количество());
		
		ТекстЗапроса = ТекстЗапросаДляЖурнала();
		
	Иначе
		
		ПараметрыПроведения.Вставить("ЗаписьЖурналаПоступлениеАванс", Неопределено);
		
		НомераТаблиц.Вставить("ВременнаяТаблицаПродавцы",                         НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДокументыОснования",                            НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_РублевыеСуммыДокументовВВалютеПредварительная", НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_РублевыеСуммыДокументовВВалюте",                НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ЗаписьЖурналаКорректировка",                       НомераТаблиц.Количество());
		
		ТекстЗапроса = ТекстЗапросаДляЖурналаКорректировочный();
		
	КонецЕсли;
	
	Если Реквизиты.ИсправлениеСобственнойОшибки
		И Реквизиты.ЕстьКомиссия Тогда 
		
		НомераТаблиц.Вставить("ВТ_СчетаФактурыВыданныеПоТекущемуСФ",                 НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_СчетаФактурыВыданныеПоИсправляемомуСФ",            НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_СчетаФактурыВыданные",                             НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДвиженияНоваяЗаписьПовторноеИсправление",          НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДвиженияНоваяЗаписьПервичноеИсправление",          НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДвиженияНоваяЗаписьВыставленныеСФПредварительная", НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ПоследнийРегистраторПоСчетуФактуреВыданному",      НомераТаблиц.Количество());
		
		НомераТаблиц.Вставить("ВТ_ДвиженияСторно",                                      НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДвиженияНоваяЗаписьВыставленныеСФ",                   НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_СуммыПоСчетамФактурамПолученным",                     НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным", НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ЗаписьЖурналаИсправлениеСобственнойОшибки",              НомераТаблиц.Количество());
		ТекстЗапроса = ТекстЗапроса + ТекстЗапросаИсправлениеСобственнойОшибки();
		
	Иначе
		ПараметрыПроведения.Вставить("ЗаписьЖурналаИсправлениеСобственнойОшибки", Неопределено);
	КонецЕсли;
	
	Если Реквизиты.РегистрироватьСФДатойСоставления
		И Реквизиты.Исправление Тогда 
		НомераТаблиц.Вставить("СторнирующаяЗаписьЖурнала", НомераТаблиц.Количество());
		ТекстЗапроса = ТекстЗапроса + ТекстЗапросаСторнирующаяЗаписьЖурналаСФ();
	Иначе
		ПараметрыПроведения.Вставить("СторнирующаяЗаписьЖурнала", Неопределено);
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаДляЖурналаСводныйСчетФактураКомитента()
	
	Возврат "ВЫБРАТЬ
	|	СУММА(СчетаФактурыВыданныеПокупателям.Сумма) КАК Сумма,
	|	СУММА(СчетаФактурыВыданныеПокупателям.НДС) КАК НДС,
	|	МИНИМУМ(СчетаФактурыВыданныеПокупателям.НомерСтроки) КАК НомерСтроки,
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура,
	|	СчетФактураВыданный.СчетФактураБезНДС
	|ПОМЕСТИТЬ СчетаФактурыВыданныеПокупателям
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетаФактурыВыданныеПокупателям
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ПО СчетаФактурыВыданныеПокупателям.СчетФактура = СчетФактураВыданный.Ссылка
	|ГДЕ
	|	СчетаФактурыВыданныеПокупателям.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура,
	|	СчетФактураВыданный.СчетФактураБезНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация,
	|	Реквизиты.Контрагент,
	|	Реквизиты.КППКонтрагента,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец = Реквизиты.Контрагент
	|				ИЛИ Реквизиты.Продавец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Реквизиты.Продавец
	|	КОНЕЦ КАК Продавец,
	|	Реквизиты.Ссылка КАК СчетФактура,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры) КАК ЧастьЖурнала,
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ КАК ДатаВыставленияПолучения,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаВыставленияПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК НомерКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаКорректировочногоСчетаФактуры,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.НомерИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НомерИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.ДатаИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА &ВалютаРеглУчета
	|		ИНАЧЕ Реквизиты.ВалютаДокумента
	|	КОНЕЦ КАК Валюта,
	|	СчетаФактурыВыданныеПокупателям.Сумма КАК СуммаПоСчетуФактуре,
	|	СчетаФактурыВыданныеПокупателям.Сумма КАК СуммаПоСчетуФактуреКомиссия,
	|	СчетаФактурыВыданныеПокупателям.НДС КАК СуммаНДС,
	|	СчетаФактурыВыданныеПокупателям.НДС КАК СуммаНДСКомиссия,
	|	0 КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	0 КАК СуммаНДСРазницаУвеличение,
	|	0 КАК СуммаНДСРазницаУменьшение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	0 КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	0 КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СчетФактураБезНДС КАК ПоСтавкеБезНДС,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураНеВыставляется,
	|	Реквизиты.РасчетыВУсловныхЕдиницах,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	0 КАК ИндексСтроки,
	|	НЕОПРЕДЕЛЕНО КАК ДокументОснование,
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер КАК Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура КАК СчетФактураВыданныйПокупателю,
	|	2 КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК Посредник,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаОперацииКомиссия,
	|	Реквизиты.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение,
	|	Реквизиты.ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК СчетФактураПолученныйОтПродавца,
	|	ЗНАЧЕНИЕ(Документ.счетФактураПолученный.ПустаяСсылка) КАК ИсправленныйСчетФактура,
	|	"""" КАК ИННПродавца,
	|	"""" КАК КПППродавца,
	|	"""" КАК ИННСубкомиссионера,
	|	"""" КАК КППСубкомиссионера
	|ИЗ
	|	Реквизиты КАК Реквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ СчетаФактурыВыданныеПокупателям КАК СчетаФактурыВыданныеПокупателям
	|		ПО (ИСТИНА)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИндексСтроки"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаДляЖурналаСводныйСчетФактураКомитентаКорректировочный()
	
	Возврат "ВЫБРАТЬ
	|	СУММА(СчетаФактурыВыданныеПокупателям.Сумма) КАК Сумма,
	|	СУММА(СчетаФактурыВыданныеПокупателям.НДС) КАК НДС,
	|	МИНИМУМ(СчетаФактурыВыданныеПокупателям.НомерСтроки) КАК НомерСтроки,
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура,
	|	СУММА(СчетаФактурыВыданныеПокупателям.СуммаУвеличение) КАК СуммаУвеличение,
	|	СУММА(СчетаФактурыВыданныеПокупателям.СуммаУменьшение) КАК СуммаУменьшение,
	|	СУММА(СчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение) КАК СуммаНДСУвеличение,
	|	СУММА(СчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение) КАК СуммаНДСУменьшение,
	|	СчетаФактурыВыданныеПокупателям.Ссылка.НомерИсходногоДокумента,
	|	СчетаФактурыВыданныеПокупателям.Ссылка.ДатаИсходногоДокумента,
	|	СчетФактураВыданный.СчетФактураБезНДС
	|ПОМЕСТИТЬ СчетаФактурыВыданныеПокупателям
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетаФактурыВыданныеПокупателям
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ПО СчетаФактурыВыданныеПокупателям.СчетФактура = СчетФактураВыданный.Ссылка
	|ГДЕ
	|	СчетаФактурыВыданныеПокупателям.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура,
	|	СчетаФактурыВыданныеПокупателям.Ссылка.НомерИсходногоДокумента,
	|	СчетаФактурыВыданныеПокупателям.Ссылка.ДатаИсходногоДокумента,
	|	СчетФактураВыданный.СчетФактураБезНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация,
	|	Реквизиты.Контрагент,
	|	Реквизиты.КППКонтрагента,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец = Реквизиты.Контрагент
	|				ИЛИ Реквизиты.Продавец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Реквизиты.Продавец
	|	КОНЕЦ КАК Продавец,
	|	Реквизиты.Ссылка КАК СчетФактура,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры) КАК ЧастьЖурнала,
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ КАК ДатаВыставленияПолучения,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаВыставленияПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	СчетаФактурыВыданныеПокупателям.НомерИсходногоДокумента КАК НомерСчетаФактуры,
	|	СчетаФактурыВыданныеПокупателям.ДатаИсходногоДокумента КАК ДатаСчетаФактуры,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерКорректировочногоСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаКорректировочногоСчетаФактуры,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.НомерИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НомерИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.ДатаИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА &ВалютаРеглУчета
	|		ИНАЧЕ Реквизиты.ВалютаДокумента
	|	КОНЕЦ КАК Валюта,
	|	0 КАК СуммаПоСчетуФактуре,
	|	0 КАК СуммаПоСчетуФактуреКомиссия,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаНДСКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СуммаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	СчетаФактурыВыданныеПокупателям.СуммаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	СчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение КАК СуммаНДСРазницаУвеличение,
	|	СчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение КАК СуммаНДСРазницаУменьшение,
	|	СчетаФактурыВыданныеПокупателям.СуммаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СуммаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	СчетаФактурыВыданныеПокупателям.СчетФактураБезНДС КАК ПоСтавкеБезНДС,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураНеВыставляется,
	|	Реквизиты.РасчетыВУсловныхЕдиницах,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	0 КАК ИндексСтроки,
	|	НЕОПРЕДЕЛЕНО КАК ДокументОснование,
	|	СчетаФактурыВыданныеПокупателям.Субкомиссионер КАК Субкомиссионер,
	|	СчетаФактурыВыданныеПокупателям.СчетФактура КАК СчетФактураВыданныйПокупателю,
	|	2 КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК Посредник,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаОперацииКомиссия,
	|	Реквизиты.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение,
	|	Реквизиты.ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК СчетФактураПолученныйОтПродавца,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправленныйСчетФактура,
	|	"""" КАК ИННПродавца,
	|	"""" КАК КПППродавца,
	|	"""" КАК ИННСубкомиссионера,
	|	"""" КАК КППСубкомиссионера
	|ИЗ
	|	Реквизиты КАК Реквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ СчетаФактурыВыданныеПокупателям КАК СчетаФактурыВыданныеПокупателям
	|		ПО (ИСТИНА)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИндексСтроки"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
			
КонецФункции

Функция ТекстЗапросаДляЖурналаКорректировочный()
	
	Возврат 
	"ВЫБРАТЬ
	|	СчетФактураПолученныйПродавцы.Продавец КАК Продавец,
	|	МИНИМУМ(СчетФактураПолученныйПродавцы.НомерСтроки) КАК НомерСтроки,
	|	СчетФактураПолученныйПродавцы.ИННПродавца КАК ИННПродавца,
	|	СчетФактураПолученныйПродавцы.КПППродавца КАК КПППродавца
	|ПОМЕСТИТЬ ВременнаяТаблицаПродавцы
	|ИЗ
	|	Документ.СчетФактураПолученный.Продавцы КАК СчетФактураПолученныйПродавцы
	|ГДЕ
	|	СчетФактураПолученныйПродавцы.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	СчетФактураПолученныйПродавцы.Продавец,
	|	СчетФактураПолученныйПродавцы.ИННПродавца,
	|	СчетФактураПолученныйПродавцы.КПППродавца
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование,
	|	СчетФактураПолученныйДокументыОснования.НомерИсходногоДокумента КАК НомерИсходногоДокумента,
	|	СчетФактураПолученныйДокументыОснования.ДатаИсходногоДокумента КАК ДатаИсходногоДокумента,
	|	СчетФактураПолученныйДокументыОснования.УчитыватьИсправлениеИсходногоДокумента КАК УчитыватьИсправлениеИсходногоДокумента,
	|	СчетФактураПолученныйДокументыОснования.НомерИсправленияИсходногоДокумента КАК НомерИсправленияИсходногоДокумента,
	|	СчетФактураПолученныйДокументыОснования.ДатаИсправленияИсходногоДокумента КАК ДатаИсправленияИсходногоДокумента,
	|	СчетФактураПолученныйДокументыОснования.СуммаУвеличение КАК СуммаУвеличение,
	|	СчетФактураПолученныйДокументыОснования.СуммаУменьшение КАК СуммаУменьшение,
	|	СчетФактураПолученныйДокументыОснования.СуммаНДСУвеличение КАК СуммаНДСУвеличение,
	|	СчетФактураПолученныйДокументыОснования.СуммаНДСУменьшение КАК СуммаНДСУменьшение,
	|	СчетФактураПолученныйДокументыОснования.НомерСтроки КАК НомерСтроки
	|ПОМЕСТИТЬ ВременнаяТаблицаДокументыОснования
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ПО СчетФактураПолученныйДокументыОснования.Ссылка = СчетФактураПолученный.Ссылка
	|ГДЕ
	|	СчетФактураПолученныйДокументыОснования.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор КАК Регистратор,
	|	РегистрСведенийРублевыеСуммыДокументовВВалюте.НомерСтрокиДокумента КАК НомерСтрокиДокумента,
	|	СУММА(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего) КАК РазницаВсегоРуб,
	|	СУММА(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС) КАК РазницаНДСРуб
	|ПОМЕСТИТЬ РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная
	|ИЗ
	|	РегистрСведений.РублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаДокументыОснования КАК ВременнаяТаблицаДокументыОснования
	|		ПО РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор = ВременнаяТаблицаДокументыОснования.ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор,
	|	РегистрСведенийРублевыеСуммыДокументовВВалюте.НомерСтрокиДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.Регистратор КАК Регистратор,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаВсегоРуб < 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаВсегоРуб * -1
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК СуммаУменьшения,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаВсегоРуб > 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаВсегоРуб
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК СуммаУвеличения,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаНДСРуб < 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаНДСРуб * -1
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК СуммаНДСУменьшения,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаНДСРуб > 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.РазницаНДСРуб
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК СуммаНДСУвеличения
	|ПОМЕСТИТЬ РегистрСведенийРублевыеСуммыДокументовВВалюте
	|ИЗ
	|	РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная КАК РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная
	|
	|СГРУППИРОВАТЬ ПО
	|	РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.Регистратор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистрСведенийРублевыеСуммыДокументовВВалютеПредварительная.Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.КППКонтрагента КАК КППКонтрагента,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец = Реквизиты.Контрагент
	|				ИЛИ Реквизиты.Продавец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Реквизиты.Продавец
	|	КОНЕЦ КАК Продавец,
	|	Реквизиты.Ссылка КАК СчетФактура,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры) КАК ЧастьЖурнала,
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ КАК ДатаВыставленияПолучения,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаВыставленияПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	Основания.ДокументОснование КАК ДокументОснование,
	|	Основания.НомерИсходногоДокумента КАК НомерСчетаФактуры,
	|	Основания.ДатаИсходногоДокумента КАК ДатаСчетаФактуры,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерКорректировочногоСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаКорректировочногоСчетаФактуры,
	|	Основания.УчитыватьИсправлениеИсходногоДокумента КАК Исправление,
	|	ВЫБОР
	|		КОГДА Основания.НомерИсправленияИсходногоДокумента <> 0
	|			ТОГДА Основания.НомерИсправленияИсходногоДокумента
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НомерИсправления,
	|	Основания.ДатаИсправленияИсходногоДокумента КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА &ВалютаРеглУчета
	|		ИНАЧЕ Реквизиты.ВалютаДокумента
	|	КОНЕЦ КАК Валюта,
	|	0 КАК СуммаПоСчетуФактуре,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаПоСчетуФактуреКомиссия,
	|	0 КАК СуммаНДСКомиссия,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|				ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|					И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА Основания.СуммаУвеличение
	|		ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУвеличения, 0)
	|	КОНЕЦ КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|				ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|					И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА Основания.СуммаУменьшение
	|		ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУменьшения, 0)
	|	КОНЕЦ КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|				ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|					И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА Основания.СуммаНДСУвеличение
	|		ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУвеличения, 0)
	|	КОНЕЦ КАК СуммаНДСРазницаУвеличение,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|				ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|					И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА Основания.СуммаНДСУменьшение
	|		ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУменьшения, 0)
	|	КОНЕЦ КАК СуммаНДСРазницаУменьшение,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаУвеличениеКомиссия = 0
	|				ИЛИ Основания.СуммаУвеличение = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА ВЫРАЗИТЬ(Основания.СуммаУвеличение / Реквизиты.СуммаУвеличение * Реквизиты.СуммаУвеличениеКомиссия КАК ЧИСЛО(15, 2))
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУвеличения, 0) = 0
	|							ТОГДА Реквизиты.СуммаУвеличениеКомиссия
	|						ИНАЧЕ ВЫРАЗИТЬ(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУвеличения / Основания.СуммаУвеличение * Реквизиты.СуммаУвеличениеКомиссия КАК ЧИСЛО(15, 2))
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаНДСУвеличениеКомиссия = 0
	|				ИЛИ Основания.СуммаНДСУвеличение = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА ВЫРАЗИТЬ(Основания.СуммаУвеличение / Реквизиты.СуммаУвеличение * Реквизиты.СуммаНДСУвеличениеКомиссия КАК ЧИСЛО(15, 2))
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУвеличения, 0) = 0
	|							ТОГДА Реквизиты.СуммаНДСУвеличениеКомиссия
	|						ИНАЧЕ ВЫРАЗИТЬ(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУвеличения / Основания.СуммаНДСУвеличение * Реквизиты.СуммаНДСУвеличениеКомиссия КАК ЧИСЛО(15, 2))
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаНДСУменьшениеКомиссия = 0
	|				ИЛИ Основания.СуммаНДСУменьшение = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА ВЫРАЗИТЬ(Основания.СуммаУменьшение / Реквизиты.СуммаУменьшение * Реквизиты.СуммаНДСУменьшениеКомиссия КАК ЧИСЛО(15, 2))
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУменьшения, 0) = 0
	|							ТОГДА Реквизиты.СуммаНДСУменьшениеКомиссия
	|						ИНАЧЕ ВЫРАЗИТЬ(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаНДСУменьшения / Основания.СуммаНДСУменьшение * Реквизиты.СуммаНДСУменьшениеКомиссия КАК ЧИСЛО(15, 2))
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаУменьшениеКомиссия = 0
	|				ИЛИ Основания.СуммаУменьшение = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА ВЫРАЗИТЬ(Основания.СуммаУменьшение / Реквизиты.СуммаУменьшение * Реквизиты.СуммаУменьшениеКомиссия КАК ЧИСЛО(15, 2))
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУменьшения, 0) = 0
	|							ТОГДА Реквизиты.СуммаУменьшениеКомиссия
	|						ИНАЧЕ ВЫРАЗИТЬ(РегистрСведенийРублевыеСуммыДокументовВВалюте.СуммаУменьшения / Основания.СуммаУменьшение * Реквизиты.СуммаУменьшениеКомиссия КАК ЧИСЛО(15, 2))
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	Реквизиты.СчетФактураБезНДС КАК ПоСтавкеБезНДС,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураНеВыставляется,
	|	Реквизиты.РасчетыВУсловныхЕдиницах КАК РасчетыВУсловныхЕдиницах,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.НомерИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.ДатаИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ИсходныйСчетФактура,
	|	Основания.НомерСтроки - 1 КАК ИндексСтроки,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|			ТОГДА Реквизиты.Субкомиссионер
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.Контрагент
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Субкомиссионер,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|			ТОГДА Реквизиты.СчетФактураВыданныйПокупателю
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СчетФактураВыданныйПокупателю,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|			ТОГДА 2
	|		КОГДА Реквизиты.ЕстьКомиссия
	|			ТОГДА 1
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК Посредник,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаОперацииКомиссия,
	|	Реквизиты.ИсправлениеСобственнойОшибки КАК ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура КАК ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента КАК ИННКонтрагента,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК СчетФактураПолученныйОтПродавца,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправленныйсчетФактура,
	|	ЕСТЬNULL(ВременнаяТаблицаПродавцы.ИННПродавца, """") КАК ИННПродавца,
	|	ЕСТЬNULL(ВременнаяТаблицаПродавцы.КПППродавца, """") КАК КПППродавца,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.ИННКонтрагента
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК ИННСубкомиссионера,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.КППКонтрагента
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КППСубкомиссионера,
	|	Реквизиты.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение
	|ИЗ
	|	ВременнаяТаблицаДокументыОснования КАК Основания
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведенийРублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
	|		ПО Основания.ДокументОснование = РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПродавцы КАК ВременнаяТаблицаПродавцы
	|		ПО (НЕ Реквизиты.СводныйСчетФактураКомиссионераПо1279)
	|			И (Реквизиты.Дата >= ДАТАВРЕМЯ(2015, 1, 1))"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаДляЖурналаКорректировочныйНаАванс()

	Возврат
	"ВЫБРАТЬ
	|	ТекущийСчетФактура.Ссылка КАК ДокументСсылка,
	|	ТекущийСчетФактура.НомерСтроки КАК ИндексСтроки,
	|	ТекущийСчетФактура.СуммаНДС - ТекущийСчетФактура.СуммаНДСДоКорректировки КАК СуммаНДСРазницаУвеличение,
	|	ТекущийСчетФактура.Сумма - ТекущийСчетФактура.СуммаДоКорректировки КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	ИсходныйСчетФактураРеквизиты.НомерСчетаФактуры КАК НомерСчетаФактуры,
	|	ИсходныйСчетФактураРеквизиты.ДатаСчетаФактуры КАК ДатаСчетаФактуры
	|ПОМЕСТИТЬ ВТ_ЗаписьЖурналаУчетаСчетовФактур
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТекущийСчетФактура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналУчетаСчетовФактур КАК ИсходныйСчетФактураРеквизиты
	|		ПО ТекущийСчетФактура.КорректируемыйСчетФактура = ИсходныйСчетФактураРеквизиты.СчетФактура
	|ГДЕ
	|	ТекущийСчетФактура.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументСсылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.Контрагент КАК Контрагент,
	|	Реквизиты.КППКонтрагента КАК КППКонтрагента,
	|	Реквизиты.Продавец КАК Продавец,
	|	Реквизиты.Ссылка КАК СчетФактура,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры) КАК ЧастьЖурнала,
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ КАК ДатаВыставленияПолучения,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаВыставленияПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	ВТ_ЗаписьЖурналаУчетаСчетовФактур.НомерСчетаФактуры КАК НомерСчетаФактуры,
	|	ВТ_ЗаписьЖурналаУчетаСчетовФактур.ДатаСчетаФактуры КАК ДатаСчетаФактуры,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерКорректировочногоСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправления,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправления,
	|	Реквизиты.ВалютаДокумента КАК Валюта,
	|	0 КАК СуммаПоСчетуФактуре,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаНДСКомиссия,
	|	0 КАК СуммаПоСчетуФактуреКомиссия,
	|	ВТ_ЗаписьЖурналаУчетаСчетовФактур.СуммаПоСчетуФактуреРазницаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	ВТ_ЗаписьЖурналаУчетаСчетовФактур.СуммаНДСРазницаУвеличение КАК СуммаНДСРазницаУвеличение,
	|	0 КАК СуммаНДСРазницаУменьшение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	0 КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	0 КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	Реквизиты.СчетФактураБезНДС КАК ПоСтавкеБезНДС,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураНеВыставляется,
	|	Реквизиты.РасчетыВУсловныхЕдиницах КАК РасчетыВУсловныхЕдиницах,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ВТ_ЗаписьЖурналаУчетаСчетовФактур.ИндексСтроки КАК ИндексСтроки,
	|	НЕОПРЕДЕЛЕНО КАК ДокументОснование,
	|	НЕОПРЕДЕЛЕНО КАК Субкомиссионер,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураВыданныйПокупателю,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК Посредник,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаОперацииКомиссия,
	|	Реквизиты.ИсправлениеСобственнойОшибки КАК ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура КАК ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента КАК ИННКонтрагента,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК СчетФактураПолученныйОтПродавца,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправленныйСчетФактура,
	|	"""" КАК ИННПродавца,
	|	"""" КАК КПППродавца,
	|	"""" КАК ИННСубкомиссионера,
	|	"""" КАК КППСубкомиссионера,
	|	Реквизиты.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение
	|ИЗ
	|	Реквизиты КАК Реквизиты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЗаписьЖурналаУчетаСчетовФактур КАК ВТ_ЗаписьЖурналаУчетаСчетовФактур
	|		ПО Реквизиты.Ссылка = ВТ_ЗаписьЖурналаУчетаСчетовФактур.ДокументСсылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИндексСтроки"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();


КонецФункции

Функция ТекстЗапросаДляЖурнала()
	
	Возврат
	"ВЫБРАТЬ
	|	СчетФактураПолученныйПродавцы.Продавец,
	|	МИНИМУМ(СчетФактураПолученныйПродавцы.НомерСтроки) КАК НомерСтроки,
	|	СчетФактураПолученныйПродавцы.ИННПродавца,
	|	СчетФактураПолученныйПродавцы.КПППродавца
	|ПОМЕСТИТЬ ВременнаяТаблицаПродавцы
	|ИЗ
	|	Документ.СчетФактураПолученный.Продавцы КАК СчетФактураПолученныйПродавцы
	|ГДЕ
	|	СчетФактураПолученныйПродавцы.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	СчетФактураПолученныйПродавцы.Продавец,
	|	СчетФактураПолученныйПродавцы.ИННПродавца,
	|	СчетФактураПолученныйПродавцы.КПППродавца
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
	|ПОМЕСТИТЬ ВременнаяТаблицаДокументыОснования
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|ГДЕ
	|	СчетФактураПолученныйДокументыОснования.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего) КАК РазницаВсегоРуб,
	|	СУММА(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС) КАК РазницаНДСРуб,
	|	СУММА(РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС) КАК РазницаНалоговаяБазаНДСРуб,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего > 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ВсегоРуб,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС > 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК НДСРуб,
	|	СУММА(ВЫБОР
	|			КОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС > 0
	|				ТОГДА РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК НалоговаяБазаНДСРуб
	|ПОМЕСТИТЬ РегистрСведенийРублевыеСуммыДокументовВВалюте
	|ИЗ
	|	РегистрСведений.РублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаДокументыОснования КАК ВременнаяТаблицаДокументыОснования
	|		ПО РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор = ВременнаяТаблицаДокументыОснования.ДокументОснование
	|ГДЕ
	|	НЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.ВозвратнаяТара)
	|	И НЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.ОплатаПоставщикам)
	|	И ВЫБОР
	|			КОГДА ВременнаяТаблицаДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|					И РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ВЫБОР
	|					КОГДА НЕ ВременнаяТаблицаДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|						ТОГДА ВЫБОР
	|								КОГДА ВременнаяТаблицаДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомитентуОПродажах
	|										И РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.ПустаяСсылка)
	|									ТОГДА ЛОЖЬ
	|								ИНАЧЕ ИСТИНА
	|							КОНЕЦ
	|					ИНАЧЕ ЛОЖЬ
	|				КОНЕЦ
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация,
	|	Реквизиты.Контрагент,
	|	Реквизиты.КППКонтрагента,
	|	ВЫБОР
	|		КОГДА НЕ ВременнаяТаблицаПродавцы.Продавец ЕСТЬ NULL
	|			ТОГДА ВЫБОР
	|					КОГДА ВременнаяТаблицаПродавцы.Продавец = Реквизиты.Контрагент
	|						ТОГДА НЕОПРЕДЕЛЕНО
	|					ИНАЧЕ ВременнаяТаблицаПродавцы.Продавец
	|				КОНЕЦ
	|		КОГДА Реквизиты.Продавец = Реквизиты.Контрагент
	|				ИЛИ Реквизиты.Продавец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				ИЛИ Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Реквизиты.Продавец
	|	КОНЕЦ КАК Продавец,
	|	Реквизиты.Ссылка КАК СчетФактура,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры) КАК ЧастьЖурнала,
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ КАК ДатаВыставленияПолучения,
	|	Реквизиты.КодСпособаПолучения КАК КодСпособаВыставленияПолучения,
	|	Реквизиты.КодВидаОперации КАК КодВидаОперации,
	|	Реквизиты.НомерВходящегоДокумента КАК НомерСчетаФактуры,
	|	Реквизиты.ДатаВходящегоДокумента КАК ДатаСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК НомерКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаКорректировочногоСчетаФактуры,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.НомерИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НомерИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.ДатаИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА &ВалютаРеглУчета
	|		ИНАЧЕ Реквизиты.ВалютаДокумента
	|	КОНЕЦ КАК Валюта,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА ВЫБОР
	|					КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.ВсегоРуб, 0) = 0
	|						ТОГДА Реквизиты.СуммаДокумента
	|					ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.ВсегоРуб, 0)
	|				КОНЕЦ
	|		ИНАЧЕ Реквизиты.СуммаДокумента
	|	КОНЕЦ КАК СуммаПоСчетуФактуре,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА ВЫБОР
	|					КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДСРуб, 0) = 0
	|						ТОГДА Реквизиты.СуммаНДСДокумента
	|					ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДСРуб, 0)
	|				КОНЕЦ
	|		ИНАЧЕ Реквизиты.СуммаНДСДокумента
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаНДСДокумента = 0
	|				ИЛИ Реквизиты.СуммаНДСДокументаКомиссия = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА Реквизиты.СуммаНДСДокументаКомиссия
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДСРуб, 0) = 0
	|							ТОГДА Реквизиты.СуммаНДСДокументаКомиссия
	|						ИНАЧЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.НДСРуб / Реквизиты.СуммаНДСДокумента * Реквизиты.СуммаНДСДокументаКомиссия
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаНДСКомиссия,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаДокумента = 0
	|				ИЛИ Реквизиты.СуммаДокументаКомиссия = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|						ИЛИ НЕ Реквизиты.ВалютаДокумента = &ВалютаРеглУчета
	|							И НЕ Реквизиты.РасчетыВУсловныхЕдиницах
	|					ТОГДА Реквизиты.СуммаДокументаКомиссия
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.ВсегоРуб, 0) = 0
	|							ТОГДА Реквизиты.СуммаДокументаКомиссия
	|						ИНАЧЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.ВсегоРуб / Реквизиты.СуммаДокумента * Реквизиты.СуммаДокументаКомиссия
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаПоСчетуФактуреКомиссия,
	|	0 КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	0 КАК СуммаНДСРазницаУвеличение,
	|	0 КАК СуммаНДСРазницаУменьшение,
	|	0 КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	0 КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	0 КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	0 КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	Реквизиты.СчетФактураБезНДС КАК ПоСтавкеБезНДС,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураНеВыставляется,
	|	Реквизиты.РасчетыВУсловныхЕдиницах,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	0 КАК ИндексСтроки,
	|	НЕОПРЕДЕЛЕНО КАК ДокументОснование,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|			ТОГДА Реквизиты.Субкомиссионер
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.Контрагент
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Субкомиссионер,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|				И НЕ Реквизиты.ИсправлениеСобственнойОшибки
	|			ТОГДА Реквизиты.СчетФактураВыданныйПокупателю
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СчетФактураВыданныйПокупателю,
	|	ВЫБОР
	|		КОГДА Реквизиты.РеализацияТоваровКомитента
	|			ТОГДА 2
	|		КОГДА Реквизиты.ЕстьКомиссия
	|			ТОГДА 1
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК Посредник,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК КодВидаОперацииКомиссия,
	|	Реквизиты.ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК СчетФактураПолученныйОтПродавца,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправленныйСчетФактура,
	|	ЕСТЬNULL(ВременнаяТаблицаПродавцы.ИННПродавца, """") КАК ИННПродавца,
	|	ЕСТЬNULL(ВременнаяТаблицаПродавцы.КПППродавца, """") КАК КПППродавца,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.ИННКонтрагента
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК ИННСубкомиссионера,
	|	ВЫБОР
	|		КОГДА Реквизиты.Продавец <> Реквизиты.Контрагент
	|				И Реквизиты.Продавец <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И Реквизиты.ЕстьКомиссия
	|			ТОГДА Реквизиты.КППКонтрагента
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КППСубкомиссионера,
	|	Реквизиты.КодВидаОперацииНаУменьшение
	|ИЗ
	|	Реквизиты КАК Реквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведенийРублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПродавцы КАК ВременнаяТаблицаПродавцы
	|		ПО (НЕ Реквизиты.СводныйСчетФактураКомиссионераПо1279)
	|			И (Реквизиты.Дата >= ДАТАВРЕМЯ(2015, 1, 1))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Реквизиты.Дата,
	|	Реквизиты.Ссылка,
	|	Реквизиты.Организация,
	|	Реквизиты.Контрагент,
	|	Реквизиты.КППКонтрагента,
	|	ВЫБОР
	|		КОГДА ТаблицаПродавцы.Продавец = Реквизиты.Контрагент
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ТаблицаПродавцы.Продавец
	|	КОНЕЦ,
	|	Реквизиты.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры),
	|	ВЫБОР
	|		КОГДА &РегистрироватьСФДатойСоставления
	|			ТОГДА Реквизиты.ДатаВходящегоДокумента
	|		ИНАЧЕ Реквизиты.Дата
	|	КОНЕЦ,
	|	Реквизиты.КодСпособаПолучения,
	|	Реквизиты.КодВидаОперации,
	|	Реквизиты.НомерВходящегоДокумента,
	|	Реквизиты.ДатаВходящегоДокумента,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.НомерИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.Исправление
	|			ТОГДА Реквизиты.ДатаИсправления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.ВалютаДокумента <> &ВалютаРеглУчета
	|				И Реквизиты.РасчетыВУсловныхЕдиницах
	|			ТОГДА &ВалютаРеглУчета
	|		ИНАЧЕ Реквизиты.ВалютаДокумента
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	Реквизиты.СчетФактураБезНДС,
	|	НЕОПРЕДЕЛЕНО,
	|	Реквизиты.РасчетыВУсловныхЕдиницах,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ТаблицаПродавцы.НомерСтроки,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	Реквизиты.ИсправлениеСобственнойОшибки,
	|	Реквизиты.ИсправляемыйСчетФактура,
	|	Реквизиты.ИННКонтрагента,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка),
	|	ТаблицаПродавцы.ИННПродавца,
	|	ТаблицаПродавцы.КПППродавца,
	|	"""",
	|	"""",
	|	Реквизиты.КодВидаОперацииНаУменьшение
	|ИЗ
	|	Реквизиты КАК Реквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПродавцы КАК ТаблицаПродавцы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	Реквизиты.СводныйСчетФактураКомиссионераПо1279
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИндексСтроки"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаИсправлениеСобственнойОшибки()
	
	// Подготавливаем сервисные временные таблицы.
	ТекстЗапросаПодготовительный =  "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ СчетаФактурыВыданныеПоТекущемуСФ
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетФактураПолученныйСчетаФактурыВыданныеПокупателям
	|ГДЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка = &Ссылка
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ СчетаФактурыВыданныеПоИсправляемомуСФ
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетФактураПолученныйСчетаФактурыВыданныеПокупателям
	|ГДЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка = &ИсправляемыйСчетФактура
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетаФактурыВыданныеПоТекущемуСФ.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ СчетаФактурыВыданные
	|ИЗ
	|	СчетаФактурыВыданныеПоТекущемуСФ КАК СчетаФактурыВыданныеПоТекущемуСФ
	|ГДЕ
	|	НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СчетаФактурыВыданныеПоИсправляемомуСФ.СчетФактура
	|ИЗ
	|	СчетаФактурыВыданныеПоИсправляемомуСФ КАК СчетаФактурыВыданныеПоИсправляемомуСФ
	|ГДЕ
	|	НЕ СчетаФактурыВыданныеПоИсправляемомуСФ.СчетФактура В
	|				(ВЫБРАТЬ
	|					СчетаФактурыВыданныеПоТекущемуСФ.СчетФактура
	|				ИЗ
	|					СчетаФактурыВыданныеПоТекущемуСФ)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ЖурналУчетаСчетовФактурСрезПоследних.Регистратор) КАК Регистратор,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура
	|ПОМЕСТИТЬ ПоследнийРегистраторПоСчетуФактуреВыданному
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			Регистратор <> &Ссылка
	|				И СчетФактура В
	|					(ВЫБРАТЬ
	|						СчетаФактурыВыданные.СчетФактура
	|					ИЗ
	|						СчетаФактурыВыданные)) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|ГДЕ
	|	НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|	И ЖурналУчетаСчетовФактурСрезПоследних.Регистратор <> &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю КАК СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент
	|ПОМЕСТИТЬ СуммыПоСчетамФактурамПолученным
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			СчетФактура <> &ИсправляемыйСчетФактура
	|				И СчетФактураВыданныйПокупателю В
	|					(ВЫБРАТЬ
	|						СчетаФактурыВыданныеПоТекущемуСФ.СчетФактура
	|					ИЗ
	|						СчетаФактурыВыданныеПоТекущемуСФ)
	|				И Регистратор <> &Ссылка
	|				И НЕ Сторно) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|ГДЕ
	|	НЕ &ПовторноеИсправлениеСобственнойОшибки
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактураВыданныйПокупателю
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.Период,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Регистратор,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Активность,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура КАК СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Сторно,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправлениеСобственнойОшибки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияНоваяЗаписьВыставленныеСФПредварительная
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			Регистратор В
	|					(ВЫБРАТЬ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному.Регистратор
	|					ИЗ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному)
	|				И СчетФактура В
	|					(ВЫБРАТЬ
	|						СчетаФактурыВыданныеПоТекущемуСФ.СчетФактура
	|					ИЗ
	|						СчетаФактурыВыданныеПоТекущемуСФ)
	|				И НЕ Сторно
	|				И ВЫБОР
	|					КОГДА &ПовторноеИсправлениеСобственнойОшибки
	|						ТОГДА СчетФактураПолученныйОтПродавца = &ИсправляемыйСчетФактура
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.Период,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Регистратор,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Активность,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура КАК СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Сторно,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправлениеСобственнойОшибки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияНоваяЗаписьПовторноеИсправление
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			Регистратор В
	|					(ВЫБРАТЬ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному.Регистратор
	|					ИЗ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному)
	|				И СчетФактура В
	|					(ВЫБРАТЬ
	|						СчетаФактурыВыданныеПоТекущемуСФ.СчетФактура
	|					ИЗ
	|						СчетаФактурыВыданныеПоТекущемуСФ)
	|				И НЕ Сторно
	|				И СчетФактураПолученныйОтПродавца <> &ИсправляемыйСчетФактура) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|ГДЕ
	|	&ПовторноеИсправлениеСобственнойОшибки
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.Период,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Регистратор,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Активность,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура КАК СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Сторно,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправлениеСобственнойОшибки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияНоваяЗаписьПервичноеИсправление
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			Регистратор <> &Ссылка
	|				И НЕ Сторно) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|ГДЕ
	|	НЕ &ПовторноеИсправлениеСобственнойОшибки
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура";
	
	//1 пакет - сторно записи.
	//  1 запрос - подготавливаем сторно запись по исправляемому полученному счету-фактуре.
	//  2 запрос - подготавливаем сторно записи по счетам-фактурам из ТЧ "СФ выданные покупателям" ИСПРАВЛЯЕМОГО СФ.
	//2 пакет - подготавливаем новые записи по счетам-фактурам из ТЧ "СФ выданные покупателям" с привязкой к текущему полученному счету-фактуре,
	//  берем запись по выданному СФ по последнему регистратору, если это повторное исправление, то из записи по последнему регистратору берем 
	//  запись со счетом-фактурой полученным равным исправляемому счету-фактуре.
	//3 пакет.
	//  1 запрос - если это повторное исправление, значит выставленный счет-фактура уже привязан ранее ко всем полученным через "СчетФактураПолученныйОтПродавца",
	//  ищем такие записи по последнему регистратору, дублируем, кроме записи, которая ссылается на исправляемый СФ полученный.
	//  2 запрос - если это не повторное исправление, значит выставленный счет-фактура не привязан ранее ко всем полученным через "СчетФактураПолученныйОтПродавца",
	//  новые записи по выставленному счету-фактуре с привязкой к счетам-фактурам из пакета 4.
	
	ТекстЗапросаОсновной = "ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки,
	|	ИСТИНА КАК ИсправлениеСобственнойОшибки,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправляемыйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца КАК СчетФактураПолученныйОтПродавца,
	|	ИСТИНА КАК Сторно,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре КАК СуммаПоСчетуФактуре,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия КАК СуммаПоСчетуФактуреКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС КАК СуммаНДС,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия КАК СуммаНДСКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение КАК СуммаНДСРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение КАК СуммаНДСРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияСторно
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			СчетФактура = &ИсправляемыйСчетФактура
	|				И Регистратор <> &Ссылка
	|				И НЕ Сторно) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка),
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца,
	|	ИСТИНА,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			Регистратор В
	|					(ВЫБРАТЬ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному.Регистратор
	|					ИЗ
	|						ПоследнийРегистраторПоСчетуФактуреВыданному)
	|				И СчетФактура В
	|					(ВЫБРАТЬ
	|						СчетаФактурыВыданныеПоИсправляемомуСФ.СчетФактура
	|					ИЗ
	|						СчетаФактурыВыданныеПоИсправляемомуСФ)
	|				И НЕ Сторно) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|ГДЕ
	|	НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	Реквизиты.Организация,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.Контрагент КАК Контрагент,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КППКонтрагента КАК КППКонтрагента,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка.Контрагент КАК Продавец,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.Посредник КАК Посредник,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ЧастьЖурнала КАК ЧастьЖурнала,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ДатаВыставленияПолучения КАК ДатаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КодСпособаВыставленияПолучения КАК КодСпособаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КодВидаОперации КАК КодВидаОперации,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.НомерСчетаФактуры КАК НомерСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ДатаСчетаФактуры КАК ДатаСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.НомерКорректировочногоСчетаФактуры КАК НомерКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ДатаКорректировочногоСчетаФактуры КАК ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.НомерИсправления КАК НомерИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ДатаИсправления КАК ДатаИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.Валюта КАК Валюта,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ПоСтавкеБезНДС КАК ПоСтавкеБезНДС,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.СчетФактураНеВыставляется КАК СчетФактураНеВыставляется,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.НомерИсправленияКорректировочногоСчетаФактуры КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ДатаИсправленияКорректировочногоСчетаФактуры КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.Субкомиссионер КАК Субкомиссионер,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.СчетФактураВыданныйПокупателю КАК СчетФактураВыданныйПокупателю,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КодВидаСделки КАК КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО КАК НомерСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ИндексСтроки,
	|	ИСТИНА КАК ИсправлениеСобственнойОшибки,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправляемыйСчетФактура,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка КАК ИсправленныйСчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ИННКонтрагента КАК ИННКонтрагента,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка КАК СчетФактураПолученныйОтПродавца,
	|	ЛОЖЬ КАК Сторно,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.СуммаПоСчетуФактуре КАК СуммаПоСчетуФактуре,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Сумма КАК СуммаПоСчетуФактуреКомиссия,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.НДС КАК СуммаНДС,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.НДС КАК СуммаНДСКомиссия,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение КАК СуммаНДСРазницаУменьшение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУвеличение КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение КАК СуммаНДСРазницаУвеличение,
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СуммаНДСУменьшение КАК СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КодВидаОперацииКомиссия,
	|	Реквизиты.ИННКонтрагента КАК ИННПродавца,
	|	Реквизиты.КППКонтрагента КАК КПППродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.ИННСубкомиссионера,
	|	ДвиженияНоваяЗаписьВыставленныеСФПредварительная.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияНоваяЗаписьВыставленныеСФ
	|ИЗ
	|	Документ.СчетФактураПолученный.СчетаФактурыВыданныеПокупателям КАК СчетФактураПолученныйСчетаФактурыВыданныеПокупателям
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияНоваяЗаписьВыставленныеСФПредварительная КАК ДвиженияНоваяЗаписьВыставленныеСФПредварительная
	|		ПО СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.СчетФактура = ДвиженияНоваяЗаписьВыставленныеСФПредварительная.СчетФактура
	|ГДЕ
	|	СчетФактураПолученныйСчетаФактурыВыданныеПокупателям.Ссылка = &Ссылка
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Организация,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Контрагент,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КППКонтрагента,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Продавец КАК Продавец,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Посредник,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СчетФактура,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ЧастьЖурнала,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КодСпособаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КодВидаОперации,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.НомерСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.НомерКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.НомерИсправления,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаИсправления,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Валюта,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ПоСтавкеБезНДС,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СчетФактураНеВыставляется,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.Субкомиссионер,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СчетФактураВыданныйПокупателю,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КодВидаСделки,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.НомерСчетаФактурыПродавца,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ДатаСчетаФактурыПродавца,
	|	НЕОПРЕДЕЛЕНО КАК ИндексСтроки,
	|	ИСТИНА КАК ИсправлениеСобственнойОшибки,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка) КАК ИсправляемыйСчетФактура,
	|	&Ссылка КАК ИсправленныйСчетФактура,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ИННКонтрагента,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СчетФактураПолученныйОтПродавца,
	|	ЛОЖЬ КАК Сторно,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуре,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуреКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДС,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДСКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДСРазницаУменьшение,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДСРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДСРазницаУвеличение,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КодВидаОперацииКомиссия,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ИННПродавца КАК ИННПродавца,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КПППродавца КАК КПППродавца,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.ИННСубкомиссионера,
	|	ДвиженияНоваяЗаписьПовторноеИсправление.КППСубкомиссионера
	|ПОМЕСТИТЬ ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным
	|ИЗ
	|	Реквизиты КАК Реквизиты,
	|	ДвиженияНоваяЗаписьПовторноеИсправление КАК ДвиженияНоваяЗаписьПовторноеИсправление
	|ГДЕ
	|	&ПовторноеИсправлениеСобственнойОшибки
	|	И НЕ &ТолькоСторнироватьИсходныйСчетФактуру
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Реквизиты.Дата,
	|	Реквизиты.Ссылка,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.Организация,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.Контрагент,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КППКонтрагента,
	|	СуммыПоСчетамФактурамПолученным.Контрагент,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.Посредник,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.СчетФактура,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ЧастьЖурнала,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ДатаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КодСпособаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КодВидаОперации,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.НомерСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ДатаСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.НомерКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.НомерИсправления,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ДатаИсправления,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.Валюта,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ПоСтавкеБезНДС,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.СчетФактураНеВыставляется,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.Субкомиссионер,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураВыданный.ПустаяСсылка),
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КодВидаСделки,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка),
	|	&Ссылка,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ИННКонтрагента,
	|	СуммыПоСчетамФактурамПолученным.СчетФактура,
	|	ЛОЖЬ,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.СуммаПоСчетуФактуре,
	|	СуммыПоСчетамФактурамПолученным.СуммаПоСчетуФактуреКомиссия,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДС,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДСКомиссия,
	|	СуммыПоСчетамФактурамПолученным.СуммаПоСчетуФактуреРазницаУменьшение,
	|	СуммыПоСчетамФактурамПолученным.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	СуммыПоСчетамФактурамПолученным.СуммаПоСчетуФактуреРазницаУвеличение,
	|	СуммыПоСчетамФактурамПолученным.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДСРазницаУменьшение,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДСРазницаУменьшениеКомиссия,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДСРазницаУвеличение,
	|	СуммыПоСчетамФактурамПолученным.СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КодВидаОперацииКомиссия,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ИННКонтрагента,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КПППродавца,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.ИННСубкомиссионера,
	|	ДвиженияНоваяЗаписьПервичноеИсправление.КППСубкомиссионера
	|ИЗ
	|	ДвиженияНоваяЗаписьПервичноеИсправление КАК ДвиженияНоваяЗаписьПервичноеИсправление
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммыПоСчетамФактурамПолученным КАК СуммыПоСчетамФактурамПолученным
	|		ПО ДвиженияНоваяЗаписьПервичноеИсправление.СчетФактура = СуммыПоСчетамФактурамПолученным.СчетФактураВыданныйПокупателю
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|ГДЕ
	|	НЕ &ПовторноеИсправлениеСобственнойОшибки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	ДвиженияСторно.Организация,
	|	ДвиженияСторно.Контрагент,
	|	ДвиженияСторно.КППКонтрагента,
	|	ДвиженияСторно.Продавец,
	|	ДвиженияСторно.Посредник,
	|	ДвиженияСторно.СчетФактура,
	|	ДвиженияСторно.ЧастьЖурнала,
	|	ДвиженияСторно.ДатаВыставленияПолучения,
	|	ДвиженияСторно.КодСпособаВыставленияПолучения,
	|	ДвиженияСторно.КодВидаОперации,
	|	ДвиженияСторно.КодВидаОперацииКомиссия,
	|	ДвиженияСторно.НомерСчетаФактуры,
	|	ДвиженияСторно.ДатаСчетаФактуры,
	|	ДвиженияСторно.НомерКорректировочногоСчетаФактуры,
	|	ДвиженияСторно.ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияСторно.НомерИсправления,
	|	ДвиженияСторно.ДатаИсправления,
	|	ДвиженияСторно.Валюта,
	|	ДвиженияСторно.ПоСтавкеБезНДС,
	|	ДвиженияСторно.СчетФактураНеВыставляется,
	|	ДвиженияСторно.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияСторно.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияСторно.Субкомиссионер,
	|	ДвиженияСторно.СчетФактураВыданныйПокупателю,
	|	ДвиженияСторно.КодВидаСделки,
	|	ДвиженияСторно.НомерСчетаФактурыПродавца,
	|	ДвиженияСторно.ДатаСчетаФактурыПродавца,
	|	ДвиженияСторно.ИндексСтроки,
	|	ДвиженияСторно.ИсправлениеСобственнойОшибки,
	|	ДвиженияСторно.ИсправляемыйСчетФактура,
	|	ДвиженияСторно.ИсправленныйСчетФактура,
	|	ДвиженияСторно.ИННКонтрагента,
	|	ДвиженияСторно.СчетФактураПолученныйОтПродавца,
	|	ДвиженияСторно.Сторно,
	|	ДвиженияСторно.СуммаПоСчетуФактуре,
	|	ДвиженияСторно.СуммаПоСчетуФактуреКомиссия,
	|	ДвиженияСторно.СуммаНДС,
	|	ДвиженияСторно.СуммаНДСКомиссия,
	|	ДвиженияСторно.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ДвиженияСторно.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ДвиженияСторно.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ДвиженияСторно.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ДвиженияСторно.СуммаНДСРазницаУменьшение,
	|	ДвиженияСторно.СуммаНДСРазницаУменьшениеКомиссия,
	|	ДвиженияСторно.СуммаНДСРазницаУвеличение,
	|	ДвиженияСторно.СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияСторно.ИННПродавца,
	|	ДвиженияСторно.КПППродавца,
	|	ДвиженияСторно.ИННСубкомиссионера,
	|	ДвиженияСторно.КППСубкомиссионера,
	|	Реквизиты.КодВидаОперацииНаУменьшение
	|ИЗ
	|	ДвиженияСторно КАК ДвиженияСторно
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Период,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Регистратор,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Организация,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Контрагент,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КППКонтрагента,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Продавец,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Посредник,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ЧастьЖурнала,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КодСпособаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КодВидаОперации,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КодВидаОперацииКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.НомерСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.НомерКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.НомерИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Валюта,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ПоСтавкеБезНДС,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СчетФактураНеВыставляется,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Субкомиссионер,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СчетФактураВыданныйПокупателю,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КодВидаСделки,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.НомерСчетаФактурыПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ДатаСчетаФактурыПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИндексСтроки,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИсправлениеСобственнойОшибки,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИсправляемыйСчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИсправленныйСчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИННКонтрагента,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СчетФактураПолученныйОтПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.Сторно,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуре,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуреКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДС,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДСКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДСРазницаУменьшение,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДСРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДСРазницаУвеличение,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИННПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КПППродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.ИННСубкомиссионера,
	|	ДвиженияНоваяЗаписьВыставленныеСФ.КППСубкомиссионера,
	|	""""
	|ИЗ
	|	ДвиженияНоваяЗаписьВыставленныеСФ КАК ДвиженияНоваяЗаписьВыставленныеСФ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Период,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Регистратор,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Организация,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Контрагент,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КППКонтрагента,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Продавец,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Посредник,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ЧастьЖурнала,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КодСпособаВыставленияПолучения,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КодВидаОперации,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КодВидаОперацииКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.НомерСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.НомерКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.НомерИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаИсправления,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Валюта,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ПоСтавкеБезНДС,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СчетФактураНеВыставляется,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.НомерИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Субкомиссионер,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СчетФактураВыданныйПокупателю,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КодВидаСделки,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.НомерСчетаФактурыПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ДатаСчетаФактурыПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИндексСтроки,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИсправлениеСобственнойОшибки,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИсправляемыйСчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИсправленныйСчетФактура,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИННКонтрагента,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СчетФактураПолученныйОтПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.Сторно,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуре,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуреКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДС,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДСКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуреРазницаУменьшение,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуреРазницаУвеличение,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДСРазницаУменьшение,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДСРазницаУменьшениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДСРазницаУвеличение,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.СуммаНДСРазницаУвеличениеКомиссия,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИННПродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КПППродавца,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.ИННСубкомиссионера,
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным.КППСубкомиссионера,
	|	""""
	|ИЗ
	|	ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным КАК ДвиженияНоваяЗаписьВыставленныеСФПоПрочимПолученным";
	
	ТекстЗапросаИтоговый = ТекстЗапросаПодготовительный
		+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета()
		+ ТекстЗапросаОсновной
		+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
		
	Возврат ТекстЗапросаИтоговый;
	
КонецФункции

Функция ТекстЗапросаСторнирующаяЗаписьЖурналаСФ()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Реквизиты.Дата КАК Период,
	|	Реквизиты.Ссылка КАК Регистратор,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Организация КАК Организация,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Контрагент КАК Контрагент,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППКонтрагента КАК КППКонтрагента,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Продавец КАК Продавец,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Посредник КАК Посредник,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактура КАК СчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ЧастьЖурнала КАК ЧастьЖурнала,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаВыставленияПолучения КАК ДатаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодСпособаВыставленияПолучения КАК КодСпособаВыставленияПолучения,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации КАК КодВидаОперации,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперацииКомиссия КАК КодВидаОперацииКомиссия,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаОперации КАК КодВидаОперацииНаУменьшение,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактуры КАК НомерСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактуры КАК ДатаСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерКорректировочногоСчетаФактуры КАК НомерКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаКорректировочногоСчетаФактуры КАК ДатаКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправления КАК НомерИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправления КАК ДатаИсправления,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Валюта КАК Валюта,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ПоСтавкеБезНДС КАК ПоСтавкеБезНДС,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураНеВыставляется КАК СчетФактураНеВыставляется,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерИсправленияКорректировочногоСчетаФактуры КАК НомерИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаИсправленияКорректировочногоСчетаФактуры КАК ДатаИсправленияКорректировочногоСчетаФактуры,
	|	ЖурналУчетаСчетовФактурСрезПоследних.Субкомиссионер КАК Субкомиссионер,
	|	НЕОПРЕДЕЛЕНО КАК СчетФактураВыданныйПокупателю,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КодВидаСделки КАК КодВидаСделки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.НомерСчетаФактурыПродавца КАК НомерСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ДатаСчетаФактурыПродавца КАК ДатаСчетаФактурыПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИндексСтроки КАК ИндексСтроки,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправлениеСобственнойОшибки КАК ИсправлениеСобственнойОшибки,
	|	НЕОПРЕДЕЛЕНО КАК ИсправляемыйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННКонтрагента КАК ИННКонтрагента,
	|	ИСТИНА КАК Сторно,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННПродавца КАК ИННПродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КПППродавца КАК КПППродавца,
	|	ЖурналУчетаСчетовФактурСрезПоследних.ИННСубкомиссионера КАК ИННСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.КППСубкомиссионера КАК КППСубкомиссионера,
	|	ЖурналУчетаСчетовФактурСрезПоследних.СчетФактураПолученныйОтПродавца КАК СчетФактураПолученныйОтПродавца,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуре КАК СуммаПоСчетуФактуре,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия КАК СуммаПоСчетуФактуреКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДС КАК СуммаНДС,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия КАК СуммаНДСКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшение КАК СуммаПоСчетуФактуреРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия КАК СуммаПоСчетуФактуреРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличение КАК СуммаПоСчетуФактуреРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия КАК СуммаПоСчетуФактуреРазницаУвеличениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшение КАК СуммаНДСРазницаУменьшение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия КАК СуммаНДСРазницаУменьшениеКомиссия,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличение КАК СуммаНДСРазницаУвеличение,
	|	-ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия КАК СуммаНДСРазницаУвеличениеКомиссия
	|ИЗ
	|	РегистрСведений.ЖурналУчетаСчетовФактур.СрезПоследних(
	|			&Дата,
	|			СчетФактура = &ИсправляемыйСчетФактура
	|				И Регистратор <> &Ссылка
	|				И НЕ Сторно) КАК ЖурналУчетаСчетовФактурСрезПоследних
	|		ЛЕВОЕ СОЕДИНЕНИЕ Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|ГДЕ
	|	(ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреКомиссия > 0
	|			ИЛИ ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСКомиссия > 0
	|			ИЛИ ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУменьшениеКомиссия > 0
	|			ИЛИ ЖурналУчетаСчетовФактурСрезПоследних.СуммаПоСчетуФактуреРазницаУвеличениеКомиссия > 0
	|			ИЛИ ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУменьшениеКомиссия > 0
	|			ИЛИ ЖурналУчетаСчетовФактурСрезПоследних.СуммаНДСРазницаУвеличениеКомиссия > 0)"
	+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОшибочныеРеквизитыКонтрагентов(НомераТаблиц, ПараметрыПроведения, Реквизиты)
	
	Если НЕ Реквизиты.ИсправлениеСобственнойОшибки Тогда
		ПараметрыПроведения.Вставить("ТаблицаОшибочныеРеквизитыКонтрагентов", Неопределено);
		Возврат "";
	КонецЕсли;
	
	НомераТаблиц.Вставить("ТаблицаОшибочныеРеквизитыКонтрагентов", НомераТаблиц.Количество());
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Дата КАК Период,
	|	СчетФактураПолученный.Ссылка КАК Регистратор,
	|	СчетФактураПолученный.Организация КАК Организация,
	|	СчетФактураПолученный.ИсправляемыйСчетФактура КАК СчетФактура,
	|	&ИсходныйСчетФактура КАК ИсходныйСчетФактура,
	|	СчетФактураПолученный.Контрагент КАК Контрагент,
	|	СчетФактураПолученный.ИННКонтрагентаДоИзменения КАК ИНН,
	|	СчетФактураПолученный.КППКонтрагентаДоИзменения КАК КПП
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата,
	|	СчетФактураПолученный.Ссылка,
	|	СчетФактураПолученный.Организация,
	|	СчетФактураПолученный.ИсправляемыйСчетФактура,
	|	&ИсходныйСчетФактура,
	|	ПродавцыПоСчетуФактуре.Продавец,
	|	ПродавцыПоСчетуФактуре.ИННПродавцаДоИзменения,
	|	ПродавцыПоСчетуФактуре.КПППродавцаДоИзменения
	|ИЗ
	|	Документ.СчетФактураПолученный.Продавцы КАК ПродавцыПоСчетуФактуре
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ПО ПродавцыПоСчетуФактуре.Ссылка = СчетФактураПолученный.Ссылка
	|ГДЕ
	|	ПродавцыПоСчетуФактуре.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ЕстьКомиссионныеОперацииПоСчетуФактуре4кв2014(ДокументСсылка)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
	|ПОМЕСТИТЬ ВременнаяТаблицаДокументыОснования
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|ГДЕ
	|	СчетФактураПолученныйДокументыОснования.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	1 КАК Количество
	|ИЗ
	|	РегистрНакопления.ЗакупленныеТоварыКомитентов КАК ЗакупленныеТоварыКомитентов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаДокументыОснования КАК ВременнаяТаблицаДокументыОснования
	|		ПО ЗакупленныеТоварыКомитентов.Регистратор = ВременнаяТаблицаДокументыОснования.ДокументОснование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	1
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный КАК Хозрасчетный
	|ГДЕ
	|	Хозрасчетный.Регистратор В
	|			(ВЫБРАТЬ
	|				ВременнаяТаблицаДокументыОснования.ДокументОснование
	|			ИЗ
	|				ВременнаяТаблицаДокументыОснования)
	|	И Хозрасчетный.СчетДт = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ТМЦпринятыеНаОтветственноеХранение)";
	
	Результат = Запрос.Выполнить();
	
	Возврат Не Результат.Пустой();
	
КонецФункции

Процедура УстановитьПараметрыЗапросаДвиженияСФ(Запрос, Реквизиты)
	
	Запрос.УстановитьПараметр("ИсправляемыйСчетФактура", Реквизиты.ИсправляемыйСчетФактура);
	
	ИсходныйСчетФактура = УчетНДСПереопределяемый.ПолучитьИсходныйСчетФактуру(Реквизиты.ИсправляемыйСчетФактура);
	Запрос.УстановитьПараметр("ИсходныйСчетФактура", ИсходныйСчетФактура);
	
	ДатаИсходногоСчетаФактуры = Дата(1, 1, 1);
	Если ЗначениеЗаполнено(ИсходныйСчетФактура) Тогда
		ДатаИсходногоСчетаФактуры = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ИсходныйСчетФактура, "Дата");
	КонецЕсли;
	Запрос.УстановитьПараметр("ДатаИсходногоСчетаФактуры", ДатаИсходногоСчетаФактуры);
	
	ПравилаПостановления981 = УчетНДСПереопределяемый.ВерсияПостановленияНДС1137(ДатаИсходногоСчетаФактуры) >= 4;
	Запрос.УстановитьПараметр("РегистрироватьИсправлениеВДопЛисте", ПравилаПостановления981);
	
	Запрос.УстановитьПараметр("ПовторноеИсправлениеСобственнойОшибки", Реквизиты.ПовторноеИсправлениеСобственнойОшибки);
	
	// С 01.10.2017 года счет-фактура регистрируется в журнале учета полученных и выданных счетов-фактур
	// в том налоговом периоде, в котором этот счет-фактура составлен.
	ВерсияПостановленияНДС1137 = УчетНДСПереопределяемый.ВерсияПостановленияНДС1137(Реквизиты.Период);
	РегистрироватьСФДатойСоставления = ВерсияПостановленияНДС1137 >= 4;
	Реквизиты.Вставить("РегистрироватьСФДатойСоставления", РегистрироватьСФДатойСоставления);
	Запрос.УстановитьПараметр("РегистрироватьСФДатойСоставления", РегистрироватьСФДатойСоставления);
	
	ТолькоСторнироватьИсходныйСчетФактуру = Истина;
	Если Реквизиты.ИсправлениеСобственнойОшибки
		И Реквизиты.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомитентом
		И НЕ Реквизиты.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный
		И НЕ Реквизиты.Исправление Тогда
		ТолькоСторнироватьИсходныйСчетФактуру = Ложь;
	КонецЕсли;
	Запрос.УстановитьПараметр("ТолькоСторнироватьИсходныйСчетФактуру", ТолькоСторнироватьИсходныйСчетФактуру);

КонецПроцедуры

Функция РеквизитыРегламентнойОперации(ДокументСсылка) Экспорт
	
	РеквизитыОперации = Новый Структура();
	РеквизитыОперации.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	РеквизитыОперации.Вставить("Дата", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.Время));
	РеквизитыОперации.Вставить("РегламентнаяОперация", Перечисления.РегламентныеОперации.ПустаяСсылка());
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Организация КАК Организация,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, СчетФактураПолученный.Дата) КАК Дата,
	|	ЗНАЧЕНИЕ(Перечисление.РегламентныеОперации.ФормированиеЗаписейКнигиПокупок) КАК РегламентнаяОперация
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО СчетФактураПолученный.Организация = ДанныеПервичныхДокументов.Организация
	|			И СчетФактураПолученный.ДокументОснование = ДанныеПервичныхДокументов.Документ
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &ДокументСсылка";
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(РеквизитыОперации, Результат);
	КонецЕсли;
	
	Возврат РеквизитыОперации;
	
КонецФункции

#КонецОбласти

#Область Печать

// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
	// Счет-фактура за поставщика
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "СчетФактураПолученный";
	КомандаПечати.Представление = НСтр("ru = 'Счет-фактура за поставщика'");
	КомандаПечати.Обработчик    = "УчетНДСКлиент.ВыполнитьКомандуПечатиСчетовФактурПолученных";
	КомандаПечати.СписокФорм    = "ФормаСписка,ФормаВыбора,ФормаДокументаНаПоступление,ФормаДокументаКорректировочный";
	
	// УПД за поставщика
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "УниверсальныйПередаточныйДокумент";
	КомандаПечати.Представление = НСтр("ru = 'Универсальный передаточный документ (УПД) за поставщика'");
	КомандаПечати.Обработчик    = "УчетНДСКлиент.ВыполнитьКомандуПечатиУниверсальныхПередаточныхДокументов";
	КомандаПечати.СписокФорм    = "ФормаСписка,ФормаВыбора,ФормаДокументаНаПоступление";
	
	Если ПравоДоступа("Чтение", Метаданные.Справочники.Контрагенты) Тогда
		// Печать конвертов
		КомандаПечати = КомандыПечати.Добавить();
		КомандаПечати.Идентификатор = "Конверт";
		КомандаПечати.Представление = НСтр("ru = 'Конверт'");
		КомандаПечати.Обработчик    = "УправлениеПечатьюБПКлиент.ВыполнитьКомандуПечатиКонверта";
		КомандаПечати.Порядок       = 90;
	КонецЕсли;
	
	// Реестр документов
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "Реестр";
	КомандаПечати.Представление = НСтр("ru = 'Реестр документов'");
	КомандаПечати.ЗаголовокФормы= НСтр("ru = 'Реестр документов ""Счет-фактура полученный""'");
	КомандаПечати.Обработчик    = "УправлениеПечатьюБПКлиент.ВыполнитьКомандуПечатиРеестраДокументов";
	КомандаПечати.СписокФорм    = "ФормаСписка";
	КомандаПечати.Порядок       = 100;
	
КонецПроцедуры

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "СчетФактура") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"СчетФактура", "Счет-фактура", 
			УчетНДСБП.ПечатьСчетовФактур(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьСчетовФактур(Ложь,Ложь), ПараметрыПечати),,
			"ОбщийМакет.ПФ_MXL_СчетФактура451");
	КонецЕсли;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "СчетФактура1137") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"СчетФактура1137", "Счет-фактура",
			УчетНДС.ПечатьСчетовФактур1137(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьСчетовФактур(,Ложь), ПараметрыПечати),,
			"ОбщийМакет.ПФ_MXL_СчетФактура1137");
	КонецЕсли;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "СчетФактура981") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"СчетФактура981", "Счет-фактура",
			УчетНДС.ПечатьСчетовФактур981(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьСчетовФактур(), ПараметрыПечати),,
			"ОбщийМакет.ПФ_MXL_СчетФактура981");
	КонецЕсли;
		
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "КорректировочныйСчетФактура") Тогда		
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"КорректировочныйСчетФактура", "Корректировочный счет-фактура", 
			УчетНДСБП.ПечатьКорректировочныхСчетовФактур(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьКорректировочныхСчетовФактур(Ложь, Ложь, Ложь), ПараметрыПечати),, 
			"ОбщийМакет.ПФ_MXL_КорректировочныйСчетФактура");
	КонецЕсли;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "КорректировочныйСчетФактура1137") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"КорректировочныйСчетФактура1137", "Корректировочный счет-фактура", 
			УчетНДС.ПечатьКорректировочныхСчетовФактур1137(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьКорректировочныхСчетовФактур(, Ложь, Ложь), ПараметрыПечати), 
			"ОбщийМакет.ПФ_MXL_КорректировочныйСчетФактура1137");
	КонецЕсли;
		
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "КорректировочныйСчетФактура952") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"КорректировочныйСчетФактура952", "Корректировочный счет-фактура",
			УчетНДС.ПечатьКорректировочныхСчетовФактур952(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьКорректировочныхСчетовФактур(,,Ложь), ПараметрыПечати),,
			"ОбщийМакет.ПФ_MXL_КорректировочныйСчетФактура952");
	КонецЕсли;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "КорректировочныйСчетФактура981") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,"КорректировочныйСчетФактура981", "Корректировочный счет-фактура",
			УчетНДС.ПечатьКорректировочныхСчетовФактур981(МассивОбъектов, ОбъектыПечати, ТекстЗапросаПечатьКорректировочныхСчетовФактур(), ПараметрыПечати),,
			"ОбщийМакет.ПФ_MXL_КорректировочныйСчетФактура981");
	КонецЕсли;
	ПараметрыВывода.ДоступнаПечатьПоКомплектно = Истина;
	
	ОбщегоНазначенияБП.ЗаполнитьДополнительныеПараметрыПечати(МассивОбъектов, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода);	
		
КонецПроцедуры

Функция ТекстЗапросаПечатьСчетовФактур(ИспользуетсяПостановлениеНДС1137 = Истина, ИспользуетсяПостановлениеНДС981 = Истина) Экспорт

	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ДокументыОснования.Ссылка КАК СчетФактура,
	|	ЛОЖЬ КАК УдалитьПрефиксыИзНомера,
	|	ЛОЖЬ КАК ЭтоСчетФактураВыданный,
	|	ИСТИНА КАК ВыводитьСуммуБезНДС,
	|	ДокументыОснования.ДокументОснование КАК ДокументОснование,
	|	ДокументыОснования.НомерСтроки КАК НомерСтроки,
	|	ДокументыОснования.Ссылка.ДатаВходящегоДокумента КАК Дата,
	|	ДокументыОснования.Ссылка.НомерВходящегоДокумента КАК Номер,
	|	ДокументыОснования.Ссылка.ВидСчетаФактуры КАК ВидСчетаФактуры,
	|	ДокументыОснования.Ссылка.СчетФактураБезНДС КАК СчетФактураБезНДС,
	|	ДокументыОснования.Ссылка.Исправление КАК Исправление,
	|	ДокументыОснования.Ссылка.НомерИсправления КАК НомерИсправления,
	|	ДокументыОснования.Ссылка.Дата КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА ДокументыОснования.Ссылка.Исправление
	|			ТОГДА ДокументыОснования.Ссылка.ДатаИсправления
	|		КОГДА ДокументыОснования.Ссылка.ДатаВходящегоДокумента <> ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ДокументыОснования.Ссылка.ДатаВходящегоДокумента
	|		ИНАЧЕ ДокументыОснования.Ссылка.Дата
	|	КОНЕЦ КАК ДатаСведений,
	|	ДокументыОснования.Ссылка.Контрагент КАК Контрагент,
	|	ДокументыОснования.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	"""" КАК ИдентификаторГосКонтракта,
	|	ВЫБОР
	|		КОГДА ДокументыОснования.Ссылка.ДоговорКонтрагента <> ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|			ТОГДА ДокументыОснования.Ссылка.ДоговорКонтрагента.ВидДоговора
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|	КОНЕЦ КАК ВидДоговора,
	|	ДокументыОснования.Ссылка.КППКонтрагента КАК КППСчетаФактуры,
	|	ДокументыОснования.Ссылка.СводныйКомиссионный
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка В(&МассивОбъектов)
	|	И ДокументыОснования.Ссылка.ДатаВходящегоДокумента > &УсловиеПоДате
	|	И НЕ ДокументыОснования.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАванс)
	|	И НЕ ДокументыОснования.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАвансКомитента)
	|	И НЕ ДокументыОснования.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|	И НЕ ДокументыОснования.ДокументОснование ССЫЛКА Документ.ОтчетКомитентуОПродажах
	|
	|УПОРЯДОЧИТЬ ПО
	|	СчетФактура,
	|	НомерСтроки
	|ИТОГИ
	|	МАКСИМУМ(УдалитьПрефиксыИзНомера),
	|	МАКСИМУМ(ЭтоСчетФактураВыданный),
	|	МАКСИМУМ(ВыводитьСуммуБезНДС)
	|ПО
	|	СчетФактура";
	
	Если ИспользуетсяПостановлениеНДС1137 Тогда
		Если ИспользуетсяПостановлениеНДС981 Тогда 
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
				">= ДАТАВРЕМЯ(2017,10,1)");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
				"МЕЖДУ &НачалоПримененияПостановления1137 И ДАТАВРЕМЯ(2017,09,30,23,59,59)");
		КонецЕсли;
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
		"< &НачалоПримененияПостановления1137");
	КонецЕсли;
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();

КонецФункции 

Функция ТекстЗапросаПечатьКорректировочныхСчетовФактур(ИспользуетсяПостановлениеНДС1137 = Истина, ИспользуетсяПостановлениеНДС952 = Истина, ИспользуетсяПостановлениеНДС981 = Истина) Экспорт

	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ДокументыОснования.Ссылка КАК СчетФактура,
	|	ДокументыОснования.Ссылка.ДатаВходящегоДокумента КАК Дата,
	|	ДокументыОснования.Ссылка.НомерВходящегоДокумента КАК Номер,
	|	ДокументыОснования.Ссылка.ВидСчетаФактуры КАК ВидСчетаФактуры,
	|	ДокументыОснования.Ссылка.СчетФактураБезНДС КАК СчетФактураБезНДС,
	|	ДокументыОснования.Ссылка.Исправление КАК Исправление,
	|	ДокументыОснования.Ссылка.НомерИсправления КАК НомерИсправления,
	|	ДокументыОснования.Ссылка.ДатаИсправления КАК ДатаИсправления,
	|	ДокументыОснования.УчитыватьИсправлениеИсходногоДокумента КАК УчитыватьИсправлениеИсходногоДокумента,
	|	ДокументыОснования.НомерИсходногоДокумента КАК НомерИсходногоДокумента,
	|	ДокументыОснования.ДатаИсходногоДокумента КАК ДатаИсходногоДокумента,
	|	ДокументыОснования.НомерИсправленияИсходногоДокумента КАК НомерИсправленияИсходногоДокумента,
	|	ДокументыОснования.ДатаИсправленияИсходногоДокумента КАК ДатаИсправленияИсходногоДокумента,
	|	ДокументыОснования.Ссылка.НомерИсправления КАК НомерИсправленияКорректировочного,
	|	ДокументыОснования.Ссылка.ДатаИсправления КАК ДатаИсправленияКорректировочного,
	|	ВЫБОР
	|		КОГДА ДокументыОснования.Ссылка.Исправление
	|			ТОГДА ДокументыОснования.Ссылка.ДатаИсправления
	|		КОГДА ДокументыОснования.Ссылка.ДатаВходящегоДокумента <> ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ДокументыОснования.Ссылка.ДатаВходящегоДокумента
	|		ИНАЧЕ ДокументыОснования.Ссылка.Дата
	|	КОНЕЦ КАК ДатаСведений,
	|	ВЫБОР
	|		КОГДА ДокументыОснования.Ссылка.Контрагент.ОбособленноеПодразделение
	|				И ДокументыОснования.Ссылка.Контрагент.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ДокументыОснования.Ссылка.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ ДокументыОснования.Ссылка.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ДокументыОснования.Ссылка.КППКонтрагента КАК КППСчетаФактуры,
	|	ЛОЖЬ КАК УдалитьПрефиксыИзНомера,
	|	ЛОЖЬ КАК ЭтоСчетФактураВыданный,
	|	ИСТИНА КАК ВыводитьСуммуБезНДС,
	|	ДокументыОснования.ДокументОснование КАК ДокументОснование,
	|	ДокументыОснования.НомерСтроки КАК НомерСтроки,
	|	"""" КАК ИдентификаторГосКонтракта
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка В(&МассивОбъектов)
	|	И ДокументыОснования.Ссылка.ДатаВходящегоДокумента > &УсловиеПоДате
	|	И ДокументыОснования.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата,
	|	СчетФактура,
	|	НомерСтроки
	|ИТОГИ
	|	МАКСИМУМ(Дата),
	|	МАКСИМУМ(Номер),
	|	МАКСИМУМ(ВидСчетаФактуры),
	|	МАКСИМУМ(СчетФактураБезНДС),
	|	МАКСИМУМ(Исправление),
	|	МАКСИМУМ(НомерИсправления),
	|	МАКСИМУМ(ДатаИсправления),
	|	МАКСИМУМ(НомерИсправленияКорректировочного),
	|	МАКСИМУМ(ДатаИсправленияКорректировочного),
	|	МАКСИМУМ(УдалитьПрефиксыИзНомера),
	|	МАКСИМУМ(ЭтоСчетФактураВыданный),
	|	МАКСИМУМ(ВыводитьСуммуБезНДС)
	|ПО
	|	СчетФактура";
	
	Если ИспользуетсяПостановлениеНДС1137 Тогда
		Если ИспользуетсяПостановлениеНДС952 Тогда
			Если ИспользуетсяПостановлениеНДС981 Тогда 
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
					">= ДАТАВРЕМЯ(2017,10,1)");
			Иначе
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
					"МЕЖДУ ДАТАВРЕМЯ(2013,11,6) И ДАТАВРЕМЯ(2017,09,30,23,59,59) ");
			КонецЕсли;
		Иначе	
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
				"МЕЖДУ &НачалоПримененияПостановления1137 И ДАТАВРЕМЯ(2013,11,5,23,59,59)");
		КонецЕсли; 
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "> &УсловиеПоДате",
			"< &НачалоПримененияПостановления1137");
	КонецЕсли;
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции 

Функция ТекстЗапросаДанныеДляПечатиСчетовФактур(НомераТаблиц) Экспорт

	НомераТаблиц.Вставить("ВТ_Реквизиты",				НомераТаблиц.Количество());
	НомераТаблиц.Вставить("Реквизиты",					НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаДокумента",	НомераТаблиц.Количество());
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Реквизиты.Дата КАК Дата,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА НЕ Реквизиты.Продавец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА Реквизиты.Продавец
	|		ИНАЧЕ Реквизиты.Контрагент
	|	КОНЕЦ КАК Поставщик,
	|	Реквизиты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Реквизиты.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ВТ_Реквизиты
	|ИЗ
	|	Документ.СчетФактураПолученный КАК Реквизиты
	|ГДЕ
	|	Реквизиты.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК ДатаОснования,
	|	Реквизиты.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА Реквизиты.Контрагент.ОбособленноеПодразделение
	|				И Реквизиты.Контрагент.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Реквизиты.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ Реквизиты.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	&ПустоеПодразделение КАК Подразделение,
	|	"""" КАК ЦифровойИндексОбособленногоПодразделения,
	|	ВЫБОР
	|		КОГДА Реквизиты.Поставщик.ОбособленноеПодразделение
	|				И Реквизиты.Поставщик.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Реквизиты.Поставщик.ГоловнойКонтрагент
	|		ИНАЧЕ Реквизиты.Поставщик
	|	КОНЕЦ КАК Поставщик,
	|	Реквизиты.Поставщик.ИНН КАК ИННпоставщика,
	|	Реквизиты.Поставщик КАК ОбособленноеПодразделениеПоставщика,
	|	""он же"" КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА Реквизиты.Организация.ОбособленноеПодразделение
	|			ТОГДА Реквизиты.Организация.ГоловнаяОрганизация
	|		ИНАЧЕ Реквизиты.Организация
	|	КОНЕЦ КАК Покупатель,
	|	Реквизиты.Организация.ИНН КАК ИННпокупателя,
	|	Реквизиты.Организация КАК ОбособленноеПодразделениеПокупателя,
	|	Реквизиты.Организация КАК Грузополучатель,
	|	Реквизиты.ВалютаДокумента КАК Валюта,
	|	Реквизиты.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	Реквизиты.ДоговорКонтрагента.РасчетыВУсловныхЕдиницах КАК РасчетыВУсловныхЕдиницах,
	|	Реквизиты.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	Реквизиты.ДоговорКонтрагента.Представление КАК Основание,
	|	Реквизиты.ДоговорКонтрагента.Дата КАК ОснованиеДата,
	|	Реквизиты.ДоговорКонтрагента.Номер КАК ОснованиеНомер,
	|	ЛОЖЬ КАК ЕстьТовары,
	|	"""" КАК АдресДоставки,
	|	"""" КАК СведенияОТранспортировкеИГрузе,
	|	НЕОПРЕДЕЛЕНО КАК ОтветственныйЗаОформление,
	|	"""" КАК СопроводительныеДокументы,
	|	НЕОПРЕДЕЛЕНО КАК Перевозчик,
	|	ЛОЖЬ КАК ПеревозкаАвтотранспортом
	|ИЗ
	|	ВТ_Реквизиты КАК Реквизиты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК НомерТабЧасти,
	|	ТаблицаТовары.НомерСтроки КАК НомерСтроки,
	|	"""" КАК Товар,
	|	"""" КАК ТоварКод,
	|	"""" КАК ТоварАртикул,
	|	"""" КАК ТоварНаименование,
	|	"""" КАК СтранаПроисхождения,
	|	"""" КАК ПредставлениеСтраны,
	|	"""" КАК НомерГТД,
	|	"""" КАК ПредставлениеГТД,
	|	"""" КАК РегистрационныйНомерТД,
	|	"""" КАК ЕдиницаИзмерения,
	|	0 КАК Количество,
	|	0 КАК Цена,
	|	ТаблицаТовары.Сумма КАК Сумма,
	|	ТаблицаТовары.СуммаНДС КАК СуммаНДС,
	|	ТаблицаТовары.СтавкаНДС КАК СтавкаНДС,
	|	ЛОЖЬ КАК ЭтоУслуга,
	|	ИСТИНА КАК СуммаВключаетНДС,
	|	ТаблицаТовары.Ссылка КАК Ссылка,
	|	ЛОЖЬ КАК ЭтоКомиссия,
	|	ТаблицаТовары.Сумма КАК ВсегоРуб,
	|	ТаблицаТовары.СуммаНДС КАК НДСРуб,
	|	ТаблицаТовары.Сумма - ТаблицаТовары.СуммаНДС КАК СуммаБезНДСРуб,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК КонтрагентСводныйСФ,
	|	НЕОПРЕДЕЛЕНО КАК ПериодичностьУслуги,
	|	ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка) КАК ТоварКодТНВЭД
	|ПОМЕСТИТЬ ТаблицаДокумента
	|ИЗ
	|	Документ.СчетФактураПолученный.Авансы КАК ТаблицаТовары
	|ГДЕ
	|	ТаблицаТовары.Ссылка = &ДокументОснование
	|	И (ТаблицаТовары.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАванс)
	|			ИЛИ ТаблицаТовары.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАвансКомитента))";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета();

КонецФункции

Функция ПолучитьДополнительныеРеквизитыДляРеестра() Экспорт
	
	Результат = Новый Структура("Информация, Номер", "Контрагент", "ПредставлениеНомера");
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ОбработчикиСобытий

// Открываемая форма документа определяется в зависимости от указанного вида счета-фактуры
//
Процедура ОбработкаПолученияФормы(ВидФормы, Параметры, ВыбраннаяФорма, ДополнительнаяИнформация, СтандартнаяОбработка)
	
	Если ВидФормы = "ФормаСписка"
		ИЛИ ВидФормы = "ФормаВыбора" Тогда
		Возврат;
	КонецЕсли;
	
	ИсправлениеСобственнойОшибки = Ложь;
	БланкСтрогойОтчетности = Ложь;
	
	Если Параметры.Свойство("Ключ") И ЗначениеЗаполнено(Параметры.Ключ) Тогда
		РеквизитыСчетаФактуры = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			Параметры.Ключ, "ВидСчетаФактуры, БланкСтрогойОтчетности, ИсправлениеСобственнойОшибки");
		ВидСчетаФактуры             = РеквизитыСчетаФактуры.ВидСчетаФактуры;
		БланкСтрогойОтчетности      = РеквизитыСчетаФактуры.БланкСтрогойОтчетности;
		ИсправлениеСобственнойОшибки = РеквизитыСчетаФактуры.ИсправлениеСобственнойОшибки;
	ИначеЕсли Параметры.Свойство("ЗначенияЗаполнения") 
		И ТипЗнч(Параметры.ЗначенияЗаполнения) = Тип("Структура")
		И Параметры.ЗначенияЗаполнения.Свойство("ВидСчетаФактуры") Тогда 
		ВидСчетаФактуры = Параметры.ЗначенияЗаполнения.ВидСчетаФактуры;
		Если Параметры.ЗначенияЗаполнения.Свойство("ИсправлениеСобственнойОшибки") Тогда 
			ИсправлениеСобственнойОшибки = Параметры.ЗначенияЗаполнения.ИсправлениеСобственнойОшибки;
		КонецЕсли;
	ИначеЕсли Параметры.Свойство("ЗначениеКопирования") 
		И ЗначениеЗаполнено(Параметры.ЗначениеКопирования)
		И ТипЗнч(Параметры.ЗначениеКопирования) = Тип("ДокументСсылка.СчетФактураПолученный") Тогда 
		ВидСчетаФактуры = Параметры.ЗначениеКопирования.ВидСчетаФактуры;
	ИначеЕсли Параметры.Свойство("Основание") 
		И ЗначениеЗаполнено(Параметры.Основание) Тогда
		ВидСчетаФактуры = УчетНДСПереопределяемый.ОпределитьВидСчетаФактурыПолученногоПоТипуОснования(Параметры.Основание);
		Если Параметры.Свойство("ИсправлениеСобственнойОшибки") Тогда 
			ИсправлениеСобственнойОшибки = Параметры.ИсправлениеСобственнойОшибки;
		КонецЕсли;
	Иначе
		ВидСчетаФактуры = Неопределено;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	Если ВидСчетаФактуры = Неопределено Тогда
		ВыбраннаяФорма = "ФормаДокумента";
	ИначеЕсли ИсправлениеСобственнойОшибки Тогда
		ВыбраннаяФорма = "ФормаДокументаИсправлениеСобственнойОшибки";
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс Тогда
		ВыбраннаяФорма = "ФормаДокументаНаАванс";
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
		ВыбраннаяФорма = "ФормаДокументаНаАванс";
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАвансКомитента Тогда
		ВыбраннаяФорма = "ФормаДокументаНаАванс";
	ИначеЕсли ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
		ВыбраннаяФорма = "ФормаДокументаКорректировочный";
	ИначеЕсли БланкСтрогойОтчетности Тогда
		ВыбраннаяФорма = "ФормаДокументаБланкСтрогойОтчетности";
	Иначе
		ВыбраннаяФорма = "ФормаДокументаНаПоступление";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СозданиеАктуализацияСчетаФактуры

Функция СоздатьДокументНаОсновании(Основание, НомерСчетаФактурыПолученного, ДатаСчетаФактурыПолученного, Продавец = Неопределено, ОбновлятьСтатусСчетаФактурыПоДокументу = Истина) Экспорт
	
	СчетФактура = Документы.СчетФактураПолученный.СоздатьДокумент();
	
	МетаданныеОснования = Основание.Метаданные();
	Если НЕ СчетФактура.Метаданные().ВводитсяНаОсновании.Содержит(МетаданныеОснования) Тогда
		ТекстШаблона = НСтр("ru='Полученный счет-фактуру нельзя зарегистрировать на основании документа ""%1""'");
		ТекстОшибки  = СтрШаблон(ТекстШаблона, МетаданныеОснования.Синоним);
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	СчетФактура.Заполнить(Основание);
	
	СчетФактура.НомерВходящегоДокумента = НомерСчетаФактурыПолученного;
	СчетФактура.ДатаВходящегоДокумента = ДатаСчетаФактурыПолученного;
	СчетФактура.Дата = Макс(ДатаСчетаФактурыПолученного, Основание.Дата);
	
	Если ЗначениеЗаполнено(Продавец) Тогда
		СчетФактура.Продавец = Продавец;
	КонецЕсли;
	
	РежимЗаписи = ?(Основание.Проведен, 
		РежимЗаписиДокумента.Проведение, 
		РежимЗаписиДокумента.Запись);
		
	Если НЕ ОбновлятьСтатусСчетаФактурыПоДокументу Тогда 
		// Передаем документ-основание по которому уже установлен статус счета-фактуры для того, 
		// чтобы счет-фактура не актуализировал статус повторно.
		СчетФактура.ДополнительныеСвойства.Вставить("ДокументСУстановленнымСтатусом", Основание)
	КонецЕсли;
			
	СчетФактура.Записать(РежимЗаписи);
	
	Возврат СчетФактура.Ссылка;
	
КонецФункции

Функция СоздатьДокументНаОснованииИсправления(Основание, НомерИсправления, ДатаИсправления) Экспорт
	
	СчетФактура = Документы.СчетФактураПолученный.СоздатьДокумент();
	
	СчетФактура.Заполнить(Основание);
	
	СчетФактура.НомерИсправления = НомерИсправления;
	СчетФактура.ДатаИсправления = ДатаИсправления;
	СчетФактура.Дата = Макс(ДатаИсправления, Основание.Дата);
	
	РежимЗаписи = ?(Основание.Проведен, 
		РежимЗаписиДокумента.Проведение, 
		РежимЗаписиДокумента.Запись);
	
	СчетФактура.Записать(РежимЗаписи);
	
	Возврат СчетФактура.Ссылка;
	
КонецФункции

// Создает или актуализирует счет-фактуру с признаком "Исправление собственной ошибки"
//
// Параметры:
//   Параметры - Структура - структура входных параметров с ключами:
//     * ДокументОснование         - ДокументСсылка.КорректировкаПоступления - основание создаваемого (актуализируемого) счета-фактуры
//     * СчетФактураИсправляемый   - ДокументСсылка.СчетФактураПолученный - исправляемый счет-фактура, 
//                                   тот в котором допустили ошибку ввода, 
//     * СчетФактура               - ДокументСсылка.СчетФактураПолученный - актуализируемый счет-фактура
//                                   если значение не заполнено - будет создан
//     * НомерСчетаФактуры         - Строка, Число - номер входящего счета-фактуры или номер исправления
//     * ДатаСчетаФактуры          - Дата          - дата входящего счета-фактуры или дата исправления
//     * КодВидаОперации           - Срока
//     * ИННКонтрагентаДоИзменения - Строка 10 или 12 символов
//     * КППКонтрагентаДоИзменения - Строка 9 символов
//     * ИННКонтрагента            - Строка 10 или 12 символов
//     * КППКонтрагента            - Строка 9 символов
//
// Возвращаемое значение:
//   ДокументСсылка.СчетФактураПолученный - ссылка на созданный или актуализированный документ
//
//
Функция СоздатьАктуализироватьИсправлениеСобственнойОшибки(Параметры) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Параметры.ДокументОснование)
		ИЛИ НЕ ЗначениеЗаполнено(Параметры.СчетФактураИсправляемый) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("СчетФактураИсправляемый", Параметры.СчетФактураИсправляемый);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Организация,
	|	СчетФактураПолученный.ВидСчетаФактуры,
	|	СчетФактураПолученный.Контрагент,
	|	СчетФактураПолученный.ДоговорКонтрагента,
	|	СчетФактураПолученный.НомерВходящегоДокумента,
	|	СчетФактураПолученный.ДатаВходящегоДокумента,
	|	СчетФактураПолученный.Исправление,
	|	СчетФактураПолученный.НомерИсправления,
	|	СчетФактураПолученный.ДатаИсправления,
	|	СчетФактураПолученный.КодВидаОперации,
	|	СчетФактураПолученный.КодВидаОперацииНаУменьшение,
	|	СчетФактураПолученный.ВалютаДокумента,
	|	СчетФактураПолученный.Продавец
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &СчетФактураИсправляемый";
	
	ДанныеИсходногоСчетаФактуры = Запрос.Выполнить();
	Если ДанныеИсходногоСчетаФактуры.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаИсходногоСчетаФактуры = ДанныеИсходногоСчетаФактуры.Выгрузить();
	РеквизитыИсходногоСчетаФактуры = ТаблицаИсходногоСчетаФактуры[0];
	
	РеквизитыДокументаОснования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Параметры.ДокументОснование,
		"Дата,Проведен,ДокументПоступления");
	
	Если ЗначениеЗаполнено(Параметры.СчетФактура) Тогда
		СчетФактура = Параметры.СчетФактура.ПолучитьОбъект();
	Иначе
		
		// Возможно исходный счет-фактура был введен к нескольким документам поступления
		// такой счет-фактура исправляется несколькими корректировками поступления
		// перед созданием нового счета-фактуры необходимо убедиться, что серия исправлений
		// уже не начата - поискать счет-фактуру с признаком "Исправление собственной ошибки"
		// у которого "ИсправляемыйСчетФактура" равен исходному,
		// но при этом исправляемый документ поступления другой.
		
		Запрос.УстановитьПараметр("ИсправляемыйДокументПоступления", РеквизитыДокументаОснования.ДокументПоступления);
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СчетФактураПолученный.Ссылка КАК РанееСозданныйСчетФактура
		|ПОМЕСТИТЬ РанееСозданныеСчетаФактуры
		|ИЗ
		|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
		|ГДЕ
		|	СчетФактураПолученный.ИсправлениеСобственнойОшибки
		|	И СчетФактураПолученный.ИсправляемыйСчетФактура = &СчетФактураИсправляемый
		|	И НЕ СчетФактураПолученный.ПометкаУдаления
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	РанееСозданныйСчетФактура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	РанееСозданныеСчетаФактуры.РанееСозданныйСчетФактура
		|ИЗ
		|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПоступления КАК КорректировкаПоступления
		|		ПО ДокументыОснования.ДокументОснование = КорректировкаПоступления.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РанееСозданныеСчетаФактуры КАК РанееСозданныеСчетаФактуры
		|		ПО ДокументыОснования.Ссылка = РанееСозданныеСчетаФактуры.РанееСозданныйСчетФактура
		|ГДЕ
		|	КорректировкаПоступления.ДокументПоступления <> &ИсправляемыйДокументПоступления";
		
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			СчетФактура = Документы.СчетФактураПолученный.СоздатьДокумент();
		Иначе
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			СчетФактура = Выборка.РанееСозданныйСчетФактура.ПолучитьОбъект();
		КонецЕсли;
		
		// Перенесем продавцов из исправляемого счета-фактуры
		Запрос.Текст = ТекстЗапросаПродавцыПоИсправляемомуСчетуФактуре();
		
		Продавцы = Запрос.Выполнить().Выгрузить();
		Для Каждого ПродавецИсходный Из Продавцы Цикл
			НоваяСтрока = СчетФактура.Продавцы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ПродавецИсходный);
		КонецЦикла;
		
	КонецЕсли;
	
	// Общие свойства
	СчетФактура.ИсправлениеСобственнойОшибки = Истина;
	СчетФактура.ИсправляемыйСчетФактура = Параметры.СчетФактураИсправляемый;
	
	// Заполним новый документ на основании исправляемого
	ЗаполнитьЗначенияСвойств(СчетФактура, РеквизитыИсходногоСчетаФактуры);
	
	СчетФактура.НомерВходящегоДокументаДоИзменения     = РеквизитыИсходногоСчетаФактуры.НомерВходящегоДокумента;
	СчетФактура.ДатаВходящегоДокументаДоИзменения      = РеквизитыИсходногоСчетаФактуры.ДатаВходящегоДокумента;
	СчетФактура.НомерИсправленияДоИзменения            = РеквизитыИсходногоСчетаФактуры.НомерИсправления;
	СчетФактура.ДатаИсправленияДоИзменения             = РеквизитыИсходногоСчетаФактуры.ДатаИсправления;
	СчетФактура.КодВидаОперацииДоИзменения             = РеквизитыИсходногоСчетаФактуры.КодВидаОперации;
	СчетФактура.КодВидаОперацииНаУменьшениеДоИзменения = РеквизитыИсходногоСчетаФактуры.КодВидаОперацииНаУменьшение;
	
	// Реквизиты, введенные в корректировке поступления
	Если РеквизитыИсходногоСчетаФактуры.Исправление Тогда
		СчетФактура.НомерИсправления = Параметры.НомерСчетаФактуры;
		СчетФактура.ДатаИсправления  = Параметры.ДатаСчетаФактуры;
	Иначе
		СчетФактура.НомерВходящегоДокумента = Параметры.НомерСчетаФактуры;
		СчетФактура.ДатаВходящегоДокумента  = Параметры.ДатаСчетаФактуры;
	КонецЕсли;
	
	СчетФактура.КодВидаОперации             = Параметры.КодВидаОперации;
	СчетФактура.КодВидаОперацииНаУменьшение = Параметры.КодВидаОперацииНаУменьшение;
	СчетФактура.ИННКонтрагента              = Параметры.ИННКонтрагента;
	СчетФактура.КППКонтрагента              = Параметры.КППКонтрагента;
	СчетФактура.ИННКонтрагентаДоИзменения   = Параметры.ИННКонтрагентаДоИзменения;
	СчетФактура.КППКонтрагентаДоИзменения   = Параметры.КППКонтрагентаДоИзменения;
	
	// Документ-основание
	// Исключим повторное добавление основания при актуализации
	Если СчетФактура.ДокументыОснования.Количество() = 0
		ИЛИ СчетФактура.ДокументыОснования.Найти(Параметры.ДокументОснование, "ДокументОснование") = Неопределено Тогда
		
		СтрокаОснования = СчетФактура.ДокументыОснования.Добавить();
		СтрокаОснования.ДокументОснование = Параметры.ДокументОснование;
		
		// Если ошибка исправляется в корректировочном счете-фактуре определим реквизиты корректируемого счета-фактуры
		Если РеквизитыИсходногоСчетаФактуры.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный Тогда
			
			Запрос.УстановитьПараметр("ИсправляемыйДокументПоступления", РеквизитыДокументаОснования.ДокументПоступления);
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ДокументыОснования.НомерИсходногоДокумента,
			|	ДокументыОснования.ДатаИсходногоДокумента,
			|	ДокументыОснования.УчитыватьИсправлениеИсходногоДокумента,
			|	ДокументыОснования.НомерИсправленияИсходногоДокумента,
			|	ДокументыОснования.ДатаИсправленияИсходногоДокумента
			|ИЗ
			|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
			|ГДЕ
			|	ДокументыОснования.Ссылка = &СчетФактураИсправляемый
			|	И ДокументыОснования.ДокументОснование = &ИсправляемыйДокументПоступления";
			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				РеквизитыКорректируемогоСчетаФактуры = Результат.Выгрузить();
				ЗаполнитьЗначенияСвойств(СтрокаОснования, РеквизитыКорректируемогоСчетаФактуры[0]);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	СчетФактура.Дата = РеквизитыДокументаОснования.Дата;
	РежимЗаписи = ?(РеквизитыДокументаОснования.Проведен, 
		РежимЗаписиДокумента.Проведение, 
		РежимЗаписиДокумента.Запись);
	
	СчетФактура.Записать(РежимЗаписи);
	
	Возврат СчетФактура.Ссылка;
	
КонецФункции

#КонецОбласти

#Область ОбработчикиОбновления

// Обработчик обновления 3.0.23.7
//
// Отбираются все счета-фактуры полученные - исправления поступления и корректировочные
// у которых не заполнен реквизит ИсправляемыйСчетФактура для установки значения данного реквизита 
// Необходимо при переходе с 2.0 в случае когда исправлялся документ поступления
Процедура ОбработатьСчетаФактурыИзПредыдущейВерсии() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	ВЫБОР
	|			КОГДА СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаПоступление)
	|						И СчетФактураПолученный.Исправление
	|					ИЛИ СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|				ТОГДА ВЫБОР
	|						КОГДА СчетФактураПолученный.ИсправляемыйСчетФактура = ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка)
	|							ТОГДА ИСТИНА
	|						ИНАЧЕ ЛОЖЬ
	|					КОНЕЦ
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|	И СчетФактураПолученный.ПометкаУдаления = ЛОЖЬ";
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			ОбрабатываемыйСчетФактура = Выборка.Ссылка;
			
			Если ОбрабатываемыйСчетФактура.ДокументыОснования.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ОбъектСчетФактура = ОбрабатываемыйСчетФактура.ПолучитьОбъект();
			
			Если ТипЗнч(ОбъектСчетФактура.ДокументыОснования[0].ДокументОснование) = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
				РезультатПоискаИсправляемыйСчетФактура = УчетНДСПереопределяемый.НайтиПодчиненныйСчетФактуруПолученный(
				ОбъектСчетФактура.ДокументыОснования[0].ДокументОснование.ИсправляемыйДокументПоступления);
				Если РезультатПоискаИсправляемыйСчетФактура = Неопределено Тогда
					РезультатПоискаИсправляемыйСчетФактура = Документы.СчетФактураВыданный.ПустаяСсылка();
				КонецЕсли;
			Иначе
				РезультатПоискаИсправляемыйСчетФактура = Документы.СчетФактураПолученный.ПустаяСсылка();
			КонецЕсли;
			
			ОбъектСчетФактура.ИсправляемыйСчетФактура = РезультатПоискаИсправляемыйСчетФактура;
			ОбъектСчетФактура.ОбменДанными.Загрузка = Истина;
			
			НачатьТранзакцию();
			
			Попытка
				ОбъектСчетФактура.Записать();
			Исключение
				ТекстОшибки = НСтр("ru = 'Не удалось записать документ.
                                    |%1'");
				ОписаниеОшибки = СтрШаблон(ТекстОшибки, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), 
					УровеньЖурналаРегистрации.Ошибка,
					ОбъектСчетФактура.Метаданные(),
					ОбъектСчетФактура.Ссылка, 
					ОписаниеОшибки);
					
				ОтменитьТранзакцию();
			КонецПопытки;
			
			ЗафиксироватьТранзакцию();
			
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

// Обработчик обновления 3.0.24.1
//
// Для всех счетов-фактур полученных устанавливается реквизит ПредставлениеНомера
// Для корректировочных счетов-фактур переопределяется СуммаДокумента и СуммаНДСДокумента
Процедура ОбработатьНомераИСуммыСчетаФактуры() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА КорректировкаПоступленияТовары.Ссылка.СуммаВключаетНДС
	|				ТОГДА КорректировкаПоступленияТовары.Сумма
	|			ИНАЧЕ КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС
	|		КОНЕЦ) КАК СуммаДокумента,
	|	СУММА(КорректировкаПоступленияТовары.СуммаНДС) КАК СуммаНДСДокумента,
	|	КорректировкаПоступленияТовары.Ссылка КАК Документ
	|ПОМЕСТИТЬ ВТ_ОснованияКоррСФ
	|ИЗ
	|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
	|
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаПоступленияТовары.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА КорректировкаПоступленияУслуги.Ссылка.СуммаВключаетНДС
	|				ТОГДА КорректировкаПоступленияУслуги.Сумма
	|			ИНАЧЕ КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС
	|		КОНЕЦ),
	|	СУММА(КорректировкаПоступленияУслуги.СуммаНДС),
	|	КорректировкаПоступленияУслуги.Ссылка
	|ИЗ
	|	Документ.КорректировкаПоступления.Услуги КАК КорректировкаПоступленияУслуги
	|
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаПоступленияУслуги.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА КорректировкаПоступленияАгентскиеУслуги.Ссылка.СуммаВключаетНДС
	|				ТОГДА КорректировкаПоступленияАгентскиеУслуги.Сумма
	|			ИНАЧЕ КорректировкаПоступленияАгентскиеУслуги.Сумма + КорректировкаПоступленияАгентскиеУслуги.СуммаНДС
	|		КОНЕЦ),
	|	СУММА(КорректировкаПоступленияАгентскиеУслуги.СуммаНДС),
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка
	|ИЗ
	|	Документ.КорректировкаПоступления.АгентскиеУслуги КАК КорректировкаПоступленияАгентскиеУслуги
	|
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученныйДокументыОснования.Ссылка КАК Ссылка,
	|	СУММА(ЕСТЬNULL(ВТ_ОснованияКоррСФ.СуммаНДСДокумента, 0)) КАК СуммаНДСДокумента,
	|	СУММА(ЕСТЬNULL(ВТ_ОснованияКоррСФ.СуммаДокумента, 0)) КАК СуммаДокумента
	|ПОМЕСТИТЬ ВТ_СуммыКорректировочныхСФ
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОснованияКоррСФ КАК ВТ_ОснованияКоррСФ
	|		ПО СчетФактураПолученныйДокументыОснования.ДокументОснование = ВТ_ОснованияКоррСФ.Документ
	|ГДЕ
	|	СчетФактураПолученныйДокументыОснования.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|
	|СГРУППИРОВАТЬ ПО
	|	СчетФактураПолученныйДокументыОснования.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка,
	|	ВЫБОР
	|		КОГДА СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА ВТ_СуммыКорректировочныхСФ.СуммаНДСДокумента
	|		ИНАЧЕ СчетФактураПолученный.СуммаНДСДокумента
	|	КОНЕЦ КАК СуммаНДСДокументаПосле,
	|	ВЫБОР
	|		КОГДА СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА ВТ_СуммыКорректировочныхСФ.СуммаДокумента
	|		ИНАЧЕ СчетФактураПолученный.СуммаДокумента
	|	КОНЕЦ КАК СуммаДокументаПосле,
	|	ВЫБОР
	|		КОГДА СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Корректировочный,
	|	СчетФактураПолученный.СуммаДокумента КАК СуммаДокументаДо,
	|	СчетФактураПолученный.СуммаНДСДокумента КАК СуммаНДСДокументаДо,
	|	СчетФактураПолученный.ПредставлениеНомера
	|ПОМЕСТИТЬ ВТ_СчетаФактурыПредварительная
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммыКорректировочныхСФ КАК ВТ_СуммыКорректировочныхСФ
	|		ПО (ВТ_СуммыКорректировочныхСФ.Ссылка = СчетФактураПолученный.Ссылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СчетаФактурыПредварительная.Ссылка,
	|	ВТ_СчетаФактурыПредварительная.СуммаНДСДокументаПосле КАК СуммаНДСДокумента,
	|	ВТ_СчетаФактурыПредварительная.СуммаДокументаПосле КАК СуммаДокумента,
	|	ВТ_СчетаФактурыПредварительная.Корректировочный
	|ИЗ
	|	ВТ_СчетаФактурыПредварительная КАК ВТ_СчетаФактурыПредварительная
	|ГДЕ
	|	(ВТ_СчетаФактурыПредварительная.ПредставлениеНомера = """"
	|			ИЛИ ВТ_СчетаФактурыПредварительная.СуммаДокументаДо <> ВТ_СчетаФактурыПредварительная.СуммаДокументаПосле
	|			ИЛИ ВТ_СчетаФактурыПредварительная.СуммаНДСДокументаДо <> ВТ_СчетаФактурыПредварительная.СуммаНДСДокументаПосле)";
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			ОбрабатываемыйСчетФактура = Выборка.Ссылка;
			
			ОбъектСчетФактура = ОбрабатываемыйСчетФактура.ПолучитьОбъект();
			
			Если Выборка.Корректировочный Тогда
				ЗаполнитьЗначенияСвойств(ОбъектСчетФактура, Выборка); 
			КонецЕсли;
			
			ОбъектСчетФактура.ОбменДанными.Загрузка = Истина;
			
			НачатьТранзакцию();
			
			Попытка
				ОбъектСчетФактура.Записать();
			Исключение
				ТекстОшибки = НСтр("ru = 'Не удалось записать документ.
                                    |%1'");
				ОписаниеОшибки = СтрШаблон(ТекстОшибки, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), 
					УровеньЖурналаРегистрации.Ошибка,
					ОбъектСчетФактура.Метаданные(),
					ОбъектСчетФактура.Ссылка, 
					ОписаниеОшибки);
					
				ОтменитьТранзакцию();
			КонецПопытки;
			
			ЗафиксироватьТранзакцию();
			
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

// Обработчик обновления
//
//Устанавливает новый код вида операции для сводных счетов-фактур по комиссии
Процедура УстановитьКодВидаОперацииСводныйКомиссионный() Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка КАК Ссылка,
	|	""27"" КАК КодВидаОперации,
	|	ВЫБОР
	|		КОГДА СчетФактураПолученный.КодВидаОперации = ""27""
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК КодУстановлен
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	(СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаПоступление)
	|			ИЛИ СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.Корректировочный))
	|	И СчетФактураПолученный.ПометкаУдаления = ЛОЖЬ
	|	И СчетФактураПолученный.СводныйКомиссионный = ИСТИНА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка,
	|	""28"",
	|	ВЫБОР
	|		КОГДА СчетФактураПолученный.КодВидаОперации = ""28""
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	(СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАванс)
	|			ИЛИ СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.НаАвансКомитента))
	|	И СчетФактураПолученный.ПометкаУдаления = ЛОЖЬ
	|	И СчетФактураПолученный.СводныйКомиссионный = ИСТИНА
	|ИТОГИ
	|	СУММА(КодУстановлен)
	|ПО
	|	ОБЩИЕ";
	
	ВыборкаИтоги = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Если ВыборкаИтоги.Следующий()
		И ВыборкаИтоги.КодУстановлен = 0 Тогда
		ВыборкаДокументы = ВыборкаИтоги.Выбрать();
		Пока ВыборкаДокументы.Следующий() Цикл
			СчетФактураДокумент = ВыборкаДокументы.Ссылка.ПолучитьОбъект();
			СчетФактураДокумент.КодВидаОПерации = ВыборкаДокументы.КодВидаОперации;
			ОбновлениеИнформационнойБазы.ЗаписатьДанные(СчетФактураДокумент);
		КонецЦикла;
	Иначе
		Возврат;
	КонецЕсли;
		
КонецПроцедуры

// Обработчик обновления 3.0.66.3
// Функция для обработчика обновления.
// Обрабатывает счет-фактуры полученные без НДС и переносит из документа основания движения по регистру НДС предъявленный
// в документ счет-фактура полученный.
Процедура ОбработкаСчетФактурПолученныхБезНДС(Параметры) Экспорт

	Параметры.ОбработкаЗавершена = Ложь;
	СФВыборкаВыполненаПолностью = Ложь;
	// Обработка счет-фактур с нулевым НДС.
	ТаблицаСФВыборка = СписокСчетовФактурПолученных();
	Если ТаблицаСФВыборка.Количество() = 0 Тогда
		СФВыборкаВыполненаПолностью = Истина;
	КонецЕсли;
	
	Пока ТаблицаСФВыборка.Следующий() Цикл
	
		ДокументСсылкаСФ = ТаблицаСФВыборка.Сф;

			ВыборкаПоРегистратору = ТаблицаСФВыборка.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоРегистратору.Следующий() Цикл
				ДокументОснованиеСсылка = ВыборкаПоРегистратору.Регистратор;
				
				НачатьТранзакцию();
				Попытка
					Блокировка = Новый БлокировкаДанных;
					ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НДСПредъявленный.НаборЗаписей");
					ЭлементБлокировки.УстановитьЗначение("Регистратор", ДокументСсылкаСФ);
					ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НДСПредъявленный.НаборЗаписей");
					ЭлементБлокировки.УстановитьЗначение("Регистратор", ДокументОснованиеСсылка);
					Блокировка.Заблокировать();
				
					НаборЗаписейНДСПредъявленныйДокументаОснования = РегистрыНакопления.НДСПредъявленный.СоздатьНаборЗаписей();
					НаборЗаписейНДСПредъявленныйДокументаОснования.Отбор.Регистратор.Установить(ДокументОснованиеСсылка);
					НаборЗаписейНДСПредъявленныйДокументаОснования.Прочитать();
			
					Если НаборЗаписейНДСПредъявленныйДокументаОснования.Количество() = 0 Тогда
						ОтменитьТранзакцию();
						Продолжить;
					КонецЕсли;
			
					Если ДобавитьДвиженияНДСПредъявленный(ДокументСсылкаСФ, НаборЗаписейНДСПредъявленныйДокументаОснования) Тогда
						УдалитьДвиженияНДСПредъявленный(НаборЗаписейНДСПредъявленныйДокументаОснования);
					КонецЕсли;
					
					ЗафиксироватьТранзакцию();
				Исключение
					ОтменитьТранзакцию();
				
					ШаблонСообщения	= НСтр("ru = 'Не выполнено обновление записей регистра накопления ""НДС предъявленый""
									|%1'");
					ТекстСообщения = СтрШаблон(ШаблонСообщения, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
					ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), 
					УровеньЖурналаРегистрации.Ошибка,
					Метаданные.РегистрыНакопления.НДСПредъявленный,, 
					ТекстСообщения);
				КонецПопытки;
					
					
			КонецЦикла;
			
	КонецЦикла;
	
	// Обработка не закрытых записей: НДС предъявленный
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДСПредъявленныйОстатки.СчетФактура КАК СчетФактура,
	|	СУММА(НДСПредъявленныйОстатки.НДСОстаток) КАК НДСОстаток,
	|	СУММА(НДСПредъявленныйОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДСОстаток
	|ПОМЕСТИТЬ ТаблицаОстатков
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный.Остатки(, ) КАК НДСПредъявленныйОстатки
	|ГДЕ
	|	НДСПредъявленныйОстатки.НДСОстаток = 0
	|	И (НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ПоступлениеДопРасходов
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ОтражениеНДСКВычету
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ПоступлениеНМА
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ПоступлениеИзПереработки
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ВыкупПредметовЛизинга
	|			ИЛИ НДСПредъявленныйОстатки.СчетФактура ССЫЛКА Документ.ВозвратТоваровОтПокупателя)
	|
	|СГРУППИРОВАТЬ ПО
	|	НДСПредъявленныйОстатки.СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаОстатков.СчетФактура КАК СчетФактура,
	|	ТаблицаОстатков.НДСОстаток КАК НДСОстаток,
	|	ТаблицаОстатков.СуммаБезНДСОстаток КАК СуммаБезНДСОстаток
	|ПОМЕСТИТЬ ТаблицаОстатковОграниченная
	|ИЗ
	|	ТаблицаОстатков КАК ТаблицаОстатков
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ТаблицаОстатков.СчетФактура = ДанныеПервичныхДокументов.Документ
	|ГДЕ
	|	ДанныеПервичныхДокументов.ДатаРегистратора >= ДАТАВРЕМЯ(2015, 1, 1, 0, 0, 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА СчетФактураПолученныйДокументыОснования.Ссылка ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		КОГДА НЕ СчетФактураПолученныйДокументыОснования.Ссылка.Проведен
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК НаличиеСчетаФактуры,
	|	ВЫБОР
	|		КОГДА СчетФактураПолученныйДокументыОснования.Ссылка ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьСчетФактура,
	|	ТаблицаОстатковОграниченная.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ТаблицаОстатковССчетФактурами
	|ИЗ
	|	ТаблицаОстатковОграниченная КАК ТаблицаОстатковОграниченная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ПО ТаблицаОстатковОграниченная.СчетФактура = СчетФактураПолученныйДокументыОснования.ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НДСПредъявленный.Регистратор КАК Регистратор,
	|	ТаблицаОстатковССчетФактурами.ЕстьСчетФактура КАК ЕстьСчетФактура,
	|	ВЫБОР
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеТоваровУслуг).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеДопРасходов
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеДопРасходов).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ОтчетКомиссионераОПродажах).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ОтражениеНДСКВычету
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ОтражениеНДСКВычету).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеНМА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеНМА).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеИзПереработки
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеИзПереработки).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ВыкупПредметовЛизинга
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ВыкупПредметовЛизинга).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ВозвратТоваровОтПокупателя
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ВозвратТоваровОтПокупателя).РучнаяКорректировка
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК РучнаяКорректировка
	|ПОМЕСТИТЬ ТаблицаРегистраторов
	|ИЗ
	|	ТаблицаОстатковССчетФактурами КАК ТаблицаОстатковССчетФактурами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|		ПО ТаблицаОстатковССчетФактурами.СчетФактура = НДСПредъявленный.Регистратор
	|ГДЕ
	|	ТаблицаОстатковССчетФактурами.НаличиеСчетаФактуры = ЛОЖЬ
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСПоставщиком)
	|
	|СГРУППИРОВАТЬ ПО
	|	НДСПредъявленный.Регистратор,
	|	ТаблицаОстатковССчетФактурами.ЕстьСчетФактура,
	|	ВЫБОР
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеТоваровУслуг).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеДопРасходов
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеДопРасходов).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ОтчетКомиссионераОПродажах).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ОтражениеНДСКВычету
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ОтражениеНДСКВычету).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеНМА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеНМА).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ПоступлениеИзПереработки
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ПоступлениеИзПереработки).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ВыкупПредметовЛизинга
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ВыкупПредметовЛизинга).РучнаяКорректировка
	|		КОГДА ТаблицаОстатковССчетФактурами.СчетФактура ССЫЛКА Документ.ВозвратТоваровОтПокупателя
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаОстатковССчетФактурами.СчетФактура КАК Документ.ВозвратТоваровОтПокупателя).РучнаяКорректировка
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаРегистраторов.Регистратор КАК Регистратор,
	|	ТаблицаРегистраторов.ЕстьСчетФактура КАК ЕстьСчетФактура,
	|	ДанныеПервичныхДокументов.ДатаРегистратора КАК Дата
	|ПОМЕСТИТЬ ТаблицаРегистраторовСФ
	|ИЗ
	|	ТаблицаРегистраторов КАК ТаблицаРегистраторов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ТаблицаРегистраторов.Регистратор = ДанныеПервичныхДокументов.Документ
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаРегистраторов.Регистратор, 0) <> 0
	|	И ТаблицаРегистраторов.РучнаяКорректировка = ЛОЖЬ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаРегистраторовСФ.Регистратор КАК Регистратор,
	|	ТаблицаРегистраторовСФ.ЕстьСчетФактура КАК ЕстьСчетФактура,
	|	ТаблицаРегистраторовСФ.Дата КАК Дата,
	|	СтатусыДокументов.СтатусСчетаФактуры КАК СтатусСчетаФактуры,
	|	СтатусыДокументов.Организация КАК Организация,
	|	СтатусыДокументов.Документ КАК Документ,
	|	СтатусыДокументов.Статус КАК Статус,
	|	СтатусыДокументов.ДополнительныйСтатус КАК ДополнительныйСтатус
	|ПОМЕСТИТЬ ТаблицаРегистраторовСтатус
	|ИЗ
	|	ТаблицаРегистраторовСФ КАК ТаблицаРегистраторовСФ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтатусыДокументов КАК СтатусыДокументов
	|		ПО ТаблицаРегистраторовСФ.Регистратор = СтатусыДокументов.Документ
	|ГДЕ
	|	ТаблицаРегистраторовСФ.Дата >= ДАТАВРЕМЯ(2018, 1, 1, 0, 0, 0)
	|	И ТаблицаРегистраторовСФ.ЕстьСчетФактура = ЛОЖЬ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаРегистраторовСФ.Регистратор КАК Регистратор,
	|	ТаблицаРегистраторовСФ.ЕстьСчетФактура КАК ЕстьСчетФактура,
	|	ТаблицаРегистраторовСФ.Дата КАК Дата,
	|	ТаблицаРегистраторовСтатус.СтатусСчетаФактуры КАК СтатусСчетаФактуры,
	|	ТаблицаРегистраторовСтатус.Организация КАК Организация,
	|	ТаблицаРегистраторовСтатус.Документ КАК Документ,
	|	ТаблицаРегистраторовСтатус.Статус КАК Статус,
	|	ТаблицаРегистраторовСтатус.ДополнительныйСтатус КАК ДополнительныйСтатус
	|ИЗ
	|	ТаблицаРегистраторовСФ КАК ТаблицаРегистраторовСФ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРегистраторовСтатус КАК ТаблицаРегистраторовСтатус
	|		ПО ТаблицаРегистраторовСФ.Регистратор = ТаблицаРегистраторовСтатус.Регистратор";

	ТаблицаНеЗакрытыхПоступлений = Запрос.Выполнить().Выгрузить();

	ВыборкаНеЗакрытыхПоступленийВыполненаПолностью = Ложь;
	Если ТаблицаНеЗакрытыхПоступлений.Количество() = 0 Тогда
		ВыборкаНеЗакрытыхПоступленийВыполненаПолностью = Истина;
	Конецесли;

	Если СФВыборкаВыполненаПолностью И ВыборкаНеЗакрытыхПоступленийВыполненаПолностью Тогда
		Параметры.ОбработкаЗавершена = Истина;
		Возврат;
	КонецЕсли;

	НачатьТранзакцию();
	Попытка
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НДСПредъявленный.НаборЗаписей");
		ЭлементБлокировки.ИсточникДанных = ТаблицаНеЗакрытыхПоступлений;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Регистратор", "Регистратор");
		Блокировка.Заблокировать();

		НаборЗаписейНДСПредъявленный = РегистрыНакопления.НДСПредъявленный.СоздатьНаборЗаписей();

		Для каждого ТекСтрокаТаблицаНеЗакрытыхПоступлений Из ТаблицаНеЗакрытыхПоступлений Цикл

			НаборЗаписейНДСПредъявленный.Отбор.Регистратор.Установить(ТекСтрокаТаблицаНеЗакрытыхПоступлений.Регистратор);
			УдалитьДвиженияНДСПредъявленный(НаборЗаписейНДСПредъявленный);
	
			Если ТекСтрокаТаблицаНеЗакрытыхПоступлений.Дата >= Дата('20180101000000') И НЕ ТекСтрокаТаблицаНеЗакрытыхПоступлений.ЕстьСчетФактура Тогда
				
				Если ТекСтрокаТаблицаНеЗакрытыхПоступлений.СтатусСчетаФактуры <> Перечисления.СтатусыСчетаФактуры.НеТребуется Тогда
					НаборЗаписейСтатусыДокументов = РегистрыСведений.СтатусыДокументов.СоздатьНаборЗаписей();
					Запись = НаборЗаписейСтатусыДокументов.Добавить();
					ЗаполнитьЗначенияСвойств(Запись, ТекСтрокаТаблицаНеЗакрытыхПоступлений);
					Запись.СтатусСчетаФактуры = Перечисления.СтатусыСчетаФактуры.НеТребуется;
					НаборЗаписейСтатусыДокументов.Отбор.Документ.Установить(ТекСтрокаТаблицаНеЗакрытыхПоступлений.Документ);
					ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписейСтатусыДокументов, Истина);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;

		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
			
		ШаблонСообщения = НСтр("ru = 'Не выполнено обновление записей регистра накопления ""НДС предъявленый""
			|%1'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗаписьЖурналаРегистрации(
			ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), 
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.РегистрыНакопления.НДСПредъявленный,, 
			ТекстСообщения);
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область ФормированиеДвижений

// Процедура формирует движения по вычету НДС по выданным авансам, вызывается Из документа СчетФактураПолученный
//
Процедура СформироватьДвиженияПолученСчетФактураНаВыданныйАванс(ТаблицаРеквизиты, ТаблицаАвансов, ТаблицаСторноНаВыданныйАванс, Движения, Отказ) Экспорт
	
	Если Не ЗначениеЗаполнено(ТаблицаРеквизиты) Тогда
		Возврат;
	КонецЕсли;
	
	Реквизиты = ТаблицаРеквизиты[0];
	
	Если Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.НаАванс Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыПолученСчетФактураНаВыданныйАванс(
		ТаблицаРеквизиты, ТаблицаАвансов, ТаблицаСторноНаВыданныйАванс);
		
	Реквизиты = Параметры.Реквизиты[0];
	
	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация, Реквизиты.Период);
	
	Если УпрощенныйУчетНДС ИЛИ ВерсияУчетаНДС = 2 Тогда
		
		Если Реквизиты.НДСИсчисляетсяНалоговымАгентом Тогда
			ОбратноеНачислениеНДС.СформироватьДвиженияСчетФактураНаВыданныйАванс(
				Реквизиты, Параметры.Авансы, Движения, Отказ);
		КонецЕсли;
		
		СформироватьПроводкиВычетНДСВыданныйАванс(Реквизиты, Параметры.СторноАвансов, Движения, Отказ);
		СформироватьДвиженияНДСЗаписиКнигиПокупокВыданныйАванс(Реквизиты, Параметры.СторноАвансов, Движения, Отказ);
		
		Если Реквизиты.НДСПредъявленКВычету Тогда
			
			СформироватьПроводкиВычетНДСВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);
			СформироватьДвиженияНДСЗаписиКнигиПокупокВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);
			
		КонецЕсли;

	Иначе

		СформироватьДвиженияНДСПредъявленныйВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);
		СформироватьДвиженияНДССАвансовВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);

	КонецЕсли;

КонецПроцедуры

// Подготовка таблицы для процедуры СформироватьДвиженияПолученСчетФактураНаВыданныйАванс()
//
Функция ПодготовитьПараметрыПолученСчетФактураНаВыданныйАванс(ТаблицаРеквизиты, ТаблицаАвансов, ТаблицаСторно)

	Параметры = Новый Структура;

	// Реквизиты шапки документа:
	ОбязательныеКолонки = ""
	+ "Период,"                         // <Дата> формирования движений (период)
	+ "Регистратор,"                    // <ДокументСсылка.СчетФактураПолученный> - проводимый документ
	+ "Организация,"                    // <СправочникСсылка.Организации>
	+ "Исправление,"
	+ "ИсправлениеСобственнойОшибки,"
	+ "ДокументОснование,"
	+ "ИсправляемыйСчетФактура,"
	+ "ДоговорКонтрагента,"
	+ "НДСИсчисляетсяНалоговымАгентом,"
	+ "НДСПредъявленКВычету";

	Параметры.Вставить("Реквизиты", ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(
		ТаблицаРеквизиты, ОбязательныеКолонки));

	// Список сумм авансов в разбивке по ставкам НДС:
	ОбязательныеКолонки = ""
	+ "СчетФактура,"                    // <ДокументСсылка...>  - документ, являющийся основанием для счета-фактуры
	+ "Контрагент,"                     // <СправочникСсылка.Контрагенты> контрагент для взаиморасчетов
	+ "ДоговорКонтрагента,"             // <СправочникСсылка.ДоговорыКонтрагентов> - договор взаиморасчетов;
	+ "НДСИсчисляетсяНалоговымАгентом," // <Булево> - признак исполнения обязанностей налогового агента при приобретении товаров,
	+ "НДС,"                            // <Число> - сумма НДС;
	+ "СуммаБезНДС,"                    // <Число> - сумма без НДС по определенной ставке НДС;
	+ "СтавкаНДС,"                      // <перечислениеСсылка.СтавкаНДС> - ставка НДС;
	+ "СчетУчетаНДС,"                   // <ПланСчетовСсылка.Хозрасчетный> - счет, на котором учитывается НДС
	+ "Содержание,"
	+ "КодВидаОперации,"
	+ "ЗаписьДополнительногоЛиста,"
	+ "СторнирующаяЗаписьДопЛиста,"
	+ "КорректируемыйПериод,"
	+ "ДатаСобытия,"
	+ "ИсправленныйСчетФактура,"
	+ "ДатаДокументаОплаты,"
	+ "НомерДокументаОплаты";
	
	Параметры.Вставить("Авансы", ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(
		ТаблицаАвансов, ОбязательныеКолонки));

	ОбязательныеКолонки = ""
	+ "СчетФактура,"
	+ "Контрагент,"
	+ "ДоговорКонтрагента,"
	+ "НДСИсчисляетсяНалоговымАгентом,"
	+ "НДС,"
	+ "СуммаБезНДС,"
	+ "СтавкаНДС,"
	+ "СчетУчетаНДС,"
	+ "Содержание,"
	+ "ВидЦенности,"
	+ "ДокументОплаты,"
	+ "ДатаОплаты,"
	+ "Событие,"
	+ "ДатаСобытия,"
	+ "ЗаписьДополнительногоЛиста,"
	+ "СторнирующаяЗаписьДопЛиста,"
	+ "КорректируемыйПериод,"
	+ "ИсправленныйСчетФактура,"
	+ "ДатаДокументаОплаты,"
	+ "НомерДокументаОплаты";
	
	Параметры.Вставить("СторноАвансов", ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(
		ТаблицаСторно, ОбязательныеКолонки));
	
	Возврат Параметры;

КонецФункции

// Процедура формирует движения по вычету НДС по выданным авансам по корректировочной счет-фактуре
//, вызывается Из документа СчетФактураПолученный
//
Процедура СформироватьДвиженияСчетФактураПолученныйКорректировочныйНаАванс(
	ТаблицаРеквизиты, ТаблицаАвансов, Движения, Отказ) Экспорт
	
	Если Не ЗначениеЗаполнено(ТаблицаРеквизиты) Тогда
		Возврат;
	КонецЕсли;
	
	Реквизиты = ТаблицаРеквизиты[0];
	
	Если Реквизиты.ВидСчетаФактуры <> Перечисления.ВидСчетаФактурыПолученного.КорректировочныйНаАванс Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметыСчетФактураПолученныйКорректировочныйНаАванс(
		ТаблицаРеквизиты, ТаблицаАвансов);
		
	Реквизиты = Параметры.Реквизиты[0];
	
	ВерсияУчетаНДС    = УчетНДСКлиентСервер.Версия(Реквизиты.Период);
	УпрощенныйУчетНДС = ВерсияУчетаНДС = 1 И УчетнаяПолитика.УпрощенныйУчетНДС(Реквизиты.Организация, Реквизиты.Период);
	
	Если Реквизиты.НДСПредъявленКВычету Тогда
		
		СформироватьПроводкиВычетНДСВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);
		СформироватьДвиженияНДСЗаписиКнигиПокупокВыданныйАванс(Реквизиты, Параметры.Авансы, Движения, Отказ);
		
	КонецЕсли;

КонецПроцедуры

// Подготовка таблицы для процедуры СформироватьДвиженияСчетФактураКорректировочныйНаАванс()
//
Функция ПодготовитьПараметыСчетФактураПолученныйКорректировочныйНаАванс(ТаблицаРеквизиты, ТаблицаАвансов)

	Параметры = Новый Структура;

	// Реквизиты шапки документа:
	ОбязательныеКолонки = ""
	+ "Период,"                         // <Дата> формирования движений (период)
	+ "Регистратор,"                    // <ДокументСсылка.СчетФактураПолученный> - проводимый документ
	+ "Организация,"                    // <СправочникСсылка.Организации>
	+ "ДокументОснование,"
	+ "ИсправляемыйСчетФактура,"
	+ "ДоговорКонтрагента,"
	+ "НДСИсчисляетсяНалоговымАгентом,"
	+ "НДСПредъявленКВычету";

	Параметры.Вставить("Реквизиты", ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(
		ТаблицаРеквизиты, ОбязательныеКолонки));

	// Список сумм авансов в разбивке по ставкам НДС:
	ОбязательныеКолонки = ""
	+ "СчетФактура,"                    // <ДокументСсылка...>  - документ, являющийся основанием для счета-фактуры
	+ "Контрагент,"                     // <СправочникСсылка.Контрагенты> контрагент для взаиморасчетов
	+ "ДоговорКонтрагента,"             // <СправочникСсылка.ДоговорыКонтрагентов> - договор взаиморасчетов;
	+ "НДСИсчисляетсяНалоговымАгентом," // <Булево> - признак исполнения обязанностей налогового агента при приобретении товаров,
	+ "НДС,"                            // <Число> - сумма НДС;
	+ "СуммаБезНДС,"                    // <Число> - сумма без НДС по определенной ставке НДС;
	+ "СтавкаНДС,"                      // <перечислениеСсылка.СтавкаНДС> - ставка НДС;
	+ "СчетУчетаНДС,"                   // <ПланСчетовСсылка.Хозрасчетный> - счет, на котором учитывается НДС
	+ "Содержание,"
	+ "КодВидаОперации,"
	+ "ЗаписьДополнительногоЛиста,"
	+ "СторнирующаяЗаписьДопЛиста,"
	+ "КорректируемыйПериод,"
	+ "ДатаСобытия,"
	+ "ИсправленныйСчетФактура,"
	+ "ДатаДокументаОплаты,"
	+ "НомерДокументаОплаты";
	
	Параметры.Вставить("Авансы", ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(
		ТаблицаАвансов, ОбязательныеКолонки));
	
	Возврат Параметры;

КонецФункции

Процедура СформироватьПроводкиВычетНДСВыданныйАванс(Реквизиты, ТаблицаАвансов, Движения, Отказ)

	Если ТаблицаАвансов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТаблицы Из ТаблицаАвансов Цикл

		// Проводки по вычету НДС с выданного аванса.
		Если СтрокаТаблицы.НДС = 0 Тогда
			Продолжить;
		КонецЕсли;

		Проводка = Движения.Хозрасчетный.Добавить();
		ЗаполнитьЗначенияСвойств(Проводка, Реквизиты);
		Проводка.Содержание = СтрокаТаблицы.Содержание;

		Если СтрокаТаблицы.НДСИсчисляетсяНалоговымАгентом Тогда
			Проводка.СчетДт = ПланыСчетов.Хозрасчетный.НДСНалоговогоАгентаПоОтдельнымВидамТоваров; // 68.52
		Иначе
			Проводка.СчетДт = ПланыСчетов.Хозрасчетный.НДС; // 68.02
		КонецЕсли;
		
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "ВидыПлатежейВГосБюджет", 
			Перечисления.ВидыПлатежейВГосБюджет.Налог);

		Проводка.СчетКт = ПланыСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным; // 76.ВА
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "СФПолученные", СтрокаТаблицы.СчетФактура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Контрагенты",  СтрокаТаблицы.Контрагент);

		Проводка.Сумма = СтрокаТаблицы.НДС;

	КонецЦикла;

	Движения.Хозрасчетный.Записывать = Истина;

КонецПроцедуры

Процедура СформироватьДвиженияНДСЗаписиКнигиПокупокВыданныйАванс(Реквизиты, ТаблицаАвансов, Движения, Отказ)

	Если ТаблицаАвансов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТаблицы Из ТаблицаАвансов Цикл

		НоваяЗапись = Движения.НДСЗаписиКнигиПокупок.Добавить();

		ЗаполнитьЗначенияСвойств(НоваяЗапись, Реквизиты);
		ЗаполнитьЗначенияСвойств(НоваяЗапись, СтрокаТаблицы);
		
		Если СтрокаТаблицы.НДСИсчисляетсяНалоговымАгентом Тогда
			НоваяЗапись.ВидЦенности = Перечисления.ВидыЦенностей.АвансыВыданныеНалоговыйАгент;
		Иначе
			НоваяЗапись.ВидЦенности = Перечисления.ВидыЦенностей.АвансыВыданные;
		КонецЕсли;
		
		НоваяЗапись.Поставщик = СтрокаТаблицы.Контрагент;
		НоваяЗапись.Событие   = Перечисления.СобытияПоНДСПокупки.ПредъявленНДСКВычету;
	КонецЦикла;
	
	Движения.НДСЗаписиКнигиПокупок.Записывать = Истина;

КонецПроцедуры

Процедура СформироватьДвиженияНДСПредъявленныйВыданныйАванс(Реквизиты, ТаблицаАвансов, Движения, Отказ)

	Если ТаблицаАвансов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТаблицы Из ТаблицаАвансов Цикл

		НоваяЗапись = Движения.НДСПредъявленный.ДобавитьПриход();

		ЗаполнитьЗначенияСвойств(НоваяЗапись, Реквизиты);

		НоваяЗапись.Организация = Реквизиты.Организация;
		НоваяЗапись.Поставщик 	= СтрокаТаблицы.Контрагент;
		НоваяЗапись.ДоговорКонтрагента = СтрокаТаблицы.ДоговорКонтрагента;

		НоваяЗапись.СчетФактура  = СтрокаТаблицы.СчетФактура;
		НоваяЗапись.ВидЦенности  = Перечисления.ВидыЦенностей.АвансыВыданные;
		НоваяЗапись.Событие		 = Перечисления.СобытияПоНДСПокупки.ПредъявленНДСПоставщиком;
		НоваяЗапись.ДатаСобытия	 = Реквизиты.Период;
		НоваяЗапись.СтавкаНДС 	 = СтрокаТаблицы.СтавкаНДС;
		НоваяЗапись.СуммаБезНДС  = СтрокаТаблицы.СуммаБезНДС;
		НоваяЗапись.НДС          = СтрокаТаблицы.НДС;

	КонецЦикла;

	Движения.НДСПредъявленный.Записывать = Истина;

КонецПроцедуры

Процедура СформироватьДвиженияНДССАвансовВыданныйАванс(Реквизиты, ТаблицаАвансов, Движения, Отказ)

	Если ТаблицаАвансов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТаблицы Из ТаблицаАвансов Цикл

		НоваяЗапись = Движения.НДССАвансов.ДобавитьПриход();

		ЗаполнитьЗначенияСвойств(НоваяЗапись, Реквизиты);

		НоваяЗапись.Покупатель         = СтрокаТаблицы.Контрагент;
		НоваяЗапись.ДоговорКонтрагента = СтрокаТаблицы.ДоговорКонтрагента;

		НоваяЗапись.ВидЦенности  = Перечисления.ВидыЦенностей.АвансыВыданные;
		НоваяЗапись.СчетФактура  = СтрокаТаблицы.СчетФактура;
		НоваяЗапись.СтавкаНДС    = СтрокаТаблицы.СтавкаНДС;
		НоваяЗапись.ДатаСобытия  = Реквизиты.Период;
		НоваяЗапись.СуммаБезНДС  = СтрокаТаблицы.СуммаБезНДС;
		НоваяЗапись.НДС          = СтрокаТаблицы.НДС;

	КонецЦикла;

	Движения.НДССАвансов.Записывать = Истина;

КонецПроцедуры

#КонецОбласти

#Область СчетаФактурыВыданныеПокупателям

Функция ТекстЗапросаИсправлениеКорректировка()
	
	Возврат "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РеализацииПоОтчету.Покупатель КАК Покупатель
	|ПОМЕСТИТЬ ПокупателиПоОтчету
	|ИЗ
	|	Документ.ОтчетКомитентуОПродажах.Товары КАК РеализацииПоОтчету
	|ГДЕ
	|	РеализацииПоОтчету.Ссылка = &ДокументОснование
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Покупатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументКорректировкиРеализации.Ссылка КАК ДокументРеализации
	|ПОМЕСТИТЬ ДокументыРеализации
	|ИЗ
	|	Документ.КорректировкаРеализации КАК ДокументКорректировкиРеализации
	|ГДЕ
	|	ДокументКорректировкиРеализации.Организация = &Организация
	|	И НАЧАЛОПЕРИОДА(ДокументКорректировкиРеализации.Дата, ДЕНЬ) = &ДатаВходящегоДокумента
	|	И ДокументКорректировкиРеализации.Контрагент В
	|			(ВЫБРАТЬ
	|				ПокупателиПоОтчету.Покупатель
	|			ИЗ
	|				ПокупателиПоОтчету)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураШапка.Ссылка КАК СчетФактура,
	|	СчетФактураШапка.СуммаДокументаКомиссия КАК Сумма,
	|	СчетФактураШапка.СуммаНДСДокументаКомиссия КАК НДС,
	|	НЕОПРЕДЕЛЕНО КАК Субкомиссионер,
	|	СчетФактураШапка.Контрагент КАК Покупатель,
	|	СчетФактураОснования.СуммаУвеличение,
	|	СчетФактураОснования.СуммаУменьшение,
	|	СчетФактураОснования.СуммаНДСУвеличение,
	|	СчетФактураОснования.СуммаНДСУменьшение
	|ИЗ
	|	ДокументыРеализации КАК ДокументыРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РеализованныеТоварыКомитентов КАК РеализованныеТоварыКомитентов
	|		ПО ДокументыРеализации.ДокументРеализации = РеализованныеТоварыКомитентов.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураОснования
	|		ПО ДокументыРеализации.ДокументРеализации = СчетФактураОснования.ДокументОснование
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураШапка
	|		ПО (СчетФактураОснования.Ссылка = СчетФактураШапка.Ссылка)
	|ГДЕ
	|	НЕ СчетФактураШапка.ПометкаУдаления";
	
КонецФункции

Функция ТекстЗапросаПрочиеСчетаФактуры()
	
	Возврат "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураВыданный.Контрагент КАК Покупатель,
	|	СчетФактураВыданный.Ссылка КАК СчетФактура,
	|	СчетФактураВыданный.СуммаДокумента КАК Сумма,
	|	СчетФактураВыданный.СуммаНДСДокумента КАК НДС,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(СчетФактураВыданный.ДокументОснование) = ТИП(Документ.ОтчетКомиссионераОПродажах)
	|			ТОГДА ЕСТЬNULL(ОтчетКомиссионераОПродажах.Контрагент, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Субкомиссионер
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|		ПО СчетФактураВыданный.ДокументОснование = ОтчетКомиссионераОПродажах.Ссылка
	|ГДЕ
	|	СчетФактураВыданный.Организация = &Организация
	|	И СчетФактураВыданный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаАвансКомитента)
	|	И НАЧАЛОПЕРИОДА(СчетФактураВыданный.Дата, ДЕНЬ) = &ДатаВходящегоДокумента
	|	И СчетФактураВыданный.Комитент = &Комитент
	|	И НЕ ЕСТЬNULL(ОтчетКомиссионераОПродажах.ВыписыватьСчетаФактурыСводно, ЛОЖЬ)
	|	И НЕ СчетФактураВыданный.ПометкаУдаления
	|	И СчетФактураВыданный.Исправление = &Исправление
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураАвансы.Контрагент,
	|	СчетФактураВыданный.Ссылка,
	|	СчетФактураАвансы.Сумма,
	|	СчетФактураАвансы.СуммаНДС,
	|	ОтчетКомиссионераОПродажах.Контрагент
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|		ПО СчетФактураВыданный.ДокументОснование = ОтчетКомиссионераОПродажах.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.Авансы КАК СчетФактураАвансы
	|		ПО (СчетФактураАвансы.Ссылка = СчетФактураВыданный.Ссылка)
	|ГДЕ
	|	СчетФактураВыданный.Организация = &Организация
	|	И СчетФактураВыданный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаАвансКомитента)
	|	И НАЧАЛОПЕРИОДА(СчетФактураВыданный.Дата, ДЕНЬ) = &ДатаВходящегоДокумента
	|	И СчетФактураВыданный.Комитент = &Комитент
	|	И ОтчетКомиссионераОПродажах.ВыписыватьСчетаФактурыСводно
	|	И НЕ СчетФактураВыданный.ПометкаУдаления
	|	И СчетФактураВыданный.Исправление = &Исправление";
	
КонецФункции

Функция ТекстЗапросаСчетФактураНаПоступление()
	
	Возврат "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РеализацииПоОтчету.Покупатель КАК Покупатель
	|ПОМЕСТИТЬ ПокупателиПоОтчету
	|ИЗ
	|	Документ.ОтчетКомитентуОПродажах.Товары КАК РеализацииПоОтчету
	|ГДЕ
	|	РеализацииПоОтчету.Ссылка = &ДокументОснование
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Покупатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	РеализованныеТоварыКомитентов.СчетФактураСубкомиссионера КАК СчетФактура,
	|	СУММА(РеализованныеТоварыКомитентов.Выручка) КАК Сумма,
	|	СУММА(РеализованныеТоварыКомитентов.СуммаНДС) КАК НДС
	|ПОМЕСТИТЬ ПродажиПоСубкомиссии
	|ИЗ
	|	РегистрНакопления.РеализованныеТоварыКомитентов КАК РеализованныеТоварыКомитентов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПокупателиПоОтчету КАК ПокупателиПоОтчету
	|		ПО РеализованныеТоварыКомитентов.Покупатель = ПокупателиПоОтчету.Покупатель
	|ГДЕ
	|	РеализованныеТоварыКомитентов.ДатаРеализации = &ДатаВходящегоДокумента
	|	И РеализованныеТоварыКомитентов.Активность
	|	И РеализованныеТоварыКомитентов.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И РеализованныеТоварыКомитентов.ДоговорКонтрагента = &ДоговорКомитента
	|	И РеализованныеТоварыКомитентов.Контрагент = &Комитент
	|	И РеализованныеТоварыКомитентов.Организация = &Организация
	|	И РеализованныеТоварыКомитентов.Регистратор ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	РеализованныеТоварыКомитентов.СчетФактураСубкомиссионера
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	СчетФактураВыданныйДокументыОснования.Ссылка КАК СчетФактура,
	|	СУММА(РеализованныеТоварыКомитентов.Выручка) КАК Сумма,
	|	СУММА(РеализованныеТоварыКомитентов.СуммаНДС) КАК НДС
	|ПОМЕСТИТЬ ПродажиПоКомиссии
	|ИЗ
	|	РегистрНакопления.РеализованныеТоварыКомитентов КАК РеализованныеТоварыКомитентов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
	|		ПО РеализованныеТоварыКомитентов.Регистратор = СчетФактураВыданныйДокументыОснования.ДокументОснование
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПокупателиПоОтчету КАК ПокупателиПоОтчету
	|		ПО РеализованныеТоварыКомитентов.Покупатель = ПокупателиПоОтчету.Покупатель
	|ГДЕ
	|	РеализованныеТоварыКомитентов.ДатаРеализации = &ДатаВходящегоДокумента
	|	И РеализованныеТоварыКомитентов.Активность
	|	И РеализованныеТоварыКомитентов.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И РеализованныеТоварыКомитентов.Контрагент = &Комитент
	|	И РеализованныеТоварыКомитентов.ДоговорКонтрагента = &ДоговорКомитента
	|	И РеализованныеТоварыКомитентов.Организация = &Организация
	|	И НЕ РеализованныеТоварыКомитентов.Регистратор ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|	И НЕ РеализованныеТоварыКомитентов.Регистратор ССЫЛКА Документ.РеализацияОтгруженныхТоваров
	|	И НЕ РеализованныеТоварыКомитентов.Регистратор ССЫЛКА Документ.ОтчетКомитентуОПродажах
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	СчетФактураВыданныйДокументыОснования.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	СчетФактураВыданныйДокументыОснования.Ссылка КАК СчетФактура,
	|	СУММА(РеализованныеТоварыКомитентов.Выручка) КАК Сумма,
	|	СУММА(РеализованныеТоварыКомитентов.СуммаНДС) КАК НДС
	|ПОМЕСТИТЬ ПродажиОтгруженныхТоваров
	|ИЗ
	|	РегистрНакопления.РеализованныеТоварыКомитентов КАК РеализованныеТоварыКомитентов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПокупателиПоОтчету КАК ПокупателиПоОтчету
	|		ПО РеализованныеТоварыКомитентов.Покупатель = ПокупателиПоОтчету.Покупатель
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
	|		ПО (ВЫРАЗИТЬ(РеализованныеТоварыКомитентов.Регистратор КАК Документ.РеализацияОтгруженныхТоваров).ДокументОтгрузки = СчетФактураВыданныйДокументыОснования.ДокументОснование)
	|ГДЕ
	|	РеализованныеТоварыКомитентов.ДатаРеализации = &ДатаВходящегоДокумента
	|	И РеализованныеТоварыКомитентов.Активность
	|	И РеализованныеТоварыКомитентов.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И РеализованныеТоварыКомитентов.Контрагент = &Комитент
	|	И РеализованныеТоварыКомитентов.ДоговорКонтрагента = &ДоговорКомитента
	|	И РеализованныеТоварыКомитентов.Организация = &Организация
	|	И РеализованныеТоварыКомитентов.Регистратор ССЫЛКА Документ.РеализацияОтгруженныхТоваров
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализованныеТоварыКомитентов.Покупатель,
	|	РеализованныеТоварыКомитентов.Субкомиссионер,
	|	СчетФактураВыданныйДокументыОснования.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПродажиПоСубкомиссии.Покупатель,
	|	ПродажиПоСубкомиссии.Субкомиссионер,
	|	ПродажиПоСубкомиссии.СчетФактура,
	|	ВЫБОР
	|		КОГДА ПродажиПоСубкомиссии.НДС > 0
	|			ТОГДА ПродажиПоСубкомиссии.Сумма
	|		ИНАЧЕ ПродажиПоСубкомиссии.СчетФактура.СуммаДокумента
	|	КОНЕЦ КАК Сумма,
	|	ВЫБОР
	|		КОГДА ПродажиПоСубкомиссии.НДС > 0
	|			ТОГДА ПродажиПоСубкомиссии.НДС
	|		ИНАЧЕ ПродажиПоСубкомиссии.СчетФактура.СуммаНДСДокументаКомиссия
	|	КОНЕЦ КАК НДС
	|ИЗ
	|	ПродажиПоСубкомиссии КАК ПродажиПоСубкомиссии
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПродажиПоКомиссии.Покупатель,
	|	ПродажиПоКомиссии.Субкомиссионер,
	|	ПродажиПоКомиссии.СчетФактура,
	|	ВЫБОР
	|		КОГДА ПродажиПоКомиссии.НДС > 0
	|			ТОГДА ПродажиПоКомиссии.Сумма
	|		ИНАЧЕ ПродажиПоКомиссии.СчетФактура.СуммаДокумента
	|	КОНЕЦ КАК Сумма,
	|	ВЫБОР
	|		КОГДА ПродажиПоКомиссии.НДС > 0
	|			ТОГДА ПродажиПоКомиссии.НДС
	|		ИНАЧЕ ПродажиПоКомиссии.СчетФактура.СуммаНДСДокументаКомиссия
	|	КОНЕЦ КАК НДС
	|ИЗ
	|	ПродажиПоКомиссии КАК ПродажиПоКомиссии
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПродажиОтгруженныхТоваров.Покупатель,
	|	ПродажиОтгруженныхТоваров.Субкомиссионер,
	|	ПродажиОтгруженныхТоваров.СчетФактура,
	|	ВЫБОР
	|		КОГДА ПродажиОтгруженныхТоваров.НДС > 0
	|			ТОГДА ПродажиОтгруженныхТоваров.Сумма
	|		ИНАЧЕ ПродажиОтгруженныхТоваров.СчетФактура.СуммаДокумента
	|	КОНЕЦ КАК Сумма,
	|	ВЫБОР
	|		КОГДА ПродажиОтгруженныхТоваров.НДС > 0
	|			ТОГДА ПродажиОтгруженныхТоваров.НДС
	|		ИНАЧЕ ПродажиОтгруженныхТоваров.СчетФактура.СуммаНДСДокументаКомиссия
	|	КОНЕЦ КАК НДС
	|ИЗ
	|	ПродажиОтгруженныхТоваров КАК ПродажиОтгруженныхТоваров";
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли