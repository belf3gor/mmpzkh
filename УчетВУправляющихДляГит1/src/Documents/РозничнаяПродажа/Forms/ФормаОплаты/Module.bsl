&НаКлиенте
Перем СуммаПолученоНаличными;

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ЗаполнитьЗначенияСвойств(ЭтаФорма, Параметры, "СуммаДокумента, Организация, ЭтоВозврат, ЗапрашиватьКонтактнуюИнформацию");
	
	Элементы.ФормаВыполнитьОперацию.Заголовок = Параметры.ЗаголовокКнопкиВыполнить;
	Заголовок = ?(ЭтоВозврат, НСтр("ru = 'Возврат'"), НСтр("ru = 'Оплата'"));
	
	Если ПравоДоступа("Чтение", Метаданные.Справочники.ПодключаемоеОборудование) Тогда
		ИспользуютсяСканерыШтрихкода = (МенеджерОборудованияВызовСервера.ОборудованиеПоПараметрам("СканерШтрихкода").Количество() > 0);
	Иначе
		ИспользуютсяСканерыШтрихкода = Ложь;
	КонецЕсли;
	
	УстановитьВидОплаты();
	
	ПолученоНаличными = ?(Параметры.ЭтоВозврат, СуммаДокумента, 0);
	ЦветПомеченнойКнопки = ЦветаСтиля.ВыделеннаяКнопкаФон;
	ЦветОбычнойКнопки = Элементы.ОтправитьSMS.ЦветФона;
	
	УправлениеФормой(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Если ИспользуютсяСканерыШтрихкода Тогда
		// Попробуем подключить сканер штрихкода
		ОповещенияПриПодключении = Новый ОписаниеОповещения("ПодключитьСканерШКЗавершение", ЭтотОбъект); 
		МенеджерОборудованияКлиент.НачатьПодключениеОборудованиеПоТипу(ОповещенияПриПодключении, УникальныйИдентификатор, "СканерШтрихкода");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	
	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаНаличные Тогда
		Если ПолученоНаличными < СуммаДокумента Тогда
			ТекстСообщения = НСтр("ru = 'Сумма введенной оплаты меньше суммы чека'");

			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Поле", "КОРРЕКТНОСТЬ", НСтр("ru = 'Наличными'"),,,ТекстСообщения);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , "ПолученоНаличными", , Отказ);
		КонецЕсли;
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаДругое Тогда
		ИмяСписка = "Оплата";
		
		Если Оплата.Итог("Сумма") > СуммаДокумента  Тогда
			
			ТекстОписаниеОшибки = НСтр("ru = 'Сумма безналичных оплат превышает сумму выручки от реализации!'");
			ТекстСообщения      = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Список", "Корректность",,, НСтр("ru = 'Безналичные оплаты'"), ТекстОписаниеОшибки);
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ИмяСписка, "Объект", Отказ);
			
		КонецЕсли;
		
		НомерСтроки = 0;
		Для каждого СтрокаОплата Из Оплата Цикл
			НомерСтроки = НомерСтроки + 1;
		
			Если НЕ ЗначениеЗаполнено(СтрокаОплата.ВидОплаты) Тогда
				
				Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяСписка, НомерСтроки, "ВидОплаты");
				
				ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", "Заполнение", 
					НСтр("ru = 'Вид оплаты'"), НомерСтроки, ИмяСписка);
					
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, "Объект", Отказ);

			КонецЕсли; 
			
			Если СтрокаОплата.Сумма = 0 Тогда
				
				Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяСписка, НомерСтроки, "Сумма");
				
				ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", "Заполнение", 
					НСтр("ru = 'Сумма'"), НомерСтроки, ИмяСписка);
					
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, "Объект", Отказ);
				
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если Источник = "ПодключаемоеОборудование" И ВводДоступен() Тогда
		Если ИмяСобытия = "ScanData" Тогда
			Если Параметр[1] = Неопределено Тогда
				ТекущийКод = Параметр[0];
			Иначе
				ТекущийКод = Параметр[1][1];
			КонецЕсли;
			
			ДанныеОбъекта = Новый Структура("АдресЭлектроннойПочты, ОтправлятьEmail, НомерТелефона, ОтправлятьSMS");
			ЗаполнитьЗначенияСвойств(ДанныеОбъекта, ЭтаФорма);
			ПечатьФискальныхДокументовКлиент.ЗаполнитьКонтактнуюИнформациюПоШтрихкоду(ДанныеОбъекта, ТекущийКод);
			ЗаполнитьЗначенияСвойств(ЭтаФорма, ДанныеОбъекта);
			
			УправлениеФормой(ЭтаФорма);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	Если НЕ ЗавершениеРаботы И Модифицированность Тогда
		Отказ = Истина;
		
		ОписаниеОповещения = Новый ОписаниеОповещения("ПриЗакрытииЗавершение", ЭтотОбъект);
		
		ТекстПредупреждения = НСтр("ru = 'Вы уверены, что хотите выйти без печати чека?'");
		ПоказатьВопрос(ОписаниеОповещения, ТекстПредупреждения, РежимДиалогаВопрос.ДаНет, 60);
	КонецЕсли; 
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	// ПодключаемоеОборудование
	Если СканерШтрихкодаПодключен И НЕ ЗавершениеРаботы Тогда
		ТипыПО = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве("СканерШтрихкода");
		ОповещенияПриОтключении = Новый ОписаниеОповещения("ОтключитьСканерШКЗавершение", ЭтотОбъект); 
		МенеджерОборудованияКлиент.НачатьОтключениеОборудованиеПоТипу(ОповещенияПриОтключении, УникальныйИдентификатор, ТипыПО);
	КонецЕсли;
	//Конец  ПодключаемоеОборудование
КонецПроцедуры


#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ВидОплатыПриИзменении(Элемент)
	
	Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы["Страница"+ВидОплаты];
	
	УправлениеФормой(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ПолученоНаличнымиИзменениеТекстаРедактирования(Элемент, Текст, СтандартнаяОбработка)
	СуммаПолученоНаличными = Число(Текст);
	РассчитатьСдачу();

КонецПроцедуры

&НаКлиенте
Процедура ОплатаПриИзменении(Элемент)
	УправлениеФормой(ЭтотОбъект);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВыполнитьОперацию(Команда)
	Если НЕ ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли; 
	
	СтруктураРезультата = СтруктураРезультата();
	
	Закрыть(СтруктураРезультата);
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьSMS(Команда)
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Заголовок", НСтр("ru = 'Телефон для информирования'"));
	ПараметрыФормы.Вставить("ЗначенияПолей", НомерТелефона);
	ПараметрыФормы.Вставить("ВидКонтактнойИнформации", ПредопределенноеЗначение("Справочник.ВидыКонтактнойИнформации.ТелефонМобильныйКонтактныеЛица"));
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ВводНомераТелефонаЗавершение", ЭтотОбъект, Новый Структура);
	
	ОткрытьФорму("Обработка.ВводКонтактнойИнформации.Форма.ВводТелефона", ПараметрыФормы,,,,,ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьНаEmail(Команда)
	ОписаниеОповещения = Новый ОписаниеОповещения("ПоказатьВопросEmailЗавершение", ЭтотОбъект);
	Если ЗначениеЗаполнено(НомерТелефона) Тогда
		ПоказатьВопрос(ОписаниеОповещения, НСтр("ru = 'Для чека указан номер телефона покупателя. 
		|Очистить его и отправить чек на электронную почту?'"), РежимДиалогаВопрос.ДаНет,15);
	Иначе
		ВыполнитьОбработкуОповещения(ОписаниеОповещения, КодВозвратаДиалога.Да);
	КонецЕсли; 
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВидОплаты()
	
	Элементы.ВидОплаты.СписокВыбора.Очистить();
	Элементы.ВидОплаты.СписокВыбора.Добавить("Наличные");
	
	ИспользоватьОплатуПоПлатежнымКартам = ПолучитьФункциональнуюОпцию("ИспользоватьОплатуПоПлатежнымКартам");
	ИспользуютсяПодарочныеСертификаты = ПолучитьФункциональнуюОпцию("ИспользуютсяПодарочныеСертификаты");
	
	Если ИспользоватьОплатуПоПлатежнымКартам Тогда
		Элементы.ВидОплаты.СписокВыбора.Добавить("Карта");
	КонецЕсли; 
	
	Если ИспользуютсяПодарочныеСертификаты 
		ИЛИ ИспользоватьОплатуПоПлатежнымКартам Тогда
		Элементы.ВидОплаты.СписокВыбора.Добавить("Другое");
	КонецЕсли; 
	
	ЗагрузитьТаблицуОплат(Параметры.АдресТаблицаОплата, ИспользоватьОплатуПоПлатежнымКартам, ИспользуютсяПодарочныеСертификаты);
	
	Если ИспользоватьОплатуПоПлатежнымКартам 
			И Оплата.Количество() = 1 
			И Оплата[0].ВидОплаты.ТипОплаты = Перечисления.ТипыОплат.ПлатежнаяКарта 
			И Оплата[0].Сумма = СуммаДокумента Тогда 
			
		ВидОплаты = "Карта";
	ИначеЕсли (ИспользоватьОплатуПоПлатежнымКартам ИЛИ ИспользуютсяПодарочныеСертификаты)
		И Оплата.Количество() > 0 Тогда 
		
		ВидОплаты = "Другое";
	Иначе
		
		ВидОплаты = "Наличные";
	КонецЕсли;
	
	Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы["Страница"+ВидОплаты];
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТаблицуОплат(АдресТаблицаОплата, ИспользоватьПлатежныеКарты, ИспользоватьПодарочныеСертификатры)
	Если НЕ ИспользоватьПлатежныеКарты И НЕ ИспользоватьПодарочныеСертификатры Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаОплат = ПолучитьИзВременногоХранилища(АдресТаблицаОплата);

	КоличествоСтрок = ТаблицаОплат.Количество();
	Для НомерСтроки = 1 По КоличествоСтрок Цикл
		СтрокаОплаты = ТаблицаОплат[КоличествоСтрок-НомерСтроки];
		
		ТипОплаты = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаОплаты.ВидОплаты, "ТипОплаты");
		Если (ТипОплаты = Перечисления.ТипыОплат.ПлатежнаяКарта И НЕ ИспользоватьПлатежныеКарты) 
			ИЛИ ((ТипОплаты = Перечисления.ТипыОплат.ПодарочныйСертификатСобственный ИЛИ ТипОплаты = Перечисления.ТипыОплат.ПодарочныйСертификатСобственный) И НЕ ИспользоватьПодарочныеСертификатры)  Тогда
			ТаблицаОплат.Удалить(СтрокаОплаты);
		КонецЕсли; 
	КонецЦикла;
	
	Оплата.Загрузить(ТаблицаОплат);
КонецПроцедуры 

&НаСервереБезКонтекста
Функция ПредставлениеТелефона(ТелефонДляИнформирования)
	СтруктураТелефона = РаботаСАдресами.ПредыдущаяСтруктураКонтактнойИнформацииXML(ТелефонДляИнформирования, Справочники.ВидыКонтактнойИнформации.ТелефонМобильныйКонтактныеЛица);

	Возврат СтруктураТелефона.КодСтраны + ОбщегоНазначенияБПКлиентСервер.ОставитьВСтрокеТолькоЦифры(СтруктураТелефона.КодГорода+СтруктураТелефона.НомерТелефона);
КонецФункции 

&НаСервере
Функция СтруктураРезультата()
	СтруктураРезультата = Новый Структура("ОплатаНаличные, ОплатаКарта, АдресТаблицыОплаты, ПечататьТоварныйЧек, ПокупательEmail, ПокупательНомер, СсылочныйНомер, НомерПлатежнойКарты, НомерЧекаЭТ", 0, 0, Неопределено, ПечататьТоварныйЧек);
	
	СтруктураРезультата.Вставить("ПокупательEmail", АдресЭлектроннойПочты);
	СтруктураРезультата.Вставить("ПокупательНомер", ПредставлениеТелефона(НомерТелефона));
	
	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаНаличные Тогда
		СтруктураРезультата.Вставить("ОплатаНаличные",       ПолученоНаличными);
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаКарта Тогда
		СтруктураРезультата.Вставить("ОплатаКарта",         СуммаДокумента);
		Если Оплата.Количество() = 1 Тогда
			ЗаполнитьЗначенияСвойств(СтруктураРезультата, Оплата[0], "СсылочныйНомер, НомерПлатежнойКарты, НомерЧекаЭТ");
		КонецЕсли; 
	Иначе
		СтруктураРезультата.Вставить("ОплатаНаличные",       Макс(СуммаДокумента - Оплата.Итог("Сумма"), 0));
		СтруктураРезультата.Вставить("АдресТаблицыОплаты",  ПоместитьВоВременноеХранилище(Оплата.Выгрузить(), Новый УникальныйИдентификатор));
	КонецЕсли;
	
	Возврат СтруктураРезультата;
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)
	Элементы = Форма.Элементы;
	
	Элементы.ДекорацияРазделитель.Видимость             = НЕ (Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаДругое);
	Элементы.СуммаСдача.Видимость                       = НЕ Форма.ЭтоВозврат;
	Элементы.ПолученоНаличными.Видимость                = НЕ Форма.ЭтоВозврат;
	Элементы.ГруппаИнформированиеПользователя.Видимость = Форма.ЗапрашиватьКонтактнуюИнформацию;
	Элементы.ОтправитьНаEmail.ЦветФона                  = ?(ЗначениеЗаполнено(Форма.АдресЭлектроннойПочты), Форма.ЦветПомеченнойКнопки, Форма.ЦветОбычнойКнопки);
	Элементы.ОтправитьSMS.ЦветФона                      = ?(ЗначениеЗаполнено(Форма.НомерТелефона), Форма.ЦветПомеченнойКнопки, Форма.ЦветОбычнойКнопки);
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСдачу()
	СуммаСдача = Макс(СуммаПолученоНаличными - СуммаДокумента, 0);
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЭтоКорректныйТелефон(СтруктураКИ)
	СтруктураТелефона = РаботаСАдресами.ПредыдущаяСтруктураКонтактнойИнформацииXML(СтруктураКИ.КонтактнаяИнформация, СтруктураКИ.Вид);
	
	НомерТелефонаБезПрефикса = ОбщегоНазначенияБПКлиентСервер.ОставитьВСтрокеТолькоЦифры(СтруктураТелефона.КодСтраны + СтруктураТелефона.КодГорода+СтруктураТелефона.НомерТелефона);
	
	Возврат ОрганизацииФормыКлиентСервер.ТелефонСоответствуетТребованиям(НомерТелефонаБезПрефикса);
КонецФункции 

&НаКлиенте
Процедура ВводНомераТелефонаЗавершение(Значение, ДополнительныеПараметры) Экспорт
	Если Значение <> Неопределено Тогда
		Если НЕ ЭтоКорректныйТелефон(Значение) Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Неверный формат номера для информирования'"));
		Иначе
			НомерТелефона = Значение.КонтактнаяИнформация;
			АдресЭлектроннойПочты   = "";
		КонецЕсли; 
	КонецЕсли; 
	УправлениеФормой(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьВопросEmailЗавершение(Значение, ДополнительныеПараметры) Экспорт
	Если Значение = КодВозвратаДиалога.Да  Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ВводEmailЗавершение", ЭтотОбъект, Новый Структура);
		
		ПоказатьВводСтроки(ОписаниеОповещения, АдресЭлектроннойПочты, НСтр("ru = 'E-mail для информирования'"));
	КонецЕсли; 
КонецПроцедуры 

&НаКлиенте
Процедура ВводEmailЗавершение(Значение, ДополнительныеПараметры) Экспорт
	Если ПустаяСтрока(Значение) Тогда 
		АдресЭлектроннойПочты = Значение;
	ИначеЕсли ОбщегоНазначенияКлиентСервер.АдресЭлектроннойПочтыСоответствуетТребованиям(Значение) Тогда 
		АдресЭлектроннойПочты= Значение;
		НомерТелефона = "";
	Иначе
		ТекстОшибки = НСтр("ru='Указан некорректный адрес электронной почты.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки,,"ОтправитьНаEmail");
	КонецЕсли;
	УправлениеФормой(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ПодключитьСканерШКЗавершение(РезультатВыполнения, ДополнительныеПараметры) Экспорт

	СканерШтрихкодаПодключен = РезультатВыполнения.Результат;

КонецПроцедуры

&НаКлиенте
Процедура ОтключитьСканерШКЗавершение(РезультатВыполнения, ДополнительныеПараметры) Экспорт

	Если Не РезультатВыполнения.Результат Тогда
		ТекстСообщения = НСтр("ru = 'При отключении оборудования произошла ошибка: ""%1"".'");
		ТекстСообщения = СтрШаблон(ТекстСообщения, РезультатВыполнения.ОписаниеОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	Иначе
		СканерШтрихкодаПодключен = Ложь;
	КонецЕсли;

КонецПроцедуры

#КонецОбласти
