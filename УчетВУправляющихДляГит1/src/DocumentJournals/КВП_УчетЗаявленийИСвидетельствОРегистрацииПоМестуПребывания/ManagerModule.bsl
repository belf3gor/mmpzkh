
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// Печать

#Область Печать

// Функция формирует Таблицу документов для печати.
//
Функция СформироватьИтоговуюТаблицу(Список) Экспорт
	
	Построитель = Новый ПостроительЗапроса;
	
	Построитель.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Ссылка КАК ДокСсылка,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Дата
		|ИЗ
		|	Документ.КВП_ЗаявлениеОРегистрацииПоМестуПребывания КАК КВП_ЗаявлениеОРегистрацииПоМестуПребывания
		|{ГДЕ
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Ссылка.*,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.ПометкаУдаления,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Номер,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Дата,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Проведен,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Организация.*,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.ЛицевойСчет.*,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Проживающий.*,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.Комментарий,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.ДатаНачалаРегистрации,
		|	КВП_ЗаявлениеОРегистрацииПоМестуПребывания.ДатаОкончанияРегистрации}
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Ссылка,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Дата
		|ИЗ
		|	Документ.КВП_СвидетельствоОРегистрацииПоМестуПребывания КАК КВП_СвидетельствоОРегистрацииПоМестуПребывания
		|{ГДЕ
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Ссылка.*,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.ПометкаУдаления,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Номер,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Дата,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Проведен,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Организация.*,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.ЛицевойСчет.*,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Проживающий.*,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.Комментарий,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.ДатаНачалаРегистрации,
		|	КВП_СвидетельствоОРегистрацииПоМестуПребывания.ДатаОкончанияРегистрации}";
		
	Для Каждого ТекОтбор Из Список.Отбор.Элементы Цикл
			
		Если ТекОтбор.Использование И Не ТекОтбор.ЛевоеЗначение = Новый  ПолеКомпоновкиДанных("Тип") Тогда
			
			НовыйОтбор = Построитель.Отбор.Добавить(Строка(ТекОтбор.ЛевоеЗначение));
			НовыйОтбор.ВидСравнения  = ВидСравнения[Строка(ТекОтбор.ВидСравнения)];
			НовыйОтбор.Значение      = ТекОтбор.ПравоеЗначение;
			НовыйОтбор.Использование = Истина;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Принудительно добавляем отбор "ПометкаУдаления".
	НовыйОтбор = Построитель.Отбор.Добавить("ПометкаУдаления");
	НовыйОтбор.ВидСравнения  = ВидСравнения.Равно;
	НовыйОтбор.Значение      = Ложь;
	НовыйОтбор.Использование = Истина;
	
	Построитель.ЗаполнитьНастройки();
	
	Построитель.Выполнить();
	ТаблицаДок = Построитель.Результат.Выгрузить();
	
	Возврат ТаблицаДок;
	
КонецФункции

// Функция формирует табличный документ по форме №4.
//
Функция ПечатьФорма4(МассивОбъектов, ОбъектыПечати)
	
	ТабДокумент = Новый ТабличныйДокумент;
	
	ТабДокумент.ОриентацияСтраницы  = ОриентацияСтраницы.Ландшафт;
	
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЖурналУчетаЗаявленийИСвидетельствОРегистрации";
	
	Макет = УПЖКХ_ТиповыеМетодыСервер.ПолучитьМакет("Отчет.КВП_ФормыРегистрационногоУчета.ПФ_MXL_Форма_4");

	
	Страница1 = Макет.ПолучитьОбласть("Страница1");
	ОблСтрока = Макет.ПолучитьОбласть("Страница1_1");
	
	ТабДокумент.Вывести(Страница1);
	
	нпп = 1;
	
	СтруктураПараметровМакета = Новый Структура("НПП,СведенияОЗаявителе,ДатаПоступления,ДатаИСрокРегистрации,ДокУЛ,АдресПребывания");
	
	Для Каждого ТекСтрока Из МассивОбъектов Цикл
		
		СведенияОЗаявителе = ТекСтрока.Проживающий.Наименование;
		
		Если ЗначениеЗаполнено(ТекСтрока.Проживающий.ФизЛицо.ДатаРождения) Тогда
			СведенияОЗаявителе = СведенияОЗаявителе
							   + ", " 
							   + Формат(ТекСтрока.Проживающий.ФизЛицо.ДатаРождения, "ДФ=yyyy") 
							   + " г.р.";
		КонецЕсли;
		
		МестоРегистрации 	= ПолучитьАдрес(ТекСтрока.Проживающий.Владелец.Адрес.Владелец, 
											Перечисления.КВП_ВидыАдресов.Здание,
											"Рег");
		ПредставлениеАдреса = ПолучитьАдресПомещения(МестоРегистрации.ПредставлениеРег, 
													 ТекСтрока.Проживающий.Владелец.Адрес);
		
		ПаспортныеДанные = ПолучитьПаспортныеДанныеПроживающего(ТекСтрока.Проживающий, ТекСтрока.Дата);
		
		СокрВидДок = СтрЗаменить(ПаспортныеДанные.ВидДокумента.Наименование,"Российской Федерации","РФ");
		
		СтруктураПараметровМакета.НПП = нпп;
		СтруктураПараметровМакета.СведенияОЗаявителе = СведенияОЗаявителе;
		СтруктураПараметровМакета.ДатаПоступления = Формат(ТекСтрока.Дата, "ДЛФ=Д");
		СтруктураПараметровМакета.ДатаИСрокРегистрации = ?(ЗначениеЗаполнено(ТекСтрока.ДатаНачалаРегистрации), "С "
												 + Строка(Формат(ТекСтрока.ДатаНачалаРегистрации, "ДЛФ=Д")), "") 
												 + ?(ЗначениеЗаполнено(ТекСтрока.ДатаОкончанияРегистрации), " по " 
												 + Строка(Формат(ТекСтрока.ДатаОкончанияРегистрации, "ДЛФ=Д")), "");
		СтруктураПараметровМакета.ДокУЛ = СокрВидДок + ?(ЗначениеЗаполнено(ПаспортныеДанные.СерияДокумента)," серии ", "") 
											   + Строка(ПаспортныеДанные.СерияДокумента) 
											   + ?(ЗначениеЗаполнено(ПаспортныеДанные.НомерДокумента), " номер ", "") 
											   + Строка(ПаспортныеДанные.НомерДокумента);
		СтруктураПараметровМакета.АдресПребывания = ПредставлениеАдреса;
		
		ОблСтрока.Параметры.Заполнить(СтруктураПараметровМакета);
		
		ТабДокумент.Вывести(ОблСтрока);
		
		нпп = нпп + 1;
		
	КонецЦикла;
	
	ТабДокумент.ПовторятьПриПечатиСтроки =ТабДокумент.Область(7, , 7);
	
	ТабДокумент.АвтоМасштаб = Истина;
	
	Возврат ТабДокумент;
	
КонецФункции

// Сформировать печатные формы объектов.
//
// ВХОДЯЩИЕ:
//   ИменаМакетов    - Строка    - Имена макетов, перечисленные через запятую.
//   МассивОбъектов  - Массив    - Массив ссылок на объекты которые нужно распечатать.
//   ПараметрыПечати - Структура - Структура дополнительных параметров печати.
//
// ИСХОДЯЩИЕ:
//   КоллекцияПечатныхФорм - Таблица значений - Сформированные табличные документы.
//   ПараметрыВывода       - Структура        - Параметры сформированных табличных документов.
//
Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	ПараметрыВывода.ДоступнаПечатьПоКомплектно = Истина;
	
	Если УПЖКХ_ТиповыеМетодыСервер.НужноПечататьМакет(КоллекцияПечатныхФорм, "ПФ_MXL_Форма_4") Тогда
		УПЖКХ_ТиповыеМетодыСервер.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "ПФ_MXL_Форма_4", "Форма №4", ПечатьФорма4(МассивОбъектов, ОбъектыПечати));
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли